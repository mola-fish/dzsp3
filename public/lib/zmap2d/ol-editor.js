"use strict";var OlExtends;!function(t){t.OlEditorable=class{get targetGeoType(){return this.drawGeoType}create(t){return this._src=t,this._srcGeo=t.getGeometry(),this._tarGeo=function(t){const s=e[t];if(!s)return;return new s}(this.targetGeoType),this._tar=new ol.Feature(this._tarGeo),this._onChanged=this._srcGeo.on("change",()=>this.update()),this.update(),this._tar}modify(t,e){this._src=t,this._srcGeo=t.getGeometry(),this._tarGeo=e.getGeometry(),this._tar=e,this._onChanged=this._srcGeo.on("change",()=>this.update())}release(){this._srcGeo.unByKey(this._onChanged)}};const e={Point:ol.geom.Point,LineString:ol.geom.LineString,Polygon:ol.geom.Polygon,MultiPoint:ol.geom.MultiPoint,MultiLineString:ol.geom.MultiLineString,MultiPolygon:ol.geom.MultiPolygon,GeometryCollection:ol.geom.GeometryCollection,Polyline:ol.geom.LineString,MultiPolyline:ol.geom.MultiLineString};const s={};class i{static register(t,e){s[t]=e}static createEditorable(t){const e=s[t];if("function"==typeof e)return e()}}t.OlEditorableFactory=i,t.createEditorable=i.createEditorable,t.register=i.register}(OlExtends||(OlExtends={})),function(t){class e extends t.OlEditorable{}t.ComplexOlEditorable=e}(OlExtends||(OlExtends={})),function(t){class e{constructor(t){this._points=t,this._init()}get length(){return this._length}sliceAlong(t,e){if(t>e)throw new Error("start > end.");if(t<0||t>this._length||e<0||e>this._length)throw new Error("start or end is invalid.");const s=this._getSect(t),i=this._getSect(e);if(-1==s||-1==i)throw new Error("start or end is invalid.");const r=[this._getPoint(s,t)];for(let t=s+1;t<=i;++t)r.push(this._points[t]);return r.push(this._getPoint(i,e)),r}pointAlong(t){if(t<0||t>this._length)return;const e=this._getSect(t);return this._getPoint(e,t)}_init(){const t=this._points,s=this._dists=[],i=this._accdists=[],r=t.length-1;let n=0;for(let l=0;l<r;++l){const r=e.distance(t[l],t[l+1]);s[l]=r,i[l]=n,n+=r}this._length=n}_getSect(t){this._points;const e=this._dists.length;for(let s=0;s<e;++s){if(!(t>this._accdists[s]))return s}return-1}_getPoint(t,s){const i=this._dists[t],r=(s-this._accdists[t])/i;return e.interp(this._points[t],this._points[t+1],r)}static interp(t,e,s){return[t[0]+(e[0]-t[0])*s,t[1]+(e[1]-t[1])*s]}static distance(t,e){const s=t[0]-e[0],i=t[1]-e[1];return Math.sqrt(s*s+i*i)}static midpoint(t,e){return[(t[0]+e[0])/2,(t[1]+e[1])/2]}}t.LineInterp=e}(OlExtends||(OlExtends={})),function(t){let e;!function(t){t.NONE="none",t.CONTINUE="continue",t.SELECTED="selected"}(e||(e={}));const s=new ol.style.Style({stroke:new ol.style.Stroke({color:"red",width:2,lineDash:[10,10]}),image:new ol.style.Circle({radius:4,fill:new ol.style.Fill({color:"#ffcc33"})})}),i={selectStyle:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"orange",width:3}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:"#ffcc33"})})}),modifyStyle:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"yellow",width:2}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:"#ffcc33"})})}),assistStyle:s,selboxStyle:new ol.style.Style({stroke:new ol.style.Stroke({color:"yellow",width:1,lineDash:[10,10]})}),drawFinished:e.SELECTED,moveableOnSelected:!0};function r(t,...e){if("function"==typeof t)try{return t(...e)}catch(t){console.warn("callWithTryCatch error.",t)}}function n(t,e){const s=l(e);s&&t.setStyle(s)}function l(t){if(!t)return;if(t instanceof ol.style.Style)return t;if("function"==typeof t)return t;const e={};return t.fill&&(e.fill=new ol.style.Fill(t.fill)),t.line&&(t.line.width=0|t.line.width||2,e.stroke=new ol.style.Stroke(t.line)),t.icon,t.shape,t.circle&&(e.image=new ol.style.Circle(t.circle)),new ol.style.Style(e)}t.OlEditor=class{constructor(t,s){this._translateFeatures=new ol.Collection,this._actions=[],this._drawFinished=e.NONE,this._moveableOnSelected=!0,this.toOlStyle=l,s=Object.assign({},i,s),this._map=t,this._assistStyle=s.assistStyle,this._selectStyle=s.selectStyle,this._modifyStyle=s.modifyStyle,this._selboxStyle=s.selboxStyle,this._drawFinished=s.drawFinished,this._moveableOnSelected=s.moveableOnSelected,this._features=new ol.Collection,this._source=new ol.source.Vector({features:this._features}),this._vector=new ol.layer.Vector({source:this._source,style:l(this._assistStyle)}),this._targetLayer=s.layer,s.layer&&(this._targetSource=s.layer.getSource(),this._targetFeatures=this._targetSource.getFeaturesCollection())}set modifyStyle(t){this._modifyStyle=t}get modifyStyle(){return this._modifyStyle}set selectStyle(t){this._selectStyle=t}get selectStyle(){return this._selectStyle}set assistStyle(t){this._assistStyle=t}get assistStyle(){return this._assistStyle}set selboxStyle(t){this._selboxStyle=t}get selboxStyle(){return this._selboxStyle}draw(s){this._clearBefore(),this._clearSelect();const i=t.createEditorable(s.type);if(!i)throw new Error("不支持的类型："+s.type);const o=this._targetFeatures,a=new ol.interaction.Draw({type:i.drawGeoType,freehand:s.freehand,style:l(this._assistStyle)});let c=null;a.on("drawstart",t=>{c=i.create(t.feature),c!=t.feature&&(c.set("oleditor-type",s.type,!0),c.set("oleditor-feature",t.feature,!0)),o&&o.push(c),n(c,this._modifyStyle||s.style),r(s.onDrawStart,c)}),a.on("drawend",t=>{setTimeout(()=>{n(c,s.style),r(s.onDrawEnd,c),i.release(),this._clearBefore(),this._drawFinished===e.CONTINUE?(this._vector.setMap(this._map),this._addAction(a)):this._drawFinished===e.SELECTED&&(this.select(),this._applySelectStyle(c,this._selectStyle),this._moveableOnSelected&&this.translate(c,!0))})}),this._vector.setMap(this._map),this._addAction(a)}select(){if(this._getAction(ol.interaction.Pointer))return;this._clearBefore();const t=new ol.interaction.Pointer({handleEvent:t=>{if("click"!==t.type)return!0;this._features.clear(),this._clearSelect(),this._moveableOnSelected&&this._clearAction(ol.interaction.Translate);const e=this._selectFeatures(t.coordinate,8)[0];return e&&(this._applySelectStyle(e,this._selectStyle),this._moveableOnSelected&&this.translate(e,!0)),!0}});this._vector.setMap(this._map),this._addAction(t),this._selectFeature&&this._moveableOnSelected&&this.translate(this._selectFeature,!0)}modify(e){if(this._getAction(ol.interaction.Modify)&&e==this._selectFeature)return;if(this._clearBefore(),e||(e=this._selectFeature),!e)return;if(!(e instanceof ol.Feature))throw new Error("invalid feature.");if(!(e.getGeometry()instanceof ol.geom.Geometry))throw new Error("invalid feature.");const s=e.get("oleditor-type"),i=e.get("oleditor-feature");if(!s||!i)return void console.warn("异常的状态");const r=t.createEditorable(s);if(!r)return;r.modify(i,e),this._features.push(i),this._applySelectStyle(e,this._modifyStyle);const n=new ol.interaction.Modify({features:this._features});this._vector.setMap(this._map),this._addAction(n)}translate(t,e){if(e)this._clearAction(ol.interaction.Translate);else{if(this._moveableOnSelected)return;this._clearBefore()}if(t||(t=this._selectFeature),!t)return;const s=t.get("oleditor-feature");if(!s)return;const i=t.getGeometry(),r=s.getGeometry(),n=ol.geom.Polygon.fromExtent(i.getExtent());var o,a;this._translateFeature=new ol.Feature(n),this._translateFeature.setStyle(l(this._selboxStyle)),o=this._features,a=this._translateFeature,-1==o.getArray().indexOf(a)&&o.push(a),this._applySelectStyle(t,this._modifyStyle),this._translateFeatures.clear(),this._translateFeatures.push(this._translateFeature);const c=new ol.interaction.Translate({features:this._translateFeatures});let h=null,_=null;c.on("translatestart",t=>h=t.coordinate),c.on("translateend",t=>_=t.coordinate),c.on("translating",t=>{_=t.coordinate;const e=_[0]-h[0],s=_[1]-h[1];i.translate(e,s),r.translate(e,s),h=_}),this._vector.setMap(this._map),this._addAction(c)}delete(t){t||(t=this._selectFeature),t&&(this._targetFeatures&&this._targetFeatures.remove(t),this._clearSelect())}clear(){this._clearBefore(),this._clearSelect()}_addAction(t){this._map.addInteraction(t),this._actions.push(t)}_clearAction(t){for(;;){const e=this._actions.findIndex(e=>e.constructor===t);if(-1===e)break;this._map.removeInteraction(this._actions[e]),this._actions.splice(e,1)}}_getAction(t){return this._actions.find(e=>e.constructor===t)}_clearBefore(){this._actions.forEach(t=>this._map.removeInteraction(t)),this._actions.length=0,this._features.clear(),this._vector.setMap(null)}_clearSelect(){this._translateFeature&&(this._features.remove(this._translateFeature),this._translateFeatures.clear(),this._translateFeature=null),this._restoreSelectStyle()}_applySelectStyle(t,e){this._restoreSelectStyle(),t&&(this._selectFeature=t,this._selectOldStyle=t.getStyle(),n(t,e))}_restoreSelectStyle(){this._selectFeature&&this._selectFeature.setStyle(this._selectOldStyle),this._selectFeature=null,this._selectOldStyle=null}_selectFeatures(t,e){const s=[],i=this._map.getView().getResolution()*e,r=[t[0]-i,t[1]-i,t[0]+i,t[1]+i];return this._targetFeatures.forEach(t=>{const e=t.getGeometry();e&&e.intersectsExtent(r)&&s.push(t)}),s}}}(OlExtends||(OlExtends={})),function(t){class e extends t.ComplexOlEditorable{get type(){return"SPLine"}get drawGeoType(){return"LineString"}update(){const t=n(this._srcGeo.getCoordinates());this._tarGeo.setCoordinates(t)}}t.SplineOlEditorable=e;class s extends e{get type(){return"ColdFrontLine"}get targetGeoType(){return"GeometryCollection"}update(){l(n(this._srcGeo.getCoordinates()),this._tarGeo,!0)}}t.ColdFrontEditorable=s;class i extends e{get type(){return"WarmFrontLine"}get targetGeoType(){return"GeometryCollection"}update(){l(n(this._srcGeo.getCoordinates()),this._tarGeo,!1)}}t.WarmFrontEditorable=i,t.register("SPLine",()=>new e),t.register("WarmFrontLine",()=>new i),t.register("ColdFrontLine",()=>new s);const r={resolution:1e4,sharpness:1.3};function n(t){let e=null;const s=[];t.forEach(t=>{e&&e[0]==t[0]&&e[1]==t[1]||(s.push(t),e=t)}),1==s.length&&s.push(e);const i=turf.lineString(s);return turf.bezierSpline(i,r).geometry.coordinates}function l(e,s,i){const r=new t.LineInterp(e),n=o(r,.1,.2,i),l=o(r,.2,.3,i),a=o(r,.7,.8,i),c=o(r,.8,.9,i);s.setGeometries([new ol.geom.LineString(e),new ol.geom.MultiPolygon([[n],[l],[a],[c]])])}function o(e,s,i,r){const n=e.length,l=e.sliceAlong(s*n,i*n),o=l[0],a=l[l.length-1],c=t.LineInterp.midpoint(o,a),h=[a[1]-c[1],c[0]-a[0]],_=[c[0]-h[0],c[1]-h[1]];if(r)return l.concat([_,o]);const u=Math.atan2(a[1]-o[1],a[0]-o[0]),y=function(t,e,s,i,r=256){const[n,l]=t,o=(i-s)/r,a=[];for(let t=0;t<r;++t){const i=t*o+s;a.push([n+Math.cos(i)*e,l+Math.sin(i)*e])}return a}(c,t.LineInterp.distance(c,a),u,u+Math.PI);return l.concat(y)}}(OlExtends||(OlExtends={})),function(t){class e extends t.OlEditorable{constructor(t){super(),this._type=t}get type(){return this._type}get drawGeoType(){return this._type}update(){const t=this._srcGeo.getCoordinates();this._tarGeo.setCoordinates(t)}}t.SimpleOlEditorable=e,t.register("Point",()=>new e("Point")),t.register("LineString",()=>new e("LineString")),t.register("Polygon",()=>new e("Polygon")),t.register("MultiPoint",()=>new e("MultiPoint")),t.register("MultiLineString",()=>new e("MultiLineString")),t.register("MultiPolygon",()=>new e("MultiPolygon")),t.register("Polyline",()=>new e("LineString")),t.register("MultiPolyline",()=>new e("MultiLineString"))}(OlExtends||(OlExtends={}));