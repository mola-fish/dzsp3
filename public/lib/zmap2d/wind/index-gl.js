var layer,_polygon,imageExtent=null,imageSize=null;function addLayers(e){layer&&map.removeLayer(layer),_polygon=e;var t={type:"FeatureCollection",crs:{type:"name",properties:{name:"EPSG:4326"}},features:[{type:"Feature",geometry:{type:"Polygon",coordinates:e}}]},a=new ol.source.Vector({features:(new ol.format.GeoJSON).readFeatures(t)});layer=new ol.layer.Vector({source:a,style:[new ol.style.Style({stroke:new ol.style.Stroke({color:"pink",width:3})})]}),map.addLayer(layer)}$(document).ready((function(){new ol.proj.Projection({code:"EPSG:4326",units:"degrees"});var e=new ol.Map({target:"map",view:new ol.View({extent:[0,-90,360,60],minZoom:0,maxZoom:12,projection:"EPSG:4326",center:[113.29,23.15],zoom:6})});window.map=e;var t=new ol.layer.Tile({title:"天地图行政区图",source:new ol.source.XYZ({projection:"EPSG:4326",url:"http://t1.tianditu.com/DataServer?T=vec_c&x={x}&y={y}&l={z}&tk=e8059e2c3ceab0123027d26a20cc63d8"})}),a=new ol.layer.Tile({title:"天地图影像地图",source:new ol.source.XYZ({projection:"EPSG:4326",url:"http://t1.tianditu.com/DataServer?T=img_c&x={x}&y={y}&l={z}&tk=e8059e2c3ceab0123027d26a20cc63d8"})}),n=new ol.layer.Tile({title:"天地图省级区划",source:new ol.source.XYZ({projection:"EPSG:4326",url:"http://t1.tianditu.com/DataServer?T=tbo_c&x={x}&y={y}&l={z}&tk=e8059e2c3ceab0123027d26a20cc63d8"})}),r=new ol.layer.Tile({title:"天地图注记",source:new ol.source.XYZ({projection:"EPSG:4326",url:"http://t1.tianditu.com/DataServer?T=cta_c&x={x}&y={y}&l={z}&tk=e8059e2c3ceab0123027d26a20cc63d8"})});e.addLayer(t),e.addLayer(a),e.addLayer(n),e.addLayer(r),t.setVisible(!1),n.setVisible(!1);var o=new ol.control.MousePosition({projection:"EPSG:4326"});e.addControl(o);var i=new ol.control.ScaleLine({units:"metric",target:"scalebar",className:"ol-scale-line"});e.addControl(i);var l,d=document.createElement("canvas");d.id="canvas";var c=new ol.layer.Image({source:new ol.source.ImageCanvas({canvasFunction:function(e,t,a,n,r){var o=n[0],i=n[1];d.width=o,d.height=i;e=ol.proj.transformExtent(e,r,"EPSG:4326");return l=e,u&&(u.resize(),u.resetWind(e)),d},projection:"EPSG:4236"})});e.addLayer(c);var s=d.getContext("webgl",{antialiasing:!1}),u=window.wind=new WindGL(s);u.layer=c,function e(){u.windData1&&u.draw(),requestAnimationFrame(e)}();const y={0:windData58,12:windData59,24:windData60,36:windData61},w=new dat.GUI;w.add({layer:"影像图",color:"风速色表"},"layer",["地形图","行政图","影像图"]).name("图层").onChange((function(e){"地形图"==e?(t.setVisible(!1),a.setVisible(!1)):"行政图"==e?(t.setVisible(!0),a.setVisible(!1)):"影像图"==e&&(t.setVisible(!1),a.setVisible(!0))}));var m=w.addFolder("风场粒子属性调整");m.add(u,"numParticles",0,2e5),m.add(u,"pointSize",.4,2),m.add(u,"fadeOpacity",.9,.999).step(.001).updateDisplay(),m.add(u,"speedFactor",.05,3),m.add(u,"dropRate",0,.05),m.add(u,"dropRateBump",0,.1),m.add(u,"spdFilterMin",0,100).step(.001),m.add(u,"spdFilterMax",0,100).step(.001),m.add(u,"dirFilterStart",0,360).step(.001),m.add(u,"dirFilterEnd",0,360).step(.001);var p=w.addFolder("时间");p.add({"2018-03-30+h":0},"2018-03-30+h",0,36,12).onChange((function(e){v(y[e])})),m.open(),p.open();function v(e,t){var a,n=new Object;e instanceof Uint8Array?(a=e,void 0===t&&(t=!0)):a=new Uint8Array(e.field);var r=new Uint8Array(e.length||e.field.length);r.set(a.subarray(0,(e.length||e.field.length)-1),0);for(var o=new DataView(r.buffer),i=new Float32Array(8),d=0;d<i.length;d++)i[d]=o.getFloat32(4*d,!!t);n.latMin=i[0],n.latMax=i[1],n.lonMin=i[2],n.lonMax=i[3],n.uMax=i[4],n.vMax=i[5],n.uMin=i[6],n.vMin=i[7],n.width=o.getInt32(32,!!t),n.height=o.getInt32(36,!!t),addLayers([[[Number(n.lonMin),Number(n.latMin)],[Number(n.lonMax),Number(n.latMin)],[Number(n.lonMax),Number(n.latMax)],[Number(n.lonMin),Number(n.latMax)],[Number(n.lonMin),Number(n.latMin)]]]);for(var c=new Int8Array(o.byteLength-40),s=0;s<c.length;s+=2)c[s]=Math.floor(256*(o.getInt8(s+40)-n.uMin)/(n.uMax-n.uMin)),c[s+1]=Math.floor(256*(o.getInt8(s+41)-n.vMin)/(n.vMax-n.vMin));n.data=new Uint8Array(2*c.byteLength);for(s=0;s<c.byteLength;s+=2)n.data[2*s]=c[s],n.data[2*s+1]=c[s+1];u.setWind(n,l)}_load=function(){axios.get("http://10.148.10.152:9089/zs/weather3d/10mwnd?name%3D10mwnd%26lvl%3D5%26row%3D13%26col%3D26%26west%3D112.5%26east%3D123.74999999999999%26south%3D21.943045533438166%26north%3D31.95216223802496%26size%3D256%3B256%26method%3Dwnd%26time%3D2020-04-24%2000%3A00%3A00%26tvalid%3D000%26format%3Dstream",{responseType:"arraybuffer"}).then(e=>{let t=new Uint8Array(e.data);setTimeout(()=>{v(t)},50)})},_load()}));