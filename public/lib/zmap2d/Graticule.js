ol.Graticule=function(t){var e=goog.isDef(t)?t:{};this.map_=null,this.projection_=null,this.maxLat_=1/0,this.maxLon_=1/0,this.minLat_=-1/0,this.minLon_=-1/0,this.targetSize_=goog.isDef(e.targetSize)?e.targetSize:100,this.maxLines_=goog.isDef(e.maxLines)?e.maxLines:100,goog.asserts.assert(this.maxLines_>0,"this.maxLines_ should be more than 0"),this.visible_=!goog.isDef(e.visible)||e.visible_,this.meridians_=[],this.parallels_=[],this.strokeStyle_=goog.isDef(e.strokeStyle)?e.strokeStyle:ol.Graticule.DEFAULT_STROKE_STYLE_,this.fromLonLatTransform_=void 0,this.toLonLatTransform_=void 0,this.projectionCenterLonLat_=null,this.setMap(goog.isDef(e.map)?e.map:null);var l=function(t,e,l){var a,i,o,s,r,n,h,_=((i=(e+180)%(a=360))*a<0?i+a:i)-180,g=Math.abs(3600*_),m=l||0,u=Math.pow(10,m),p=Math.floor(g/3600),c=Math.floor((g-3600*p)/60),L=g-3600*p-60*c;return(L=Math.ceil(L*u)/u)>=60&&(L=0,c+=1),c>=60&&(c=0,p+=1),p+"° "+(o=c,s=2,n=void 0!==r?o.toFixed(r):""+o,((h=-1===(h=n.indexOf("."))?n.length:h)>s?n:new Array(1+s-h).join("0")+n)+"′ ")+(0==_?"":" "+t.charAt(_<0?1:0))};e.showLabels&&(this.lonLabelFormatter_=null==e.lonLabelFormatter?l.bind(this,"EW"):e.lonLabelFormatter,this.latLabelFormatter_=null==e.latLabelFormatter?l.bind(this,"NS"):e.latLabelFormatter,this.lonLabelPosition_=null==e.lonLabelPosition?0:e.lonLabelPosition,this.latLabelPosition_=null==e.latLabelPosition?1:e.latLabelPosition,this.lonLabelStyleBase_=new ol.style.Style({text:void 0!==e.lonLabelStyle?goog.object.clone(e.lonLabelStyle):new ol.style.Text({font:"12px Calibri,sans-serif",textBaseline:"bottom",fill:new ol.style.Fill({color:"rgba(0,0,0,1)"}),stroke:new ol.style.Stroke({color:"rgba(255,255,255,1)",width:3})})}),this.lonLabelStyle_=function(t){var e=t.get("graticule_label");return this.lonLabelStyleBase_.getText().setText(e),this.lonLabelStyleBase_}.bind(this),this.latLabelStyleBase_=new ol.style.Style({text:void 0!==e.latLabelStyle?goog.object.clone(e.latLabelStyle):new ol.style.Text({font:"12px Calibri,sans-serif",textAlign:"end",textBaseline:"right",fill:new ol.style.Fill({color:"rgba(0,0,0,1)"}),stroke:new ol.style.Stroke({color:"rgba(255,255,255,1)",width:3})})}),this.latLabelStyle_=function(t){var e=t.get("graticule_label");return this.latLabelStyleBase_.getText().setText(e),this.latLabelStyleBase_}.bind(this),this.meridiansLabels_=[],this.parallelsLabels_=[]),this.intervals_=void 0!==e.intervals?e.intervals:INTERVALS;var a=new ol.source.Vector({loader:this.loaderFunction.bind(this),features:new ol.Collection,overlaps:!1,useSpatialIndex:!1,wrapX:e.wrapX});this.layer_=new ol.layer.Vector({source:a,style:new ol.style.Style({stroke:new ol.style.Stroke({color:"rgba(255, 0, 0, 1.0)",width:2})})}),this.featurePool_=[],this.lineStyle_=new ol.style.Style({stroke:this.strokeStyle_}),this.textStyle_=new ol.style.Style({text:new ol.style.Text({font:"12px Calibri, sans-serif",fill:new ol.style.Fill({color:"#000"}),stroke:new ol.style.Stroke({color:"#fff",width:3})})})},ol.Graticule.DEFAULT_STROKE_STYLE_=new ol.style.Stroke({color:"rgba(0,0,0,0.2)"}),ol.Graticule.intervals_=[90,45,30,20,10,6,3,1,.5,.25],ol.Graticule.prototype.addMeridian_=function(t,e,l,a){var i=this.getMeridian_(t,e,a);if(ol.extent.intersects(i.getExtent(),l)){if(this.meridiansLabels_){var o=this.lonLabelFormatter_(t);a in this.meridiansLabels_?this.meridiansLabels_[a].text=o:this.meridiansLabels_[a]={geom:new ol.geom.Point([0,0]),text:o}}this.meridians_[a++]=i}return a},ol.Graticule.prototype.addParallel_=function(t,e,l,a){var i=this.getParallel_(t,e,a);if(ol.extent.intersects(i.getExtent(),l)){if(this.parallelsLabels_){var o=this.latLabelFormatter_(t);a in this.parallelsLabels_?this.parallelsLabels_[a].text=o:this.parallelsLabels_[a]={geom:new ol.geom.Point([0,0]),text:o}}this.parallels_[a++]=i}return a},ol.Graticule.prototype.clear=function(){this.meridiansLabels_.length>0&&this.meridiansLabels_.splice(0,this.meridiansLabels_.length),this.meridians_.length>0&&this.meridians_.splice(0,this.meridians_.length),this.parallelsLabels_.length>0&&this.parallelsLabels_.splice(0,this.parallelsLabels_.length),this.parallels_.length>0&&this.parallels_.splice(0,this.parallels_.length)},ol.Graticule.prototype.createGraticule_=function(t,e,l,a){var i=this.getInterval_(l);if(-1!=i){this.clear();var o,s,r,n,h=this.toLonLatTransform_(e),_=h[0],g=h[1],m=this.maxLines_;for(_=Math.floor(_/i)*i,n=goog.math.clamp(_,this.minLon_,this.maxLon_),s=this.addMeridian_(n,a,t,0),o=0;n!=this.minLon_&&o++<m;)n=Math.max(n-i,this.minLon_),s=this.addMeridian_(n,a,t,s);for(n=goog.math.clamp(_,this.minLon_,this.maxLon_),o=0;n!=this.maxLon_&&o++<m;)n=Math.min(n+i,this.maxLon_),s=this.addMeridian_(n,a,t,s);for(g=Math.floor(g/i)*i,r=goog.math.clamp(g,this.minLat_,this.maxLat_),s=this.addParallel_(r,a,t,0),o=0;r!=this.minLat_&&o++<m;)r=Math.max(r-i,this.minLat_),s=this.addParallel_(r,a,t,s);for(r=goog.math.clamp(g,this.minLat_,this.maxLat_),o=0;r!=this.maxLat_&&o++<m;)r=Math.min(r+i,this.maxLat_),s=this.addParallel_(r,a,t,s)}},ol.Graticule.prototype.getInterval_=function(t){var e,l,a,i=this.projectionCenterLonLat_[0],o=this.projectionCenterLonLat_[1],s=-1,r=Math.pow(this.targetSize_*t,2),n=[],h=[];for(e=0,l=ol.Graticule.intervals_.length;e<l&&(a=ol.Graticule.intervals_[e]/2,n[0]=i-a,n[1]=o-a,h[0]=i+a,h[1]=o+a,this.fromLonLatTransform_(n,n),this.fromLonLatTransform_(h,h),!(Math.pow(h[0]-n[0],2)+Math.pow(h[1]-n[1],2)<=r));++e)s=ol.Graticule.intervals_[e-1];return s},ol.Graticule.prototype.getMap=function(){return this.map_},ol.Graticule.prototype.getMeridian_=function(t,e,l){goog.asserts.assert(t>=this.minLon_,"lon should be larger than or equal to this.minLon_"),goog.asserts.assert(t<=this.maxLon_,"lon should be smaller than or equal to this.maxLon_");var a=ol.geom.flat.geodesic.meridian(t,this.minLat_,this.maxLat_,this.projection_,e);goog.asserts.assert(a.length>0,"flatCoordinates cannot be empty");var i=goog.isDef(this.meridians_[l])?this.meridians_[l]:new ol.geom.LineString(null);return i.setFlatCoordinates(ol.geom.GeometryLayout.XY,a),i},ol.Graticule.prototype.getMeridians=function(){return this.meridians_},ol.Graticule.prototype.getParallel_=function(t,e,l){goog.asserts.assert(t>=this.minLat_,"lat should be larger than or equal to this.minLat_"),goog.asserts.assert(t<=this.maxLat_,"lat should be smaller than or equal to this.maxLat_");var a=ol.geom.flat.geodesic.parallel(t,this.minLon_,this.maxLon_,this.projection_,e);goog.asserts.assert(a.length>0,"flatCoordinates cannot be empty");var i=goog.isDef(this.parallels_[l])?this.parallels_[l]:new ol.geom.LineString(null);return i.setFlatCoordinates(ol.geom.GeometryLayout.XY,a),i},ol.Graticule.prototype.getParallels=function(){return this.parallels_},ol.Graticule.prototype.loaderFunction=function(t,e,l){this.loadedExtent_=t;var a=this.layer_.getSource(),i=this.layer_.getExtent()||[-1/0,-1/0,1/0,1/0];var o,s,r,n,h=this.map_,_=h.getView(),g=h.getSize(),m=(e=_.getResolution(),l=_.getProjection(),n=r||0,function(t,e){return t[0]<=e[2]&&t[2]>=e[0]&&t[1]<=e[3]&&t[3]>=e[1]}(o=i,s=t)&&(o[0]>s[0]?n[0]=o[0]:n[0]=s[0],o[1]>s[1]?n[1]=o[1]:n[1]=s[1],o[2]<s[2]?n[2]=o[2]:n[2]=s[2],o[3]<s[3]?n[3]=o[3]:n[3]=s[3]),n);if(!(this.renderedExtent_&&goog.math.equals(this.renderedExtent_,m)||(this.renderedExtent_=m,goog.isNull(m)))){var u=_.getCenter(),p=(t=_.calculateExtent(g),e*e/4);!(this.projection_&&this.projection_==l)&&this.updateProjectionInfo_(l),this.createGraticule_(m,u,e,p);var c,L=this.meridians_.length+this.parallels_.length;for(this.meridiansLabels_&&(L+=this.meridians_.length),this.parallelsLabels_&&(L+=this.parallels_.length);L>this.featurePool_.length;)c=new ol.Feature,this.featurePool_.push(c);var d=a.getFeaturesCollection();d.clear();var f,b,y=0;for(f=0,b=this.meridians_.length;f<b;++f)(c=this.featurePool_[y++]).setGeometry(this.meridians_[f]),c.setStyle(this.lineStyle_),d.push(c);for(f=0,b=this.parallels_.length;f<b;++f)(c=this.featurePool_[y++]).setGeometry(this.parallels_[f]),c.setStyle(this.lineStyle_),d.push(c)}},ol.Graticule.prototype.drawLabels_=function(t){var e=t.frameState.viewState.rotation,l=t.frameState.extent,a=this.map_,i=a.getView(),o=a.getSize(),s=i.getCenter(),r=i.calculateExtent(o);i.getResolution(),i.getProjection();if(e){var n=o[0],h=o[1],_=Math.abs(Math.cos(e)),g=Math.abs(Math.sin(e)),m=(g*h-_*n)/(g*g-_*_),u=(g*n-_*h)/(g*g-_*_);r=[s[0]-m/2,s[1]-u/2,s[0]+m/2,s[1]+u/2]}var p=0,c=0,L=this.latLabelPosition_<.5,d=r,f=o[0];d||(p=Math.floor((l[0]-d[0])/f),c=Math.ceil((l[2]-d[2])/f),L=L!==Math.abs(e)>Math.PI/2);for(var b=t.vectorContext,y=p;y<=c;++y){var v=this.meridians_.length+this.parallels_.length,x=void 0,S=void 0,P=void 0,w=void 0;if(this.layer_.getSource().clear(),this.meridiansLabels_)for(S=0,P=this.meridiansLabels_.length;S<P;++S){var M=this.meridians_[S];if(e||0!==y)(G=M.clone()).translate(y*f,0),G.rotate(-e,s),(w=this.getMeridianPoint_(G,r,S)).rotate(e,s);else w=this.getMeridianPoint_(M,l,S);(x=this.featurePool_[v++]).setGeometry(w),x.set("graticule_label",this.meridiansLabels_[S].text),b.drawFeature(x,goog.cloneObject(this.lonLabelStyle_(x)))}if(this.parallelsLabels_&&(y===p&&L||y===c&&!L))for(S=0,P=this.parallels_.length;S<P;++S){var G;M=this.parallels_[S];if(e||0!==y)(G=M.clone()).translate(y*f,0),G.rotate(-e,s),(w=this.getParallelPoint_(G,r,S)).rotate(e,s);else w=this.getParallelPoint_(M,l,S);(x=this.featurePool_[v++]).setGeometry(w),x.set("graticule_label",this.parallelsLabels_[S].text),b.drawFeature(x,goog.cloneObject(this.latLabelStyle_(x)))}}},ol.Graticule.prototype.getMeridianPoint_=function(t,e,l){var a=t.getFlatCoordinates(),i=1,o=a.length-1;a[i]>a[o]&&(i=o,o=1);var s=Math.max(e[1],a[i]),r=Math.min(e[3],a[o]),n=goog.math.clamp(e[1]+Math.abs(e[1]-e[3])*this.lonLabelPosition_,s,r),h=[a[i-1]+(a[o-1]-a[i-1])*(n-a[i])/(a[o]-a[i]),n],_=this.meridiansLabels_[l].geom;return _.setCoordinates(h),_},ol.Graticule.prototype.getParallelPoint_=function(t,e,l){var a=t.getFlatCoordinates(),i=0,o=a.length-2;a[i]>a[o]&&(i=o,o=0);var s=Math.max(e[0],a[i]),r=Math.min(e[2],a[o]),n=goog.math.clamp(e[0]+Math.abs(e[0]-e[2])*this.latLabelPosition_,s,r),h=[n,a[i+1]+(a[o+1]-a[i+1])*(n-a[i])/(a[o]-a[i])],_=this.parallelsLabels_[l].geom;return _.setCoordinates(h),_},ol.Graticule.prototype.handlePostCompose_=function(t){goog.isNull(this.map_)||this.visible_&&(this.ePostComposeEvent_=t,this.moveEnd_(t))},ol.Graticule.prototype.moveEnd_=function(t){var e=t.vectorContext;null==e&&(t=this.ePostComposeEvent_),e=t.vectorContext;var l,a,i,o=t.frameState,s=o.extent,r=o.viewState,n=r.center,h=r.projection,_=r.resolution,g=o.pixelRatio,m=_*_/(4*g*g);for((goog.isNull(this.projection_)||!ol.proj.equivalent(this.projection_,h))&&this.updateProjectionInfo_(h),this.extent_=s,this.createGraticule_(s,n,_,m),e.setFillStrokeStyle(null,this.strokeStyle_),l=0,a=this.meridians_.length;l<a;++l)i=this.meridians_[l],e.drawLineString(i,null);for(l=0,a=this.parallels_.length;l<a;++l)i=this.parallels_[l],e.drawLineString(i,null);this.featurePool_.length>0&&this.featurePool_.splice(0,this.featurePool_);var u,p=this.meridians_.length+this.parallels_.length;for(this.meridiansLabels_&&(p+=this.meridians_.length),this.parallelsLabels_&&(p+=this.parallels_.length);p>this.featurePool_.length;)u=new ol.Feature,this.featurePool_.push(u);this.drawLabels_(t)},ol.Graticule.prototype.updateProjectionInfo_=function(t){goog.asserts.assert(!goog.isNull(t),"projection cannot be null");var e=t.getExtent(),l=t.getWorldExtent(),a=l[3],i=l[2],o=l[1],s=l[0];goog.asserts.assert(!goog.isNull(e),"extent cannot be null"),goog.asserts.assert(goog.isDef(a),"maxLat should be defined"),goog.asserts.assert(goog.isDef(i),"maxLon should be defined"),goog.asserts.assert(goog.isDef(o),"minLat should be defined"),goog.asserts.assert(goog.isDef(s),"minLon should be defined"),this.maxLat_=a,this.maxLon_=i,this.minLat_=o,this.minLon_=s;var r=ol.proj.get("EPSG:4326");this.fromLonLatTransform_=ol.proj.getTransform(r,t),this.toLonLatTransform_=ol.proj.getTransform(t,r),this.projectionCenterLonLat_=this.toLonLatTransform_(ol.extent.getCenter(e)),this.projection_=t},ol.Graticule.prototype.setMap=function(t){goog.isNull(this.map_)||(this.map_.un(ol.render.EventType.POSTCOMPOSE,this.handlePostCompose_,this),this.map_.render()),goog.isNull(t)||(t.on(ol.render.EventType.POSTCOMPOSE,this.handlePostCompose_,this),t.render()),this.map_=t},ol.Graticule.prototype.remove=function(t){this.setMap(null),goog.isNull(this.map_)||this.map_.render()},ol.Graticule.prototype.setVisible=function(t){this.visible_=t,goog.isNull(this.map_)||this.map_.render()},ol.Graticule.prototype.isVisible=function(){return this.visible_};