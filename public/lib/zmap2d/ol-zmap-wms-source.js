goog.provide("ol.source.ImageWMSZMap"),goog.require("goog.asserts"),goog.require("goog.object"),goog.require("goog.string"),goog.require("ol"),goog.require("ol.Image"),goog.require("ol.extent"),goog.require("ol.proj"),goog.require("ol.source.Image"),goog.require("ol.source.ImageWMSZMap"),goog.require("ol.source.wms.ServerType"),ol.source.ImageWMSZMap=function(e){var o=goog.isDef(e)?e:{};goog.base(this,{attributions:o.attributions,logo:o.logo,projection:o.projection,resolutions:o.resolutions}),this.crossOrigin_=goog.isDef(o.crossOrigin)?o.crossOrigin:null,this.url_=o.url,this.callback_=o.callback,this.imageLoadFunction_=goog.isDef(o.imageLoadFunction)?o.imageLoadFunction:ol.source.Image.defaultImageLoadFunction,this.params_=o.params,this.v13_=!0,this.updateV13_(),this.serverType_=o.serverType,this.hidpi_=!goog.isDef(o.hidpi)||o.hidpi,this.image_=null,this.imageSize_=[0,0],this.renderedRevision_=0,this.ratio_=goog.isDef(o.ratio)?o.ratio:1.5},goog.inherits(ol.source.ImageWMSZMap,ol.source.Image),ol.source.ImageWMSZMap.GETFEATUREINFO_IMAGE_SIZE_=[101,101],ol.source.ImageWMSZMap.prototype.getGetFeatureInfoUrl=function(e,o,t,i){if(goog.asserts.assert(!("VERSION"in i),"key VERSION is not allowed in params"),goog.isDef(this.url_)){var s=ol.extent.getForViewAndSize(e,o,0,ol.source.ImageWMSZMap.GETFEATUREINFO_IMAGE_SIZE_),r={SERVICE:"WMS",VERSION:ol.DEFAULT_WMS_VERSION,REQUEST:"GetFeatureInfo",FORMAT:"image/png",TRANSPARENT:!0,QUERY_LAYERS:this.params_.LAYERS};goog.object.extend(r,this.params_,i);var a=Math.floor((e[0]-s[0])/o),g=Math.floor((s[3]-e[1])/o);return r[this.v13_?"I":"X"]=a,r[this.v13_?"J":"Y"]=g,this.getRequestUrl_(s,ol.source.ImageWMSZMap.GETFEATUREINFO_IMAGE_SIZE_,1,ol.proj.get(t),r)}},ol.source.ImageWMSZMap.prototype.getParams=function(){return this.params_},ol.source.ImageWMSZMap.prototype.getImage=function(e,o,t,i){if(!goog.isDef(this.url_))return null;o=this.findNearestResolution(o),1==t||this.hidpi_&&goog.isDef(this.serverType_)||(t=1);var s=this.image_;if(!goog.isNull(s)&&this.renderedRevision_==this.getRevision()&&s.getResolution()==o&&s.getPixelRatio()==t&&ol.extent.containsExtent(s.getExtent(),e))return s.extent=e,s;var r={SERVICE:"WMS",VERSION:ol.DEFAULT_WMS_VERSION,REQUEST:"GetMap",FORMAT:"image/png",TRANSPARENT:!0};goog.object.extend(r,this.params_);var a=((e=e.slice())[0]+e[2])/2,g=(e[1]+e[3])/2;if(1!=this.ratio_){var n=this.ratio_*ol.extent.getWidth(e)/2,u=this.ratio_*ol.extent.getHeight(e)/2;e[0]=a-n,e[1]=g-u,e[2]=a+n,e[3]=g+u}var l,h=o/t,_=Math.ceil(ol.extent.getWidth(e)/h),p=Math.ceil(ol.extent.getHeight(e)/h);return e[0]=a-h*_/2,e[2]=a+h*_/2,e[1]=g-h*p/2,e[3]=g+h*p/2,this.imageSize_[0]=_,this.imageSize_[1]=p,l=this.callback_?this.callback_({extent:e,size:this.imageSize_,pixelRadio:t,url:this.url_,projection:i,params:r}):this.getRequestUrl_(e,this.imageSize_,t,i,r),this.image_=new ol.Image(e,o,t,this.getAttributions(),l,this.crossOrigin_,this.imageLoadFunction_),this.renderedRevision_=this.getRevision(),goog.events.listen(this.image_,goog.events.EventType.CHANGE,this.handleImageChange,!1,this),this.image_},ol.source.ImageWMSZMap.prototype.getImageLoadFunction=function(){return this.imageLoadFunction_},ol.source.ImageWMSZMap.prototype.getRequestUrl_=function(e,o,t,i,s){if(goog.asserts.assert(goog.isDef(this.url_),"url is defined"),s[this.v13_?"CRS":"SRS"]=i.getCode(),"STYLES"in this.params_||(s.STYLES=new String("")),1!=t)switch(this.serverType_){case ol.source.wms.ServerType.GEOSERVER:var r=90*t+.5|0;goog.isDef(s.FORMAT_OPTIONS)?s.FORMAT_OPTIONS+=";dpi:"+r:s.FORMAT_OPTIONS="dpi:"+r;break;case ol.source.wms.ServerType.MAPSERVER:s.MAP_RESOLUTION=90*t;break;case ol.source.wms.ServerType.CARMENTA_SERVER:case ol.source.wms.ServerType.QGIS:s.DPI=90*t;break;default:goog.asserts.fail("unknown serverType configured")}s.WIDTH=o[0],s.HEIGHT=o[1];var a,g=i.getAxisOrientation();a=this.v13_&&"ne"==g.substr(0,2)?[e[1],e[0],e[3],e[2]]:e,s.BBOX=a.join(",");var n="";for(var u in s)n+=u+"="+s[u],n+="&";return url+"?"+n},ol.source.ImageWMSZMap.prototype.getUrl=function(){return this.url_},ol.source.ImageWMSZMap.prototype.setImageLoadFunction=function(e){this.image_=null,this.imageLoadFunction_=e,this.changed()},ol.source.ImageWMSZMap.prototype.setUrl=function(e){e!=this.url_&&(this.url_=e,this.image_=null,this.changed())},ol.source.ImageWMSZMap.prototype.updateParams=function(e){goog.object.extend(this.params_,e),this.updateV13_(),this.image_=null,this.changed()},ol.source.ImageWMSZMap.prototype.updateV13_=function(){this.v13_="SRS"};