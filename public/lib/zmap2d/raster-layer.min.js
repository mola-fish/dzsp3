"use strict";!function(t){t.CompIsoOnServer=class{constructor(){}initBody(e,i,s){const r=[],n=Object.assign({width:.4},i.line),o=Object.assign({size:24,color:"black",repeat:100,decimals:1},i.label);if(!Array.isArray(s))throw"没有指定色表，无法追钟等值线";t.ColorTable.createPiecewise(s).colors.forEach(t=>{const e=t.rgba;0!=e[3]&&r.push({min:t.min,max:t.max,color:e})});const a={enabled:!0,field:"value",text:{fontSize:o.size,textColor:t.ColorTool.parseCssColorString(o.color),decimals:o.decimals,fontFamily:o.fontFamily||"SimSun",textSpacing:o.textSpacing||0},placement:{placementFlags:o.place||["above","below"],repeatDistance:o.repeat},render:{labelPerPart:!0,minFeatureSize:o.minFeatureSize||20},buffer:Object.assign({bufferDraw:!1,bufferSize:1,bufferColor:[255,255,255,255]},o.buffer),shadow:Object.assign({shadowDraw:!1,shadowOffsetAngle:135,shadowOffsetDist:1,shadowRadius:1.5,shadowColor:[0,0,0],shadowTransparency:.3},o.shadow),background:Object.assign({shapeDraw:!1,shapeFillColor:"255,255,255,255",shapeBorderColor:"255,255,255,255",shapeBorderWidth:0},o.background)};return{data:e,polygon:this._option.clip,colors:r,values:i.values,labeling:a,filter:this._option.interpFilter,"line-width":n.width,"line-color":t.ColorTool.parseCssColorString(n.color),"line-style":n.style,"line-joinstyle":n.joinstyle,"line-capstyle":n.capstyle}}init(t,e,i){this._option=t;const s=this.initBody(i,t,e);return this.initIsoWorker(t.server,s)}static fieldName2Index(t,e){if("number"==typeof t)return t;const i=e.indexOf(t);if(-1==i)throw new Error("数据集中不存在字段："+t);return i}getImageURL(e,i,s,r,n){if(!this._workid)return;const o=[r[0]*s,r[1]*s],a={id:this._workid,mode:this._option.mode,size:o.join(","),extent:e.join(","),uuid:this._uuid},l=t.toUrlParams(a);return`http://${this._option.server}/zs/featuregrapha/isoline2/isoline?`+l}getImage(e,i,s,r,n){const o=this.getImageURL(e,i,s,r,n);if(!o)return Promise.resolve(void 0);const a=this._imageFlag={cancel:!1};return t.createImagePromise(o,a)}export(e,i,s){if(!this._workid)throw new Error("invalid workid!!!");const r={id:this._workid,size:i.join(","),extent:e.join(","),fmt:s,uuid:this._uuid},n=t.toUrlParams(r);return`http://${this._option.server}/zs/featuregrapha/isoline2/export?`+n}reset(){this._workid=void 0,this._server=void 0,this._body=void 0,this._controller&&(this._controller.abort(),this._controller=void 0),this._imageFlag&&(this._imageFlag.cancel=!0,this._imageFlag=void 0)}initIsoWorker(e,i){const s=JSON.stringify(i);if(e===this._server&&s==this._body)return Promise.resolve();this.reset(),this._controller=new AbortController,this._server=e,this._body=s,this._uuid=t.guid();const r={headers:{"content-type":"application/json"},body:JSON.stringify(i),method:"POST",signal:this._controller.signal};return fetch(`http://${e}/zs/featuregrapha/isoline2/init?uuid=${this._uuid}`,r).then(t=>t.json()).then(t=>{if(1!=t.success)return Promise.reject("init error");this._workid=t.data.workid})}}}(OLE||(OLE={})),function(t){let e;!function(t){t.ISO_LINES="isolines",t.ISO_BANDS="isobands"}(e=t.IsoTracerType||(t.IsoTracerType={}));class i{static buildGrid(t,e){const i=e[2]-e[0],s=e[3]-e[1],r=i/t.width,n=s/t.height,o={type:"FeatureCollection",features:new Array(t.width*t.height)};for(let i=0;i<t.height;++i)for(let s=0;s<t.width;++s){const a=s+i*t.width;o.features[a]={type:"Feature",properties:{v:t.data[a]},geometry:{type:"Point",coordinates:[e[0]+(s+.5)*r,e[1]+(i+.5)*n]}}}return o}static trace(t,e,i,s){return-1!=t.indexOf("lines")?this.tracelines(e,i,s):-1!=t.indexOf("bands")?this.tracebands(e,i,s):void 0}static traceByResample(t,e,s,r,n,o){const a=s.subData2(r,n,o);return i.trace(t,a,a.extent,e)}static tracelines(e,s,r){return t.DebugTicks.logCost("trace isolines",()=>{const t=i.buildGrid(e,s);return turf.isolines(t,r,{zProperty:"v"})})}static tracebands(e,s,r){return t.DebugTicks.logCost("trace isolines",()=>{const t=i.buildGrid(e,s);return turf.isobands(t,r,{zProperty:"v"})})}static simplify(e,i,s){const r=[];e.features.forEach(t=>{t.geometry.coordinates.length>0&&r.push(t)}),e.features=r;const n=Math.min(t.Extents.width(i),t.Extents.height(i))/1e3;return turf.simplify(e,{tolerance:n,highQuality:s})}}t.IsoTracer=i}(OLE||(OLE={})),function(t){class e{constructor(t,i){this._map=t,i=e.getOption(i),this._win=i.win||window,this._projection=i.projection}refresh(){this.update()}static getOption(t){if(void 0===t)return{win:window};const e=t;return e.window===e?{win:e}:t}}t.BaseAbstractLayer=e}(OLE||(OLE={})),function(t){class e extends t.BaseAbstractLayer{constructor(e,i){super(e,i),i=t.BaseAbstractLayer.getOption(i),this._memContext=this._createMemoryCanvas(),this._memCanvas=this._memContext.canvas,this._createLayer(i.ratio)}get layer(){return this._layer}get soruce(){return this._source}update(){this._source.changed()}refresh(){this.update()}clear(){const{width:t,height:e}=this._memCanvas;this._memContext.clearRect(0,0,t,e)}destroy(){this._map&&this._map.removeLayer(this._layer),this._layer=void 0,this._source=void 0,this._memCanvas=void 0,this._memContext=void 0}_createMemoryCanvas(){return document.createElement("CANVAS").getContext("2d")}_createLayer(t){const e=this._win.ol;this._source=new e.source.ImageCanvas({canvasFunction:(t,e,i,s,r)=>{const n=Math.round(s[0]),o=Math.round(s[1]);return n==this._memCanvas.width&&o==this._memCanvas.height||(this._memCanvas.width=n,this._memCanvas.height=o),this._clearLast()&&this._memContext.clearRect(0,0,n,o),this._canvasFunction(t,e,i,s,r),this._memCanvas},projection:this._projection,ratio:t||1}),this._layer=new e.layer.Image({source:this._source}),this._source._owner=this,this._layer._owner=this,this._map&&this._map.addLayer(this._layer)}_clearLast(){return!0}}t.BaseCanvasLayer=e}(OLE||(OLE={}));var __awaiter=this&&this.__awaiter||function(t,e,i,s){function r(t){return t instanceof i?t:new i((function(e){e(t)}))}return new(i||(i=Promise))((function(i,n){function o(t){try{l(s.next(t))}catch(t){n(t)}}function a(t){try{l(s.throw(t))}catch(t){n(t)}}function l(t){t.done?i(t.value):r(t.value).then(o,a)}l((s=s.apply(t,e||[])).next())}))};!function(t){class e extends t.BaseCanvasLayer{constructor(t){super(void 0,t),this._version=0,t=t||{},this._GetImageFunction=t.getImage||(()=>{})}clear(){super.clear(),this._lastImage=void 0}_canvasFunction(t,e,i,s,r){return this._version++,this._requestImage(this._version,t,e,i,s,r),this._drawImage(t,e,i,s),this._memCanvas}_getImage(t,e,i,s,r){if(this._GetImageFunction)return this._GetImageFunction(t,e,i,s,r)}_requestImage(e,i,s,r,n,o){return __awaiter(this,void 0,void 0,(function*(){let a,l=yield this._getImage(i,s,r,n,o);l&&(a="string"==typeof l?yield t.createImagePromise(l):l,e<this._version||(this._lastImage=a,this._lastExtent=i,this._drawImage(i,s,r,n),this._layer.changed()))}))}_drawImage(t,e,i,s){if(this._lastImage&&this._memContext){const s=this._lastImage,r=this._lastExtent,n=(r[0]-t[0])/e*i,o=(t[3]-r[3])/e*i,a=(r[2]-r[0])/e*i,l=(r[3]-r[1])/e*i;this._memContext.clearRect(0,0,this._memCanvas.width,this._memCanvas.height),this._memContext.drawImage(s,0,0,s.width,s.height,n,o,a,l)}}}t.CustomWmsLayer=e}(OLE||(OLE={})),function(t){class e{static width(t){return t[2]-t[0]}static height(t){return t[3]-t[1]}static isEmpty(t){return t[2]<t[0]||t[3]<t[1]}static isEquals(t,e){return t[0]==e[0]&&t[2]==e[2]&&t[1]==e[1]&&t[3]==e[3]}static clone(t,e){return e?(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e):t.slice()}static createEmpty(){return[1/0,1/0,-1/0,-1/0]}static isIntersects(t,e){return t[0]<=e[2]&&t[2]>=e[0]&&t[1]<=e[3]&&t[3]>=e[1]}static intersection(t,i,s){var r=s||e.createEmpty();return e.isIntersects(t,i)&&(r[0]=Math.max(t[0],i[0]),r[1]=Math.max(t[1],i[1]),r[2]=Math.min(t[2],i[2]),r[3]=Math.min(t[3],i[3])),r}static mergePointXY(t,e,i){if(this.isEmpty(t))return t[0]=t[2]=e,void(t[1]=t[3]=i);e<t[0]&&(t[0]=e),e>t[2]&&(t[2]=e),i<t[1]&&(t[1]=i),i>t[3]&&(t[3]=i)}static mergePoint(t,e){this.mergePointXY(t,e[0],e[1])}static mergePointArray(t,e){e.forEach(e=>this.mergePoint(t,e))}static center(t,e){const i=(t[2]+t[0])/2,s=(t[3]+t[1])/2;return e?(e[0]=i,e[1]=s,e):[i,s]}static buffer(t,e,i){return this.bufferXY(t,e,e,i)}static bufferXY(t,e,i,s){return s||(s=[]),s[0]=t[0]-e,s[1]=t[1]-i,s[2]=t[2]+e,s[3]=t[3]+i,s}}t.Extents=e}(OLE||(OLE={})),function(t){class e extends t.BaseCanvasLayer{constructor(t,e){super(t,e),this._points=[]}get points(){return this._points}get fieldX(){return this._fieldX}get fieldY(){return this._fieldY}setPoints(e){Array.isArray(e)?(this._points=e.slice(),this._fieldX=0,this._fieldY=1):(this._points=e.points.slice(),this._fieldX=Number.isInteger(e.fieldX)?e.fieldX:0,this._fieldY=Number.isInteger(e.fieldY)?e.fieldY:1);const i=this._fieldX,s=this._fieldY,r=this._extent=t.Extents.createEmpty();this._points.forEach(e=>t.Extents.mergePointXY(r,e[i],e[s])),this._onSetPoints()}clear(){super.clear(),this._points.length=0,this._onSetPoints()}_onSetPoints(){}}t.PointsLayer=e}(OLE||(OLE={})),function(t){let e;!function(t){t.PIECEWISE="piecewise",t.CONTINUOUS="continuous"}(e=t.ColorTableType||(t.ColorTableType={}));class i{constructor(t){const e=t.defaultColor||"rgba(0,0,0,0)";this._default={color:e,rgba:a(e),min:-1/0,max:1/0}}static createPiecewise(t,e){return new s({colors:t,defaultColor:e})}static createContinuous(t,e,i){return new r({colors:t,min:e,max:i})}get default(){return this._default}getCssColor(t){return this._find(t).color}getColorByte(t){return this._find(t).rgba}}t.ColorTable=i;class s extends i{constructor(t){super(t);const e=t.colors,i=n(e.length);e.forEach((t,e)=>{i.fillStyle=t.color,i.fillRect(e,0,1,1)});const s=i.getImageData(0,0,e.length,1).data;this._items=e.map((t,e)=>{const i=4*e;return{min:t.min,max:t.max,color:t.color,rgba:[s[i],s[i+1],s[i+2],s[i+3]]}})}get type(){return e.PIECEWISE}get colors(){return this._items}_find(t){const e=this._items.find(e=>t>=e.min&&t<e.max);return e||this.default}}t.PiecewiseColorTable=s;class r extends i{constructor(t){super(t),this._items=[];const e=4096,i=n(e),{colors:s,min:r,max:a}=t,l=a-r,h=i.createLinearGradient(0,0,e,0);s.forEach((t,e)=>{h.addColorStop(e/s.length,t)}),i.fillStyle=h,i.fillRect(0,0,e,1);const c=i.getImageData(0,0,e,1).data;this._items.length=e;for(let t=0;t<e;++t){const i=4*t,s=[c[i],c[i+1],c[i+2],c[i+3]],n=t/e*l+r,a=(t+1)/e*l+r;this._items[t]={color:o(s),rgba:s,min:n,max:a}}this._min=r,this._max=a}get type(){return e.CONTINUOUS}_find(t){if(t<this._min||t>this._max)return this.default;const e=this._max-this._min,i=this._items.length;let s=(t-this._min)/e*i|0;return s===i&&(s=i-1),this._items[s]}}function n(t){const e=document.createElement("canvas"),i=e.getContext("2d");return e.width=t,e.height=1,i}function o(t){return`rgba(${t[0]}, ${t[1]}, ${t[2]}, ${t[3]/255})`}function a(t){const e=n(1);e.fillStyle=t,e.fillRect(0,0,1,1);const[i,s,r,o]=e.getImageData(0,0,1,1).data;return[i,s,r,o]}t.ContinuousColorTable=r}(OLE||(OLE={})),function(t){class e{constructor(e){this.count=0,this.sum=0,this.values=[],this.extent=t.Extents.clone(e)}get avg(){return this.count?this.sum/this.count:0}add(e,i){if(this.values.push(e),this.count+=1,t.defined(i)){const t=e[i];this.sum+=t}}}t.DensityCell=e;const i=t.ColorTable.createContinuous(["green","blue","red"],0,100);class s extends t.PointsLayer{constructor(t){super(void 0,t),this._density=[1,1],this._lastDensity=[0,0],this._densityCallback=()=>this._density,this._dirty=!0,this._colors=i,this._densityType="count",this._cells=[],this._borderWidth=2,this._borderColor="yellow",this._densityOffset=[0,0]}setDensity(t){this.setDensityXY(t,t)}setDensityXY(t,e){this._density[0]=t,this._density[1]=e,this._dirty=!0}setDensityOffset(t,e){this._densityOffset[0]=t,this._densityOffset[1]=e,this._dirty=!0}setDensityCallback(t){this._densityCallback=t}setValueCallback(t){this._valueCallback=t}setColors(e){this._colors=t.ColorTable.createPiecewise(e),this.update()}setColorTable(t){this._colors=t,super.update()}setBorder(t,e){this._borderWidth=t,this._borderColor=e||"yellow"}getValue(t,e,i){const[s,r]=this._lastDensity,[n,o]=this._densityOffset,a=`${Math.floor((t-n)/s)}-${Math.floor((e-o)/r)}`;return this._cellMap[a]}clear(){super.clear()}_onSetPoints(){this._dirty=!0}_updateCells(t){const[i,s]=t;if(!this._dirty&&i==this._lastDensity[0]&&s==this._lastDensity[1])return;this._dirty=!1,this._lastDensity[0]=i,this._lastDensity[1]=s;const[r,n]=this._densityOffset,o={};this._cells.length=0;const a=this._fieldX,l=this._fieldY;this._points.forEach(t=>{const h=Math.floor((t[a]-r)/i),c=Math.floor((t[l]-n)/s),d=`${h}-${c}`;let u=o[d];u||(u=new e([h*i,c*s,(h+1)*i,(c+1)*s]),o[d]=u,this._cells.push(u)),u.add(t)}),this._cellMap=o}_canvasFunction(e,i,s,r,n){const o=this._memContext;o.clearRect(0,0,r[0],r[1]);let a=this._densityCallback();Array.isArray(a)?this._updateCells(a):this._updateCells([a,a]);const[l,h]=this._lastDensity;let c=!1;this._borderWidth>0&&(o.strokeStyle=this._borderColor,o.lineWidth=this._borderWidth,c=!0);const d=t.Extents.width(e)/r[0],u=t.Extents.height(e)/r[1],_=l/d,f=h/u;const m=this._densityType,g=this._valueCallback||(t=>t[m]);return this._cells.forEach(i=>{if(!t.Extents.isIntersects(e,i.extent))return;const s=g(i),r=this._colors.getCssColor(s);o.fillStyle=r;const n=function(t){return[(t[0]-e[0])/d,(e[3]-t[3])/u,_,f]}(i.extent);o.fillRect(...n),c&&o.strokeRect(...n)}),this._memCanvas}}t.DensityLayer=s}(OLE||(OLE={})),function(t){class e extends t.CustomWmsLayer{constructor(e){super(e),this._isoOnServer=new t.CompIsoOnServer}init(e,i,s){this._isoOnServer=this._isoOnServer||new t.CompIsoOnServer,this._isoOnServer.init(e,i,s).then(t=>{this.refresh()})}export(t,e){return this._isoOnServer.export(t,e)}exportJSON(t,e){return __awaiter(this,void 0,void 0,(function*(){const i=this._isoOnServer.export(t,e,"geojson"),s=yield fetch(i);return yield s.json()}))}_getImage(t,e,i,s,r){return __awaiter(this,void 0,void 0,(function*(){if(!this._isoOnServer)return Promise.resolve(void 0);try{return yield this._isoOnServer.getImage(t,e,i,s,r)}catch(t){throw t}}))}}t.IsoOnServerLayer=e}(OLE||(OLE={})),function(t){class e extends t.CustomWmsLayer{constructor(t){super(t),this.data=t.data,this.server=t.server}_getImage(e,i,s,r,n){return __awaiter(this,void 0,void 0,(function*(){const i=Object.assign({method:"gridline",zmin:0,zmax:100,vmin:0,vmax:100,imageFormat:"base64",returnLine:!0,lineTable:!1,extent:e,width:r[0],height:r[1]},this.data),s=t.toUrlParams(i);return fetch(this.server+"/zs/FeatureGrapha/contourline",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=utf-8;"},body:s}).then(t=>t.json()).then(t=>"data:image/png;base64,"+t.pic)}))}}t.OldIsoOnServerLayer=e}(OLE||(OLE={})),function(t){let e,i;!function(t){t.NONE="none",t.SHAPE="shape",t.ICON="icon",t.CHARACTER="character"}(e=t.PointStyleType||(t.PointStyleType={})),function(t){t.CIRCLE="circle",t.RECT="rect",t.CROSS="cross",t.TRIANGLE="triangle",t.SQUARE="square",t.DIAMOND="diamond",t.PIN="pin",t.ARROW="arrow",t.PLUS="plus",t.MINUS="minus"}(i=t.PointShapeType||(t.PointShapeType={}));const s={type:e.SHAPE,shape:i.CIRCLE,fillColor:"darkblue",lineColor:"black",lineWidth:1,radius:3},r={};class n extends t.PointsLayer{constructor(t){super(void 0,t),this._hiddenRadius=5,this._lastSize=[]}setHiddenRadious(t){this._hiddenRadius=t,this.update()}setStyle(t){this._style=t,this.update()}getValue(t,e,i){if(0==this._points.length)return;const[s,r]=this._lastSize,n=this._lastExtent,o=(n[2]-n[0])/s,a=(n[3]-n[1])/r;if(t<n[0]||t>n[2]||e<n[1]||e>n[3])return;const l=Math.floor((t-n[0])/o),h=Math.floor((n[3]-e)/a),c=this._lastRaster;if(void 0===i){const t=c[l+h*s];if(void 0!==t)return this._points[Math.abs(t)-1]}else{let t,e=Number.MAX_VALUE;const n=i,o=Math.max(l-n,0),a=Math.max(h-n,0),d=Math.min(l+n+1,s),u=Math.min(h+n+1,r);for(let i=a;i<u;++i)for(let r=o;r<d;++r){const n=c[r+i*s];if(void 0===n||n>0)continue;const o=l-r,a=h-i,d=o*o+a*a;d<e&&(t=-n,e=d)}if(void 0!==t)return this._points[t-1]}}_canvasFunction(t,e,i,s,r){const o=Math.round(s[0]),a=Math.round(s[1]),l=t[2]-t[0],h=t[3]-t[1],c=l/o,d=h/a,u=o*a,_=this._lastRaster=new Array(u);this._lastExtent=t.slice(),this._lastSize=[o,a];const f=this._fieldX,m=this._fieldY;return this._points.forEach((e,i)=>{const s=Number.parseFloat(e[f]),r=Number.parseFloat(e[m]);if(s<t[0]||s>t[2]||r<t[1]||r>t[3])return;let l=Math.floor((s-t[0])/c),h=Math.floor((t[3]-r)/d);void 0===_[l+h*o]&&(this._tagPoint(i+1,l,h,_,o,a),n.draw({pd:e,ostyle:this._style,ctx:this._memContext,cx:l,cy:h,redraw:()=>this._source.changed()}))}),this._memCanvas}_onSetPoints(){this.update()}_tagPoint(t,e,i,s,r,n){const o=this._hiddenRadius,a=Math.max(e-o,0),l=Math.max(i-o,0),h=Math.min(e+o+1,r),c=Math.min(i+o+1,n);for(let e=l;e<c;++e)for(let i=a;i<h;++i)void 0===s[i+e*r]&&(s[i+e*r]=t);s[e+i*r]=-t}static draw(i){const{pd:r,ostyle:n,ctx:a,cx:l,cy:h,redraw:c}=i;let d,u,_=n;if("function"==typeof n&&(_=n(r)),_=Object.assign({},s,_),_.type!=e.NONE){switch(a.lineWidth=_.lineWidth,a.fillStyle=_.fillColor,a.strokeStyle=_.lineColor,Array.isArray(_.radius)?(d=_.radius[0],u=_.radius[1]):d=u=_.radius,a.resetTransform(),a.save(),_.rotate&&(a.translate(l,h),a.rotate(_.rotate*Math.PI/180),a.translate(-l,-h)),_.type){case e.SHAPE:o(_.shape,a,l,h,d,u);break;case e.ICON:t.IconCache.initImage(_.icon.url,c),function(e,i,s,r,n,o){const a=t.IconCache.getImage(e.url);if(a){const t=s-n+(e.offsetX||0),l=r-o+(e.offsetY||0);i.drawImage(a,t,l,2*n,2*o)}}(_.icon,a,l,h,d,u);break;case e.CHARACTER:_.character}_.label&&function(t,e,i,s,r,n){let o,a,l,h=t.background();t.textField?o=e[t.textField]:"function"==typeof t.formatter&&(o=t.formatter(e));if(!o)return;t.lineColor&&(l=t.lineColor(e));t.lineWidth&&(a=t.lineWidth(e));const c=t.offsetX||0,d=t.offsetY||0;i.translate(s+c,r+d),n&&!t.enableRotate&&i.rotate(-n*Math.PI/180);t.font&&(i.font=t.font);t.color&&(i.fillStyle=t.color);i.textAlign=t.textAlign||"left",i.textBaseline=t.textBaseline||"middle",h&&!!h.shapeDraw&&function(t,e,i){const s=t.lineWidth,r=t.fillStyle,n=t.strokeStyle,[o,a,l,h]=function(t){let e=[4,8,4,8];"number"==typeof t&&e.fill(t);if(Array.isArray(t)){if(1===t.length&&e.fill(t[0]),2===t.length){const[i,s]=t;e=[i,s,i,s]}4===t.length&&(e=t)}return e}(i.padding),c=t.measureText(e),d=c.actualBoundingBoxLeft,u=c.actualBoundingBoxRight,_=c.actualBoundingBoxAscent,f=c.actualBoundingBoxDescent,m=Math.abs(u+d)+h+a,g=Math.abs(f+_)+o+l;let y=-d-h,p=-_-o;t.lineWidth=i.shapeBorderWidth,t.fillStyle=i.shapeFillColor,t.strokeStyle=i.shapeBorderColor;let w=function(t=0,e=0,i,s,r){let n=i+t,o=s+e;const a=new Path2D,l=Math.PI/2;if(r&&r.radius){const i=Math.min(n,o),s=Math.min(r.radius,i/2);a.moveTo(s+t,e),a.lineTo(n-s,e),a.arc(n-s,s+e,s,3*l,4*l,!1),a.lineTo(n,o-s),a.arc(n-s,o-s,s,0,l,!1),a.lineTo(s+t,o),a.arc(s+t,o-s,s,l,2*l,!1),a.lineTo(t,s+e),a.arc(s+t,e+s,s,2*l,3*l,!1)}else a.moveTo(t,e),a.lineTo(n,e),a.lineTo(n,o),a.lineTo(t,o),a.lineTo(t,e);return a}(y,p,m,g,{radius:i.shapeBorderRadius});t.fill(w),t.stroke(w),t.lineWidth=s,t.fillStyle=r,t.strokeStyle=n}(i,o,h);a&&(i.lineWidth=a,i.strokeStyle=l,i.strokeText(o,0,0));i.fillText(o,0,0)}(_.label,r,a,l,h,_.rotate),a.restore()}}}function o(t,e,i,s,n,o){const a=r[t];if(a){e.beginPath();const t=a(e,i,s,n,o);1&t&&e.fill(),2&t&&e.stroke()}}t.LargePointsLayer=n,r[i.CIRCLE]=function(t,e,i,s,r){return t.arc(e,i,Math.max(s,r),0,2*Math.PI),3},r[i.SQUARE]=function(t,e,i,s,r){const n=Math.max(s,r);return t.rect(e-n,i-n,2*n,2*n),3},r[i.RECT]=function(t,e,i,s,r){return t.rect(e-s,i-r,2*s,2*r),3},r[i.TRIANGLE]=function(t,e,i,s,r){return t.moveTo(e,i-r),t.lineTo(e-.87*s,i+r/2),t.lineTo(e+.87*s,i+r/2),t.closePath(),3},r[i.DIAMOND]=function(t,e,i,s,r){return t.moveTo(e-s,i),t.lineTo(e,i+r),t.lineTo(e+s,i),t.lineTo(e,i-r),t.closePath(),3},r[i.PIN]=function(t,e,i,s,r){return t.moveTo(e,i),t.arc(e,i-1.5*r,s,.75*Math.PI,2.25*Math.PI),t.lineTo(e,i),t.closePath(),3},r[i.ARROW]=function(t,e,i,s,r){return t.moveTo(e,i),t.lineTo(e+s,i+2*r),t.lineTo(e,i+r),t.lineTo(e-s,i+2*r),t.closePath(),3},r[i.CROSS]=function(t,e,i,s,r){return t.moveTo(e-s,i+r),t.lineTo(e+s,i-r),t.moveTo(e-s,i-r),t.lineTo(e+s,i+r),2},r[i.PLUS]=function(t,e,i,s,r){return t.moveTo(e-s,i),t.lineTo(e+s,i),t.moveTo(e,i-r),t.lineTo(e,i+r),2},r[i.MINUS]=function(t,e,i,s,r){return t.moveTo(e-s,i),t.lineTo(e+s,i),2}}(OLE||(OLE={})),function(t){class e extends t.BaseCanvasLayer{constructor(e,i=window){super(e,i),this._opacity=1,this._rasterID=0,this._isoWorkerBusy=!1,this._renderLabel=!1,this._filter=t.FILTER.FILTER_BSPLINE;const s=t.BaseAbstractLayer.getOption(i),r=t.defaultValue(s.mode,"raster");this._renderRaster=-1!=r.indexOf("raster"),-1!=r.indexOf("isolines")?this._renderIsoMode=t.IsoTracerType.ISO_LINES:-1!=r.indexOf("isobands")&&(this._renderIsoMode=t.IsoTracerType.ISO_BANDS),this._renderLabel=!1,t.defined(s.label)&&(this._label=s.label,this._renderLabel=!1!==s.label.enable,this._renderRaster=!0===s.label.enableRaster),this._clip=s.clip,this._showRasterGrid=s.showRasterGrid,this._useWorker="undefined"!=typeof Worker&&t.defaultValues(s.useWorker,s.userWorker),this._delayTime=t.defaultValue(s.delayTime,100),this._memContext2=this._createMemoryCanvas(),this._memCanvas2=this._memContext2.canvas,this._createLayers()}get layer(){return this._folder_layer}get vmin(){return this._data?this._data.minValue:void 0}get vmax(){return this._data?this._data.maxValue:void 0}get valueRange(){return this._data?[this._data.minValue,this._data.maxValue]:[void 0,void 0]}get opacity(){return this._opacity}set opacity(t){this._opacity=t,this._raster_layer&&this._raster_layer.setOpacity(t),this._iso_layer&&this._iso_layer.setOpacity(t)}setData(t,e,i,s){this.setDataOption({data:t,xcells:e,ycells:i,extent:s})}setDataOption(e){const{data:i,xcells:s,ycells:r,extent:n,vmin:o,vmax:a,noDataVal:l}=e;if(i.length!=s*r)throw"bad raster data";this._data=new t.RasterDataset({width:s,height:r,vmin:o,vmax:a,extent:n,data:i,noDataValue:l}),void 0!==e.filter&&(this._filter=e.filter),e.clip&&(this._clip=e.clip),t.defined(e.label)&&(this._label=e.label,this._renderLabel=!1!==e.label.enable,this._renderRaster=!0===e.label.enableRaster),this._visibleExtent=n.slice(),this._raster_layer.setExtent(this._visibleExtent),this._updateColors(),this._syncData(this._rasterWorker),this._syncData(this._isoWorker),this._raster_source.changed()}setVisibleExtent(t){this._visibleExtent=t.slice(),this._raster_layer.setExtent(this._visibleExtent),this._raster_source.changed()}setShowRasterGrid(t){this._showRasterGrid=t,this._raster_source.changed()}setColors(t){if(t&&t.length>0){this._colorItems=t.slice(),this._values=[];const e=document.createElement("CANVAS");e.width=this._colorItems.length,e.height=1;const i=e.getContext("2d");this._colorItems.forEach((t,e)=>{i.fillStyle=t.color,i.fillRect(e,0,1,1),-1==this._values.indexOf(t.min)&&this._values.push(t.min),-1==this._values.indexOf(t.max)&&this._values.push(t.max)});const s=i.getImageData(0,0,e.width,e.height).data;this._colorItems.forEach((t,e)=>{const i=4*e;t.rgba=[s[i],s[i+1],s[i+2],s[i+3]]}),this._values.sort((t,e)=>t-e),this._updateColors(),this._syncColors(this._rasterWorker),this._raster_source.changed()}}clear(){super.clear();const{width:t,height:e}=this._memCanvas;this._memContext2.clearRect(0,0,t,e),this._data=void 0}destroy(){this._isoWorker&&(this._isoWorker.terminate(),this._isoWorker=null),this._rasterWorker&&(this._rasterWorker.terminate(),this._rasterWorker=null),this._folder_layer&&(this._map&&this._map.removeLayer(this._folder_layer),this._folder_layer=void 0,this._raster_layer=void 0,this._raster_source=void 0,this._iso_layer=void 0,this._iso_source=void 0)}_updateColors(){if(!this._data)return;const t=4096;this._colors=new Uint8ClampedArray(4*t);const[e,i]=this.valueRange,s=(i-e)/t;for(let i=0;i<t;++i){let t;const r=s*i+e;if(this._colorItems&&0!=this._colorItems.length){let e=this._colorItems.find(t=>r>=t.min&&r<=t.max);t=e?e.rgba:[0,0,0,0]}else t=[i,i,i,255];const n=4*i;this._colors[n]=t[0],this._colors[n+1]=t[1],this._colors[n+2]=t[2],this._colors[n+3]=t[3]}}getValue(t,e){if(this._data)return this._data.getValue(t,e)}getDisplayValue(t,e){if(this._renderData)return this._renderData.getValue(t,e)}_createLayers(){this._raster_source=this._source,this._raster_layer=this._layer,this._iso_source=new this._win.ol.source.Vector,this._iso_layer=new this._win.ol.layer.Vector({source:this._iso_source}),this._folder_layer=new this._win.ol.layer.Group({layers:[this._raster_layer,this._iso_layer]}),this._map&&this._map.addLayer(this._folder_layer)}_canvasFunction(e,i,s,r,n){if(this._canvasExtent=t.Extents.clone(e,this._canvasExtent),this._canvasResolution=i,this._canvasPixelRatio=s,this._rasterID++,!this._data)return;const o=t.Extents.intersection(e,this._visibleExtent);if(t.Extents.isEmpty(o))return;const a=t.Extents.width(o)/i*s,l=t.Extents.height(o)/i*s,h=()=>{if(this._renderRaster||this._renderLabel)if(this._useWorker)this._traceRasterByWorker(o,[a,l]);else{const t=this._data.subData2(o,[a,l],this._filter);this._renderToCanvas(e,i,s,t),this._delayTime&&this._raster_layer.changed()}if(this._renderIsoMode)if(this._useWorker)this._traceIsoByWorker(o,[a>>1,l>>1]);else{const e=t.IsoTracer.traceByResample(this._renderIsoMode,this._values,this._data,o,[a>>1,l>>1],this._filter);e&&(this._iso_source.clear(!0),this._iso_source.addFeatures((new ol.format.GeoJSON).readFeatures(e)))}};return this._delayTime?(window.clearTimeout(this._delayHandle),this._delayHandle=window.setTimeout(()=>h(),this._delayTime)):h(),this._drawLast(e,r),this._memCanvas}_drawLast(e,i){const s=this._memExtent;if(!s)return;const r=t.Extents.width(e)/i[0],n=t.Extents.height(e)/i[1],o=(s[0]-e[0])/r,a=(e[3]-s[3])/n,l=t.Extents.width(s)/r,h=t.Extents.height(s)/n,c=this._memCanvas2.width,d=this._memCanvas2.height,u=this._memCanvas.width,_=this._memCanvas.height;this._memContext.clearRect(0,0,u,_),this._memContext.drawImage(this._memCanvas2,0,0,c,d,o,a,l,h)}_traceRasterByWorker(e,i){this._rasterWorker||(this._rasterWorker=this._createWorker("resample",e=>{if(e.data&&e.rid==this._rasterID){const i=new t.RasterDataset(e.data.raster);this._renderToCanvas(this._canvasExtent,this._canvasResolution,this._canvasPixelRatio,i,e.data.pixels),this._raster_layer.changed()}}));const s={op:"resample",rid:this._rasterID,extent:e,size:i};this._rasterWorker.postMessage(s)}_traceIsoByWorker(t,e){this._isoWorker&&this._isoWorkerBusy&&(this._isoWorker.terminate(),this._isoWorker=null),this._isoWorker||(this._isoWorker=this._createWorker("iso",t=>{this._isoWorkerBusy=!1,t.data&&(this._iso_source.clear(!0),this._iso_source.addFeatures((new ol.format.GeoJSON).readFeatures(t.data)))}));const i={op:"iso",rid:0,mode:this._renderIsoMode,values:this._values,extent:t,size:e};this._isoWorker.postMessage(i),this._isoWorkerBusy=!0}_createWorker(t,i){const s=e.getBaseUrlFromScript(),r=new Worker(s+"raster-worker.js",{name:"RasterLayerWorker"});return r.addEventListener("message",e=>{e.data.op===t&&i(e.data)}),this._syncData(r),r}_syncData(t){if(!t)return;const e={op:"init",rid:0,raster:this._data.toDataObject(),colors:this._colors,filter:this._filter};t.postMessage(e)}_syncColors(t){if(!t)return;const e={op:"init",rid:0,colors:this._colors,filter:this._filter};t.postMessage(e)}getValueColor(t){const[e,i,s,r]=this.getValueColorByte(t);return`rgba(${e},${i},${s},${r/255})`}getValueColorByte(t){const e=this._colors,i=e.length/4,[s,r]=this.valueRange;if(t<s||t>r)return[0,0,0,0];let n=(t-s)/(r-s)*i|0;return n===i&&(n=i-1),[e[4*n],e[4*n+1],e[4*n+2],e[4*n+3]]}_renderToCanvas(e,i,s,r,n){const o=this._memContext,a=r.width,l=r.height,h=r.minValue,c=r.maxValue,d=r.data,u=r.extent,[_,f,m,g]=e,y=s/i;function p(t){return(t-e[0])*y}function w(t){return(e[3]-t)*y}const x=p(u[0]),b=w(u[3]),E=this._memCanvas.width,v=this._memCanvas.height;if(o.clearRect(0,0,E,v),o.save(),this._clip){const t=new Path2D;this._clip.flat().forEach(e=>{if(0!=e.length){t.moveTo(p(e[0][0]),w(e[0][1]));for(let i=1;i<e.length;++i){const s=e[i];t.lineTo(p(s[0]),w(s[1]))}t.closePath()}}),o.clip(t,"evenodd")}if(this._renderData=r,this._renderRaster){n||(n=r.toPixelData(this._colors));const t=o.createImageData(a,l);if(t.data.set(n),this._clip){const e=document.createElement("canvas");e.width=a,e.height=l,e.getContext("2d").putImageData(t,x,b),o.drawImage(e,0,0)}else o.putImageData(t,x,b)}if(this._renderLabel){const e=this._label,i=e.font_size||18,s=e.font_name||"arial",r=e.color||"white",n=e.padding||[10,10];o.font=`${i}px ${s}`,o.textAlign="center",o.textBaseline="middle",o.fillStyle=r;const u=void 0!==e.fixed?e.fixed:1,_=o.measureText(h.toFixed(u)),f=o.measureText(c.toFixed(u)),m=Math.round(t.defaultValue(e.cellWidth,Math.max(_.width,f.width))+n[0]),g=Math.round(t.defaultValue(e.cellHeight,i)+n[1]),y=m/2,p=g/2,w=a%m/2,E=l%g/2,v=Math.round(y+w),L=Math.round(p+E),T=e.formatter?e.formatter:t=>t.toFixed(u);for(let i=L;i<=l-p;i+=g)for(let s=v;s<=a-y;s+=m){const n=d[s+i*a];if(n<h||n>c)continue;const[u,_,f,w]=this.getValueColorByte(n);if(0===w)continue;"auto"===r&&(o.fillStyle=`rgba(${u}, ${_}, ${f}, ${w/255})`),e.grid&&(o.lineWidth=e.grid.width||1,o.strokeStyle=e.grid.color||"gray",o.strokeRect(x+s-y,b+(l-i-1)-p,m,g));const E=x+s,v=b+(l-i-1),L=T(n);if("string"==typeof L)e.stroke&&e.stroke.width&&(o.lineWidth=e.stroke.width,o.strokeStyle=e.stroke.color||"black",o.strokeText(L,E,v)),o.fillText(L,E,v);else{const e=t.IconCache.initImage(L.url,()=>this.update());if(e){o.save(),L.rotate&&(o.resetTransform(),o.translate(E,v),o.rotate(L.rotate*Math.PI/180),o.translate(-E,-v));const t=L.width||e.width,i=L.height||e.height;o.drawImage(e,E-t/2,v-i/2,t,i),o.restore()}}}}this._showRasterGrid&&this._drawDataGrid(e,i,s),o.restore(),this._memCanvas2.width=E,this._memCanvas2.height=v;this._memContext2.drawImage(this._memCanvas,0,0),this._memExtent=t.Extents.clone(e,this._memExtent)}_drawDataGrid(t,e,i){const[s,r]=t,n=this._memCanvas.height;function o(t,i){return[(t-s)/e,n-(i-r)/e]}e/=i;const a=this._memContext;a.beginPath();const l=this._data.extent,h=this._data.cellWidth,c=this._data.cellHeight;if(h/e>20)for(let e=l[0];e<l[2];e+=h)e<t[0]||e>t[2]||(a.moveTo(...o(e,t[1])),a.lineTo(...o(e,t[3])));if(c/e>20)for(let e=l[1];e<l[3];e+=c){if(e<t[1]||e>t[3])continue;const i=o(t[0],e),s=o(t[2],e);a.moveTo(...i),a.lineTo(...s)}a.strokeStyle="red",a.stroke()}static getBaseUrlFromScript(){for(var t=document.getElementsByTagName("script"),i=0,s=t.length;i<s;++i){var r=t[i].getAttribute("src"),n=e.RasterLayerScriptRegex.exec(r);if(null!==n)return n[1]}}}e.RasterLayerScriptRegex=/((?:.*\/)|^)raster-layer[\w-]*\.js(?:\W|$)/i,t.RasterLayer=e}(OLE||(OLE={})),function(t){class e extends t.BaseAbstractLayer{constructor(t,e){super(t,e),this._option=e,this._olSource=new ol.source.Vector,this._olLayer=new ol.layer.Vector({source:this._olSource}),this._map&&this._map.addLayer(this._olLayer)}get layer(){return this._olLayer}get soruce(){return this._olSource}setData(e){this.clear();const i=this._option,s=new t.StreamLine(i).generate(e),r=new ol.style.Style({stroke:new ol.style.Stroke({color:t.defaultValue(i.lineColor,"green"),width:t.defaultValue(i.lineSize,1),lineDash:i.lineDash})}),n=new ol.style.Style({image:new ol.style.Circle({radius:t.defaultValue(i.headSize,2),fill:new ol.style.Fill({color:t.defaultValue(i.headFillColor,"yellow")}),stroke:new ol.style.Stroke({color:t.defaultValue(i.headStrokeColor,"red"),width:t.defaultValue(i.headStrokeSize,1)})})}),o=[];s.forEach(t=>{const e=[t.line];t.tail&&e.push(t.tail),t.arrows&&e.push(...t.arrows);const i=new ol.Feature(new ol.geom.MultiLineString(e));if(i.setStyle(r),o.push(i),this._option.showHead){const e=new ol.Feature(new ol.geom.Point(t.line[0]));e.setStyle(n),o.push(e)}}),this._olSource.addFeatures(o)}update(){this._olSource.changed()}clear(){this._olSource.clear()}destroy(){this._map&&this._map.removeLayer(this._olLayer)}}t.StreamLineLayer=e}(OLE||(OLE={})),function(t){class e{constructor(e,i){this[0]=0,this[1]=0,this[2]=0,this[3]=0,this.isOriginal=!0,e&&(this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3]),this.isOriginal=t.defaultValue(i,!0)}get values(){return[this[0],this[1],this[2],this[3]]}clone(){return new e(this.values,this.isOriginal)}}const i=[];class s{constructor(){this.id=0,this.rid=0,this.x=0,this.y=0,this.windspeed=0,this.speed=0,this.radii=[],this.isReal=!0,this.isOriginal=!0,this.totalLen=0,this.segmentLen=0,this.extStyle=[]}clone(){const t=new s;return t.x=this.x,t.y=this.y,t.windspeed=this.windspeed,t.speed=this.speed,t.datetime=this.datetime,t.radii=this.radii.map(t=>function(t){return t?t.clone():void 0}(t)),t.data=this.data,t.pre=this.pre,t.isReal=this.isReal,t.isOriginal=this.isOriginal,t}hide(){this.feature.setStyle(i)}showNormal(){this.feature.setStyle([this.pointStyle,this.lineStyle,...this.extStyle])}showCircle(t,...e){const i=[];this.radii.forEach((e,s)=>{t&&!e.isOriginal||i.push(this.circleStyle[s])}),this.feature.setStyle([...i,this.pointStyle,this.lineStyle,...this.extStyle,...e])}}function r(t){let e,i=0;t.forEach(t=>{if(e){const s=function(t,e){const i=111e3*(t.x-e.x),s=111e3*(t.y-e.y);return Math.sqrt(i*i+s*s)}(e,t);t.segmentLen=s,t.totalLen=i+=s,t.pre=e}e=t})}let n;function o(t,e,i){return t+(e-t)*i}function a(t,e,i,s){s||(s=[]);const r=Math.min(t.length,e.length);s.length=r;for(let n=0;n<r;++n)s[n]=o(t[n],e[n],i);return s}!function(t){t.normal="normal",t.GD="广东气象局"}(n||(n={}));const l=[{name:"radius7",fillColor:"rgba(0, 0, 0, 0.2)",lineColor:"#00bab2",lineWidth:1},{name:"radius10",fillColor:"rgba(0, 0, 0, 0.2)",lineColor:"#ffff00",lineWidth:1},{name:"radius12",fillColor:"rgba(0, 0, 0, 0.2)",lineColor:"#da7341",lineWidth:1}],h=t.ColorTable.createPiecewise([{min:10.8,max:17.2,color:"rgb(29,1,245)"},{min:17.2,max:24.6,color:"rgb(253,254,84)"},{min:24.6,max:32.7,color:"rgb(235,164,58)"},{min:32.7,max:41.5,color:"rgb(225,49,35)"},{min:41.5,max:50.1,color:"rgb(148,28,156)"},{min:0,max:9999,color:"rgb(135,251,76)"}]);class c{constructor(t){this._iconReqHandle=0,this._iconCanvass={},this._data=t.data,this._circles=t.circles||l,this._colors=t.colors||h,this._interpDistance=t.interpDistance||1e4,this._interval=t.interval||50,this._labelStyle=t.label||{},this._pointStyle=t.point||{},this._forecastStyle=t.forecast||{},this._singleColorLine=!!t.singleColorLine,this._forecastRadiusType=t.forecastRadiusType||n.GD,this._showForecastCircle=!0,this._init(),this._initTyphoonIcon(t.icon),this._createForecastCircle(),this._createLayer()}get layer(){return this._layer}get source(){return this._source}get overlays(){return[this._iconOverlay]}get current(){return this._currentNode}get colors(){return this._colors}get forecastPolygon(){return this._forecastPolygon}getTyphoonCircle(t){if(t||(t=this.current),t)return this._circles.map((e,i)=>{const s=t.circleStyle[i];return{name:e.name,polygon:s.getGeometry().getCoordinates()}})}play(){this.stop(),this._allShowPoints.forEach(t=>t.hide()),this._currentNode=void 0;const t=()=>{this._forcastPoints.forEach(t=>t.showNormal())};let e=0;const i=(new Date).getTime();let s=0,r=i,n=this._realPointsInterp.length;const o=()=>{this._playHandle=void 0;const a=(new Date).getTime();s+=a-r,r=a;let l=s/this._interval|0;if(l>0){let r=!1;s-=l*this._interval,e+l>=n&&(l=n-e-1,r=!0);const o=this._currentNode;o&&(o.isOriginal?o.showNormal():o.hide());for(let t=0;t<l-1;++t){const i=this._realPointsInterp[e+t];i.isOriginal?i.showNormal():i.hide()}const h=this._realPointsInterp[e+l-1];if(h.showCircle(),this._currentNode=h,e+=l,r)return t(),void console.info("play finished!, cost:",(a-i)/1e3)}this._playHandle=window.requestAnimationFrame(o)};o()}stop(){this._playHandle&&(window.cancelAnimationFrame(this._playHandle),this._playHandle=void 0),this._realPointsInterp.forEach(t=>t.isOriginal?t.showNormal():t.hide()),this._forcastPoints.forEach(t=>t.showNormal()),this.setCurrent(this._realPoints.last())}isPlaying(){return void 0!==this._playHandle}firstForecast(){return this._forcastPoints[0]}setVisible(t){this._layer.setVisible(t),this._iconOverlay.getElement().style.display=t?"block":"none"}getVisible(){return this._layer.getVisible()}setColors(t){this._colors=t,this._updateStyle()}getValue(t,e,i,s){const r=t.getPixelFromCoordinate([e,i]);return this.getValueAtPixel(t,r,s)}getValueAtPixel(t,e,i){const[s,r]=t.getCoordinateFromPixel(e),n=t.getView().getResolution()*(i||5),o=[s-n,r-n,s+n,r+n];if(ol.extent.intersects(this._extent,o))return this._originalPoints.find(t=>ol.extent.containsXY(o,t.x,t.y))}setCurrent(t){t&&(this.current&&this.current.showNormal(),t.showCircle(!this.isPlaying()),this._currentNode=t)}setCurrentByTime(t){let e;e=t instanceof Date?t:new Date(t);const i=this._originalPoints.find(t=>t.datetime.getTime()===e.getTime());i||console.warn("can not find Typhoon point by time: "+e),this.setCurrent(i)}findPoint(t,e){return this._originalPoints.find(t)}destroy(){this.stop(),cancelAnimationFrame(this._iconReqHandle)}_init(){const i=this._extent=ol.extent.createEmpty(),n=new t.DataRowsHelp(this._data.fields,this._data.values,this._data.fieldMap),o=n.values.map((t,r)=>{const o=new s;return o.rid=r,o.x=parseFloat(n.readValue(t,"x")),o.y=parseFloat(n.readValue(t,"y")),o.datetime=new Date(n.readValue(t,"datetime")),o.windspeed=parseFloat(n.readValue(t,"windspeed")),o.speed=parseFloat(n.readValue(t,"speed")),o.forecast=parseFloat(n.readValue(t,"forecast")),o.isReal=!(o.forecast>0),ol.extent.extendCoordinate(i,[o.x,o.y]),this._circles.forEach((i,s)=>{o.radii[s]=function(t){if(!t)return;if(Array.isArray(t)&&4==t.length)return new e(t);const i=t.split(",").map(t=>parseFloat(t));return 4==i.length?new e(i):void 0}(n.readValue(t,i.name))}),o.data=t,o});this._originalPoints=o,this._realPoints=o.filter(t=>t.isReal),this._forcastPoints=o.filter(t=>!t.isReal),this._initForcastOrigin(),r(this._realPoints),r(this._forcastPoints),this._interpCircleRadii(this._realPoints),this._interpCircleRadii(this._forcastPoints),this._realPointsInterp=this._interpTyphoonLine(this._realPoints),this._allShowPoints=this._realPointsInterp.concat(this._forcastPoints),this._allShowPoints.forEach((t,e)=>t.id=e)}_initForcastOrigin(){if(0==this._forcastPoints.length)return;const t=this._forcastPoints[0],e=t.datetime.getTime()-60*t.forecast*60*1e3;let i=this._realPoints.find(t=>t.datetime.getTime()===e);i||(i=this._realPoints.last(),console.warn("无法找到预报其实点，使用最后实际点位代替!")),this._forcastPoints.unshift(i)}_interpCircleRadii(t){this._circles.forEach((i,s)=>{let r=void 0;t.forEach((i,n)=>{if(0==n)return i.radii[s]||(i.radii[s]=new e([0,0,0,0])),void(r=i);if(i.radii[s])return void(r=i);const o=function(t,e,i){for(;i<t.length;++i){const s=t[i];if(s.radii[e])return s}}(t,s,n);if(!o)return i.radii[s]=new e(r.radii[s].values,!1),void(r=i);const l=(i.totalLen-r.totalLen)/(o.totalLen-r.totalLen),h=a(r.radii[s].values,o.radii[s].values,l);i.radii[s]=new e(h,!1)})})}_interpTyphoonLine(t){const e=[t[0]];for(let i=1;i<t.length;++i){const s=this._interp(t[i-1],t[i],this._interpDistance);e.push(...s),e.push(t[i])}return e}_interp(t,i,s){const r=[],n=i.segmentLen,l=Math.round(n/s);for(let s=1;s<l;++s){const n=s/l,h=t.clone();h.isOriginal=!1,h.isReal=i.isReal,h.x=o(t.x,i.x,n),h.y=o(t.y,i.y,n),h.radii=h.radii.map((s,r)=>{const o=a(t.radii[r].values,i.radii[r].values,n);return new e(o,!1)}),h.pre=t,r.push(h)}return r}_createLayer(){const t=this._allShowPoints.map((t,e)=>{const i=new ol.Feature({geometry:new ol.geom.Point([t.x,t.y]),typhoon:t});return t.feature=i,i});this._updateStyle(),this._source=new ol.source.Vector({features:t}),this._layer=new ol.layer.Vector({source:this._source,renderBuffer:5e3,updateWhileAnimating:!0})}_updateStyle(){this._allShowPoints.forEach(t=>{this._typhoonStyle(t)}),t.defaultValue(this._labelStyle.enable,!0)&&(this._realPoints[0].pointStyle.text_=new ol.style.Text({text:this._data.name,offsetX:t.defaultValue(this._labelStyle.offsetX,50),offsetY:t.defaultValue(this._labelStyle.offsetY,0),font:t.defaultValue(this._labelStyle.font,"30px sans-serif"),textBaseline:"middle",fill:new ol.style.Fill(t.defaultValue(this._labelStyle.color))}));const e=this.firstForecast();this._forecastStyleOL&&e.extStyle.push(this._forecastStyleOL),this.stop()}_getTyphoonIcon(t,e){const i=`${e.join()}-${t}`;let s=this._iconCanvass[i];return s||(s=new Promise((i,s)=>{const r=new Image;r.crossOrigin="anonymous",r.onload=()=>{const t=function(t,e){const i=document.createElement("canvas");i.width=t.width,i.height=t.height;const s=i.getContext("2d");s.drawImage(t,0,0);const r=s.getImageData(0,0,t.width,t.height),n=r.data,o=e[0]/255,a=e[1]/255,l=e[2]/255;for(let t=0,e=n.length;t<e;t+=4)n[t]*=o,n[t+1]*=a,n[t+2]*=l;return s.putImageData(r,0,0),i}(r,e);i(t)},r.src=t}),this._iconCanvass[i]=s,s)}_initTyphoonIcon(t){const e=document.createElement("div"),i=this._iconOverlay=new ol.Overlay({element:e,positioning:"center-center",stopEvent:!1});let s=-1,r=void 0,n=0;const o=()=>{this._iconReqHandle=requestAnimationFrame(o);const a=this.current;if(a&&a.id!=s){const n=this._colors.getColorByte(this.current.windspeed),o=n.join();o!=r&&(this._getTyphoonIcon(t,n).then(t=>{e.innerHTML="",e.appendChild(t),e.style.width=t.width+"px",e.style.height=t.height+"px"}),r=o);const{x:l,y:h}=this.current;i.setPosition([l,h]),s=a.id}n=(n+3)%360,e.style.transform=`rotate(${-n}deg)`};o()}_getLineColor(t){return t.isReal?"rgba(0, 0, 0, .6)":"rgba(0, 0, 0, .3)"}_typhoonStyle(e){const i=this._colors.getCssColor(e.windspeed),s=t.defaultValue(this._pointStyle.radius,4),r=e.isReal?s:s-1;e.pointStyle=new ol.style.Style({image:new ol.style.Circle({radius:r,fill:new ol.style.Fill({color:i}),stroke:new ol.style.Stroke({color:t.defaultValue(this._pointStyle.lineColor,"rgba(0, 0, 0, 0.6)"),width:t.defaultValue(this._pointStyle.lineWidth,1),lineDash:this._pointStyle.lineDash})})});const n=this._getLineColor(e),o=e.isReal?[0]:[8],a=e.isReal?2:1;if(e.lineStyle=new ol.style.Style({stroke:new ol.style.Stroke({color:n,width:a,lineDash:o})}),e.pre){const t=[[e.pre.x,e.pre.y],[e.x,e.y]],i=new ol.geom.LineString(t);if(!this._singleColorLine){const t=e.pre.pointStyle.getImage().getFill().getColor();e.lineStyle.getStroke().setColor(t)}e.lineStyle.setGeometry(i)}e.circleStyle=this._circles.map((i,s)=>{const r=this._createCircle(e.x,e.y,e.radii[s]);return new ol.style.Style({geometry:r,stroke:new ol.style.Stroke({color:i.lineColor,width:i.lineWidth,lineDash:t.defaultValue(i.lineDash,o)}),fill:new ol.style.Fill({color:i.fillColor})})}),e.extStyle=[]}_createCircle(t,e,i){const s=[];let[r,n,o,a]=i.values;const l=[r,a,o,n];for(let i=0;i<4;++i){const r=1e3*l[i]/111e3;for(let n=0;n<=90;++n){const o=1*(90*i+n),a=t+r*Math.cos(o*Math.PI/180),l=e+r*Math.sin(o*Math.PI/180);s.push([a,l])}}return new ol.geom.Polygon([s])}_getRaidusByForecast(t){switch(this._forecastRadiusType){case n.GD:return this._getRaidusByForecastGD(t);case n.normal:default:return this._getRaidusByForecastNormal(t)}}_getRaidusByForecastGD(t){return 1e3*c.radiusMap[t]/111e3}_getRaidusByForecastNormal(t){return 1e3*t/111e3}_createForecastCircle(){if(!1===this._showForecastCircle)return;const e=this._forcastPoints.map((t,e)=>[t.x,t.y,this._getRaidusByForecast(t.forecast)]);if(e.length>0){const i=function(e){return function(){const s=e[0];let r=[[s[0],s[1]]],n=[[s[0],s[1]]];const o=e.length;function l(t){return-1===e.findIndex(e=>function(t,e){return a([t[0]-e[0],t[1]-e[1]])}(e,t)<.9*e[2])}let c;for(let t=1;t<o;++t){c=h(e[t-1],e[t],e[t+1]),l(c[0])&&r.push(c[0]),l(c[1])&&n.push(c[1])}n.reverse();const d=e[o-1];let u=i(c[0],c[1],d,8);u.reverse(),u=u.slice(1,u.length-1);const _=[].concat(r,u,n);return t.BSPLine.interp(_,100,2)}();function i(t,e,i,s=100){const n=r(t,i),o=r(e,i);let a=Math.atan2(n[1],n[0]),l=Math.atan2(o[1],o[0]);a<l&&(a+=2*Math.PI);const h=[];for(let t=0;t<=s;++t){const e=l+t/s*(a-l),r=Math.cos(e)*i[2]+i[0],n=Math.sin(e)*i[2]+i[1];h.push([r,n])}return h}function s(t,e){return[t[0]+e[0],t[1]+e[1]]}function r(t,e){return[t[0]-e[0],t[1]-e[1]]}function n(t,e){return[t[0]*e,t[1]*e]}function o(t){const e=a(t);return e>0&&(t[0]=t[0]/e,t[1]=t[1]/e),e}function a(t){const[e,i]=t;return Math.sqrt(e*e+i*i)}function l(t,e){const[i,s]=t;return e?[s,-i]:[-s,i]}function h(t,e,i){if(i){const a=r(e,t),h=r(i,e);o(a),o(h);const c=s(a,h);if(o(c)>1e-7){const t=n(c,e[2]),i=l(t,!1),r=l(t,!0);return[s(i,e),s(r,e)]}}const a=r(e,t);o(a);const h=n(a,e[2]),c=l(h,!1),d=l(h,!0);return[s(c,e),s(d,e)]}}(e);this._forecastPolygon=[i];const s=this._forecastStyle;this._forecastStyleOL=new ol.style.Style({geometry:new ol.geom.Polygon([i]),stroke:new ol.style.Stroke({color:t.defaultValue(s.lineColor,"rgba(0, 0, 0, 0.6)"),width:t.defaultValue(s.lineWidth,1),lineDash:t.defaultValue(s.lineDash,[8])}),fill:new ol.style.Fill({color:t.defaultValue(s.fillColor,"rgba(0, 0, 0, 0.3)")})})}}}function d(t,e){t.getElement().style.display=e?"block":"none"}c.radiusMap={6:60,12:100,18:140,24:160,36:200,48:240,60:300,72:320,96:380,120:460},t.Typhoon=c;class u extends t.BaseAbstractLayer{constructor(e,i){super(e,i),this._typhoons=[],this._warnOverlays=[],i=t.BaseAbstractLayer.getOption(i),this._layer=new ol.layer.Group,this._colors=i.colors||h,this._icon=i.icon||"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACMAAAAjCAYAAAAe2bNZAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAF0WlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxNDUgNzkuMTYzNDk5LCAyMDE4LzA4LzEzLTE2OjQwOjIyICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdEV2dD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlRXZlbnQjIiB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iIHhtbG5zOnBob3Rvc2hvcD0iaHR0cDovL25zLmFkb2JlLmNvbS9waG90b3Nob3AvMS4wLyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ0MgMjAxOSAoV2luZG93cykiIHhtcDpDcmVhdGVEYXRlPSIyMDIxLTA1LTI1VDE5OjA1OjU1KzA4OjAwIiB4bXA6TWV0YWRhdGFEYXRlPSIyMDIxLTA1LTI1VDE5OjA1OjU1KzA4OjAwIiB4bXA6TW9kaWZ5RGF0ZT0iMjAyMS0wNS0yNVQxOTowNTo1NSswODowMCIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDphM2YxOTkzNi1iMzNjLTI4NDItYmQyMS02N2JlZjVmMTkzZTYiIHhtcE1NOkRvY3VtZW50SUQ9ImFkb2JlOmRvY2lkOnBob3Rvc2hvcDoxNThhMjkwMi0xMDc2LTZjNDgtOThlZi0zMzI0YTUzMWFiYzciIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDozYzIxNjk3Mi0wZjhiLTg0NGUtYjFjNC0xOTRjYjQyZDRkMDUiIGRjOmZvcm1hdD0iaW1hZ2UvcG5nIiBwaG90b3Nob3A6Q29sb3JNb2RlPSIzIj4gPHhtcE1NOkhpc3Rvcnk+IDxyZGY6U2VxPiA8cmRmOmxpIHN0RXZ0OmFjdGlvbj0iY3JlYXRlZCIgc3RFdnQ6aW5zdGFuY2VJRD0ieG1wLmlpZDozYzIxNjk3Mi0wZjhiLTg0NGUtYjFjNC0xOTRjYjQyZDRkMDUiIHN0RXZ0OndoZW49IjIwMjEtMDUtMjVUMTk6MDU6NTUrMDg6MDAiIHN0RXZ0OnNvZnR3YXJlQWdlbnQ9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE5IChXaW5kb3dzKSIvPiA8cmRmOmxpIHN0RXZ0OmFjdGlvbj0ic2F2ZWQiIHN0RXZ0Omluc3RhbmNlSUQ9InhtcC5paWQ6YTNmMTk5MzYtYjMzYy0yODQyLWJkMjEtNjdiZWY1ZjE5M2U2IiBzdEV2dDp3aGVuPSIyMDIxLTA1LTI1VDE5OjA1OjU1KzA4OjAwIiBzdEV2dDpzb2Z0d2FyZUFnZW50PSJBZG9iZSBQaG90b3Nob3AgQ0MgMjAxOSAoV2luZG93cykiIHN0RXZ0OmNoYW5nZWQ9Ii8iLz4gPC9yZGY6U2VxPiA8L3htcE1NOkhpc3Rvcnk+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+p15VHgAABdBJREFUWIWdmM1v00gYh3+2mw/HCQkhBLcF0TQSWSo1GxWpB86IU/9VbhGXHrl1QZWihVKqEhYoDVCCs7HjJM7Ee/D7xhPHCV1GGo0te2Yev99jBb/ZfN9XAKh0y+MaAAWAFjNFAPABTOh+CgCKoghaD2u/AcEbqbT5Gm2uAkhI16o0bQrAk8YxjfB9fwak/CYEb5qm65TUtQgQA3gARgCGAFwaJ9SnAMS1JEMgsiTSAHQAGeopAAaNSQLktQVJYkD9X4RqZCBAmrAMgu2CpZGmzbMAcjTeoOsMAaYlCSm0GUP06BlDCno+XgkTAUlT582LAAoAbtL1Deo6dVYjf30fwE8A3xEY8UjqQ9pjpZqiIHnavATgNoAyjbdYOq7rGpeXl2XLsvTRaDQzYN/3rwqFwlmxWLxhmmafpMPAGsiYY2EkG2HV5GnTOwBMAJs0llzXvX1ycnL//Py81O12M3HrGYZR2t7eRrFY7GDe++baAoykHgbJkkQY4i6Au57nbb58+fLB69evN4UQsV5ZLBYHjx49+rS9vX0J4BMCu5kgsBUPod3EwyBUT1ICKQPYAHAPwJZlWZXDw8PdZZIAgEql8uPJkycfVFVl0DEC+xgCcBDGGh8UAOdgJKloCPSaRWCgdwCsA9i0LKvSbDb/dBwnvQxE0zQ/AsKxpQ/ARmi4HiTXjupNlkoGga0UEahow3XdrV+BAIAQQnn+/HnVdV3Zo1zqDDKCpKI4GCCUio7AS0oIjLf84sWLnV+BcLu4uCg8e/asRkBTzMcUthsBYMrpIGozsooMBMGsAOD2+/fvH7Tb7VszYk3z6/W6XavVUtlsNmHbtnd6ejpqtVpZNmjHcdInJyc39/b22I2n1LnNQFZJJonQk/IAcq9evbongxwcHAz39/dz+Xw+qWmaks/nk/v7+7mDg4Ohpmk+v3t+fl5CGE8SS/aMhWGX5uSnA8hYlrUue069XrdN09TjFjRNU9/d3bX5vtvtZjzPS9MHyjFmocxYRrmGMNklB4NBSn5Yq9VSsbOoPXz4cO654zhGDMzC/nGSid4vfEE2m02sgjEMY+XzZS26ORuXkO5FJpMZyS/Ztu2tWtRxnLnnqVRqjMCLeF22KdmYl8L4CAPSuFAo9BOJxMzqT09PR1jR3r59O3tuGMZQ1/U+wgjMUCI6T86sHC25VoU0aVIul/v8bqvVynY6HTcOpNPpuK1WK8v31Wr1CkH4dxCmA678FmGkNLA0o+7s7HzlayGE0mw200dHR/1erzcWQvi9Xm98dHTUbzabaY4ziURCNBqNNoJa5ieCVDBAGH3n1MRBj9MAe5Fc12oAsLW1ZRuGMeQILIRQjo+Pc8fHx7xWkvqsNRqNC13XOwB+IKjy+gTCCXJeMpHahSEyCCLwrJRUVVV5/PjxP9EFlrVKpfJjb2/vbwBfEVR4DDRAWPsuNWCu9rm0LCCIvsZ0Os0BwPr6+vC6IE+fPv0LwGcAlwTURaAmF2FOmpPOmjTKUskhLLQNVVUVy7K8w8PDP1ZBkI1ckEQ+A7gA8AXANwAWwbABLzSG4VNgCmHNmwaQbLfb5bOzs/sfP34sLqvoDMMYVqvVq0aj0dZ1/SuADknkC43fEapogkiClGHk0Dzrb968qb97927Ptu3N8XicUFV1qqoqksmkl0qlpvl83i2VSo5pmt2NjY0rBCUlnwC+IVDNN7pnT+LyIbYpZMBcMtxEUNVtUDcR1DJ5BOpjj5uQqDlu9OnLewiNtYtANT3MqydWKvJZ20dYJDu0CCe7IS2YRHhcFQgrNj4psutatDlDDBDWu7Eg3BiGv3SA8DwjaPEcwnMOg08IZoLAOxjIka4XztOrQGQYBhrR10zpa3oIDHkNYUCLHktZXZx7OKjNpAGEvz5WwiiKInzfZxjejKXEEPzfhSXDfxYYypPmyX8WrgXBbeaqS/67AIuV2Vx5gV/8BLpu831/8f+MBMVgq1q0uF7IN/8H5j8WA47HPVAEQwAAAABJRU5ErkJggg==",t.defaultValue(i.showAlertLine,!0)&&this._initWarnLine(),this._layer.on("change:visible",()=>{this.udpateIconVisible()})}get layer(){return this._layer}get soruce(){throw new Error("Method not implemented.")}get typhoons(){return this._typhoons}setVisible(t){this._layer.setVisible(t),this._warnOverlays.forEach(e=>d(e,t))}udpateIconVisible(...t){const e=t;e.push(this._layer.getVisible()),this._typhoons.forEach(t=>{e.push(t.getVisible()),t.overlays.forEach(t=>{d(t,-1==e.indexOf(!1))}),e.pop()}),e.pop()}update(){this._layer.changed()}destroy(){this.disableClick(),this.clear(),this._warnOverlays.forEach(t=>this._map.removeOverlay(t)),this._warnOverlays.length=0}play(){this._typhoons.forEach(t=>t.play())}stop(){this._typhoons.forEach(t=>t.stop())}setColors(t){this._colors=t,this._typhoons.forEach(e=>e.setColors(t))}getColors(){return this._colors}addTyphoon(e){const i=Object.assign({colors:this._colors,icon:this._icon},e),s=new t.Typhoon(i);this._layer.getLayers().push(s.layer),this._typhoons.push(s),s.overlays.forEach(t=>this._map.addOverlay(t)),s.play()}removeTyphoon(t){const e=this._typhoons[t];e&&(e.overlays.forEach(t=>this._map.removeOverlay(t)),this._layer.getLayers().remove(e.layer),this._typhoons.splice(t,1),e.destroy())}clear(){this._typhoons.forEach(t=>{this._layer.getLayers().remove(t.layer),t.overlays.forEach(t=>this._map.removeOverlay(t)),t.destroy()}),this._typhoons.length=0}enableClick(){this.disableClick(),this._clickEventKey=this._map.on("click",t=>{for(let e=this._typhoons.length-1;e>=0;--e){const i=this._typhoons[e],s=i.getValueAtPixel(this._map,t.pixel,5);s&&i.setCurrent(s)}})}disableClick(){this._clickEventKey&&(ol.Observable.unByKey(this._clickEventKey),this._clickEventKey=void 0)}getValue(t,e,i){for(let s=this._typhoons.length-1;s>=0;--s){const r=this._typhoons[s],n=r.getValue(this._map,t,e,i);if(n)return{typhoon:r,point:n}}}_initWarnLine(){const t=[{name:"24小时警戒线",color:"red",weight:1.4,dashArray:[0,0],points:[[105,0],[113,4.5],[119,11],[119,18],[127,22],[127,34]]},{name:"48小时警戒线",color:"blue",weight:1.4,dashArray:[10,5],points:[[105,0],[120,0],[132,15],[132,34]]}],e=t.map(t=>{const e=new ol.Feature({geometry:new ol.geom.LineString(t.points)});return e.setStyle(new ol.style.Style({stroke:new ol.style.Stroke({color:t.color,width:t.weight,lineDash:t.dashArray})})),e});t.forEach(t=>{const e=document.createElement("div");e.innerText=t.name,e.style.color=t.color,e.style.font="600 12px/1.5 Helvetica Neue,Arial,Helvetica,sans-serif",e.style.width="12px",e.style.paddingLeft="3px";const i=new ol.Overlay({element:e,position:t.points.last(),positioning:"top-left",stopEvent:!1});this._map.addOverlay(i),this._warnOverlays.push(i)});const i=new ol.layer.Vector({source:new ol.source.Vector({features:e})});this._layer.getLayers().push(i)}}t.TyphoonLayer=u}(OLE||(OLE={})),function(t){class e{constructor(t,e){this.x=0,this.y=0,this.x=t,this.y=e}}function i(...t){let i=0,s=0;return t.forEach(t=>{i+=t.x,s+=t.y}),new e(i,s)}function s(t,e,i){t.moveTo(e.x,e.y),t.lineTo(i.x,i.y)}function r(e){if(t.defined(e.min)&&t.defined(e.max))return;const[i,s]=t.calcLimit(e.data);e.min=i,e.max=s}t.PointF=e,t.addPoint=i;class n extends t.BaseCanvasLayer{constructor(t,e=window){super(t,e),this._arrowSize=32,this._arrowColor="blue",this._drawExtent=[]}get arrowSize(){return this._arrowSize}set arrowSize(t){this._arrowSize=t,this._source.changed()}get arrowColor(){return this._arrowColor}set arrowColor(t){this._arrowColor=t,this._source.changed()}setDataOption(e){const i=e.datau,s=e.datav,n=e.xcells*e.ycells;if(i.data.length!=n||s.data.length!=n)throw new Error("bad raster data");this._datau=i,this._datav=s,this._dataExtent=e.extent,this._xcells=e.xcells,this._ycells=e.ycells,this._cellWidth=t.Extents.width(this._dataExtent)/this._xcells,this._cellHeight=t.Extents.height(this._dataExtent)/this._ycells,r(i),r(s),this._source.changed()}setData(t,e,i,s,r){this.setDataOption({datau:{data:t},datav:{data:e},xcells:i,ycells:s,extent:r})}clear(){super.clear(),this._datau=this._datav=void 0}getValue(t,e){if(!this._datau)return;const i=Math.floor((t-this._dataExtent[0])/this._cellWidth),s=Math.floor((e-this._dataExtent[1])/this._cellHeight);if(i<0||i>=this._xcells||s<0||s>=this._ycells)return;const r=i+s*this._xcells;return[this._datau[r],this._datav[r]]}_canvasFunction(e,i,s,r,n){if(!this._datau||!this._datav)return;const o=t.Extents.intersection(e,this._dataExtent,this._drawExtent);if(t.Extents.isEmpty(o))return;const[a,l]=r,h=(e[2]-e[0])/a,c=(e[3]-e[1])/l,d=this._dataExtent,u=this._cellWidth,_=this._cellHeight,f=this._xcells,m=this._ycells,g=this._datau,y=this._datav;function p(t,e){let i=t.data[e];return i===t.noData||i<t.min||i>t.max?0:i}const w=this._arrowSize*i,x=Math.floor((o[0]-d[0])/w),b=Math.floor((o[1]-d[1])/w),E=Math.ceil((o[2]-d[0])/w),v=Math.ceil((o[3]-d[1])/w),L=this._memContext;L.resetTransform(),L.clearRect(0,0,a,l),L.lineWidth=1,L.strokeStyle=this._arrowColor,L.fillStyle=this._arrowColor;for(let t=b;t<v;++t)for(let i=x;i<E;++i){const s=Math.floor(i*w/u),r=Math.floor(t*w/_);if(s<0||s>=f||r<0||r>=m)continue;const n=s+r*f,o=p(g,n),a=p(y,n),x=(i*w+d[0]-e[0])/h,b=l-(t*w+d[1]-e[1])/c-1;this.drawWindUV(x,b,o,a)}return this._memCanvas}drawWindUV(t,e,i,s){let r=Math.sqrt(i*i+s*s);const n=Math.atan2(s,i)/3.14159265*180;if(r>100)r=100;else if(r<1e-6)return;return this.drawWind(t,e,r,n)}drawWind(t,r,n,o){o=-o-90;let a=this._arrowSize,l=this._arrowSize;const h=this._memContext;h.resetTransform(),h.translate(t,r),h.rotate(o*Math.PI/180),h.translate(.5*-a,.5*-l);let c=new e(.5*a,.1*l*2),d=new e(.5*a,.9*l),u=new e(.2*a*.5,.1*-l*.5),_=new e(.2*a,.1*-l),f=new e(0,.08*l);for(h.beginPath(),s(h,c,d);n>=20;)s(h,c,i(c,_)),s(h,i(c,f),i(c,_)),c=i(c,f,f),n-=20;const m=Math.floor(n/4);for(let t=0;t<m;++t)s(h,c,i(c,_)),c=i(c,f);return n%4!=0&&s(h,c,i(c,u)),h.stroke(),1}}t.WindArrowLayer=n}(OLE||(OLE={})),function(t){class e{constructor(t){t=t||{},this._width=t.width||0,this._height=t.height||0,this._bands=t.bands||1;const e=this._width*this._height*this._bands;t.data&&t.data.length==e?t.data instanceof Float32Array||t.data instanceof Float64Array?this._data=t.data:this._data=new Float32Array(t.data):this._data=new Float32Array(e)}static create(t,i,s,r){return new e({width:t,height:i,bands:s,data:r})}get width(){return this._width}get height(){return this._height}get bands(){return this._bands}get data(){return this._data}isEmpty(){return 0===this._width&&0===this._height}subData(t){const i=this.subDataInner(t);return e.create(t.width,t.height,this.bands,i)}subDataInner(t){if(function(t,e,s){const r="invaild clip";i(s.x,0,t-1,r),i(s.y,0,e-1,r),i(s.width,1,t-s.x,r),i(s.height,1,e-s.y,r)}(this.width,this.height,t),t.width==this.width&&t.height==this.height)return this._data.slice();const e=new Float32Array(t.width*t.height*this.bands),s=this.bands;for(let i=0;i<s;++i)for(let r=0;r<t.height;++r){const n=r*t.width,o=(r+t.y)*this.width;for(let r=0;r<t.width;++r){const a=o+(r+t.x)*s+i;e[n+r*s+i]=this.data[a]}}return e}}function i(t,e,i,s){if(t<e||t>i){if(s)throw new Error(s);return!1}return!0}t.Bitmap=e}(OLE||(OLE={})),function(t){class e extends t.Bitmap{constructor(e){if(super(e),e)if(this._extent=e.extent.slice(),this._geoWidth=t.Extents.width(this._extent),this._geoHeight=t.Extents.height(this._extent),this._cellWidth=this._geoWidth/this.width,this._cellHeight=this._geoHeight/this.height,this._noDataValue=e.noDataValue,t.defined(e.vmin)&&t.defined(e.vmax))this._minValue=e.vmin,this._maxValue=e.vmax;else{let t=Number.POSITIVE_INFINITY,e=Number.NEGATIVE_INFINITY;const i=this.data,s=i.length;for(let r=0;r<s;++r){const s=i[r];s<t&&(t=s),s>e&&(e=s)}this._minValue=t,this._maxValue=e}else this._extent=t.Extents.createEmpty(),this._cellWidth=0,this._cellHeight=0,this._geoWidth=0,this._geoHeight=0}get extent(){return this._extent.slice()}get cellWidth(){return this._cellWidth}get cellHeight(){return this._cellHeight}get geoWidth(){return this._geoWidth}get geoHeight(){return this._geoHeight}get noDataValue(){return this._noDataValue}get minValue(){return this._minValue}get maxValue(){return this._maxValue}getValue(t,e){if(!this._data)return;const i=Math.floor((t-this._extent[0])/this._cellWidth),s=Math.floor((e-this._extent[1])/this._cellHeight);return i<0||i>=this._width||s<0||s>=this._height?void 0:this._data[i+s*this._width]}subData(t){const i=super.subDataInner(t),s=t.x*this._cellWidth+this._extent[0],r=t.y*this._cellHeight+this._extent[1],n=s+t.width*this._cellWidth,o=r+t.height*this._cellHeight;return new e({width:t.width,height:t.height,extent:[s,r,n,o],bands:this.bands,data:i,vmin:this._minValue,vmax:this._maxValue,noDataValue:this._noDataValue})}subData2(i,s,r){const n=t.Extents.width(i),o=t.Extents.height(i),a=n/s[0],l=o/s[1],h=t.Extents.intersection(this._extent,i);if(t.Extents.isEmpty(h))return null;let c=this,d=this._extent,u=this._geoWidth,_=this._geoHeight;const f=t.Extents.width(h),m=t.Extents.height(h);if(f<this._geoWidth/2||m<this._geoHeight/2){const e=3,i=t.Extents.bufferXY(h,this._cellWidth*e,this._cellHeight*e),s=this.toPixelCoord(i);t.Extents.intersection(s,[0,0,this.width,this.height],s),d=this.toGeoCoord(s),u=t.Extents.width(d),_=t.Extents.height(d),c=super.subData({x:s[0],y:s[1],width:t.Extents.width(s),height:t.Extents.height(s)})}const g=Math.ceil(u/a),y=Math.ceil(_/l),p=u/g,w=_/y,x=Math.round((h[0]-d[0])/p),b=Math.round((h[1]-d[1])/w),E=Math.round((h[2]-d[0])/p),v=Math.round((h[3]-d[1])/w),L=t.doRescale(c,g,y,r,this._noDataValue,{x:x,y:b,width:E-x,height:v-b});return new e({width:L.width,height:L.height,extent:h,bands:this.bands,data:L.data,vmin:this._minValue,vmax:this._maxValue,noDataValue:this._noDataValue})}toPixelCoord(t){return[Math.floor((t[0]-this._extent[0])/this._cellWidth),Math.floor((t[1]-this._extent[1])/this._cellHeight),Math.ceil((t[2]-this._extent[0])/this._cellWidth),Math.ceil((t[3]-this._extent[1])/this._cellHeight)]}toGeoCoord(t){return[t[0]*this._cellWidth+this._extent[0],t[1]*this._cellHeight+this._extent[1],t[2]*this._cellWidth+this._extent[0],t[3]*this._cellHeight+this._extent[1]]}toDataObject(){return{data:this._data,width:this._width,height:this._height,bands:this._bands,extent:this._extent,vmin:this._minValue,vmax:this._maxValue,noDataValue:this._noDataValue}}toPixelData(t){const{width:e,height:i,minValue:s,maxValue:r}=this,n=r-s,o=this.width*this.height,a=t.length/4|0,l=this._data,h=new Uint8ClampedArray(4*o);for(let r=0;r<i;++r)for(let o=0;o<e;++o){const c=4*(o+(i-r-1)*e),d=l[o+r*e];if(d==this.noDataValue)h[c]=0,h[c+1]=0,h[c+2]=0,h[c+3]=0;else{let e=(d-s)/n*a|0;e<0?e=0:e>=a&&(e=a-1);const i=4*e;h[c]=t[i+0],h[c+1]=t[i+1],h[c+2]=t[i+2],h[c+3]=t[i+3]}}return h}}t.RasterDataset=e}(OLE||(OLE={})),function(t){function e(t,e,i,s){if(t<e||t>i){if(s)throw new Error(s);return!1}return!0}function i(t,i,s){const r="invaild clip";e(s.x,0,t-1,r),e(s.y,0,i-1,r),e(s.width,1,t-s.x,r),e(s.height,1,i-s.y,r)}class s{constructor(t){this.m_pFilter=t}scale(e,s,r,n){s=Math.floor(s),r=Math.floor(r);const o=e.width,a=e.height;if(n?i(s,r,n):n={x:0,y:0,width:s,height:r},o==s&&a==r)return e.subData(n);const l=t.Bitmap.create(n.width,n.height,e.bands),h=n.x,c=n.x+n.width,d=n.y,u=n.y+n.height;if(s<=o){let i=null;o!==s?(i=a!==r?t.Bitmap.create(n.width,a,e.bands):l,this.horizontalFilter(e,i,s,h,c)):i=e,a!==r&&this.verticalFilter(i,l,r,d,u)}else{let i=null;a!=r?(i=o!=s?t.Bitmap.create(o,n.height,e.bands):l,this.verticalFilter(e,i,r,d,u)):i=e,o!=s&&this.horizontalFilter(i,l,s,h,c)}return l}horizontalFilter(e,i,s,r,n){const o=new t.CWeightsTable(this.m_pFilter,s,e.width,r,n).m_WeightTable,a=e.data,l=i.data,h=e.bands;for(let t=0;t<h;++t)for(let s=0;s<e.height;s++){const r=e.width*s;let n=i.width*s;for(let e=0;e<i.width;e++){const i=o[e],s=i.Weights,c=i.Left,d=i.Right;let u=0;for(let e=c;e<d;++e){u+=s[e-c]*a[r+(e*h+t)]}l[n+t]=u,n+=h}}}verticalFilter(e,i,s,r,n){const o=new t.CWeightsTable(this.m_pFilter,s,e.height,r,n).m_WeightTable,a=e.data,l=i.data,h=e.bands,c=i.width*i.bands,d=e.width*e.bands;for(let t=0;t<h;++t)for(let s=0;s<e.width;++s){const e=s*h;let r=e;for(let s=0;s<i.height;++s){const i=o[s],n=i.Weights,h=i.Left,u=i.Right;let _=h*d+e,f=0;for(let e=h;e<u;++e){f+=n[e-h]*a[_+t],_+=d}l[r+t]=f,r+=c}}}}let r;function n(e){let i=null;switch(e){case r.FILTER_BOX:i=new t.CBoxFilter;break;case r.FILTER_BICUBIC:i=new t.CBicubicFilter;break;case r.FILTER_BILINEAR:i=new t.CBilinearFilter;break;case r.FILTER_BSPLINE:i=new t.CBSplineFilter;break;case r.FILTER_CATMULLROM:i=new t.CCatmullRomFilter;break;case r.FILTER_LANCZOS3:i=new t.CLanczos3Filter}return i}!function(t){t[t.FILTER_BOX=0]="FILTER_BOX",t[t.FILTER_BICUBIC=1]="FILTER_BICUBIC",t[t.FILTER_BILINEAR=2]="FILTER_BILINEAR",t[t.FILTER_BSPLINE=3]="FILTER_BSPLINE",t[t.FILTER_CATMULLROM=4]="FILTER_CATMULLROM",t[t.FILTER_LANCZOS3=5]="FILTER_LANCZOS3"}(r=t.FILTER||(t.FILTER={})),t.createFilter=n,t.doRescale=function(e,i,r,o,a,l){let h=n(o);if(!h)return null;e instanceof t.Bitmap||(e=new t.Bitmap(e));const c=l?l.width:i,d=l?l.height:r;console.info(`scale start, ${e.width}*${e.height} => ${c}*${d}`);const u=new Date,_=new s(h),f=_.scale(e,i,r,l);if(null!=a){const s=e.data.slice();s.forEach((t,e)=>{s[e]=t===a?0:1});const n=t.Bitmap.create(e.width,e.height,e.bands,s),o=_.scale(n,i,r,l).data,h=f.data;o.forEach((t,e)=>{t<.95&&(h[e]=a)})}const m=new Date;return console.info("scale finish, cost: "+(m.getTime()-u.getTime())),f}}(OLE||(OLE={})),function(t){t.CWeightsTable=class{constructor(t,e,i,s,r){let n,o;const a=t.GetWidth();void 0===s&&(s=0),void 0===r&&(r=e);const l=r-s,h=e/i;h<1?(n=a/h,o=h):(n=a,o=1);const c=2*Math.ceil(n)+1,d=l,u=new Float64Array(d*c);this.m_WeightTable=[];const _=c*Float64Array.BYTES_PER_ELEMENT;for(let t=0;t<d;t++){const e=t*_,i=new Float64Array(u.buffer,e,c);this.m_WeightTable[t]={Weights:i,Left:0,Right:0}}const f=.5/h;for(let e=0;e<d;e++){const r=this.m_WeightTable[e],a=r.Weights,l=(e+s)/h+f,c=Math.max(0,Math.floor(l-n+.5)),d=Math.min(Math.floor(l+n+.5),i);r.Left=c,r.Right=d;let u=0;for(let e=c;e<d;e++){const i=o*t.Filter(o*(e+.5-l));a[e-c]=i,u+=i}if(u>0&&1!=u)for(let t=c;t<d;t++)a[t-c]/=u;let _=d-c-1;for(;0==a[_]&&(r.Right--,_--,r.Right!=r.Left););}}get(t){return this.m_WeightTable[t]}getWeight(t,e){return this.m_WeightTable[t].Weights[e]}getLeftBoundary(t){return this.m_WeightTable[t].Left}getRightBoundary(t){return this.m_WeightTable[t].Right}}}(OLE||(OLE={})),function(t){class e{constructor(t){this.m_dWidth=t}GetWidth(){return this.m_dWidth}SetWidth(t){this.m_dWidth=t}}t.CGenericFilter=e;t.CBoxFilter=class extends e{constructor(){super(.5)}Filter(t){return Math.abs(t)<=this.m_dWidth?1:0}};t.CBilinearFilter=class extends e{constructor(){super(1)}Filter(t){return(t=Math.abs(t))<this.m_dWidth?this.m_dWidth-t:0}};t.CBicubicFilter=class extends e{constructor(t=1/3,e=1/3){super(2),this.p0=(6-2*t)/6,this.p2=(12*t-18+6*e)/6,this.p3=(12-9*t-6*e)/6,this.q0=(8*t+24*e)/6,this.q1=(-12*t-48*e)/6,this.q2=(6*t+30*e)/6,this.q3=(-t-6*e)/6}Filter(t){return(t=Math.abs(t))<1?this.p0+t*t*(this.p2+t*this.p3):t<2?this.q0+t*(this.q1+t*(this.q2+t*this.q3)):0}};t.CCatmullRomFilter=class extends e{constructor(){super(2)}Filter(t){return t<-2?0:t<-1?.5*(4+t*(8+t*(5+t))):t<0?.5*(2+t*t*(-5-3*t)):t<1?.5*(2+t*t*(3*t-5)):t<2?.5*(4+t*(t*(5-t)-8)):0}};t.CLanczos3Filter=class extends e{constructor(){super(3)}Filter(t){return(t=Math.abs(t))<this.m_dWidth?this.sinc(t)*this.sinc(t/this.m_dWidth):0}sinc(t){return 0!=t?(t*=3.141592653589793,Math.sin(t)/t):1}};t.CBSplineFilter=class extends e{constructor(){super(2)}Filter(t){if((t=Math.abs(t))<1)return(4+t*t*(3*t-6))/6;if(t<2){let e=2-t;return e*e*e/6}return 0}};t.CBlackmanFilter=class extends e{constructor(t=.5){super(t)}Filter(t){if(Math.abs(t)>this.m_dWidth)return 0;return t/=2*this.m_dWidth+1-1,.42+.5*Math.cos(6.283185307179586*t)+.08*Math.cos(12.566370614359172*t)}}}(OLE||(OLE={})),function(t){let e,i,s;function r(t){return t===s.POSITIVE?1:-1}!function(t){t.LEFT="left",t.RIGHT="right",t.CENTER="center"}(e=t.DockedLocateX||(t.DockedLocateX={})),function(t){t.TOP="top",t.BOTTOM="bottom",t.CENTER="center"}(i=t.DockedLocateY||(t.DockedLocateY={})),function(t){t.POSITIVE="positive",t.NEGATIVE="negative"}(s=t.DockedDir||(t.DockedDir={}));t.DockedBar=class{constructor(t){this.dockx=e.LEFT,this.docky=i.TOP,this.dockxdir=s.POSITIVE,this.dockydir=s.POSITIVE,this.offsetx=0,this.offsety=0,this.width=0,this.height=0,Object.assign(this,t)}getRange(s){const[n,o,a,l]=s,[h,c]=t.Extents.center(s),d=r(this.dockxdir),u=r(this.dockydir);let _=0,f=0;switch(this.dockx){case e.LEFT:_=n;break;case e.RIGHT:_=a;break;case e.CENTER:_=h}switch(this.docky){case i.TOP:f=o;break;case i.BOTTOM:f=l;break;case i.CENTER:f=c}let m=_+this.offsetx*d,g=f+this.offsety*u,y=m+this.width*d,p=g+this.height*u;if(m>y){const t=m;m=y,y=t}if(g>p){const t=g;g=p,p=t}return[m,g,y,p]}}}(OLE||(OLE={})),function(t){const e={font:"14px sans-serif",color:"black"},i={font:"20px 黑体",color:"black"},s={font:"12px 黑体",color:"#7f7f7f"},r={color:"#2c7ccc",width:4},n={color:"#2c7ccc",width:2},o={color:"#2c7ccc",width:1};let a,l;!function(t){t[t.TT_TITLE=0]="TT_TITLE",t[t.TT_LEFT=1]="TT_LEFT",t[t.TT_RIGHT=2]="TT_RIGHT",t[t.TT_TOP=3]="TT_TOP",t[t.TT_BOTTOM=4]="TT_BOTTOM"}(a||(a={})),function(t){t[t.LT_FRAME=0]="LT_FRAME",t[t.LT_BORDER=1]="LT_BORDER",t[t.LT_GRID=2]="LT_GRID"}(l||(l={}));class h{constructor(e,i){this._option={range:[],xgap:2,ygap:2,hasFrame:!0,hasGrid:!0,hasMask:!0,fixedNum:0,bkColor:"white",scaleBar:{docked:{dockx:t.DockedLocateX.LEFT,docky:t.DockedLocateY.BOTTOM,offsetx:0,offsety:20,width:100,height:10},minWidth:64,units:"metric",labelStyle:{font:"12px 黑体"},lineStyle:{width:3,color:"black"}},legendBar:{docked:{dockx:t.DockedLocateX.RIGHT,offsetx:20,offsety:0},dir:"vertical",items:[],cols:1,cellWidth:100,cellHeight:40,iconWidth:32,iconHeigth:32,title:"图例",titleStyle:{font:"30px 黑体",color:"black"},lineStyle:{width:1,color:"black"},labelStyle:{color:"black",font:"14px 黑体"}},infoTable:{docked:{offsetx:20,dockx:t.DockedLocateX.RIGHT,docky:t.DockedLocateY.BOTTOM,dockydir:t.DockedDir.NEGATIVE},labelStyle:{font:"12px 黑体",color:"black"},lineStyle:{width:1,color:"black"},cellWidth:60,cellHeight:24,rows:[]}},this._frame=[],this._lines=[],this._labels=[],this._map=e,t.deepAssign(this._option,i),this._scaleBar=new t.DockedBar(this._option.scaleBar.docked),this._legendBar=new t.DockedBar(this._option.legendBar.docked),this._infoBar=new t.DockedBar(this._option.infoTable.docked),this._createCanvas(),this._createGrid(),this._initLegends(),this._eventKey=e.on(ol.render.EventType.POSTCOMPOSE,this._handlePostCompose,this),e.render()}_createCanvas(){this._canvas=document.createElement("CANVAS"),this._context=this._canvas.getContext("2d")}static toOneNumber(t){t<0&&(t=-t);let e=1;for(;t<1;)t*=10,e/=10;for(;t>10;)t/=10,e*=10;return Math.floor(t)*e}static calcDefaultGaps(e){const i=t.Extents.width(e),s=t.Extents.height(e),r=Math.max(i,s);let n=this.toOneNumber(r);return{defgap:n/10,mingap:n/20}}_createGrid(){const e=this._option;let{xgap:i,ygap:s}=e;const{range:r,hasFrame:n,hasGrid:o,fixedNum:c}=e,[d,u,_,f]=r,m=t.Extents.width(r),g=t.Extents.height(r),y=h.calcDefaultGaps(r);i=Math.max(i,y.mingap),s=Math.max(s,y.mingap);const p=.2*i,w=.2*s,x=Math.ceil((d+p)/i),b=Math.floor((_-p)/i),E=Math.ceil((u+w)/s),v=b-x+1,L=Math.floor((f-w)/s)-E+1;t.defined(e.frameGap)||(e.frameGap=Math.max(m,g)/30);const T=e.frameGap,C=T/4;if(t.Extents.buffer(r,T,this._frame),this._lines.length=0,this._labels.length=0,n){const[t,e,i,s]=this._frame;this._createLineByRange(this._frame,l.LT_FRAME),this._createLineX(t,i,u,l.LT_BORDER),this._createLineX(t,i,f,l.LT_BORDER),this._createLineY(e,s,d,l.LT_BORDER),this._createLineY(e,s,_,l.LT_BORDER)}else this._createLineX(d,_,u,l.LT_BORDER),this._createLineX(d,_,f,l.LT_BORDER),this._createLineY(u,f,d,l.LT_BORDER),this._createLineY(u,f,_,l.LT_BORDER);for(let t=0;t<v;++t){const e=(t+x)*i;if(o)this._createLineY(u,f,e,l.LT_GRID);else{this._createLineY(u,u+C,e,l.LT_GRID);for(let t=0;t<L;++t){const i=(t+E)*s;this._createLineY(i-C,i+C,e,l.LT_GRID)}this._createLineY(f-C,f,e,l.LT_GRID)}const r=e.toFixed(c);this._createLabel(r,[e,u],a.TT_BOTTOM),this._createLabel(r,[e,f],a.TT_TOP)}for(let t=0;t<L;++t){const e=(t+E)*s;if(o)this._createLineX(d,_,e,l.LT_GRID);else{this._createLineX(d,d+C,e,l.LT_GRID);for(let t=0;t<v;++t){const s=(t+x)*i;this._createLineX(s-C,s+C,e,l.LT_GRID)}this._createLineX(_-C,_,e,l.LT_GRID)}const r=e.toFixed(c);this._createLabel(r,[d,e],a.TT_LEFT),this._createLabel(r,[_,e],a.TT_RIGHT)}}_initLegends(){const t=this._option.legendBar,e=t.items.length;t.rows?t.cols=Math.ceil(e/t.rows):t.cols?t.rows=Math.ceil(e/t.cols):(t.rows=e,t.cols=1),this._legendBar.width=t.cols*t.cellWidth,this._legendBar.height=t.rows*t.cellHeight,t.items.forEach(t=>{if(!t.image&&t.icon){const e=new Image;e.onload=()=>this._map.render(),e.src=t.icon,t.image=e}})}destroy(){this._eventKey&&(ol.Observable.unByKey(this._eventKey),this._eventKey=void 0),this._map.render()}_createLineByRange(t,e){const i=[],[s,r,n,o]=t;i.push([s,r]),i.push([n,r]),i.push([n,o]),i.push([s,o]),i.push([s,r]),this._createLines(i,e)}_createLine(t,e,i){this._createLines([t,e],i)}_createLineX(t,e,i,s){this._createLine([t,i],[e,i],s)}_createLineY(t,e,i,s){this._createLine([i,t],[i,e],s)}_createLines(t,e){this._lines.push({type:e,coords:t})}_createLabel(t,e,i){this._labels.push({type:i,text:t,coords:e})}_toDevPoint(t){const e=this._drawExtent;return[(t[0]-e[0])/this._drawCW,(e[3]-t[1])/this._drawCH]}_toDevRect(t){const[e,i,s,r]=t,[n,o]=this._toDevPoint([e,r]),[a,l]=this._toDevPoint([s,i]);return[n,o,a,l]}_handlePostCompose(e){const i=e.frameState,s=e.context,r=s.canvas,{width:n,height:o}=r;this._drawWidth=n,this._drawHeight=o,this._drawExtent=i.extent,this._drawCW=t.Extents.width(this._drawExtent)/n,this._drawCH=t.Extents.height(this._drawExtent)/o,this._viewState=i.viewState,n==this._canvas.width&&o==this._canvas.height||(this._canvas.width=n,this._canvas.height=o),this._drawGrid(),s.drawImage(this._canvas,0,0)}_drawGrid(){const t=this._option,[i,s,r,n]=this._toDevRect(t.range),o=this._context;o.clearRect(0,0,o.canvas.width,o.canvas.height),t.hasMask&&(o.fillStyle=t.bkColor,o.fillRect(0,0,o.canvas.width,o.canvas.height),o.clearRect(i,s,r-i,n-s)),this._drawTitle(),t.scaleBar&&this._drawScale(t.scaleBar),t.legendBar&&this._drawLegends(t.legendBar),t.infoTable&&this._drawTable(t.infoTable),this._lines.forEach(t=>this._drawLine(t)),this._applyLabelStyle(t.labelStyle,e),this._labels.forEach(t=>this._drawLabel(t)),this._drawCornerLabel()}_applyLineStyle(e,i){const s=this._context;s.strokeStyle=t.defaultValue(null==e?void 0:e.color,null==i?void 0:i.color),s.lineWidth=t.defaultValue(null==e?void 0:e.width,null==i?void 0:i.width)}_applyLabelStyle(e,i){const s=this._context;s.font=t.defaultValue(null==e?void 0:e.font,null==i?void 0:i.font),s.fillStyle=t.defaultValue(null==e?void 0:e.color,null==i?void 0:i.color)}_applyLineTypeStyle(t){const e=this._option;switch(t){case l.LT_GRID:this._applyLineStyle(e.gridStyle,o);break;case l.LT_BORDER:this._applyLineStyle(e.borderStyle,n);break;case l.LT_FRAME:this._applyLineStyle(e.frameStyle,r)}}_drawLine(t){const e=this._context;this._applyLineTypeStyle(t.type);const i=t.coords.map(t=>this._toDevPoint(t)),s=i[0];e.beginPath(),e.moveTo(...s);for(let t=1;t<i.length;++t)e.lineTo(...i[t]);e.stroke()}_drawTitle(){const e=this._option,[r]=t.Extents.center(this._frame);let[n,o]=this._toDevPoint([r,this._frame[3]]);const a=this._context;a.textAlign="center",a.textBaseline="middle";let l=0;e.subtitle&&(this._applyLabelStyle(e.subtitleStyle,s),l=t.getFontSize(a.font)+10,a.fillText(e.subtitle,n,o-l)),e.title&&(this._applyLabelStyle(e.titleStyle,i),l+=t.getFontSize(a.font)+10,a.fillText(e.title,n,o-l))}_drawCornerLabel(){const t=this._option.range,e=this._option.fixedNum+2,[i,s,r,n]=t.map(t=>t.toFixed(e)),[o,a,l,h]=this._toDevRect(t),[c,d,u,_]=this._toDevRect(this._frame),f=this._context;f.textAlign="left",f.textBaseline="top",f.fillText(i,o,d),f.fillText(n,c,a),f.textBaseline="bottom",f.fillText(i,o,_),f.fillText(s,c,h),f.textAlign="right",f.textBaseline="top",f.fillText(r,l,d),f.fillText(n,u,a),f.textBaseline="bottom",f.fillText(r,l,_),f.fillText(s,u,h)}_drawLabel(t){const e=this._context;let[i,s]=this._toDevPoint(t.coords);switch(e.textAlign="center",e.textBaseline="middle",t.type){case a.TT_LEFT:i-=2,e.textAlign="right";break;case a.TT_RIGHT:i+=2,e.textAlign="left";break;case a.TT_TOP:s-=2,e.textBaseline="bottom";break;case a.TT_BOTTOM:s+=2,e.textBaseline="top";break;case a.TT_TITLE:s-=20,e.textBaseline="bottom"}e.fillText(t.text,i,s)}_drawScale(e){const i=this._viewState,s=i.center,r=i.projection,n=r.getMetersPerUnit(),o=t.defaultValue(e.minWidth,64),a=t.defaultValue(e.units,"metric"),l=[1,2,5];let h=r.getPointResolution(i.resolution,s)*n;const c=o*h;let d="";if("degrees"==a){const t=ol.proj.METERS_PER_UNIT[ol.proj.Units.DEGREES];h/=t,c<t/60?(d="″",h*=3600):c<t?(d="′",h*=60):d="°"}else"imperial"==a?c<.9144?(d="in",h/=.0254):c<1609.344?(d="ft",h/=.3048):(d="mi",h/=1609.344):"nautical"==a?(h/=1852,d="nm"):"metric"==a?c<1?(d="mm",h*=1e3):c<1e3?d="m":(d="km",h/=1e3):"us"==a?c<.9144?(d="in",h*=39.37):c<1609.344?(d="ft",h/=.30480061):(d="mi",h/=1609.3472):ol.asserts.assert(!1,33);let u=3*Math.floor(Math.log(o*h)/Math.log(10)),_=0,f=0;for(;;){if(_=l[(u%3+3)%3]*Math.pow(10,Math.floor(u/3)),f=Math.round(_/h),isNaN(f))return;if(f>=o)break;++u}const m=this._context;this._scaleBar.width=f;const g=this._toDevRect(this._frame),y=this._scaleBar.getRange(g),[p,w,x,b]=y,[E,v]=t.Extents.center(y);this._applyLineStyle(e.lineStyle),m.beginPath(),m.moveTo(p,w),m.lineTo(p,b),m.lineTo(x,b),m.lineTo(x,w),m.stroke(),this._applyLabelStyle(e.labelStyle);const L=_+" "+d;m.textAlign="center",m.textBaseline="bottom",m.fillText(L,E,v)}_drawLegends(e){const i=this._context,s=this._toDevRect(this._frame),r=this._legendBar.getRange(s),[n,o]=r,{rows:a,cols:l,cellWidth:h,cellHeight:c,iconWidth:d,iconHeigth:u}=e;i.textAlign="left",i.textBaseline="top",this._applyLabelStyle(e.titleStyle),i.fillText(e.title,n,o);let _=t.getFontSize(e.titleStyle.font)+10;_||(_=30),i.textBaseline="middle",e.items.forEach((t,s)=>{if(!t.image)return;let r=0,f=0;"horizontal"===e.dir?(r=Math.floor(s/l),f=s%l):(f=Math.floor(s/a),r=s%a);const m=n+f*h,g=o+r*c+_;i.drawImage(t.image,m,g,d,u),this._applyLineStyle(e.lineStyle),i.strokeRect(m,g,d,u),this._applyLabelStyle(e.labelStyle),i.fillText(t.title,m+d+10,g+u/2)})}_drawTable(t){const{cellWidth:e,cellHeight:i}=t,s=t.rows.map(t=>{let e=0;return t.forEach(t=>{"string"==typeof t?e++:t.cols?e+=t.cols:e++}),e});this._infoBar.width=Math.max(...s)*e,this._infoBar.height=t.rows.length*i;const r=this._context,n=this._toDevRect(this._frame),o=this._infoBar.getRange(n),[a,l]=o;let h=l;t.rows.forEach(s=>{let n=a;s.forEach(s=>{let o=s;"string"==typeof s&&(o={value:s});const a=(o.cols||1)*e;this._applyLineStyle(o.lineStyle,t.lineStyle),r.strokeRect(n,h,a,i),this._applyLabelStyle(o.labelStyle,t.labelStyle),r.textBaseline="middle",r.textAlign="left",r.fillText(o.value,n+5,h+i/2),n+=a}),h+=i}),this._applyLineStyle(t.lineStyle),r.strokeRect(a,l,this._infoBar.width,this._infoBar.height)}}t.GridMapView=h}(OLE||(OLE={})),function(t){let e;!function(t){t[t.None=0]="None",t[t.Start=1]="Start",t[t.End=2]="End"}(e||(e={}));class i{constructor(t){this.dirX=0,this.dirY=0,this.sub_layers=[],this.layer=t.layer;const i=t.positioning;-1!=i.indexOf("left")?this.dirX=e.Start:-1!=i.indexOf("right")&&(this.dirX=e.End),-1!=i.indexOf("top")?this.dirY=e.Start:-1!=i.indexOf("bottom")&&(this.dirY=e.End)}}t.LayerSwipe=class{constructor(t){this._layers=new Map,this._x=.5,this._y=.5,this._map=t}addLayer(t){this.removeLayer(t.layer);const e=new i(t);this._layers.set(e.layer,e),function t(e,i){e instanceof ol.layer.Group?e.getLayers().forEach(e=>t(e,i)):i(e)}(e.layer,t=>{e.sub_layers.push({slayer:t,precomposeKey:t.on("precompose",t=>this._on_precompose(t,e)),postcomposeKey:t.on("postcompose",t=>this._on_postcompose(t,e))})}),this._map.render()}removeLayer(t){const e=this._layers.get(t);e&&(e.sub_layers.forEach(t=>{ol.Observable.unByKey(t.precomposeKey),ol.Observable.unByKey(t.postcomposeKey)}),this._layers.delete(t),this._map.render())}clear(){this._layers.forEach((t,e)=>this.removeLayer(e))}setSwipePixelX(t){this.setSwipePixel(t)}setSwipePixelY(t){this.setSwipePixel(void 0,t)}setSwipePixel(e,i){const[s,r]=this._map.getSize();t.defined(e)&&(this._x=e/s),t.defined(i)&&(this._y=i/r),this._map.render()}setSwipePosX(t){this.setSwipePos(t)}setSwipePosY(t){this.setSwipePos(void 0,t)}setSwipePos(e,i){t.defined(e)&&(this._x=e),t.defined(i)&&(this._y=i),this._map.render()}_on_precompose(t,i){const s=t.context;let{width:r,height:n}=s.canvas,o=0,a=0;i.dirX===e.Start?r=this._x*r:i.dirX===e.End&&(o=this._x*r),i.dirY===e.Start?n=this._y*n:i.dirY===e.End&&(a=this._y*n),s.save(),s.beginPath(),s.rect(o,a,r,n),s.clip()}_on_postcompose(t,e){t.context.restore()}}}(OLE||(OLE={})),function(t){class e{constructor(t,e,i,s){this._degree=t;const r=e.length,n=r+t+1;if(t<1)throw new Error("degree must be at least 1 (linear)");if(t>r-1)throw new Error("degree must be less than or equal to point count - 1");const o=e[0].length;if(s){if(s.length!=r)throw new Error("bad weights vector length")}else{s=[];for(let t=0;t<r;t++)s[t]=1}if(i){if(i.length!==n)throw new Error("bad knot vector length")}else{i=[];for(let t=0;t<n;t++)i[t]=t}this._konts=i,this._dim=o,this._vdata=[];const a=this._vdata,l=o+1;for(let t=0;t<r;t++){for(let i=0;i<o;i++)a[t*l+i]=e[t][i]*s[t];a[t*l+o]=s[t]}}interp(t,e){const i=this._degree,s=this._konts,r=this._dim,n=r+1,o=[i,s.length-1-i],a=s[o[0]],l=s[o[1]];if((t=t*(l-a)+a)<a||t>l)throw new Error("out of bounds");let h=0;for(h=o[0];h<o[1]&&!(t>=s[h]&&t<=s[h+1]);h++);const c=this._vdata.slice();for(let e=1;e<=i+1;e++)for(let o=h;o>h-i-1+e;o--){const a=(t-s[o])/(s[o+i+1-e]-s[o]);for(let t=0;t<r+1;t++){const e=c[o*n+t],i=c[(o-1)*n+t];c[o*n+t]=(1-a)*i+a*e}}e=e||[];for(let t=0;t<r;t++)e[t]=c[h*n+t]/c[h*n+r];return e}static interp(t,i,s){s=s||2;const r=[],n=t.length+s+1;for(let t=0;t<n;++t)r[t]=t<s+1?0:t>=n-s-1?n-1:t;const o=[],a=new e(s,t,r);for(let t=0;t<=i;++t)o.push(a.interp(t/i));return o}}t.BSPLine=e}(OLE||(OLE={})),function(t){t.Base64=class{static byteLength(t){var e=o(t),i=e[0],s=e[1];return 3*(i+s)/4-s}static toByteArray(t){let e;const s=o(t),r=s[0],n=s[1],a=new Uint8Array(function(t,e,i){return 3*(e+i)/4-i}(0,r,n));let l=0;const h=n>0?r-4:r;let c;for(c=0;c<h;c+=4)e=i[t.charCodeAt(c)]<<18|i[t.charCodeAt(c+1)]<<12|i[t.charCodeAt(c+2)]<<6|i[t.charCodeAt(c+3)],a[l++]=e>>16&255,a[l++]=e>>8&255,a[l++]=255&e;return 2===n&&(e=i[t.charCodeAt(c)]<<2|i[t.charCodeAt(c+1)]>>4,a[l++]=255&e),1===n&&(e=i[t.charCodeAt(c)]<<10|i[t.charCodeAt(c+1)]<<4|i[t.charCodeAt(c+2)]>>2,a[l++]=e>>8&255,a[l++]=255&e),a}static fromByteArray(t){let i;const s=t.length,r=s%3,n=[],o=16383;for(var a=0,h=s-r;a<h;a+=o)n.push(l(t,a,a+o>h?h:a+o));return 1===r?(i=t[s-1],n.push(e[i>>2]+e[i<<4&63]+"==")):2===r&&(i=(t[s-2]<<8)+t[s-1],n.push(e[i>>10]+e[i>>4&63]+e[i<<2&63]+"=")),n.join("")}};const e=[],i=[],s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var r=0,n=s.length;r<n;++r)e[r]=s[r],i[s.charCodeAt(r)]=r;function o(t){const e=t.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");let i=t.indexOf("=");-1===i&&(i=e);return[i,i===e?0:4-i%4]}function a(t){return e[t>>18&63]+e[t>>12&63]+e[t>>6&63]+e[63&t]}function l(t,e,i){let s;for(var r=[],n=e;n<i;n+=3)s=(t[n]<<16&16711680)+(t[n+1]<<8&65280)+(255&t[n+2]),r.push(a(s));return r.join("")}i["-".charCodeAt(0)]=62,i["_".charCodeAt(0)]=63}(OLE||(OLE={})),function(t){class e{static parseCssColorString(t){function i(t,e){return null==t?e:t}if(!t)return;const s=e.Colors[t.toUpperCase()];if(s)return s.slice();const r=[0,0,0,0];let n=e.rgbaMatcher.exec(t);return null!==n?(r[0]=Math.floor(parseInt(n[1],16)/15*255),r[1]=Math.floor(parseInt(n[2],16)/15*255),r[2]=Math.floor(parseInt(n[3],16)/15*255),r[3]=Math.floor(parseInt(i(n[4],"f"),16)/15*255),r):(n=e.rrggbbaaMatcher.exec(t),null!==n?(r[0]=parseInt(n[1],16),r[1]=parseInt(n[2],16),r[2]=parseInt(n[3],16),r[3]=parseInt(i(n[4],"ff"),16),r):(n=e.rgbParenthesesMatcher.exec(t),null!==n?(r[0]=Math.floor(parseFloat(n[1])*("%"===n[1].substr(-1)?2.55:1)),r[1]=Math.floor(parseFloat(n[2])*("%"===n[2].substr(-1)?2.55:1)),r[2]=Math.floor(parseFloat(n[3])*("%"===n[3].substr(-1)?2.55:1)),r[3]=Math.floor(255*parseFloat(i(n[4],"1.0"))),r):void 0))}}e.rgbaMatcher=/^#([0-9a-f])([0-9a-f])([0-9a-f])([0-9a-f])?$/i,e.rrggbbaaMatcher=/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})?$/i,e.rgbParenthesesMatcher=/^rgba?\(\s*([0-9.]+%?)\s*,\s*([0-9.]+%?)\s*,\s*([0-9.]+%?)(?:\s*,\s*([0-9.]+))?\s*\)$/i,e.hslParenthesesMatcher=/^hsla?\(\s*([0-9.]+)\s*,\s*([0-9.]+%)\s*,\s*([0-9.]+%)(?:\s*,\s*([0-9.]+))?\s*\)$/i,e.Colors={RED:[255,0,0,255],GREEN:[0,255,0,255],BLUE:[0,0,255,255],WHITE:[255,255,255,0],BLACK:[0,0,0,255]},t.ColorTool=e}(OLE||(OLE={})),function(t){t.DataRowsHelp=class{constructor(t,e,i){this._fields={},t&&t.forEach((t,e)=>this._fields[t]=e),this._values=e,this._fieldMap=i}get values(){return this._values}forEach(t){this._values.forEach(t)}readValue(t,e){if(this._fieldMap){const t=this._fieldMap[e];t&&(e=t)}return Array.isArray(t)?t[this._fields[e]]:t[e]}readByIndex(t,e){const i=this._values[t];if(i)return this.readValue(i,e)}}}(OLE||(OLE={})),function(t){t.DebugTicks=class{constructor(t){this._name=t}start(){this._start=new Date,console.info(this._name+" started")}finish(){this._end=new Date;const t=this._end.getTime()-this._start.getTime();console.info(`${this._name} finished, cost:${t}`)}static logCost(t,e){const i=new Date;console.info("start "+t);const s=e(),r=((new Date).getTime()-i.getTime())/1e3;return console.info(`finished ${t}, cost:${r.toFixed(2)}s`),s}}}(OLE||(OLE={})),function(t){class e{static triangleArea(t,e,i){const s=(t[0]-i[0])*(e[1]-i[1])-(t[1]-i[1])*(e[0]-i[0]);return s<1e-20&&s>-1e-20?0:s/2}static intersect(t,i,s,r,n,o){const a=e.triangleArea(t,i,s),l=e.triangleArea(t,i,r);if(o&&a*l>=0)return!1;const h=e.triangleArea(s,r,t),c=e.triangleArea(s,r,i);if(o&&h*c>=0)return!1;if(l-a==0)return!1;if(n){const e=h/(l-a),s=e*(i[0]-t[0]),r=e*(i[1]-t[1]);n[0]=t[0]+s,n[1]=t[1]+r}return!0}}t.GeoMath=e}(OLE||(OLE={})),function(t){const e=32768;let i,s,r,n,o,a,l,h,c,d,u,_,f,m,g=null;const y=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],p=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],w=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,99,99],x=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],b=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],E=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];function v(t,e){const i=new Array(t);for(let s=0;s<t;++s)i[s]=e;return i}class L{constructor(){this.next=null,this.list=null}}class T{constructor(){this.e=0,this.b=0,this.n=0,this.t=null}}class C{constructor(t,e,i,s,r,n){this.BMAX=16,this.N_MAX=288,this.status=0,this.root=null,this.m=0;const o=v(this.BMAX+1,0);let a,l,h,c,d,u;const _=v(this.BMAX+1,0);let f,m;const g=new T,y=v(this.BMAX,null),p=v(this.N_MAX,0),w=v(this.BMAX+1,0);let x,b=this.root=null;a=e>256?t[256]:this.BMAX,f=t,m=0,c=e;do{o[f[m]]++,m++}while(--c>0);if(o[0]===e)return this.root=null,this.m=0,void(this.status=0);for(d=1;d<=this.BMAX&&0===o[d];d++);for(u=d,n<d&&(n=d),c=this.BMAX;0!==c&&0===o[c];c--);const E=c;for(n>c&&(n=c),x=1<<d;d<c;d++,x<<=1)if((x-=o[d])<0)return this.status=2,void(this.m=n);if((x-=o[c])<0)return this.status=2,void(this.m=n);o[c]+=x,w[1]=d=0,f=o,m=1;let C=2;for(;--c>0;)w[C++]=d+=f[m++];f=t,m=0,c=0;do{0!==(d=f[m++])&&(p[w[d]++]=c)}while(++c<e);e=w[E],w[0]=c=0,f=p,m=0,h=-1;let S=_[0]=0,I=null,O=0;for(;u<=E;u++){let t=o[u];for(;t-- >0;){for(;u>S+_[1+h];){if(S+=_[1+h],h++,O=(O=E-S)>n?n:O,(l=1<<(d=u-S))>t+1){l-=t+1;let e=u;for(;++d<O&&!((l<<=1)<=o[++e]);)l-=o[e]}S+d>a&&S<a&&(d=a-S),O=1<<d,_[1+h]=d,I=[];for(let t=0;t<O;t++)I[t]=new T;b=b?b.next=new L:this.root=new L,b.next=null,b.list=I,y[h]=I,h>0&&(w[h]=c,g.b=_[h],g.e=16+d,g.t=I,d=(c&(1<<S)-1)>>S-_[h],y[h-1][d].e=g.e,y[h-1][d].b=g.b,y[h-1][d].n=g.n,y[h-1][d].t=g.t)}for(g.b=u-S,m>=e?g.e=99:f[m]<i?(g.e=f[m]<256?16:15,g.n=f[m++]):(g.e=r[f[m]-i],g.n=s[f[m++]-i]),l=1<<u-S,d=c>>S;d<O;d+=l)I[d].e=g.e,I[d].b=g.b,I[d].n=g.n,I[d].t=g.t;for(d=1<<u-1;0!=(c&d);d>>=1)c^=d;for(c^=d;(c&(1<<S)-1)!==w[h];)S-=_[h],h--}}this.m=_[1],this.status=0!==x&&1!==E?1:0}}function S(){if(_.length===f)throw new Error("no more byte!");return 255&_[f++]}function I(){A(7&l)}function O(t){for(;l<t;)a|=S()<<l,l+=8;return a&y[t]}function R(t){const e=O(t);return A(t),e}function A(t){a>>=t,l-=t}function M(t){let e=0,i=0;for(;e<8*t;)i|=S()<<e,e+=8;return i}function k(){const t=m,r=t.length;let n,o,a=0;for(;;){for(o=h.list[O(d)],n=o.e;n>16;){if(99===n)return-1;A(o.b),o=o.t[O(n-16)],n=o.e}if(A(o.b),16===n){s&=e-1,t[r+a++]=i[s++]=o.n;continue}if(15===n)break;let l=o.n+R(n);for(o=c.list[O(u)],n=o.e;n>16;){if(99===n)return-1;A(o.b),o=o.t[O(n-16)],n=o.e}A(o.b);let _=s-o.n-R(n);for(;l>0;)l--,_&=e-1,s&=e-1,t[r+a++]=i[s++]=i[_++]}return a}function D(){const t=m,r=t.length;I();const n=M(2);if(n!==(65535&~M(2)))throw new Error("error in compressed data");for(let o=0;o<n;++o)s&=e-1,t[r+o]=i[s++]=M(1);return n}function B(){return g||function(){let t;const e=[];for(t=0;t<144;t++)e[t]=8;for(;t<256;t++)e[t]=9;for(;t<280;t++)e[t]=7;for(;t<288;t++)e[t]=8;const i=new C(e,288,257,p,w,7);if(0!==i.status)throw new Error("HufBuild error: "+i.status);for(t=0;t<30;t++)e[t]=5;const s=new C(e,30,0,x,b,5);if(s.status>1)throw new Error("HufBuild error: "+s.status);g=i.root,n=i.m,r=s.root,o=s.m}(),h=g,c=r,d=n,u=o,k()}function P(){const t=v(316,0),e=257+R(5),i=1+R(5),s=4+R(4);if(e>286||i>30)throw new Error("bad lengths");let r=0;for(;r<s;r++)t[E[r]]=R(3);for(;r<19;r++)t[E[r]]=0;let n=new C(t,19,19,null,null,7);if(0!==n.status)throw new Error("incomplete code set");h=n.root,d=n.m;const o=e+i;let a=0,l=0;for(;a<o;){const e=h.list[O(d)];A(e.b);let i=e.n;if(i<16)t[a++]=l=i;else{if(16===i?i=3+R(2):17===i?(i=3+R(3),l=0):(i=11+R(7),l=0),a+i>o)throw new Error("invalid bit length repeat");for(;i-- >0;)t[a++]=l}}if(n=new C(t,e,257,p,w,9),0!==n.status&&1!==n.status)throw new Error("incomplete code set");h=n.root,d=n.m;for(let s=0;s<i;s++)t[s]=t[s+e];if(n=new C(t,i,0,x,b,6),c=n.root,u=n.m,0===u&&e>257)throw new Error("incomplete distance tree");if(0!==n.status)throw new Error("incomplete distance tree");return k()}function F(){i||(i=[]),s=0,a=0,l=0}t.inflate=function(t){const e=[];return F(),_=t,f=2,m=e,function(){let t=0,e=0,i=!1;for(;!i;){0!==R(1)&&(i=!0);const s=R(2);switch(s){case 0:console.info("read stored block"),e=D();break;case 1:console.info("read fixed block"),e=B();break;case 2:console.info("read dynamic block"),e=P();break;default:throw new Error("bad block type:"+s)}t+=e}}(),_=null,m=null,e}}(OLE||(OLE={})),function(t){class e{constructor(e,i){this.nx=0,this.ny=0,t.defined(e)&&(this.nx=0|e,this.ny=0|i)}}class i{constructor(e,i){this.x=0,this.y=0,t.defined(e)&&(this.x=e,this.y=i)}clone(){return new i(this.x,this.y)}copyFrom(t){this.x=t.x,this.y=t.y}equal(t){return this.x==t.x&&this.y==t.y}}class s{constructor(){this.u=0,this.v=0}}t.StreamLine=class{constructor(e){this.mLines=[],this.mOption=t.deepAssign({lineSpace:19,interpCount:20,interpStep:.05,minLength:1,maxPoints:2e3,maxStay:100,forwardOnly:!1,showArrow:!0,arrowDist:5,arrowSize:1},e),this.initUsedCache()}clear(){this.mLines=[]}initUsedCache(){const t=this.mOption.lineSpace>>1;this.mUsedCache=[];const i=t*t;for(let s=-t;s<=t;s++)for(let r=-t;r<=t;r++){r*r+s*s<i&&this.mUsedCache.push(new e(r,s))}}generate(t){this.clear(),this.mDataU=t.u,this.mDataV=t.v,this.mWidth=t.width,this.mHeight=t.height,this.mRange=t.range;const e=t.width*t.height;this.mFlags=new Uint32Array(e),this.mFlags2=new Uint8Array(e);let s=0,r=0;const n=new i;for(;-1!=(s=this.getSeed())&&this.mLines.length<2e3;){++r,n.x=.5+(s%this.mWidth|0),n.y=.5+(s/this.mWidth|0),this.mFlags[s]=r;const t=[];this.mOption.forwardOnly||(this.trackStreamLine(r,n,t,-1),t.length>0&&t.reverse()),t.push(n.clone()),this.trackStreamLine(r,n,t,1),t.length<=1||(this.mLines.push(t),this.setLineUsed(t,r))}return this.getLines()}getLines(){const e=t.Extents.width(this.mRange),i=t.Extents.height(this.mRange),r=this.mWidth,o=this.mHeight,[a,l]=this.mRange,{showArrow:h,showTailArrow:c,minLength:d,arrowSize:u,arrowDist:_}=this.mOption;function f(t,s){return[t/r*e+a,s/o*i+l]}function m(t){return f(t.x,t.y)}const g=new s,y=t=>{const e=t.x,i=t.y;this.interpValueXY(e,i,g);const s=Math.atan2(g.v,g.u),r=2.7925268,n=u,o=[];return o.push(f(e+n*Math.cos(s+r),i+n*Math.sin(s+r))),o.push(f(e,i)),o.push(f(e+n*Math.cos(s-r),i+n*Math.sin(s-r))),o},p=this.mLines,w=[],x=p.length;for(let t=0;t<x;++t){const e=p[t],i=e.length;let s=0,r=0;const o=[];let a=e[0];const l=[];for(let t=0;t<i;++t){const i=e[t];l.push(m(i));const h=n(a,i);s+=h,r+=h,s>_&&(o.push(i),s-=_),a=i}if(r<d)continue;const u=o.length,f=[];if(h&&u>0)for(let t=0;t<u;++t)f.push(y(o[t]));let g;c&&(g=y(a)),w.push({id:t,line:l,tail:g,arrows:f})}return w}trackStreamLine(e,i,s,r){let n=i;const o=new Map,{mWidth:a,mHeight:l,mFlags2:h}=this,{maxStay:c,interpStep:d,maxPoints:u}=this.mOption;for(;s.length<u;){const e=this.interpNextPosition(n,d,r);if(e.equal(n))break;if(e.x<=0||e.x>=a-1||e.y<=0||e.y>=l-1)break;const i=(0|e.x)+(0|e.y)*a;if(0!==h[i])break;const u=t.defaultValue(o.get(i),0);if(u>c)break;o.set(i,u+1),s.push(e),n=e}}getSeed(){const t=this.mFlags.length;for(let e=0;e<t;e++)if(0==this.mFlags[e])return e;return-1}setLineUsed(t,e){let i=-1,s=-1;t.forEach(t=>{const r=0|t.x,n=0|t.y;r===i&&n===s||(this.setUsed(r,n,e),i=r,s=n)})}setUsed(t,e,i){const{mFlags:s,mUsedCache:r,mWidth:n,mHeight:o}=this,a=r.length;for(let l=0;l<a;l++){const a=r[l],h=t+a.nx,c=e+a.ny;if(h<0||h>=n||c<0||c>=o)continue;const d=h+c*n;0==s[d]&&(s[d]=i)}this.mFlags2[t+e*n]=1}interpValue(t,e){this.interpValueXY(t.x,t.y,e)}interpValueXY(t,e,i){const{mDataU:s,mDataV:r,mWidth:n,mHeight:a}=this,l=o(t-.5,0,n-2),h=o(e-.5,0,a-2),c=0|l,d=0|h,u=c+1,_=d+1,f=c+d*n,m=u+d*n,g=c+_*n,y=u+_*n,p=l-c,w=h-d,x=1-p,b=1-w;i.u=s[f]*x*b+s[m]*p*b+s[g]*x*w+s[y]*p*w,i.v=r[f]*x*b+r[m]*p*b+r[g]*x*w+r[y]*p*w}interpNextPosition(t,e,s){const n=this.mOption.interpCount,o=e/n*s,a=new i(t.x,t.y);for(let t=0;t<n&&(this.interpValue(a,r),0!=r.u||0!=r.v);t++)a.x=a.x+o*r.u,a.y=a.y+o*r.v;return a}};const r=new s;function n(t,e){const i=t.x-e.x,s=t.y-e.y;return Math.sqrt(i*i+s*s)}function o(t,e,i){return t<e?e:t>i?i:t}}(OLE||(OLE={})),function(t){function e(t){let e=Number.MAX_VALUE,i=-Number.MAX_VALUE;const s=t.length;for(let r=0;r<s;++r){const s=t[r];s!==Number.NaN&&(s<e&&(e=s),s>i&&(i=s))}return[e,i]}t.calcLimit=e,t.unpackRasterData=function(t){return t.startsWith("deflater:")?r(t.substring(9)):s(t)};const i=12;function s(e){const s=t.Base64.toByteArray(e),r=new DataView(s.buffer),n=r.getInt32(0,!0),o=r.getFloat32(4,!0),a=r.getFloat32(8,!0),l=a-o;if(s.byteLength-i!=n)throw new Error("bad raster data.");const h=Math.floor(o-.1*l),c=new Float32Array(n);for(let t=0;t<n;++t){if(0===s[t+i]){c[t]=h;continue}const e=s[t+i]/255*l+o;c[t]=e}return{data:c,min:o,max:a,noData:h}}function r(e){const i=t.Base64.toByteArray(e),s=t.inflate(i),r=new Uint8Array(s),n=new DataView(r.buffer),o=n.getInt32(0,!0),a=n.getInt32(4,!0),l=n.getInt32(8,!0)/a,h=new Int32Array(r.buffer,12);if(h.length!=o)throw new Error("bad raster data.");let c=Number.MAX_VALUE,d=-Number.MAX_VALUE;const u=new Float32Array(o);for(let t=0;t<o;++t){const e=h[t]/a;u[t]=e,e!=l&&(e<c&&(c=e),e>d&&(d=e))}return{data:u,min:c,max:d,noData:l}}function n(t){return void 0!==t&&null!=t}function o(t){return"function"==typeof t||"object"==typeof t&&!Array.isArray(t)}t.decodeRasterData=s,t.inflaterRasterData=r,t.encodeRasterData=function(s){let[r,n]=e(s);const o=(255*r-n)/254,a=n-r,l=new Uint8Array(i+s.length),h=new DataView(l.buffer);return h.setInt32(0,s.length,!0),h.setFloat32(4,o,!0),h.setFloat32(8,n,!0),s.forEach((t,e)=>{l[e+i]=t<r?0:(t-r)/a*254+1}),t.Base64.fromByteArray(l)},t.defined=n,t.defaultValue=function(t,e){return n(t)?t:e},t.defaultValues=function(...t){return t.find(t=>n(t))},t.deepAssign=function t(e,...i){if(null==e)throw new TypeError("Cannot convert undefined or null to object");const s=Object(e);return i.forEach(e=>{if(null!=e)for(let i in e)if(Object.prototype.hasOwnProperty.call(e,i)){const r=s[i],n=e[i];o(r)&&o(n)?t(r,n):s[i]=n}}),s};const a=/([0-9]+)px/;t.getFontSize=function(t){if(a.test(t))return parseFloat(RegExp.$1)},t.guid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)}))}}(OLE||(OLE={}));const RasterEngine=OLE,PointEngine=OLE;var OLE;void 0===Array.prototype.last&&(Array.prototype.last=function(){const t=this.length;if(0!=t)return this[t-1]}),function(t){const e={};t.IconCache=class{static initImage(t,i){let s=e[t];if(!s){const r=new Image;s={image:r,isLoaded:!1},e[t]=s,r.onload=()=>{s.isLoaded=!0,i&&i(r)},r.crossOrigin="Anonymous",r.src=t}if(s.isLoaded)return s.image}static getImage(t){let i=e[t];if(i&&i.isLoaded)return i.image}}}(OLE||(OLE={})),function(t){t.createImagePromise=function(t,e){return e=e||{},new Promise((i,s)=>{const r=new Image;r.onload=function(){e.cancel||i(r)},r.onerror=function(t){console.warn(t),e.cancel||s(t)},r.src=t})},t.toUrlParams=function(e){const i=[];for(let s in e){let r=e[s];t.defined(r)&&("string"!=typeof r&&(r=JSON.stringify(r)),i.push(`${s}=${encodeURIComponent(r)}`))}return i.join("&")}}(OLE||(OLE={}));