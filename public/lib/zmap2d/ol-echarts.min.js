var EventDispatchOther=function(){function t(t,e){this._events={},this._src=t,this._target=e}return t.prototype.bind=function(){for(var t=this,e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];e.forEach((function(e){var i=t._events[e];i||(i=function(e){return t._doDisp(e)},t._src.addEventListener(e,i),t._events[e]=i)}))},t.prototype.unbind=function(t){var e=this._events[t];e&&(this._src.removeEventListener(t,e),delete this._events[t])},t.prototype.unbindAll=function(){for(var t in this._events)console.info(t),this.unbind(t)},t.prototype._doDisp=function(t){var e;e=t instanceof WheelEvent?new WheelEvent(t.type,t):t instanceof MouseEvent?new MouseEvent(t.type,t):new Event(t.type,t),this._target instanceof HTMLElement?this._target.dispatchEvent(e):"function"==typeof this._target&&this._target(e)},t}(),OlEchartsLayer=function(){function t(t,e,i){var n=this;this._memRect=[],this._isMoving=!1,this._delayEvent=0,this._delayTimer=0,this._lastCenter=[],this._lastResolu=0,this._option=i=Object.assign({delayOnMouseMove:500,optimizeScatter:!0,optimizeRadius:6},i),this._map=t,this._view=t.getView(),t.getInteractions().forEach((function(t){t instanceof ol.interaction.DragPan&&(n._mapPan=t)})),this._createMemoryCanvas(),this._createLayer(),this._createEcharts(),this.setOption(e),this._viewCenterKey=this._view.on("change:center",(function(){n._isMoving=!0})),this._mapMoveendKey=this._map.on("moveend",(function(){n._isMoving=!1}))}return Object.defineProperty(t.prototype,"olMap",{get:function(){return this._map},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"olView",{get:function(){return this._view},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"layer",{get:function(){return this._layer},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"visible",{get:function(){return this._layer.getVisible()},set:function(t){this._layer.setVisible(t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"echartsInstance",{get:function(){return this._echarts},enumerable:!0,configurable:!0}),t.prototype.setOption=function(e,i,n){if(this._echarts){var r=this._view.getCenter(),s=this._view.calculateExtent(this._map.getSize()),a=s[0],o=s[1],h=s[2],c={aspectScale:1,zoom:1,roam:!1,left:0,top:0,right:0,bottom:0,center:r,boundingCoords:[[a,s[3]],[h,o]]};(e=t.deepClone(e)).animation=!1,e.geo=Object.assign(e.geo||{},c),e.series?(Array.isArray(e.series)||(e.series=[e.series]),e.series.forEach((function(t){"map"===t.type&&void 0===t.geoIndex&&Object.assign(t,c)}))):e.series=[],d(e,"title"),d(e,"legend"),d(e,"toolbox"),d(e,"grid"),v(e.visualMap),v(e.xAxis),v(e.yAxis),v(e.radiusAxis),v(e.angleAxis),v(e.radar),v(e.polar),e.series.forEach((function(t){null!=t&&void 0!==t.type&&("scatter"===t.type&&(t.large=!0,t.largeThreshold=2e4),"map"!==t.type&&"geo"!==t.coordinateSystem&&v(t))}));var l=t.deepClone(e.series);e.series.forEach((function(t){"scatter"===t.type&&t.data&&t.data.length>0&&(t.data=[t.data[0]])})),this.setOptionInner(e,i,n),this._echartsCanvas=[];for(var _=this._echartsDiv.firstChild.childNodes,u=0;u<_.length;++u){var p=_[u],m=p.getAttribute("data-zr-dom-id");parseFloat(m.substr(3))>=9999||(p.style.display="none",this._echartsCanvas.push(p))}this._echartsOption=e,this._echartsSeries=l,this._lastResolu=0,this._source.changed()}function v(t){null!=t&&(Array.isArray(t)?t.forEach(v):t.zlevel&&t.zlevel<9999?t.zlevel=t.zlevel+9999:t.zlevel=9999)}function d(t,e){var i=t[e];i?v(i):t[e]={zlevel:9999}}},t.prototype.setOptionInner=function(e,i,n){t.current=this,this._echartsSetOption.call(this._echarts,e,i,n)},t.prototype.destroy=function(){if(this._echarts)return ol.Observable.unByKey(this._mapMoveendKey),ol.Observable.unByKey(this._viewCenterKey),ol.Observable.unByKey(this._mapCenterChangedKey),ol.Observable.unByKey(this._mapResChangedKey),this._mutation.disconnect(),this._dispOther.unbindAll(),this._echarts.dispose(),this._echarts=null,this._echartsCanvas=null,this._echartsDiv&&this._echartsDiv.parentNode&&this._echartsDiv.parentNode.removeChild(this._echartsDiv),this._echartsDiv=null,this._option.noAddToMap||this._map.removeLayer(this._layer),this._layer=null,this._source=null,this._memContext=null,this._memCanvas=null,null},t.prototype._createMemoryCanvas=function(){this._memCanvas=document.createElement("CANVAS"),this._memContext=this._memCanvas.getContext("2d")},t.prototype._createLayer=function(){var t=this;this._source=new ol.source.ImageCanvas({canvasFunction:function(e,i,n,r,s){return t._canvasFunction(e,i,n,r,s)},projection:this._view.getProjection(),ratio:1}),this._layer=new ol.layer.Image({source:this._source}),this._layer.on("change:visible",(function(e){t._echartsDiv&&(t._echartsDiv.style.display=t._layer.getVisible()?"block":"none")})),this._option.noAddToMap||this._map.addLayer(this._layer)},t.prototype._createEcharts=function(){var t=this;echarts&&"function"==typeof echarts.init?(this._echartsDiv=document.createElement("DIV"),this._map.getViewport().append(this._echartsDiv),this._bindEvents(),Object.assign(this._echartsDiv.style,{position:"absolute",height:"100%",width:"100%",pointerEvents:"none",top:"0px"}),this._echarts=echarts.init(this._echartsDiv),this._echartsSetOption=this._echarts.setOption,this._echarts.setOption=function(e,i,n){t.setOption(e,i,n)},this._echarts.on("rendered",(function(){requestAnimationFrame((function(){t._render()}))})),this._mutation=new MutationObserver((function(e){return t._mutationEvent(e)})),this._mutation.observe(this._echartsDiv.firstChild,{attributes:!0,attributeFilter:["style"]})):console.error("没有引用echarts库，请引用echarts库！！！")},t.prototype._mutationEvent=function(t){if(0!=t.length){var e=this._map.getViewport(),i=t[0].target;e.style.cursor=i.style.cursor,this._mapPan&&this._mapPan.setActive("default"===i.style.cursor||"pointer"===i.style.cursor)}},t.prototype._bindEvents=function(){var t=this,e=this._map.getViewport().querySelector("canvas.ol-unselectable");this._dispOther=new EventDispatchOther(e,(function(e,i){if(t._layer.getVisible()&&("mousemove"!==e.type||!t._isMoving))for(var n=t._echartsDiv.children,r=(n.length,0);r<1;++r){var s=n[r];e.target!==s&&("DIV"===s.nodeName&&s.dispatchEvent(e))}})),this._dispOther.bind("click","dblclick","contextmenu","mousedown","mouseup","mousewheel","mouseenter","mouselevel","mousemove","mouseover","mouseout","selectstart")},t.deepClone=function(e){var i=Object.prototype.toString;function n(t){return t.__ec_primitive__}if(null==e||"object"!=typeof e)return e;var r=e,s=i.call(e);if("[object Array]"===s){if(!n(e)){r=[];for(var a=0,o=e.length;a<o;a++)r[a]=t.deepClone(e[a])}}else if({"[object Int8Array]":1,"[object Uint8Array]":1,"[object Uint8ClampedArray]":1,"[object Int16Array]":1,"[object Uint16Array]":1,"[object Int32Array]":1,"[object Uint32Array]":1,"[object Float32Array]":1,"[object Float64Array]":1}[s]){if(!n(e)){var h=e.constructor;if(e.constructor.from)r=h.from(e);else{r=new h(e.length);for(a=0,o=e.length;a<o;a++)r[a]=t.deepClone(e[a])}}}else if(!{"[object Function]":1,"[object RegExp]":1,"[object Date]":1,"[object Error]":1,"[object CanvasGradient]":1,"[object CanvasPattern]":1,"[object Image]":1,"[object Canvas]":1}[s]&&!n(e)&&!function(t){return"object"==typeof t&&"number"==typeof t.nodeType&&"object"==typeof t.ownerDocument}(e))for(var c in r={},e)e.hasOwnProperty(c)&&(r[c]=t.deepClone(e[c]));return r},t.prototype._canvasFunction=function(t,e,i,n,r){return this._memCanvas.width=this._memWidth=n[0],this._memCanvas.height=this._memHeight=n[1],this._memExtent=t,this._updateEcharts(),this._memCanvas},t.prototype._delayUpdateEcharts=function(){var t=this;this._delayTimer&&clearTimeout(this._delayTimer),this._delayTimer=setTimeout((function(){return t._updateEcharts()}),500)},t.prototype._isNeedUpdate=function(t,e){var i=this._lastCenter,n=i[0],r=i[1],s=t[0],a=t[1];return(n!=s||r!=a||this._lastResolu!=e)&&(this._lastCenter[0]=t[0],this._lastCenter[1]=t[1],this._lastResolu=e,!0)},t.prototype._updateEcharts=function(t){var e=this;if(this._echarts){var i=this._map.getSize(),n=this._view.getCenter(),r=this._view.getResolution(),s=this._view.calculateExtent(i);if(t||this._isNeedUpdate(n,r)){var a=s[0],o=s[1],h=s[2],c=s[3],l=this._memExtent,_=l[0],u=l[1],p=l[2],m=l[3],v=this._memWidth/(p-_),d=this._memHeight/(m-u);this._memRect[0]=(a-_)*v,this._memRect[1]=(m-c)*d,this._memRect[2]=(h-a)*v,this._memRect[3]=(c-o)*d;var f={center:n,boundingCoords:[[a,c],[h,o]]},y=this._echartsOption;if(Object.assign(y.geo,f),this._echartsSeries){var g=this._echartsSeries;y.series.forEach((function(t,n){return"map"===t.type&&Object.assign(t,f),"scatter"===t.type&&(e._option.optimizeScatter?t.data=e._optimizeScatterData(g[n].data,s,i,r):t.data=g[n].data),t}))}this.setOptionInner(y,!0),this._renderOneFrame()}}},t.prototype._optimizeScatterData=function(t,e,i,n){var r=this,s=[],a=i[0],o=i[1],h=new Uint8Array(a*o);return t.forEach((function(t,i){var c=t;t.value&&(c=t.value);var l=c[0],_=c[1];if(!(l<e[0]||l>e[2]||_<e[1]||_>e[3])){var u=Math.floor((l-e[0])/n),p=Math.floor((e[3]-_)/n);0===h[u+p*a]&&(r._tagPoint(i+1,u,p,h,a,o),s.push(t))}})),console.info("optimizeScatterData",s.length),s},t.prototype._tagPoint=function(t,e,i,n,r,s){for(var a=this._option.optimizeRadius,o=Math.max(e-a,0),h=Math.max(i-a,0),c=Math.min(e+a+1,r),l=Math.min(i+a+1,s),_=h;_<l;++_)for(var u=o;u<c;++u)n[u+_*r]=t},t.prototype._render=function(){this._echarts&&(this._renderOneFrame(),this._map.render())},t.prototype._renderOneFrame=function(){var t=this;if(this._memExtent){this._memContext.clearRect(0,0,this._memWidth,this._memHeight);var e=this._memRect,i=e[0],n=e[1],r=e[2],s=e[3];this._echartsCanvas.forEach((function(e){return t._memContext.drawImage(e,i,n,r,s)}))}},t}();