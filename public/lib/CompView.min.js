"use strict";class ColorTool{static parseCssColorString(e){function t(e,t){if(e===undefined||e===null)return t;return e}if(!e)return;const r=ColorTool.Colors[e.toUpperCase()];if(r){return r.slice()}const s=[0,0,0,0];let i=ColorTool.rgbaMatcher.exec(e);if(i!==null){s[0]=Math.floor(parseInt(i[1],16)/15*255);s[1]=Math.floor(parseInt(i[2],16)/15*255);s[2]=Math.floor(parseInt(i[3],16)/15*255);s[3]=Math.floor(parseInt(t(i[4],"f"),16)/15*255);return s}i=ColorTool.rrggbbaaMatcher.exec(e);if(i!==null){s[0]=parseInt(i[1],16);s[1]=parseInt(i[2],16);s[2]=parseInt(i[3],16);s[3]=parseInt(t(i[4],"ff"),16);return s}i=ColorTool.rgbParenthesesMatcher.exec(e);if(i!==null){s[0]=Math.floor(parseFloat(i[1])*("%"===i[1].substr(-1)?2.55:1));s[1]=Math.floor(parseFloat(i[2])*("%"===i[2].substr(-1)?2.55:1));s[2]=Math.floor(parseFloat(i[3])*("%"===i[3].substr(-1)?2.55:1));s[3]=Math.floor(parseFloat(t(i[4],"1.0"))*255);return s}return undefined}static toPiecewiseColors(e){const t=e===null||e===void 0?void 0:e.list;if(!t)return;return t.map(e=>{return{color:e.color,name:e.name,min:e.minV,max:e.maxV}})}}ColorTool.rgbaMatcher=/^#([0-9a-f])([0-9a-f])([0-9a-f])([0-9a-f])?$/i;ColorTool.rrggbbaaMatcher=/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})?$/i;ColorTool.rgbParenthesesMatcher=/^rgba?\(\s*([0-9.]+%?)\s*,\s*([0-9.]+%?)\s*,\s*([0-9.]+%?)(?:\s*,\s*([0-9.]+))?\s*\)$/i;ColorTool.hslParenthesesMatcher=/^hsla?\(\s*([0-9.]+)\s*,\s*([0-9.]+%)\s*,\s*([0-9.]+%)(?:\s*,\s*([0-9.]+))?\s*\)$/i;ColorTool.Colors={RED:[255,0,0,255],GREEN:[0,255,0,255],BLUE:[0,0,255,255],WHITE:[255,255,255,0],BLACK:[0,0,0,255]};var Comp;(function(n){function l(){}n.VOID=l;class a{constructor(e,t,r,s){this.target=e;this.type=t;this.listener=r;this.bindto=s}}n.ListenerObject=a;const e=new a(undefined,"void",l,undefined);class t{constructor(){this._removing={};this._dispatching={};this._listeners={}}getListeners(e){return this._listeners[e]}hasListener(e){return e?e in this._listeners:Object.keys(this._listeners).length>0}addEventListener(e,t,r){let s=this._listeners[e];if(!s){s=this._listeners[e]=[]}const i=this.findListener(s,t,r);if(i!=-1)return s[i];const o=new a(this,e,t,r);s.push(o);return o}dispatchEvent(e){let r;const s=typeof e==="string"?new n.Event(e):e;const t=s.type;s.target=this;const i=this._listeners[t];if(i){if(!(t in this._dispatching)){this._dispatching[t]=0;this._removing[t]=0}++this._dispatching[t];for(let e=0,t=i.length;e<t;++e){const o=i[e];const a=o.bindto||o.target;if(o.listener.call(a,s)===false||s.propagationStopped){r=false;break}}--this._dispatching[t];if(this._dispatching[t]===0){let e=this._removing[t];delete this._removing[t];while(e--){this.removeEventListener(t,l)}delete this._dispatching[t]}return r}}removeEventListener(e,t,r){const s=this._listeners[e];if(s){const i=this.findListener(s,t,r);if(i===-1)return;if(e in this._removing){s[i].listener=l;++this._removing[e]}else{s.splice(i,1);if(s.length===0){delete this._listeners[e]}}}}findListener(r,s,i){for(let t=0;t<r.length;++t){let e=r[t];if(e.listener===s&&e.bindto===i){return t}}return-1}removeAllEventListener(){const e=Object.keys(this._listeners);for(let r of e){const s=this._listeners[r];for(let t=s.length-1;t>=0;--t){let e=s[t];this.removeEventListener(r,e.listener,e.bindto)}}}_disposeInternal(){this.removeAllEventListener()}}n.EventTarget=t})(Comp||(Comp={}));var Comp;(function(e){class t{constructor(e){this.target=null;this.type=e}preventDefault(){this.propagationStopped=true}stopPropagation(){this.propagationStopped=true}}e.Event=t})(Comp||(Comp={}));var Comp;(function(t){class e extends t.EventTarget{constructor(){super();this._revision=0}changed(){++this._revision;this.dispatchEvent(e.CHANGE)}getRevision(){return this._revision}on(t,r,s){if(Array.isArray(t)){const i=t.length;const o=new Array(i);for(let e=0;e<i;++e){o[e]=a(this,t[e],r,s)}return o}else{return a(this,t,r,s)}}un(r,s,i){if(Array.isArray(r)){for(let e=0,t=r.length;e<t;++e){o(this,r[e],s,i)}return}else{o(this,r,s,i)}}static unByKey(r){if(Array.isArray(r)){for(let e=0,t=r.length;e<t;++e){s(r[e])}}else{s(r)}}}e.CHANGE="change";t.Observable=e;function a(e,t,r,s){return e.addEventListener(t,r,s)}function o(e,t,r,s){e.removeEventListener(t,r,s)}function s(e){if(e instanceof t.ListenerObject){e.target.removeEventListener(e.type,e.listener,e.bindto)}}})(Comp||(Comp={}));class CompDataRender extends Comp.Observable{constructor(e,t){super();this._version=-1;this._visible=true;this._properties={};this._renderStatus=CompMapLayerEventType.RENDER_COMPLATE;this._updateHandle=0;this._view=e;this._declare=t}get renderName(){return this.factory.name}get dataTypes(){return this.factory.types}get olMap(){return this._view.olMap}get colors(){return this.layer.colors}get renderStatus(){return this._renderStatus}set properties(e){this._properties=e}get properties(){return this._properties}$get(e){const t=this._properties;return t&&t[e]}$set(e,t){if(!this._properties){this._properties={}}this._properties[e]=t}setVisible(e){if(this._visible===e)return;const t=this.olLayer;if(t)t.setVisible(e);this._visible=e;if(e&&this._version!==this.layer.version){this.clear();this.update()}}isVisible(){return this._visible}isRealVisible(){if(!this._visible)return false;const e=this.olLayer;if(!e)return true;const t=this.olMap.getView().getResolution();const r=e.getMinResolution();const s=e.getMaxResolution();return t>=r&&t<s}update(){if(!this.isVisible()){return}cancelAnimationFrame(this._updateHandle);this._view.license.checkPower(this.factory.licenseRequired).then(e=>{if(e){this._updateHandle=requestAnimationFrame(()=>{this.updateImm();this._version=this.layer.version})}})}queryTip(e,t,r){return}queryDisplay(e,t){return}_fireRenderStatus(e){this._renderStatus=e;this.dispatchEvent(e)}getColor(e){return this.layer.getColor(e)}}class CompFieldsHelp{static findField(r,e,s){let t=-1;const i=typeof e;if(i==="string"){t=r.indexOf(e);if(t!=-1)return t;t=Number.parseInt(e);if(t>=0&&t<r.length)return t}if(i==="number"&&Number.isInteger(e)){t=e;if(t>=0&&t<r.length)return t}if(!s)return-1;if(!Array.isArray(s)){s=[s]}for(let t=0;t<s.length;++t){let e=this.findField(r,s[t]);if(e!=-1)return e}return-1}}class CompLRUCache{constructor(e,t){this._map=new Map;this._list=new CompLinkedList;this._mCapability=e||100;this._mLowLevel=t||this._mCapability*.8}setSize(e,t){this._mLowLevel=t;this._mCapability=e;this._obsolete()}get(e){const t=this._map.get(e);if(!t)return null;this._list.removeByItem(t.iterator);t.iterator=this._list.push_front(e);return t.value}add(e,t){this._obsolete();this.remove(e);this._map.set(e,{key:e,value:t,iterator:this._list.push_front(e)})}remove(e){const t=this._map.get(e);if(!t){this._map.delete(e);this._list.removeByItem(t.iterator);return t.value}}clear(){this._map.clear();this._list.clear()}get size(){return this._map.size}get lowlevel(){return this._mLowLevel}get capability(){return this._mCapability}forEach(r){this._map.forEach((e,t)=>{return r(e.value,t)})}_obsolete(){if(this.size<this._mCapability)return;while(this.size>this._mLowLevel){const e=this._list.back;this._map.delete(e);this._list.pop_back()}}}var Comp;(function(e){const o="A".charCodeAt(0);const a="Z".charCodeAt(0);const n="a".charCodeAt(0);const l="z".charCodeAt(0);const c="0".charCodeAt(0);const u="9".charCodeAt(0);const h="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";const p="WlNs4mMr7cPEh3FnGi0C5OAgId8JL6KkDuSaUb9Ty1Hfz2BjVoqXtZvYpwQxRe";function d(e){if(e<128)return 1;if(e<2048)return 2;if(e<65536)return 3;if(e<2097152)return 4;if(e<67108864)return 5;if(e<2147483648)return 6;throw new Error("bad code number")}function f(e){if(e<128)return[1,e];if((e&192)!==192)throw new Error("bad utf8 first byte");let t=2;let r=32;e=e&63;while(e&r){t++;e=e&~r;r=r>>1}if(t>6)throw new Error("bad utf8 first byte");return[t,e]}class t{static encodeStringV1(r){const s=[];const e=r.length;for(let t=0;t<e;++t){let e=-1;const i=r.charCodeAt(t);if(i>=o&&i<=a){e=i-o}else if(i>=n&&i<=l){e=i-n+26}else if(i>=c&&i<=u){e=i-c+52}if(e!==-1)s.push(p[e]);else s.push(r[t])}return s.join("")}static decodeStringV1(t){const r=[];const s=t.length;for(let e=0;e<s;++e){const i=t[e];const o=p.indexOf(i);if(o!==-1)r.push(h[o]);else r.push(i)}return r.join("")}static parseResponseJSON(e){if(!e.ok)return{};return e.arrayBuffer().then(e=>{const t=new TextDecoder("gbk");const r=t.decode(e);return JSON.parse(r)})}static toUtf8Bytes(i){const o=[];const t=i.length;for(let e=0;e<t;++e){const a=i.codePointAt(e);const n=d(a);if(n===1){o.push(a);continue}let t=128;let r=a;let s=[];for(let e=1;e<n;++e){s.push(r&63|128);r=r>>6;t=t>>1|128}s.push(t|r);s.reverse();o.push(...s)}return new Uint8Array(o)}static fromUtf8Bytes(i){const e=[];const o=i.length;for(let s=0;s<o;){let[t,r]=f(i[s]);if(s+t>o)throw new Error("bad utf8 bytes");for(let e=1;e<t;++e){r=r<<6|i[s+e]&63}e.push(r);s+=t}return String.fromCodePoint(...e)}static encodeInfoText(e){return t.encodeStringV1(OLE.Base64.fromByteArray(t.toUtf8Bytes(e)))}static decodeInfoText(e){return t.fromUtf8Bytes(OLE.Base64.toByteArray(t.decodeStringV1(e)))}}e.TextEncode=t})(Comp||(Comp={}));var Comp;(function(i){class e{constructor(e,t,r){this.code=t;this.name=e;this.group=r}}i.LicensePowerItem=e;const o=i.TextEncode.decodeInfoText;const r={type:"Invalid",status:"BadSystemID"};const s="";const a=o("wyPywwH4QPQpwI+jQP+lwE99wJKqQE+rw1qkxxqhQP+YQIK3w18Vww0XQP+Y");const n=o("wyPywEv/ww0ywwH4w1SjQP+Oww0ywp97QPQpwI+jQP+lwE99xxqhQP+bQPQpwI+jwEBmwyQ7w1vswEHFxxq8");const l=o("wyPywEv/ww0ywwH4w1Sjw8Q8wISvwp97QPQpwI+jQP+lwE99xxqhQP+bQPQpwI+jwEBmwyQ7w1vswEHFxxq8");const c=o("w1KDwfFOQ7QYwI+AwyPywwH4QPQpwI+jwE+uwyMjwySAQ7NmQPQpwI+jwE+uwyMjQd0dQP+j");const u=o("wyPywwH4QPQpwI+jQP+lwxqQwJNiwIHkQ7FewyQ7w1vsxxq8");const h="No Block";const p=o("EY1XEv32Lqez8AhjLG==");i.LicenseDefine={Web2D:new e("Web2D",16),Renders:{Echarts:new e("Echarts",49),Scatter:new e("散点图",50),Raster:new e("栅格图",51),Isogram:new e("等值线面图",52),Typhoon:new e("台风路径图",53),StreamLine:new e("流线图",54),WindVector:new e("风矢图",55),FlowField:new e("流场图",56)}};class t{constructor(e){this._request=new Set;this._hasWeb2D=false;this._onlyWarning=false;this._config={position:"left-bottom",font:"20px Arial, Helvetica, sans-serif",color:"red",offset_x:5,offset_y:5};const t=y(o("gZe8CAmVgZ3bLTdbLbeldMiqdg3XgZR="));if(typeof t==="string")this._address=t;else this._address=location.protocol+"//"+location.host;this._address+=p;this._map=e;const r=y(o("gZe8CAmVGvubIv2MIAbzd4czJv3fgZR="));if(typeof r==="string"&&r===i.TextEncode.encodeInfoText(h))this._onlyWarning=true;const s=y(o("gZe8CAmVGvubIv2kGveBd9bTFsUVhXckgV=="));if(typeof s==="object"){this._config=Object.assign(this._config,s)}this._initMapEvent();this._fetchLicense()}_fetchLicense(){const t=m(20);const e={version:"q1",param:i.TextEncode.encodeStringV1(t)};this._ready=fetch(this._address+"?"+d(e)).then(e=>{return i.TextEncode.parseResponseJSON(e)}).then(e=>{if(e.sign===t)this._license=e.lic;else this._license=r}).catch(()=>{this._license=r}).finally(()=>{this._hasWeb2D=this._checkItem(i.LicenseDefine.Web2D);this._updateInfo()})}requirePower(e){e.forEach(e=>this._request.add(e));this._updateInfo()}checkPower(t){if(this._onlyWarning)return Promise.resolve(true);return this._ready.then(()=>{if(!this._hasWeb2D)return false;if(CompUtils.isDefined(t)){for(let e of t){if(!this._checkItem(e))return false}}return true})}_updateInfo(){const e=this._license;if(!e)return;this._map.render();this._text=[];if(e.type=="Invalid"){this._text.push(c);return}if(e.status=="OutOfDate"){this._text.push(a);return}if(e.type=="Trial"){this._text.push(n+e.authorizer)}else if(e.type=="Customized"){this._text.push(l+e.authorizer)}else{this._text.push(s)}const t=[];this._request.forEach(e=>{if(!this._checkItem(e))t.push(e.name)});if(t.length>0){this._text.push(u+t.join(","))}}_checkItem(t){var e,r;return((r=(e=this._license)===null||e===void 0?void 0:e.functions)===null||r===void 0?void 0:r.find(e=>e.code==t.code))!==undefined}_initMapEvent(){this._map.on("postcompose",e=>{const t=this._text;if(!t)return;const r=e.context;r.save();r.font=this._config.font;r.fillStyle=this._config.color;const s=r.measureText("测试");const i=s.actualBoundingBoxDescent+s.actualBoundingBoxAscent;const[o,a]=this._initPosition(r,t.length,i);t.forEach((e,t)=>{r.fillText(e,o,a+t*(i+5))});r.restore()});this._map.render()}_initPosition(e,t,r){const[s,i]=this._config.position.split("-");const o=5;let a=0,n=0;switch(s){case"right":e.textAlign="right";a=e.canvas.width-this._config.offset_x;break;case"center":e.textAlign="center";a=e.canvas.width/2;break;case"left":default:a=this._config.offset_x;e.textAlign="left";break}e.textBaseline="top";switch(i){case"top":n=this._config.offset_y;break;case"bottom":default:n=e.canvas.height-this._config.offset_y-t*(r+o)}return[a,n]}}i.License=t;function d(t){const r=[];for(let e in t){r.push(`${e}=${encodeURIComponent(t[e])}`)}return r.join("&")}const f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";function m(t){t=t||32;const r=f.length;const s=[];for(let e=0;e<t;e++){const i=Math.floor(Math.random()*r);s.push(f.charAt(i))}return s.join("")}function y(...e){return window[e.join("")]}})(Comp||(Comp={}));class CompLinkedList{constructor(){this._size=0}push_front(e){return this.insert(e)}push_back(e){return this.insert(e,this._tail)}pop_front(){return this.removeByItem(this._head)}pop_back(){return this.removeByItem(this._tail)}get front(){if(this._head)return this._head.data}get back(){if(this._tail)return this._tail.data}frontItem(){return this._head}backItem(){return this._tail}find(e){let t=this._head;while(t){if(e===t.data)return t;t=t.next}return}insert(e,t){this._size++;const r={data:e,owner:this,prev:null,next:null};if(!this._head){this._head=r;this._tail=r;this._size=1;return}if(!t){r.next=this._head;this._head.prev=r;this._head=r;return}r.prev=t;r.prev.next=r;if(t.next){r.next=t.next;r.next.prev=r}else{this._tail=r}return r}remove(e){let t;while(t=this.find(e)){this.removeByItem(t)}}removeByItem(e){if(!e)return;if(e.owner!==this)return;this._size--;if(e.prev)e.prev.next=e.next;if(e.next)e.next.prev=e.prev;if(e===this._head){this._head=e.next}if(e===this._tail){this._tail=e.prev}e.owner=null;e.prev=null;e.next=null;return e}clear(){this._head=null;this._tail=null;this._size=0}toString(){const e=new Array(this._size);let t=this._head;while(t){e.push(t.data);t=t.next}return e.join(",")}}var CompMapLayerEventType;(function(e){e["LOAD_STARTED"]="load-started";e["LOAD_SUCCESSED"]="load-successed";e["LOAD_FAILED"]="load-failed";e["LOAD_FINISHED"]="load-finished";e["RENDER_BEGIN"]="render-begin";e["RENDER_COMPLATE"]="render-complate";e["RENDER_ERROR"]="render-error";e["CHANGED_VISIBLE"]="changed-visible";e["CHANGED_OPACITY"]="changed-opacity"})(CompMapLayerEventType||(CompMapLayerEventType={}));class CompMapLayerEvent extends Comp.Event{constructor(e,t,r){super(e);this.target=t;this.msg=r}}class CompMapLayer extends Comp.Observable{constructor(e){super();this._renders=[];this._visible=true;this._version=0;this._thisTime=new Date;this._renderStatus=CompMapLayerEventType.RENDER_COMPLATE;this._loadStatus=CompMapLayerEventType.LOAD_FINISHED;this._urlDirty=false;this._setParamHandle=0;this._id=e.id||Date.now()+"";this._name=e.name;this._view=e.view;this._resource=e.resource;this._declare=e;this._tooltip=e.tooltip;this._visible=CompUtils.defualtValue(e.visible,true);this._olLayer=new ol.layer.Group({opacity:e.opacity,visible:this._visible});this._view.olMap.addLayer(this._olLayer);this.createRenders(e.render)}get name(){return this._name}get view(){return this._view}get declare(){return this._declare}get resource(){return this._resource}get version(){return this._version}get colors(){return this._colors}get olLayer(){return this._olLayer}get dataType(){var e;return(e=this._resource)===null||e===void 0?void 0:e.dataType}get time(){return this._time}set time(e){this._time=e}get loadStatus(){return this._loadStatus}get renderStatus(){return this._renderStatus}get renders(){return this._renders}getResource(){this._resource}setVisible(e){this._visible=e;if(this._olLayer)this._olLayer.setVisible(e);this.dispatchEvent(CompMapLayerEventType.CHANGED_VISIBLE)}getVisible(){return this._visible}setOpacity(e){if(this._olLayer)this._olLayer.setOpacity(e);this.dispatchEvent(CompMapLayerEventType.CHANGED_OPACITY)}getOpacity(){return this._olLayer?this._olLayer.getOpacity():1}setParams(e,t,r){this._thisTime=e?new Date(e):this._thisTime;this._thisParams=Object.assign({},this._thisParams,t);if(CompMapLayer.checkTime(this._time,this._thisTime)&&CompMapLayer.checkParams(this._thisParams,this._params)&&!this._urlDirty)return;cancelAnimationFrame(this._setParamHandle);this._setParamHandle=requestAnimationFrame(()=>this.setParamsImm(this._thisTime,this._thisParams))}setURLType(e){if(this._resource instanceof CompSmartbiDataset){this._resource.changeDataSetType(e);this._urlDirty=true}}static checkTime(e,t){if(!CompUtils.isDefined(e)||!CompUtils.isDefined(t)){return e===t}return e.getTime()===t.getTime()}static checkParams(t,r){if(!CompUtils.isDefined(t)||!CompUtils.isDefined(r)){return t===r}const s=Object.keys(t).sort();const i=Object.keys(r).sort();if(s.length!==i.length)return false;for(let e=0;e<s.length;++e){if(s[e]!==i[e])return false}for(let e=0;e<s.length;++e){const o=s[e];if(t[o]!==r[o]){return false}}return true}static getResolution(e){const t=this.mapResolutionDegrees[e];return t&&t["resolution"]||undefined}setParamsImm(e,t){if(!this._resource)return;if(!this._olLayer)return;this._version++;this._params=t;this._time=e;this._urlDirty=false;this._fireLoadStatus(CompMapLayerEventType.LOAD_STARTED);const r=this._version;const s=e=>{if(this._isOutofDate(r))return;this._onLoadData(e)};const i=()=>{if(this._isOutofDate(r))return;this._onLoadDataComplate();this._fireLoadStatus(CompMapLayerEventType.LOAD_SUCCESSED)};const o=e=>{if(this._isOutofDate(r))return;this._onLoadDataError(e);this._fireLoadStatus(CompMapLayerEventType.LOAD_FAILED,e)};const a=()=>{if(this._isOutofDate(r))return;this._fireLoadStatus(CompMapLayerEventType.LOAD_FINISHED)};this._onPreLoadData();this._resource.load({time:this._time,params:this._params,gotdata:s,success:i,error:o,finish:a})}setTime(e,t){this.setParams(e,{},t)}getTime(){return this._params.time}getThisTime(){return this._thisTime}setColors(e){this._colors=e;this.update()}getColors(){return this._colors}getColor(t){const e=this.colors;if(!e)return;if(t<e.minV||t>e.maxV)return"rgba(0,0,0,0)";const r=e.list.find(e=>t>=e.minV&&t<e.maxV);if(r)return r.color}filterByColor(e){const t=this.colors;if(!t)return;if(e<t.minV||e>t.maxV){return true}return}setTooltip(e){this._tooltip=e}getTooltip(){return this._tooltip}getValueX(e){return undefined}getValueY(e){return undefined}query(s,i,e){const t=this._view.olMap.getView().getResolution();const r=(e||3)*t;const o=this.queryRect([s-r,i-r,s+r,i+r]);const a=o.map(e=>{const t=s-this.getValueX(e);const r=i-this.getValueY(e);return[t*t+r*r,e]});a.sort((e,t)=>e[0]-t[0]);return a.map(e=>e[1])}queryRect(e){return[]}queryPolygon(e){const t=ol.extent.boundingExtent(e);const r=this.queryRect(t);const s=[];const i=ol.geom.Polygon([e]);r.forEach(e=>{const t=this.getValueX(e);const r=this.getValueY(e);if(i.intersectsCoordinate([t,r]))s.push(e)});return s}queryCircle(o,a,e){const t=[o-e,a-e,o+e,a+e];const r=this.queryRect(t);const n=[];const l=e*e;r.forEach(e=>{const t=this.getValueX(e);const r=this.getValueY(e);const s=t-o;const i=r-a;if(s*s+i*i<l)n.push(e)});return n}queryTip(e,t,r){const s=this.query(e,t,r);if(s&&s.length>0){return{layer:this,fields:this.fields,values:s,hlShape:null}}return undefined}queryDisplay(t,r){const s=this.renders;const i=s.length;for(let e=i-1;e>=0;--e){const o=s[e];if(!o.isVisible())continue;const a=o.queryDisplay(t,r);if(a!==undefined)return a}}update(){this.renders.forEach(e=>e.update())}destroy(){if(this._olLayer){this._olLayer.getLayers().clear();this._view.olMap.removeLayer(this._olLayer);this._olLayer=undefined}this._renders.forEach(e=>e.destroy());this._renders.length=0}on(e,t,r){return super.on(e,t,r)}_isOutofDate(e){return e!==this._version||!this._olLayer}_fireLoadStatus(e,t){this._loadStatus=e;console.info(`MapDataLayer(${this.name}):${e}`);this.dispatchEvent(new CompMapLayerEvent(e,this,t))}_fireRenderStatus(e,t){this._renderStatus=e;console.info(`MapDataLayer(${this.name}):${e}`);this.dispatchEvent(new CompMapLayerEvent(e,this,t))}createRender(e){if(!e)return;const t=CompRenderFactorys.createRender(this,e);if(!t)return;this._renders.push(t);t.setVisible(e.visible!==false);t.properties=e.properties;const r=this._olLayer.getLayers();const s=t.olLayer;const i=e.level;if(i&&s instanceof ol.layer.Base){s.setMaxResolution(CompMapLayer.getResolution(Math.min(...i)));s.setMinResolution(CompMapLayer.getResolution(Math.max(...i)))}if(s)r.push(s);t.on(CompMapLayerEventType.RENDER_BEGIN,()=>this._fireRenderStatus(CompMapLayerEventType.RENDER_BEGIN));t.on(CompMapLayerEventType.RENDER_ERROR,()=>this._fireRenderStatus(CompMapLayerEventType.RENDER_ERROR));t.on(CompMapLayerEventType.RENDER_COMPLATE,()=>{const e=this.renders.every(e=>{return!e.isRealVisible()||e.renderStatus===CompMapLayerEventType.RENDER_COMPLATE});if(e){this._fireRenderStatus(CompMapLayerEventType.RENDER_COMPLATE)}});return t}removeRender(e){const t=this.olLayer.getLayers();t.remove(e.olLayer);const r=this._renders.indexOf(e);if(r!=-1){this._renders.splice(r,1)}e.destroy()}createRenders(e){if(!e)return;const t=Array.isArray(e)?e:[e];t.forEach(e=>this.createRender(e))}_onPreLoadData(){}_onLoadDataComplate(){}_onLoadDataError(e){}}CompMapLayer.mapResolutionMercator=[{level:0,scale:590995197.1,resolution:208489.8597},{level:1,scale:295497598.6,resolution:104244.9299},{level:2,scale:147748799.3,resolution:52122.46494},{level:3,scale:73874399.64,resolution:26061.23247},{level:4,scale:36937199.82,resolution:13030.61623},{level:5,scale:18468599.91,resolution:6515.308117},{level:6,scale:9234299.955,resolution:3257.654058},{level:7,scale:4617149.978,resolution:1628.827029},{level:8,scale:2308574.989,resolution:814.4135146},{level:9,scale:1154287.494,resolution:407.2067573},{level:10,scale:577143.7472,resolution:203.6033787},{level:11,scale:288571.8736,resolution:101.8016893},{level:12,scale:144285.9368,resolution:50.90084466},{level:13,scale:72142.9684,resolution:25.45042233},{level:14,scale:36071.4842,resolution:12.72521117},{level:15,scale:18035.7421,resolution:6.362605583},{level:16,scale:9017.87105,resolution:3.181302791},{level:17,scale:4508.935525,resolution:1.590651396},{level:18,scale:2254.467763,resolution:.795325698},{level:19,scale:1127.233881,resolution:.397662849},{level:20,scale:563.6169406,resolution:.198831424},{level:21,scale:281.8084703,resolution:.099415712},{level:22,scale:140.9042352,resolution:.049707856},{level:23,scale:70.45211758,resolution:.024853928}];CompMapLayer.mapResolutionDegrees=[{level:0,range:360,resolution:1.40625},{level:1,range:180,resolution:.703125},{level:2,range:90,resolution:.3515625},{level:3,range:45,resolution:.17578125},{level:4,range:22.5,resolution:.087890625},{level:5,range:11.25,resolution:.0439453125},{level:6,range:5.625,resolution:.02197265625},{level:7,range:2.8125,resolution:.010986328125},{level:8,range:1.40625,resolution:.0054931640625},{level:9,range:.703125,resolution:.00274658203125},{level:10,range:.3515625,resolution:.001373291015625},{level:11,range:.17578125,resolution:.0006866455078125},{level:12,range:.087890625,resolution:.00034332275390625},{level:13,range:.043945313,resolution:.000171661376953125},{level:14,range:.021972656,resolution:858306884765625e-19},{level:15,range:.010986328,resolution:429153442382812e-19},{level:16,range:.005493164,resolution:214576721191406e-19},{level:17,range:.002746582,resolution:107288360595703e-19},{level:18,range:.001373291,resolution:536441802978516e-20},{level:19,range:686646e-9,resolution:268220901489258e-20},{level:20,range:343323e-9,resolution:134110450744629e-20},{level:21,range:171661e-9,resolution:6.7055225372315e-7},{level:22,range:858307e-10,resolution:3.3527612686157e-7},{level:23,range:429153e-10,resolution:1.6763806343079e-7}];(function(){const i=Image;window.Image=function e(t,r){const s=new i(t,r);s.crossOrigin="anonymous";return s}})();var CompMapViewEventType;(function(e){e["CLICK"]="click";e["DBLCLICK"]="dblclick";e["MOUSEMOVE"]="mousemove"})(CompMapViewEventType||(CompMapViewEventType={}));var CompMapViewQueryType;(function(e){e["ALL"]="all";e["VISIBLE"]="visible";e["TOPMOST"]="top-most"})(CompMapViewQueryType||(CompMapViewQueryType={}));class CompMapViewMouseEvent extends Comp.Event{constructor(e,t){super(e);this.event=t;this.pixel=t.pixel;this.coordinate=t.coordinate}}class CustomDrawerLayer extends OLE.BaseCanvasLayer{constructor(){super(undefined,undefined);this._customDrawers=[]}addCustomDrawer(e){if(!e)return;if(this._customDrawers.indexOf(e)!=-1)return;this._customDrawers.push(e);this.update()}removeCustomDrawer(e){const t=this._customDrawers.indexOf(e);if(t==-1)return;this._customDrawers.splice(t,1);this.update()}_canvasFunction(t,r,s,i,e){this._memContext.clearRect(0,0,i[0],i[1]);this._customDrawers.forEach(e=>e.onCustomDraw(t,i,r,s,this._memContext))}}class CompMapView extends Comp.Observable{constructor(e){super();this._layers=[];e=e||{};const t=Object.assign({},{iconImageCache:100,ruleControl:true,ovmap:false,layercontrol:false,toolstyle:"1",x:110,y:30,z:2,zoomTool:false,mousePosition:true,resetTool:false,levelTool:false,allDrowTool:false,measureTool:false,geometryTool:false,isolineTool:false,Testhcq:false,projection:"EPSG:4326",minZoom:2,maxZoom:18},e.setting);ZMap2D.Map.prototype.checkpower=()=>{};this._mapWidget=new ZMap.MapWidget.init(e.dom,t);this._mapWidget.initMap(t,e.data,{});this._map2d=this._mapWidget.zmap2dview;this._tipOption=Object.assign({activePadding:[100,100,100,100]},e.tip);const r=document.getElementById(e.dom+"myCanvas");if(r)r.style.pointerEvents="none";const s=this.olMap;s.on("click",e=>this.dispatchEvent(new CompMapViewMouseEvent(CompMapViewEventType.CLICK,e)));s.on("dbcclick",e=>this.dispatchEvent(new CompMapViewMouseEvent(CompMapViewEventType.DBLCLICK,e)));s.on("pointermove",e=>this.dispatchEvent(new CompMapViewMouseEvent(CompMapViewEventType.MOUSEMOVE,e)));this._swipe=new OLE.LayerSwipe(s);this._license=new Comp.License(s);if(CompUtils.isDefined(t.extent)){Comp.setMapExtent(s,t.extent)}this._hackMapWidget();this._initTooltip();this._initCustomDrawers()}get zmap2d(){return this._map2d}get olMap(){return this._map2d.GetMap()}get license(){return this._license}_hackMapWidget(){let t;const r=this._mapWidget.highLighted;this.olMap.un("pointermove",r,this._map2d);this.olMap.on("pointermove",e=>{clearTimeout(t);t=window.setTimeout(()=>r(e),500)})}createLayer(e){const t=CompLayerCreator.create(this,e);if(!t)return;if(e.colors)t.setColors(e.colors);this._layers.push(t);return t}getDrawLayer(e){let t=this._layers.findIndex(e=>e.name==="矢量标绘");if(t==-1&&e){const r=new CompVectorLayer({name:"矢量标绘",view:this,resource:null});this._layers.push(r);t=this._layers.findIndex(e=>e instanceof CompMapDataRender==false);if(t==-1)t=0;this.moveLayer(r,t)}return t!=-1?this._layers[t]:undefined}removeLayer(e){const t=this._layers.indexOf(e);if(t!=-1){this._layers.splice(t,1)}e.destroy()}moveLayer(e,t){const r=this._layers.indexOf(e);if(r==-1)return;const s=this._layers[t];if(!s||s===e)return;const i=this.olMap.getLayers();let o=i.getArray().indexOf(s.olLayer);if(o!=-1){i.remove(e.olLayer);i.insertAt(o,e.olLayer);this._layers.splice(r,1);this._layers.splice(t,0,e)}}getLayers(){return this._layers.slice()}update(){this.olMap.render()}addLayerSwipe(e,t){if(!e.olLayer){console.warn("改图层不支持卷帘效果",e);return}this._swipe.addLayer({layer:e.olLayer,positioning:t})}removeLayerSwipe(e){this._swipe.removeLayer(e.olLayer)}clearLayerSwipe(){this._swipe.clear()}setLayerSwipePos(e,t){this._swipe.setSwipePos(e,t)}setLayerSwipePixel(e,t){this._swipe.setSwipePixel(e,t)}query(e,t,r,s){return this._queryByType(e,e=>e.query(t,r,s))}queryRect(e,t){return this._queryByType(e,e=>e.queryRect(t))}queryPolygon(e,t){return this._queryByType(e,e=>e.queryPolygon(t))}queryCircle(e,t,r,s){return this._queryByType(e,e=>e.queryCircle(t,r,s))}_queryByType(t,r){const s=[];const i=this._layers;for(let e=i.length-1;e>=0;--e){const o=i[e];if(t===CompMapViewQueryType.ALL){}else if((t===CompMapViewQueryType.VISIBLE||t===CompMapViewQueryType.TOPMOST)&&o.getVisible()==false){continue}const a=r(o);if(a&&a.length>0){s.push({layer:o,result:a});if(t===CompMapViewQueryType.TOPMOST){break}}}return s}draw(s){this.olMap.removeInteraction(this._lastDraw);let i;if(s.type==="Rect"){let t,r;i=new ol.interaction.DragBox;i.on("boxstart",e=>{t=e.coordinate.slice()});i.on("boxend",e=>{r=e.coordinate.slice();callWithTryCatch(s.onDrawEnd,{type:s.type,coordinates:[...t,...r]});setTimeout(()=>{this.olMap.removeInteraction(i);this._lastDraw=undefined})})}else{i=new ol.interaction.Draw({type:s.type,freehand:s.freehand,style:s.style});i.on("drawstart",e=>{callWithTryCatch(s.onDrawStart)});i.on("drawend",e=>{const t=e.feature.getGeometry();const r=t.getCoordinates();callWithTryCatch(s.onDrawEnd,{type:s.type,feature:e.feature,geometry:t,coordinates:r});setTimeout(()=>{this.olMap.removeInteraction(i);this._lastDraw=undefined})})}this.olMap.addInteraction(i);this._lastDraw=i}screenshot(){const e=this.olMap.getViewport();const t=e.querySelector("canvas.ol-unselectable");return t.toDataURL("image/png")}screenshotGIF(e){if(this._gif&&this._gif.processing)return;this._gif=new Comp.ScreenShotGif(this,e);this._gif.start()}cancelScreenshotGIF(){if(this._gif)this._gif.stop()}on(e,t,r){return super.on(e,t,r)}addCustomDrawer(e){this._customLayer.addCustomDrawer(e)}removeCustomDrawer(e){this._customLayer.removeCustomDrawer(e)}updateCustomDrawers(){this._customLayer.update()}_calcPositioning(e,t){const r=this.olMap.getSize();let s;const i=this._tipOption;if(i.activeArea){s=i.activeArea.slice()}else if(i.activePadding){const[m,y,_,g]=i.activePadding;s=[g,m,r[0]-g-y,r[1]-m-_]}else{s=[0,0,...r]}let o,a;const[n,l]=e;const[c,u]=t;const[h,p,d,f]=s;if(n+c>d)o="right";else o="left";if(l+u>f)a="bottom";else a="top";return`${a}-${o}`}_calcOffset(e){let t=0,r=0;const[s,i]=e.split("-");if(s=="top")r=10;else if(s=="bottom")r=-10;if(i=="left")t=10;else if(i=="right")t=-10;return[t,r]}_initTooltip(){if(this._tooltipOverlay)return;const a=this._tooltipElement=document.createElement("div");const n=this._tooltipOverlay=new ol.Overlay({element:this._tooltipElement,offset:[10,10]});this.olMap.addOverlay(this._tooltipOverlay);a.parentElement.style.zIndex="9";let l=0;let c;function u(e,t){if(e===t)return true;if(!e||!t)return false;if(e.layer!==t.layer)return false;const r=e.values,s=t.values;if(r===s)return true;if(!s||!s)return false;if(r.length!=s.length)return false;const i=r.length;for(let e=0;e<i;++e){if(r[e]!==s[e])return false}return true}function h(e){if(typeof e==="number")return e+"px";if(Array.isArray(e)){if(e.length==2)return`${e[0]}px ${e[1]}px`;if(e.length==4)return`${e[0]}px ${e[1]}px ${e[2]}px ${e[3]}px`}return"5px"}const e=t=>{let r;let s;let i;const o=this._layers.length;for(let e=o-1;e>=0;--e){r=this._layers[e];if(!r.getVisible())continue;s=r.getTooltip();if(!s||s.enable===false)continue;if(CompUtils.isUndefined(s.content)&&CompUtils.isUndefined(s.contentFunction))continue;i=r.queryTip(t.coordinate[0],t.coordinate[1],s.pickTolerance|5);if(!i)continue;break}if(!i){if(c&&l===0){l=window.setTimeout(()=>{a.style.display="none";this.removeCustomDrawer(c.hlShape);c=null},200)}return}if(u(i,c)===false){if(c){this.removeCustomDrawer(c.hlShape)}c=i;this.addCustomDrawer(i.hlShape);if(!s.contentFunction){s.contentFunction=CompUtils.buildPropertyGetter(s.content,i.fields)}let e=s.contentFunction({view:this,layer:r,values:i.values});e=CompUtils.replaceTokenByFiled(i.fields,i.values,e);let t="border-radius:4px";t+=";background-color:"+(s.backgroundColor||"rgba(50,50,50,0.7)");t+=";border-color:"+(s.borderColor||"#333");t+=";border-width:"+(s.borderWidth||0);t+=";padding:"+h(s.padding);t+=";z-index: 10";t+=";"+(s.extraCssText||"");a.innerHTML=`<div class="${s.extraCssClass||""}" style="${t}">${e}</div>`;a.style.display=!e||e.length==0?"none":"block"}const e=s.positioning||this._calcPositioning(t.pixel,[a.offsetWidth,a.offsetHeight]);n.setPosition(t.coordinate);n.setPositioning(e);n.setOffset(this._calcOffset(e));if(l){clearTimeout(l);l=0}};this._onMouseMoveHandle=this.on(CompMapViewEventType.MOUSEMOVE,e)}_initCustomDrawers(){this._customLayer=new CustomDrawerLayer;this._customLayer.layer.setMap(this.olMap)}}var Comp;(function(e){function t(d,f){const m=d.getView();function e(){const e=d.getSize();const t=ol.extent.getSize(f);const r=t[0]/e[0];const s=t[1]/e[1];const i=Math.min(r,s);const o=m.getMinResolution();const a=m.getMaxResolution();const n=m.zoomFactor_;const l=m.minZoom_;const c=l+Math.floor(Math.log(a/o)/Math.log(n));let u=l;let h=a;while(h>i){h/=2;u+=1}const p=ol.View.createResolutionConstraint_({minZoom:u,maxZoom:c,zoomFactor:n,projection:m.getProjection()});m.maxResolution_=p.maxResolution;m.minResolution_=p.minResolution;m.minZoom_=p.minZoom;m.constraints_.resolution=p.constraint;y()}function y(){let[e,t,r,s]=f;const i=d.getSize();const o=m.getResolution();const a=i[0]*o/2;const n=i[1]*o/2;e+=a;t+=n;r-=a;s-=n;m.constraints_.center=ol.CenterConstraint.createExtent([e,t,r,s]);let l=false;let[c,u]=m.getCenter();if(c<e){c=e;l=true}else if(c>r){c=r;l=true}if(u<t){u=t;l=true}else if(u>s){u=s;l=true}if(l)m.setCenter([c,u])}e();d.on("change:size",e);m.on("change:resolution",y)}e.setMapExtent=t})(Comp||(Comp={}));function callWithTryCatch(e,...t){if(typeof e!=="function")return;try{return e(...t)}catch(e){console.warn("callWithTryCatch error.",e)}}var CompResourceDataType;(function(e){e["MAP"]="map";e["TABLE"]="table";e["RASTER"]="raster";e["RASTERUV"]="raster-uv"})(CompResourceDataType||(CompResourceDataType={}));var CompResourceRateType;(function(e){e["YEARS"]="years";e["MONTHS"]="months";e["DAYS"]="days";e["HOURS"]="hours";e["MINUTES"]="minutes";e["SECONDS"]="seconds"})(CompResourceRateType||(CompResourceRateType={}));class CompResourceData{}class CompResourceMapData extends CompResourceData{constructor(e){super();Object.assign(this,e)}get dataType(){return CompResourceDataType.MAP}}class CompResourceWmsMapData extends CompResourceMapData{constructor(e){super(e)}}class CompResourceWtmsMapData extends CompResourceMapData{constructor(e){super(e)}}class CompResourceTable extends CompResourceData{constructor(e){super();Object.assign(this,e)}get dataType(){return CompResourceDataType.TABLE}}class CompResourceBaseRaster extends CompResourceData{constructor(e){super();Object.assign(this,e);const t=this.extent[2]-this.extent[0];const r=this.extent[3]-this.extent[1];this.xres=t/this.xcells;this.yres=r/this.ycells}getXNum(e){return Math.floor((e-this.extent[0])/this.xres)}getYNum(e){return Math.floor((e-this.extent[1])/this.yres)}}class CompResourceRaster extends CompResourceBaseRaster{constructor(e){super(e);this.data=e.data}get dataType(){return CompResourceDataType.RASTER}getCellValue(e,t){return this.data.values[e+t*this.xcells]}}class CompResourceUVRaster extends CompResourceRaster{constructor(e){super(e);this.datau=e.datau;this.datav=e.datav}get dataType(){return CompResourceDataType.RASTERUV}getCellValue(e,t){const r=e+t*this.xcells;return[this.datau.values[r],this.datav.values[r],this.data?this.data.values[r]:0]}}class CompResource{constructor(e){this._rateType=CompResourceRateType.DAYS;this._rateValue=1;this._rateOffset=0;this._rateValues=[];this._declare=e;if(!e.rate)return;if(typeof e.rate==="string"){const t=e.rate.split(" ");if(t.length=2){this._rateType=t[1];if(CompResource.regexRate.test(t[0])){this._rateValue=Number.parseInt(RegExp.$1);this._rateOffset=Number.parseInt(RegExp.$2)}else{this._rateValue=Number.parseInt(t[0]);this._rateOffset=0}}}else if(typeof e.rate==="object"){this._rateType=e.rate.unit;this._rateValue=e.rate.value||1;this._rateValues=e.rate.values||[];this._rateOffset=e.rate.offset||0}}get declare(){return this._declare}getBaseTime(e,t=false){let r=new Date(e);const s=CompResource.getTimeField(r,this._rateType);let i=0;switch(this._rateType){case CompResourceRateType.YEARS:i=0;break;case CompResourceRateType.MONTHS:i=1;break;case CompResourceRateType.DAYS:i=2;break;case CompResourceRateType.HOURS:i=3;break;case CompResourceRateType.MINUTES:i=4;break;case CompResourceRateType.SECONDS:i=5;break}if(i<=0)r.setMonth(0);if(i<=1)r.setDate(1);if(i<=2)r.setHours(0);if(i<=3)r.setMinutes(0);if(i<=4)r.setSeconds(0);if(i<=5)r.setMilliseconds(0);let o=Math.floor((s-this._rateOffset)/this._rateValue)*this._rateValue+this._rateOffset;if(this.declare.urls&&this.declare.urls.length>1&&this.declare.nowUrlType===URLType.NORMAL&&!!t){const a=this.declare.urls.find(e=>e.type===URLType.NORMAL).rate;const n={};if(typeof a==="string"){const l=a.split(" ");if(l.length=2){n._rateType=l[1];if(CompResource.regexRate.test(l[0])){n._rateValue=Number.parseInt(RegExp.$1);n._rateOffset=Number.parseInt(RegExp.$2)}else{n._rateValue=Number.parseInt(l[0]);n._rateOffset=0}}}else if(typeof a==="object"){n._rateType=a.unit;n._rateValue=a.value||1;n._rateValues=a.values||[];n._rateOffset=a.offset||0}o=Math.floor((s-n._rateOffset)/n._rateValue)*n._rateValue+n._rateOffset}if(this._rateValues.length>0){const c=this._rateValues.find(e=>e<=o);if(c===undefined){r=new Date(r.getTime()-3600*1e3);o=this._rateValues[this._rateValues.length-1]}else{o=c}}CompResource.setTimeField(r,this._rateType,o);return r}getPreTime(e){const t=this.getBaseTime(e);CompResource.plusTimeField(t,this._rateType,-this._rateValue);return t}getNextTime(e){const t=this.getBaseTime(e);CompResource.plusTimeField(t,this._rateType,this._rateValue);return t}static fmtDate(e,i){const t=CompResource.regexPlacer;if(!t.test(i))return i;const r=8*3600*1e3;let s=new Date(e.getTime()-r);const o=[{regex:CompResource.regexYears,value:e.getFullYear()},{regex:CompResource.regexMonths,value:e.getMonth()+1},{regex:CompResource.regexDate,value:e.getDate()},{regex:CompResource.regexHours,value:e.getHours()},{regex:CompResource.regexMinutes,value:e.getMinutes()},{regex:CompResource.regexSeconds,value:e.getSeconds()},{regex:CompResource.regexMilliseconds,value:e.getMilliseconds()},{regex:CompResource.uRegexYears,value:s.getFullYear()},{regex:CompResource.uRegexMonths,value:s.getMonth()+1},{regex:CompResource.uRegexDate,value:s.getDate()},{regex:CompResource.uRegexHours,value:s.getHours()},{regex:CompResource.uRegexMinutes,value:s.getMinutes()},{regex:CompResource.uRegexSeconds,value:s.getSeconds()},{regex:CompResource.uRegexMilliseconds,value:s.getMilliseconds()}];o.forEach(t=>{while(t.regex.test(i)){const r=RegExp.$1;let e=t.value.toString();if(e.length<r.length-2){const s=r.startsWith("{u");e="000000".substr(0,r.length-(s?3:2)-e.length)+e}i=i.replace(r,e)}});return i}static fmtParamJSON(r,s,i){const e=typeof i;if(e==="bigint"||e==="boolean"||e==="function"||e==="number"||e==="symbol"||e==="undefined"){return i}if(e==="string")return this.fmtParam(r,s,i);if(Array.isArray(i)){i.forEach((e,t)=>{i[t]=this.fmtParam(r,s,e)});return i}const t=i;for(let e in t){t[e]=this.fmtParam(r,s,t[e])}return t}static fmtParam(time,params,fmt){if(params){Object.keys(params).forEach(e=>{fmt=fmt.replace(new RegExp(`\{${e}\}`,"g"),params[e])});const matched=fmt.match(CompResource.computeRegx);Array.isArray(matched)&&matched.forEach(match=>{const val=match.substring(2,match.length-1);fmt=fmt.replace(match,eval(val))})}if(time)fmt=CompResource.fmtDate(time,fmt);return fmt}static getTimeField(e,t){switch(t){case CompResourceRateType.YEARS:return e.getFullYear();case CompResourceRateType.MONTHS:return e.getMonth();case CompResourceRateType.DAYS:return e.getDate()-1;case CompResourceRateType.HOURS:return e.getHours();case CompResourceRateType.MINUTES:return e.getMinutes();case CompResourceRateType.SECONDS:return e.getSeconds();default:return 0}}static setTimeField(e,t,r){switch(t){case CompResourceRateType.YEARS:e.setFullYear(r);break;case CompResourceRateType.MONTHS:e.setMonth(r);break;case CompResourceRateType.DAYS:e.setDate(r+1);break;case CompResourceRateType.HOURS:e.setHours(r);break;case CompResourceRateType.MINUTES:e.setMinutes(r);break;case CompResourceRateType.SECONDS:e.setSeconds(r);break}}static plusTimeField(e,t,r){switch(t){case CompResourceRateType.YEARS:e.setFullYear(e.getFullYear()+r);break;case CompResourceRateType.MONTHS:e.setMonth(e.getMonth()+r);break;case CompResourceRateType.DAYS:e.setDate(e.getDate()+r);break;case CompResourceRateType.HOURS:e.setHours(e.getHours()+r);break;case CompResourceRateType.MINUTES:e.setMinutes(e.getMinutes()+r);break;case CompResourceRateType.SECONDS:e.setSeconds(e.getSeconds()+r);break}}static callWithTryCatch(e,...t){if(typeof e!=="function")return;try{return e(...t)}catch(e){console.warn("callWithTryCatch error.",e)}}static callLoadGotData(e,t){CompResource.callWithTryCatch(e.gotdata,t)}static callLoadDataSuccess(e){CompResource.callWithTryCatch(e.success)}static callLoadDataError(e,t){CompResource.callWithTryCatch(e.error,t)}static callLoadDataFinish(e){CompResource.callWithTryCatch(e.finish)}}CompResource.regexRate=/(\d+)([\+-]\d+)/;CompResource.regexPlacer=/(\{[a-zA-z]+\})/;CompResource.regexYears=/(\{yyyy\})/;CompResource.regexMonths=/(\{M+\})/;CompResource.regexDate=/(\{d+\})/;CompResource.regexHours=/(\{[Hh]+\})/;CompResource.regexMinutes=/(\{m+\})/;CompResource.regexSeconds=/(\{s+\})/;CompResource.regexMilliseconds=/(\{S+\})/;CompResource.uRegexYears=/(\{uyyyy\})/;CompResource.uRegexMonths=/(\{uM+\})/;CompResource.uRegexDate=/(\{ud+\})/;CompResource.uRegexHours=/(\{u[Hh]+\})/;CompResource.uRegexMinutes=/(\{um+\})/;CompResource.uRegexSeconds=/(\{us+\})/;CompResource.uRegexMilliseconds=/(\{uS+\})/;CompResource.computeRegx=/#\[.*?\]/g;class CompResourceFactory{static createResource(e){const t=CompResourceFactory.factories[e.type];if(t)return new t(e);console.error(`不支持的资源类型'${e.type}'`);return}}CompResourceFactory.factories={};class CompRenderFactory{constructor(e,t,r,s,i){this._name=e;this._types=t;this._factory=r;this._licitems=CompUtils.defualtValue(s,[]);this._alias=CompUtils.defualtValue(i,[])}get name(){return this._name}get alias(){return this._alias}get types(){return this._types}get factory(){return this._factory}get licenseRequired(){return this._licitems}}class CompRenderFactorys{static createRender(e,t){const r=CompRenderFactorys.renderSupports[t.type];if(!r){console.warn(`不支持的渲染器:${t.type}`);return}const s=e.resource;if(r.types.indexOf(s.dataType)==-1){console.warn(`不支持的数据类型：${s.dataType}，支持的类型：[${r.types.join(",")}]`);return}if(e.view.license)e.view.license.requirePower(r.licenseRequired);return new r.factory(e,t)}static regFactory(e){const t=[e.name,...e.alias];CompRenderFactorys.regFactory2(t,e)}static regFactory2(e,t){if(Array.isArray(e))e.forEach(e=>CompRenderFactorys.renderSupports[e]=t);else CompRenderFactorys.renderSupports[e]=t}}CompRenderFactorys.renderSupports={};var Comp;(function(r){let s;(function(e){e["TEXT"]="text";e["IMAGE"]="image";e["RECT"]="rect";e["TIMESTAMP"]="timestamp";e["COLORTABLES"]="colortables";e["PROGRESS"]="progress"})(s||(s={}));const e={position:"",offset:[0,0]};const t={fillColor:"rgba(255, 255, 255, 0.8)",borderColor:"#CACACA",borderWidth:1};const i=Object.assign({width:100,height:100},e,t);const o=Object.assign({width:0,height:0},e);const a=Object.assign({font:"15px 微软雅黑",color:"black",bgColor:"rgba(255, 255, 255, 0.8)",borderColor:"CACACA",borderWidth:1},e,t);const n=Object.assign({position:"center-top",font:"25px 宋体",color:"red",bgColor:"rgba(255,255,255,0.5)",borderColor:"#ACACAC",borderWidth:0},e,t);const l=Object.assign({position:"center-top",offset:[0,30],padding:5,cellSize:{width:10,height:10},cellStyle:{fillColor:"gray"},currentStyle:{fillColor:"red"}},e,t);const c=Object.assign({position:"right-bottom",offset:[10,10],width:560,height:40,padding:5,textWidth:200,textStyle:{font:"15px 微软雅黑",color:"rgb(51,51,51)"},barHeight:6,barBorderColor:"rgb(211, 211, 211)",barBorderWidth:1,barLabelStyle:{font:"12px 微软雅黑",color:"rgb(153,153,153)"}},e,t);class u{constructor(e,t){this._date=[];this._current=0;this._view=e;this._frameTime=t.frameTime||200;this._repeat=!!t.repeat;this._quality=t.quality||10;this._timeOut=t.timeout||3e4;this._workerScript=t.workerScript||"/ywwhome/vision/js/libs/gif.worker.js";this._overlays=t.overlays.map(e=>d(e));this._onProcess=t.onProgress;this._onError=t.onError;this._onSuccess=t.onSuccess;this._onCancel=t.onCancel;const r=t.start.getTime();const s=t.end.getTime();const i=t.interval*1e3;for(let e=r;e<=s;e+=i){this._date.push(new Date(e));if(this._date.length>=50){console.warn("抓图的帧数已经超过50帧，将忽略后面的帧");break}}const o=e.olMap.getViewport();this._mapCanvas=o.querySelector("canvas.ol-unselectable");this._mapCtx=this._mapCanvas.getContext("2d");this._memCanvas=document.createElement("canvas");this._memCanvas.width=this._mapCanvas.width;this._memCanvas.height=this._mapCanvas.height;this._memCtx=this._memCanvas.getContext("2d")}get current(){return this._current}get processing(){return!!this._gif}start(){if(!window["GIF"]){callWithTryCatch(this._onError,"没有找到GIF库");return}if(this._gif){console.warn("正在处理中");return}this._cancel=false;this._gif=new GIF({workers:2,quality:this._quality,width:this._mapCanvas.width,height:this._mapCanvas.height,repate:this._repeat?0:-1,workerScript:this._workerScript});this._isTimeout=false;this._processOne(0)}stop(){this._cancel=true;if(this._gif)this._gif.abort()}_processOne(e){this._current=e;if(e==this._date.length){this._processLast();return}this._timeOutHandle=window.setTimeout(()=>{this._isTimeout=true;this._gif=undefined;callWithTryCatch(this._onError,"处理超时")},this._timeOut);const s=[CompMapLayerEventType.LOAD_FAILED,CompMapLayerEventType.RENDER_ERROR];const i=[];const t=[];const o=[];const a=this._date[e];this._view.getLayers().forEach(r=>{if(!r.getVisible())return;if(r instanceof CompVectorLayer)return;const e=new Promise((e,t)=>{i.push(r.on(CompMapLayerEventType.RENDER_COMPLATE,()=>e()));i.push(...r.on(s,()=>t()))});o.push(e);t.push(r);r.setTime(a)});Promise.all(o).then(()=>{clearTimeout(this._timeOutHandle);if(this._isTimeout){return}setTimeout(()=>{if(this._cancel){this._gif=undefined;callWithTryCatch(this._onCancel);return}callWithTryCatch(this._onProcess,e,this._date.length*2);this._addFrame(a,t);this._processOne(e+1)},100)},()=>{this._gif=undefined;callWithTryCatch(this._onError,"抓图错误")}).then(()=>{i.forEach(e=>r.Observable.unByKey(e))})}_processLast(){this._gif.on("finished",e=>{this._gif=undefined;callWithTryCatch(this._onSuccess,URL.createObjectURL(e))});this._gif.on("abort",()=>{this._gif=undefined;callWithTryCatch(this._onCancel)});this._gif.on("progress",e=>{const t=this._date.length;const r=t+t*e;callWithTryCatch(this._onProcess,r,t*2)});this._gif.render()}_addFrame(e,t){var r;let s=this._mapCtx;if((r=this._overlays)===null||r===void 0?void 0:r.length){const i=s=this._memCtx;const o=this._memCanvas.width;const a=this._memCanvas.height;i.clearRect(0,0,o,a);i.drawImage(this._mapCanvas,0,0);const n={ctx:i,layers:t,dataList:this._date,date:e,index:this._current,count:this._date.length};this._overlays.forEach(e=>f(n,e))}this._gif.addFrame(s,{copy:true,delay:this._frameTime})}}r.ScreenShotGif=u;const h={[s.RECT]:R,[s.IMAGE]:w,[s.TEXT]:v,[s.TIMESTAMP]:E,[s.COLORTABLES]:D,[s.PROGRESS]:T};const p={[s.RECT]:i,[s.IMAGE]:o,[s.TEXT]:a,[s.TIMESTAMP]:n,[s.COLORTABLES]:c,[s.PROGRESS]:l};function d(e){if(e.type===s.IMAGE){const r=e;if(!r.image&&r.url){r.image=new Image;r.image.src=r.url}}const t=p[e.type];return L({},t,e)}function f(e,t){const r=h[t.type];if(!r)return;e.ctx.save();callWithTryCatch(r,e,t);e.ctx.restore()}function y(e,t,r,s){const[i,o]=t.split("-");const[a,n]=r;const{width:l,height:c}=e.canvas;const u={x:a,y:n,width:s.width,height:s.height};if(i==="right"){u.x=l-a-s.width}else if(i==="center"){u.x=l/2-s.width/2+a}if(o==="bottom"){u.y=c-n-s.height}else if(o==="center"){u.y=c/2-s.height/2+n}return u}function _(e,t){return ol.extent.intersects([e.x,e.y,e.x+e.width,e.y+e.height],[t.x,t.y,t.x+t.width,t.y+t.height])}const g=/(\d+)/;function m(e,t,r,s,i,o,a,n){e.font=a.font;e.textAlign=i;e.textBaseline=o;const l=e.measureText(t);const c=l.width;let u=20;if(g.test(a.font)){u=parseInt(RegExp.$1)}const h=y(e,r,s,{width:c,height:u});const{x:p,y:d}=h;let f=0,m=0;switch(i){case"left":case"start":f=0;break;case"center":f=h.width/2;break;case"end":case"right":f=h.width;break}switch(o){case"top":m=0;break;case"hanging":m=0;break;case"alphabetic":case"hanging":m=h.height;break;case"bottom":m=h.height;break;case"middle":m=h.height/2;break}h.x-=f;h.y-=m;if(n){if(n.find(e=>_(e,h)))return;n.push(h)}if(a.bgColor){e.fillStyle=a.bgColor;e.fillRect(h.x-f,h.y-m,h.width,h.height)}if(a.borderWidth>0){e.strokeStyle=a.borderColor;e.lineWidth=a.borderWidth;e.strokeRect(h.x-f,h.y-m,h.width,h.height)}e.fillStyle=a.color;e.fillText(t,p,d)}function C(e,t,r,s,i,o){if(t.fillColor){e.fillStyle=t.fillColor;e.fillRect(r,s,i,o)}if(Number.isFinite(t.borderWidth)){e.strokeStyle=t.borderColor;e.lineWidth=t.borderWidth;e.strokeRect(r,s,i,o)}}function R(e,t){const r=y(e.ctx,t.position,t.offset,t);C(e.ctx,t,r.x,r.y,r.width,r.height)}function v(e,t){m(e.ctx,t.text,t.position,t.offset,"left","top",t)}function w(e,t){const r=y(e.ctx,t.position,t.offset,t.width&&t.height?t:t.image);e.ctx.drawImage(t.image,r.x,r.y,r.width,r.height)}function E(e,t){const r=CompResource.fmtDate(e.date,"{yyyy}-{MM}-{dd} {HH}:{mm}:{ss}");const s=Object.assign({text:r},t);v(e,s)}function T(t,r){const s=t.ctx;const e=(r.cellSize.width+r.padding)*t.dataList.length+r.padding;const i=r.cellSize.height+r.padding*2;const o=y(s,r.position,r.offset,{width:e,height:i});C(s,r,o.x,o.y,o.width,o.height);const a=o.y+r.padding;const n=a+r.cellSize.height;for(let e=0;e<t.count;++e){const l=o.x+r.padding+(r.cellSize.width+r.padding)*e;C(s,e===t.index?r.currentStyle:r.cellStyle,l,a,r.cellSize.width,r.cellSize.height)}}function D(e,a){const r=[];e.layers.forEach(e=>{const t=e.colors;if(!t||typeof t!=="object")return;r.push({name:e.declare["nickname"]||e.name,colors:t})});const n=e.ctx;const t=a.height*r.length;const l=y(n,a.position,a.offset,{width:a.width,height:t});C(n,a,l.x,l.y,l.width,l.height);const c=l.x+a.textWidth+a.padding;const u=l.x+l.width-a.padding;const h=u-c;const p=[];r.reverse();r.forEach((e,t)=>{const s=h/e.colors.list.length;const r=l.y+a.height*t;const i=r+a.height;const o=(r+i)/2;m(n,e.name,"",[l.x+a.padding,o,a.textWidth-a.padding*2],"left","middle",a.textStyle);m(n,e.colors.unit,"",[u,o],"right","top",a.barLabelStyle);n.strokeStyle=a.barBorderColor;n.lineWidth=a.barBorderWidth;e.colors.list.forEach((e,t)=>{const r=c+t*s;n.fillStyle=e.color;n.fillRect(r,o-a.barHeight*2,s,a.barHeight);n.strokeRect(r,o-a.barHeight*2,s,a.barHeight);n.beginPath();n.moveTo(r,o-a.barHeight);n.lineTo(r,o);n.stroke();m(n,e.minV.toString(),"",[r,o],"center","top",a.barLabelStyle,p)});n.strokeRect(l.x,r,l.width,i-r)})}function L(t,...r){if(t===null||t===undefined)t={};const e=Object(t);for(let e=0;e<r.length;++e){const s=r[e];if(s===null||s===undefined)continue;for(let e in s){const i=s[e];if(i===undefined||i===null)continue;const o=t[e];if(o===undefined||o===null||o.constructor!==Object){if(i.constructor===Object)t[e]=L({},i);else t[e]=i;continue}L(o,i)}}return t}})(Comp||(Comp={}));var CompUtils;(function(o){function r(e){return e!==undefined&&e!==null}o.isDefined=r;function e(e){return e===undefined||e===null}o.isUndefined=e;function t(e,t){return r(e)?e:t}o.defualtValue=t;function s(e){if(e[0]>e[2]){const t=e[2];e[2]=e[0];e[0]=t}if(e[1]>e[3]){const t=e[3];e[3]=e[1];e[1]=t}return e}o.normalExtent=s;const l=/\{f([0-9]+)\}/;const c=/(\{([^\}]+)\})/;function i(r,s,i){const e=c;const o=l;while(e.test(i)){let e=undefined;const a=RegExp.$1;if(o.test(i)){e=RegExp.$1}else if(r){e=r.indexOf(RegExp.$2)}else{e=RegExp.$2}let t=s[e];if(t===undefined||t===null)t="";i=i.replace(a,t)}return i}o.replaceTokenByFiled=i;function a(e,t){const r=c;const s=l;let i=e;while(r.test(i)){const o=RegExp.$1;const a=RegExp.$2;if(s.test(i)){i=i.replace(o,`values[${RegExp.$1}]`);continue}let e=-1;if(t&&(e=t.indexOf(a))!=-1){i=i.replace(o,`values[${e}]`)}i=i.replace(o,`others['${a}']`)}try{const n=Function("values","others",`return (${i});`);return(e,t)=>{try{return n(e,t)}catch(e){console.warn("执行表达式失败",e)}}}catch(e){console.error("创建表达式函数失败",e);return()=>false}}o.buildCaseFunction=a;function n(e){const t=typeof e;if(t==="function"){return{type:"callback",callback:e}}if(Array.isArray(e)){const r=e[0];if(r.case){return{type:"switch-case",caselist:e}}}if(t==="object"&&e["type"]){return e}return{type:"value",value:e}}function u(e,t){const r=n(e);const s=r.type;if(s==="callback"&&r.callback){return r.callback}if(s==="switch-case"&&r.caselist){const i=r.caselist.map(e=>{return{case:o.buildCaseFunction(e.case,t),value:e.value}});return t=>{const r={level:t.view.olMap.getView().getZoom()};for(let e of i){if(e.case(t.values,r))return e.value}}}if(s==="value"){return()=>r.value}return()=>undefined}o.buildPropertyGetter=u;function h(s,i){i=i||{};return new Promise((e,t)=>{const r=new Image;r.onload=function(){if(i.cancel)return;e(r)};r.onerror=function(e){console.warn(e);if(i.cancel)return;t(e)};r.src=s})}o.createImagePromise=h})(CompUtils||(CompUtils={}));class SmartbiDataset{constructor(e,t){this._address=e;this._dsid=t}get dataSetId(){return this._dsid}set dataSetId(e){this._dsid=e}fetch(t){t=t||{};const e=t.params||[];const i=t.rows||1e3;let o;const a=e=>{CompResource.callWithTryCatch(t.gotdata,e)};const n=()=>{CompResource.callWithTryCatch(t.finish)};const l=()=>{CompResource.callWithTryCatch(t.success)};const c=e=>{CompResource.callWithTryCatch(t.error,e)};const u=()=>{this.rmi("closeLoadDataView",[o.clientId])};const h=s=>{return this.rmi("loadViewData",[o.clientId,s]).then(e=>{if(e.retCode!=0){c(e.result);n();u();return}const t=e.result.length<i;const r={start:s*i,fields:o.fieldNames,types:o.fieldTypes,data:e.result,isLastPart:t};if(!t){h(s+1)}a(r);if(t){l();n();u()}},e=>{c(e);n();u()})};let p=0;const d=r=>{return this.rmi("loadViewData",[o.clientId,r]).then(e=>{if(e.retCode!=0){console.warn(`loadViewData page:${r} error.`,e.result);return false}p--;const t={start:r*i,fields:o.fieldNames,types:o.fieldTypes,data:e.result,isLastPart:p==0};a(t);return true},e=>{console.warn(`loadViewData page:${r} error.`,e);c(e);return false})};const r=e.map(e=>({id:`OutputParameter.${this._dsid}.${e.id}`,value:e.value}));this.rmi("openLoadDataView",[this._dsid,JSON.stringify(r),i,true]).then(e=>{if(e.retCode!=0){console.warn(`OpenLoadDataView error！code:${e.retCode}, result:${e.result}`);c(e.result);n();return}o=e.result;if(o.totalRowCount<0||o.totalRowCount>1e8){h(0)}else if(o.totalRowCount==0){const t={start:0,fields:o.fieldNames,types:o.fieldTypes,data:[],isLastPart:true};a(t);l();n();u()}else{const r=p=Math.ceil(o.totalRowCount/i);const s=new Array(r);for(let e=0;e<r;++e){s[e]=d(e)}Promise.all(s).then(e=>{if(e.indexOf(false)==-1){l()}n();u()})}},e=>{console.warn(`OpenLoadDataView error！info:${e}`);c(e.result);n()})}rmi(e,t){return SmartbiDataset.SmartBiRMI(this._address,"BusinessViewService",e,t)}getFutureList(s,i){const t="ClientReportService";let o,r,a,n;return SmartbiDataset.SmartBiRMI(this._address,t,"createSimpleReport",[]).then(e=>{o=e.result.parameterPanelId;r=e.result.clientId;a=[r,"CurrentReportName()"];n=[r,s,true];return SmartbiDataset.SmartBiRMI(this._address,t,"getFunctionValue",a)}).then(()=>{return SmartbiDataset.SmartBiRMI(this._address,t,"initFromBizViewEx",n)}).then(()=>{const e=[o,"OutputParameter."+s+".Nc查询-变量名称"];const t=[o,"OutputParameter."+s+".varu"];const r=[o,"OutputParameter."+s+".varv"];if(i==="grid"){return[SmartbiDataset.SmartBiRMI(this._address,"ParameterPanelService","getParamStandbyValue",e)]}else if(i==="uvGrid"){return[SmartbiDataset.SmartBiRMI(this._address,"ParameterPanelService","getParamStandbyValue",t),SmartbiDataset.SmartBiRMI(this._address,"ParameterPanelService","getParamStandbyValue",r)]}}).then(e=>{return Promise.all(e)}).then(e=>{return{type:i,data1:e[0].result,data2:e[1]&&e[1].result}})}static SmartBiRMI(e,t,r,s){const i=[];i.push(`className=${t}`);i.push(`methodName=${r}`);i.push(`params=${encodeURIComponent(JSON.stringify(s))}`);const o={headers:{"content-type":"application/x-www-form-urlencoded;charset=UTF-8"},body:i.join("&"),method:"POST",credentials:"same-origin",mode:"cors"};return fetch(e,o).then(e=>e.json(),e=>({retCode:e,result:e}))}}class CompMapDataRender extends CompDataRender{constructor(e,t){super(e.view,t);this._layer=e}get layer(){return this._layer}get data(){return this._layer.data}}class CompRasterDataRender extends CompDataRender{constructor(e,t){super(e.view,t);this._layer=e}get layer(){return this._layer}get data(){return this._layer.data}}class CompTableDataRender extends CompDataRender{constructor(e,t){super(e.view,t);this._layer=e}get layer(){return this._layer}get partialRenderable(){return true}}class CompUVDataRender extends CompDataRender{constructor(e,t){super(e.view,t);this._layer=e}get layer(){return this._layer}get data(){return this._layer.data}}var URLType;(function(e){e["NORMAL"]="normal";e["FUTURE"]="future"})(URLType||(URLType={}));var DataType;(function(e){e["GRID"]="grid";e["UVGRID"]="uvGrid"})(DataType||(DataType={}));class CompLayerCreator{static create(e,t){if(!t.resource){const i=t;let e=Array.isArray(i.urls);const o={type:i.type,url:e?i.urls[0].url:i.url,rate:i.rate,projection:i.projection,nowUrlType:e?i.urls[0].type:URLType.NORMAL,nowDataType:e?i.urls[0].dataType:DataType.GRID,urls:i.urls,dataType:e?i.urls[0].url:DataType.GRID};for(let e in i.exdata){o[e]=i.exdata[e]}t.resource=o}const r=CompResourceFactory.createResource(t.resource);if(!r){return}const s=Object.assign({},t,{view:e,resource:r});switch(r.dataType){case CompResourceDataType.TABLE:return new CompTableDataLayer(s);case CompResourceDataType.RASTER:return new CompRasterDataLayer(s);case CompResourceDataType.RASTERUV:return new CompUVDataLayer(s);case CompResourceDataType.MAP:return new CompMapDataLayer(s)}}}class CompMapDataLayer extends CompMapLayer{constructor(e){super(e)}get data(){return this._data}get fields(){return CompUVDataLayer.Fields}get values(){return[]}isDataEmpty(){return!this._data}_onLoadData(e){this._data=undefined;if(!e){this.olLayer.setVisible(false);return}if(this.getVisible())this.olLayer.setVisible(true);const t=e;if(this._isSame(this._data,t))return;this._data=t;this.update()}_onLoadDataError(e){this.olLayer.setVisible(false)}_isSame(e,t){if(e===t)return true;if(!e||!t)return false;return e.url===t.url}}class CompAbstractRasterDataLayer extends CompMapLayer{constructor(e){super(e)}query(e,t,r){const s=this.data;if(!s)return;const{xres:i,yres:o,xcells:a,ycells:n}=s;const[l,c]=s.extent;const u=s.getXNum(e);const h=s.getYNum(t);const p=s.getCellValue(u,h);if(!CompUtils.isDefined(p))return undefined;return[u*i+l,h*o+c].concat(p)}queryRect(e){const r=this.data;if(!r)return;CompUtils.normalExtent(e);const{xres:s,yres:i,xcells:o,ycells:t}=r;const[a,n]=r.extent;const l=[];const c=r.getXNum(e[0]);const u=r.getYNum(e[1]);const h=r.getXNum(e[0]);const p=r.getYNum(e[1]);for(let t=u;t<p;++t){for(let e=c;e<h;++e){const d=e+t*o;l.push([e*s+a,t*i+n].concat(r.getCellValue(e,t)))}}}}class CompRasterDataLayer extends CompAbstractRasterDataLayer{constructor(e){super(e)}get data(){return this._data}isDataEmpty(){return!this._data}getValueX(e){return e[0]}getValueY(e){return e[1]}get fields(){return CompRasterDataLayer.Fields}get values(){return[]}_onLoadData(e){this._data=undefined;if(!e){this.olLayer.setVisible(false);return}if(this.getVisible())this.olLayer.setVisible(true);this._data=e;this.update()}}CompRasterDataLayer.Fields=["x","y","value"];class CompTableDataLayer extends CompMapLayer{constructor(e){super(e)}createIso(e,t){this.removeIso();t=t||{};const r=this.olLayer.getLayers();const s=this.createRender(e);if(s instanceof CompTableDataRender){this._hidePoints=t.hidePoints;if(t.hidePoints){r.clear()}this.renders.unshift(s);if(s.olLayer)r.insertAt(0,s.olLayer);this._isoRender=s;if(this._fields){s.update()}}}removeIso(){if(this._isoRender){this.removeRender(this._isoRender);if(this._hidePoints){const t=this.olLayer.getLayers();t.clear();this.renders.forEach(e=>{if(e.olLayer)t.push(e.olLayer)})}}}get fields(){return this._fields}get values(){return this._values}get fieldx(){return this._fieldx}get fieldy(){return this._fieldy}get complate(){return this._complate}getValueX(e){return e[this._fieldx]}getValueY(e){return e[this._fieldy]}isDataEmpty(){return!this._values||this._values.length==0}queryRect(t){if(!this._values)return[];if(!this._fieldx||!this._fieldy)return[];CompUtils.normalExtent(t);const r=[];const s=this._fieldx,i=this._fieldy;this._values.forEach(e=>{if(ol.extent.containsXY(t,e[s],e[i]))r.push(e)});return r}queryTip(t,r,s){const i=this.renders;const o=i.length;for(let e=o-1;e>=0;--e){const a=i[e];if(!a.isVisible())continue;const n=a.queryTip(t,r,s);if(n!==undefined)return n}return}_onPreLoadData(){this._fields=undefined;this._values=undefined;this._fieldx=undefined;this._fieldy=undefined;this._complate=undefined}_onLoadData(e){if(e.dataType!==CompResourceDataType.TABLE){throw`不支持的数据类型:${e.dataType}`}const t=e;if(!this._fields){this._fields=t.fields;this._values=t.rows.slice();this._fieldx=t.fieldx;this._fieldy=t.fieldy}else{this._values=this._values.concat(t.rows)}this._complate=t.isLastPart;this.update()}}class CompUVDataLayer extends CompAbstractRasterDataLayer{constructor(e){super(e)}get data(){return this._data}get fields(){return CompUVDataLayer.Fields}get values(){return[]}isDataEmpty(){return!this._data}_onLoadData(e){this._data=undefined;if(!e){this.olLayer.setVisible(false);return}if(this.getVisible())this.olLayer.setVisible(true);this._data=e;this.update()}}CompUVDataLayer.Fields=["x","y","u","v","scalar"];class CompVectorLayer extends CompMapLayer{constructor(e){super(e);this._olVectorSource=new ol.source.Vector({features:new ol.Collection});this._olVector=new ol.layer.Vector({source:this._olVectorSource});this._olEditor=new OlExtends.OlEditor(this.view.olMap,{layer:this._olVector,selectStyle:undefined,modifyStyle:undefined,selboxStyle:{line:{width:1,color:"#8a79db",lineDash:[10,5]}}});this._olVector.setMap(this.view.olMap)}get olSource(){return this._olVectorSource}get editor(){return this._olEditor}setVisible(e){super.setVisible(e);this._olVector.setVisible(e)}get fields(){return CompUVDataLayer.Fields}get values(){return[]}addFeature(e,t){if(e instanceof ol.Feature==false){e=(new ol.format.GeoJSON).readFeature(e)}if(t){e.setStyle(this._toOlStyle(t))}this._olVectorSource.addFeature(e);return e}addFeatures(e,t){const r=new ol.format.GeoJSON;e=e.map(e=>{if(e instanceof ol.Feature==false){e=r.readFeature(e);if(t){if(typeof t==="function"){e.setStyle(this._toOlStyle(t(e)))}else{e.setStyle(this._toOlStyle(t))}}}});this._olVectorSource.addFeatures(e);return e}clear(){this._olVectorSource.clear()}isDataEmpty(){return this._olVectorSource.getFeatures().length==0}query(e,t,r){if(!this._olVectorSource)return;const s=this._view.olMap.getView().getResolution();const i=s*(r||5);const o=[e-i,t-i,e+i,t+i];let a=undefined;this._olVectorSource.forEachFeatureIntersectingExtent(o,e=>{a=e;return true});return a}queryRect(e){const t=[];CompUtils.normalExtent(e);this._olVectorSource.forEachFeatureIntersectingExtent(e,e=>{t.push(e)});return t}queryPolygon(e){console.warn("多边形查询没有真正实现 queryPolygon not impl");const t=[];const r=ol.extent.boundingExtent(e);const s=ol.geom.Polygon([e]);const i=[];this._olVectorSource.forEachFeatureIntersectingExtent(r,e=>{i.push(e)});return i}queryCircle(e,t,r){console.warn("圆形查询没有实现 queryCircle not impl");return this.queryRect([e-r,t-r,e+r,t+r])}removeFeature(e){if(this._olVectorSource){this._olVectorSource.removeFeature(e)}}modifyStyle(e,t){if(e instanceof ol.Feature==false){return}if(t){if(typeof t==="function"){e.setStyle(this._toOlStyle(t(e)))}else{e.setStyle(this._toOlStyle(t))}}}modifyAllStyle(t){if(!this._olVectorSource)return;this._olVectorSource.forEachFeature(e=>{this.modifyStyle(e,t)})}getAllFeatures(){if(!this._olVectorSource)return[];return this._olVectorSource.getFeatures()}destroy(){if(this._olVector){this._olVector=undefined;this._olVectorSource=undefined}}_toOlStyle(e){if(!e)return;const t={};if(e.fill){t.fill=new ol.style.Fill(e.fill)}if(e.line){t.stroke=new ol.style.Stroke(e.line)}return new ol.style.Style(t)}_createRender(e){return}_onLoadData(e){}}class CompEchartsRender extends CompTableDataRender{constructor(e,t){super(e,t);this._olEcharts=new OlEchartsLayer(this.olMap,{},{noAddToMap:true,optimizeRadius:5})}get factory(){return CompEchartsRenderFactory}get olLayer(){var e;return(e=this._olEcharts)===null||e===void 0?void 0:e.layer}updateImm(){if(!this._layer.values)return;const e=this._declare;this._fireRenderStatus(CompMapLayerEventType.RENDER_BEGIN);const r=[];const t=t=>{if(!t)return;if(echarts.getMap(t))return;const e=fetch(t).then(e=>e.ok?e.json():Promise.reject()).then(e=>echarts.registerMap(t,e));r.push(e)};t(e.mapData);e.series.forEach(e=>t(e.mapData));Promise.all(r).then(()=>{this._olEcharts.setOption(this._buildEchartsOption(),true);this._fireRenderStatus(CompMapLayerEventType.RENDER_COMPLATE)})}clear(){}destroy(){if(this._olEcharts){this._olEcharts.destroy();this._olEcharts=undefined}}_getValue(t,r){if(t===undefined)return undefined;const s=typeof r;const i=this._layer.fields;if(Array.isArray(t)){let e=-1;if(s==="number"){e=r}else if(s==="string"){e=i?i.indexOf(r):-1}if(e==-1)return undefined;return t[e]}else{let e=r;if(s==="number"){e=i[r]}if(e===undefined)return undefined;return t[e]}}_buildColors(e,t){const r=t.visualMap||{};t.visualMap=r;if(!r.type)r.type="piecewise";if(r.type==="piecewise"){r.pieces=e.list.map(e=>({min:e.minV,max:e.maxV,color:e.color,opacity:e.opacity||1,label:e.name}))}else if(r.type==="continuous"){r.inRange={color:e.list.map(e=>e.color)}}}_buildEchartsOption(){const i=this._declare;const e=OlEchartsLayer.deepClone(i.option);const o=e.series||[];const a=this._layer.values;if(i.mapData){const t=e.geo=e.geo||{};t.map=i.mapData}i.series.forEach((t,e)=>{const r=o[e]||{};o[e]=r;r.type=t.type;r.coordinateSystem="geo";const s=r.data=[];if(t.type==="map"){if(t.mapData)r.map=t.mapData;else r.geoIndex=0}a.forEach(r=>{const e={name:this._getValue(r,t.nameField),value:t.valueFields.map((e,t)=>{return this._getValue(r,e)})};if(typeof i.filter==="function"&&i.filter(e.value)){return}s.push(e)})});if(this._layer.colors){this._buildColors(this._layer.colors,e)}e.series=o;return e}}CompEchartsRender.renderType="echarts";CompEchartsRender.dataTypes=[CompResourceDataType.TABLE];const CompEchartsRenderFactory=new CompRenderFactory("echarts",[CompResourceDataType.TABLE],CompEchartsRender,[Comp.LicenseDefine.Renders.Echarts]);CompRenderFactorys.regFactory(CompEchartsRenderFactory);class CompFlowFieldRender extends CompUVDataRender{constructor(e,t){super(e,t);const r=Object.assign({particleNumber:1024,particleWidth:2,fadeOpacity:.935,speedFactor:.7,speeddFilterMin:0,speeddFilterMax:1e3,windColor:"#fff"},t);const s=CompUtils.defualtValue(r.renderScale,2);this._flow=new WindEngine.WindOlLayer(this.olMap,{renderScale:s});this.olMap.removeLayer(this._flow.layer);const i=this._flow.windGL;if(!Array.isArray(r.windColor)){r.windColor=[r.windColor]}this._defaultRender={numParticles:r.particleNumber,pointSize:r.particleWidth,fadeOpacity:r.fadeOpacity,speedFactor:r.speedFactor,spdFilterMin:r.speeddFilterMin,spdFilterMax:r.speeddFilterMax,windColor:r.windColor,pointAge:r.pointAge,pointGap:r.pointGap};const o=this._defaultRender;for(let e in o){if(o[e]===undefined)delete o[e]}i.setColors(r.windColor);Object.assign(i,this._defaultRender)}setDefaultParams(){this._flow.windGL.params=this._defaultRender}setDefaultColors(){let e=this._defaultRender.windColor;if(Array.isArray(e)){this._flow.windGL.setColors(e)}else{this._flow.windGL.setColors([e])}}get factory(){return CompFlowFieldRenderFactory}get olLayer(){var e;return(e=this._flow)===null||e===void 0?void 0:e.layer}query(e,t){}updateImm(){const e=this.data;if(!e)return;this._fireRenderStatus(CompMapLayerEventType.RENDER_BEGIN);this._flow.setWindData({datau:e.datau.values,datav:e.datav.values,noDataValueU:e.datau.noData,noDataValueV:e.datav.noData,width:e.xcells,height:e.ycells,extent:e.extent,flipY:true});this._fireRenderStatus(CompMapLayerEventType.RENDER_COMPLATE)}clear(){this._flow.setWindData({datau:[],datav:[],noDataValueU:0,noDataValueV:0,width:0,height:0,extent:[],flipY:true})}destroy(){if(this._flow){this._flow.destroy();this._flow=undefined}}}const CompFlowFieldRenderFactory=new CompRenderFactory("flowField",[CompResourceDataType.RASTERUV],CompFlowFieldRender,[Comp.LicenseDefine.Renders.FlowField]);CompRenderFactorys.regFactory(CompFlowFieldRenderFactory);class CompOverlaysRender extends CompTableDataRender{constructor(e,t){super(e,t);this._overlays=[];this._olGroup=new ol.layer.Group;this._source=new ol.source.Vector}get factory(){return CompOverlaysRenderFactory}get olLayer(){return this._olGroup}query(e,t){if(this._source){}}clear(){if(this._overlays.length){this._overlays.forEach(e=>{this._view.olMap.removeOverlay(e)});this._overlays.length=0}if(this._source)this._source.clear()}destroy(){if(this._olGroup){this._olGroup=null}this.clear()}setVisible(t){this._overlays.forEach(e=>{e.getElement().style.display=t?"block":"none"});super.setVisible(t)}updateImm(){this.clear();const e=this._layer.values;const t=this._layer.fields;if(!e)return;this._fireRenderStatus(CompMapLayerEventType.RENDER_BEGIN);let r=e;const a=this._declare;if(a.fields&&a.fields.length){const i=a.fields.map(e=>{if(Number.isInteger(e))return e;else return t.indexOf(e)});r=e.map(t=>{return i.map(e=>t[e])})}const n=this._view.olMap;const s=n.getOverlays().getLength()+r.length;if(s>200){console.warn("最多支持构造200个Overlay，过多的Overlays会造成性能低下，地图卡顿！多余的点将被忽略");r.length=Math.max(200-n.getOverlays().getLength(),0)}if(r.length>0){const l=a.fieldX||0;const c=a.fieldY||1;const u=a.offset;const h=a.positioning||"center-center";const p=this.layer.getVisible();r.forEach(e=>{let t=a.html;if(typeof a.html==="function"){t=a.html(e)}let r;if(typeof t==="string"){if(t==="")return;const o=document.createElement("div");o.innerHTML=t;r=o.lastElementChild}else if(t instanceof HTMLElement){r=t}if(!r){console.warn("构建DOM失败，请检查传入的html属性");return}r.style.display=p?"block":"none";const s=[e[l],e[c]];const i=new ol.Overlay({element:r,position:s,offset:u,positioning:h});n.addOverlay(i);this._overlays.push(i);this._source.addFeature(new ol.Feature({values:e,geometry:new ol.geom.Point(s)}))})}this._fireRenderStatus(CompMapLayerEventType.RENDER_COMPLATE)}}const CompOverlaysRenderFactory=new CompRenderFactory("overlays",[CompResourceDataType.TABLE],CompOverlaysRender);CompRenderFactorys.regFactory(CompOverlaysRenderFactory);class CompPointIsoRender extends CompTableDataRender{constructor(e,t){super(e,t);this._raster=new OLE.CustomWmsLayer({getImage:(e,t,r,s,i)=>this._GetImage(e,t,r,s,i),win:undefined})}get factory(){return CompPointIsoRenderFactory}get olLayer(){var e;return(e=this._raster)===null||e===void 0?void 0:e.layer}query(e,t){}updateImm(){this._initIsoLine()}clear(){var e;(e=this._raster)===null||e===void 0?void 0:e.clear()}destroy(){if(this._raster){this._raster.destroy();this._raster=undefined}}async _GetImage(e,t,r,s,i){if(!this._isoOnServer)return Promise.resolve(undefined);try{return await this._isoOnServer.getImage(e,t,r,s,i)}catch(e){this._fireRenderStatus(CompMapLayerEventType.RENDER_ERROR);throw e}finally{this._fireRenderStatus(CompMapLayerEventType.RENDER_COMPLATE)}}static fieldName2Index(e,t){if(typeof e==="number")return e;const r=t.indexOf(e);if(r==-1){throw new Error(`数据集中不存在字段：${e}`)}return r}_initIsoLine(){const e=this.layer;if(!e.values){this.clear();return}this._fireRenderStatus(CompMapLayerEventType.RENDER_BEGIN);const t=this._declare;const r=CompPointIsoRender.fieldName2Index(t.fieldx,e.fields);const s=CompPointIsoRender.fieldName2Index(t.fieldy,e.fields);const i=CompPointIsoRender.fieldName2Index(t.fieldv,e.fields);const o=[];e.values.forEach(e=>{const t=parseFloat(e[i]);if(t>-999&&t<9999)o.push([e[r],e[s],t])});if(o.length===0){this.clear();return}const a={type:"Point3Ds",gapx:t.interpGapx,gapy:t.interpGapy,radius:t.interpRadius,points:o,preInterp:t.preInterp,interpGrid:t.interpGrid};this._isoOnServer=this._isoOnServer||new OLE.CompIsoOnServer;this._isoOnServer.init(t,ColorTool.toPiecewiseColors(this.layer.colors),a).then(e=>{if(this._raster)this._raster.refresh()}).catch(e=>{this.clear();this._fireRenderStatus(CompMapLayerEventType.RENDER_ERROR);this._fireRenderStatus(CompMapLayerEventType.RENDER_COMPLATE)})}}const CompPointIsoRenderFactory=new CompRenderFactory("points-iso",[CompResourceDataType.TABLE],CompPointIsoRender,[Comp.LicenseDefine.Renders.Isogram]);CompRenderFactorys.regFactory(CompPointIsoRenderFactory);class CompPointsRender extends CompTableDataRender{constructor(e,t){super(e,t);const r=this._declare;this._points=new OLE.LargePointsLayer;this._points.setHiddenRadious(3);this._points.setStyle(r.style)}get factory(){return CompPointRenderFactory}get olLayer(){var e;return(e=this._points)===null||e===void 0?void 0:e.layer}updateImm(){if(!this._layer.values)return;this._fireRenderStatus(CompMapLayerEventType.RENDER_BEGIN);const e=this._declare;const t=this._declare;if(e.series){this._updateForEcharts()}else{this._updateNormal()}this._fireRenderStatus(CompMapLayerEventType.RENDER_COMPLATE)}clear(){var e;(e=this._points)===null||e===void 0?void 0:e.clear()}destroy(){if(this._points){this._points.destroy();this._points=undefined}if(this._tooltip){this._view.olMap.removeOverlay(this._tooltip);this._tooltip=undefined;this._tooltipElement.remove();this._tooltipElement=undefined}if(this._tooltipPoint){this._view.removeCustomDrawer(this._tooltipPoint);this._tooltipPoint=undefined}Comp.Observable.unByKey(this._onMouseMoveHandle);this._onMouseMoveHandle=undefined}queryTip(e,t,r){return}_updateNormal(){let e=this._layer.values;const t=this._declare;if(t.fields&&t.fields.length){const r=t.fields.map(e=>{if(Number.isInteger(e))return e;else return this._layer.fields.indexOf(e)});e=this._layer.values.map(t=>{return r.map(e=>t[e])})}this._points.setPoints({points:e,fieldX:t.fieldX,fieldY:t.fieldY})}_updateForEcharts(){var e,t;const r=this._declare;const s=r.series.findIndex(e=>e.type==="scatter");if(s==-1){console.warn("不支持的 echarts 配置，仅支持散点图");return}const i=[];const o=r.series[s];this._renderFields=o.valueFields.slice();this._renderFields.push(o.nameField);const a=this._renderFields.map(e=>CompFieldsHelp.findField(this._layer.fields,e));this._layer.values.forEach(t=>{const e=a.map(e=>t[e]);if(typeof r.filter==="function"&&r.filter(e)){return}i.push(e)});function n(e){if(typeof e==="number")return e+"px";if(Array.isArray(e)){if(e.length==2)return`${e[0]}px ${e[1]}px`;if(e.length==4)return`${e[0]}px ${e[1]}px ${e[2]}px ${e[3]}px`}return"5px"}const u=this;class l{constructor(){}setPoint(e){this._point=e}onCustomDraw(r,e,s,i,o){if(this._point){const a=this._point;const[n,l]=a;const c=u._getStyle(h,a,true);let e=Math.floor((n-r[0])/s)*i;let t=Math.floor((r[3]-l)/s)*i;OLE.LargePointsLayer.draw({pd:a,ostyle:c,ctx:o,cx:e,cy:t})}}}const c=(e=r.option)===null||e===void 0?void 0:e.tooltip;const h=(t=r.option)===null||t===void 0?void 0:t.series[s];if(c&&c.show!==false){Comp.Observable.unByKey(this._onMouseMoveHandle);if(!this._tooltip){this._tooltipElement=document.createElement("div");this._tooltip=new ol.Overlay({element:this._tooltipElement,offset:[10,10]});this._view.olMap.addOverlay(this._tooltip);this._tooltipElement.parentElement.style.zIndex="9";this._tooltipPoint=new l;this._view.addCustomDrawer(this._tooltipPoint)}let s=0;const p=this._tooltipElement;const d=this._tooltipPoint;let i;this._onMouseMoveHandle=this._view.on(CompMapViewEventType.MOUSEMOVE,e=>{if(!this._layer.getVisible())return;if(CompPointsRender._tipOn&&CompPointsRender._tipOn!=this)return;this._tooltip.setPosition(e.coordinate);const t=this._points.getValue(...e.coordinate);if(!t){if(p&&s==0)s=window.setTimeout(()=>{p.style.display="none";CompPointsRender._tipOn=null;i=null;d.setPoint(null);this._view.updateCustomDrawers()},100);return}if(s){clearTimeout(s);s=0}if(t!=i){i=t;d.setPoint(t);this._view.updateCustomDrawers();const r=c.formatter({name:t[t.length-1],data:{value:t},fields:this._renderFields,value:t});if(!r||r.length==0)return;let e="border-radius:4px";e+=";background-color:"+(c.backgroundColor||"rgba(50,50,50,0.7)");e+=";border-color:"+(c.borderColor||"#333");e+=";border-width:"+(c.borderWidth||0);e+=";padding:"+n(c.padding);e+=";"+(c.extraCssText||"");p.innerHTML=`<div style='${e}'>${r}</div>`;p.style.display="block";CompPointsRender._tipOn=this}})}this._points.setStyle(e=>this._getStyle(h,e));this._points.setPoints({points:i,fieldX:0,fieldY:1})}_getStyle(e,t,r){function s(e,t,r){if(typeof t==="function"){try{return t.call(this,e)}catch(e){console.warn("通过函数获取参数异常",e)}return}return t||r}function i(e,t){const r=e[t];if(!r)return;let s=r.emphasis;if(s)return s;const i=e.emphasis;if(!i)return;s=i[t];if(s)return s;return r}function o(e,t){const r=e[t];if(!r)return;const s=r.normal;if(s)return s;return r}function a(e){if(e==""||e==null||e==undefined)return false;return!isNaN(e)}const n=r?i:o;const l={type:"shape"};l.shape=s(t,e.symbol)||OLE.PointShapeType.CIRCLE;l.radius=s(t,e.symbolSize)/2;l.rotate=s(t,e.symbolRotate);if(l.shape.startsWith("image://")){l.type=OLE.PointStyleType.ICON;l.icon={url:l.shape.substr(8)}}let c;let u=t.length-2;while(!a(c)&&u>0){c=t[u];u--}const h=this.getColor(c);const p=n(e,"label");if(p&&p.show!==false){l.label={};if(p.textStyle){const d=p.textStyle;if(d.color)p.color=d.color;if(d.fontSize)p.fontSize=d.fontSize;p.textStyle=undefined}l.label.color=p.color==="auto"?h:p.color;l.label.font=`${p.fontSize||"12"}px ${p.fontFamily||""}`;if(p.offset){l.label.offsetX=p.offset[0];l.label.offsetY=p.offset[1]}if(typeof p.formatter==="function")l.label.formatter=e=>p.formatter({value:e});else l.label.formatter=()=>p.formatter}l.fillColor=h;l.lineColor=h;if(!h){const f=n(e,"itemStyle");if(f){if(f.color)l.fillColor=f.color;l.lineColor=f.borderColor||"#000";l.lineWidth=f.borderWidth||0}}return l}}CompPointsRender._tipOn=null;const CompPointRenderFactory=new CompRenderFactory("largePoints",[CompResourceDataType.TABLE],CompPointsRender,[Comp.LicenseDefine.Renders.Scatter],["largePoints-echarts"]);CompRenderFactorys.regFactory(CompPointRenderFactory);class CompRasterBaseRender extends CompRasterDataRender{constructor(e,t){super(e,t);this._filter=OLE.FILTER.FILTER_BSPLINE;this._colorGradient=0}get olLayer(){var e;return(e=this._raster)===null||e===void 0?void 0:e.layer}queryDisplay(e,t){if(!this._raster)return undefined;const r=this._raster.getValue(e,t);const s=this._raster.getDisplayValue(e,t);if(s===undefined)return;const i=this._raster.getValueColorByte(s);const o=`rgba(${i[0]},${i[1]},${i[2]},${i[3]/255})`;return{x:e,y:t,originValue:r,displayValue:s,rgba:i,color:o}}updateImm(){if(!this.data||!this.data.data)return;this._fireRenderStatus(CompMapLayerEventType.RENDER_BEGIN);const e=this.data;this._raster.setDataOption({data:e.data.values,vmin:e.data.vmin,vmax:e.data.vmax,filter:this._filter,noDataVal:e.data.noData,xcells:e.xcells,ycells:e.ycells,extent:e.extent});const t=this.colors.list.map(e=>{return{min:e.minV,max:e.maxV,color:e.color}});this._raster.setColors(t,this._colorGradient);this._fireRenderStatus(CompMapLayerEventType.RENDER_COMPLATE)}set interpFilter(e){this._filter=e;this.update()}get interpFilter(){return this._filter}clear(){var e;(e=this._raster)===null||e===void 0?void 0:e.clear()}destroy(){if(this._raster){this._raster.destroy();this._raster=undefined}}_getFormatter(e){if(!CompUtils.isDefined(e))return;const t=CompUtils.buildPropertyGetter(e,["value"]);return e=>t({view:this._view,layer:this.layer,values:[e]})}}class CompRasterDirectRender extends CompRasterBaseRender{constructor(e,t){super(e,t);const r=t;let s=undefined;if(CompUtils.isDefined(r.label)){s=Object.assign({},r.label);s.formatter=this._getFormatter(s.formatter)}this._colorGradient=r.colorGradient;this._raster=new OLE.RasterLayer(undefined,{userWorker:true,mode:r.mode||"raster",label:s,clip:r.clip});if(CompUtils.isDefined(r.interpFilter)){this._filter=r.interpFilter}}get factory(){return CompRasterDirectRenderFactory}}const CompRasterDirectRenderFactory=new CompRenderFactory("raster",[CompResourceDataType.RASTER,CompResourceDataType.RASTERUV],CompRasterDirectRender,[Comp.LicenseDefine.Renders.Raster]);CompRenderFactorys.regFactory(CompRasterDirectRenderFactory);class CompRasterTextRender extends CompRasterBaseRender{constructor(e,t){super(e,t);const r={enable:true,enableRaster:false,font_name:t.font_name,font_size:t.font_size,color:t.color,fixed:t.fixed,padding:t.padding,grid:t.grid,stroke:t.stroke,formatter:this._getFormatter(t.formatter)};this._raster=new OLE.RasterLayer(undefined,{userWorker:true,label:r,clip:t.clip})}get factory(){return CompRasterTextRenderFactory}}const CompRasterTextRenderFactory=new CompRenderFactory("raster-text",[CompResourceDataType.RASTER,CompResourceDataType.RASTERUV],CompRasterTextRender,[Comp.LicenseDefine.Renders.Raster]);CompRenderFactorys.regFactory(CompRasterTextRenderFactory);class CompRasterIsoRender extends CompRasterDataRender{constructor(e,t){super(e,t);this._raster=new OLE.CustomWmsLayer({getImage:(e,t,r,s,i)=>this._GetImage(e,t,r,s,i),win:undefined})}get factory(){return CompRasterIsoRenderFactory}get olLayer(){var e;return(e=this._raster)===null||e===void 0?void 0:e.layer}updateImm(){this._initIsoLine()}clear(){var e;(e=this._raster)===null||e===void 0?void 0:e.clear()}destroy(){if(this._raster){this._raster.destroy();this._raster=undefined}}async _GetImage(e,t,r,s,i){if(!this._isoOnServer)return Promise.resolve(undefined);try{return await this._isoOnServer.getImage(e,t,r,s,i)}catch(e){this._fireRenderStatus(CompMapLayerEventType.RENDER_ERROR);throw e}finally{this._fireRenderStatus(CompMapLayerEventType.RENDER_COMPLATE)}}_initIsoLine(){if(!this.data)return;this._fireRenderStatus(CompMapLayerEventType.RENDER_BEGIN);const e=this._declare;const t={type:"RasterDataset",width:this.data.xcells,height:this.data.ycells,extent:this.data.extent,base64:this.data.data.base64};if(!this._isoOnServer)this._isoOnServer=new OLE.CompIsoOnServer;this._isoOnServer.init(e,ColorTool.toPiecewiseColors(this.layer.colors),t).then(e=>{this._raster.refresh()}).catch(e=>{this._fireRenderStatus(CompMapLayerEventType.RENDER_ERROR);this._fireRenderStatus(CompMapLayerEventType.RENDER_COMPLATE)})}}const CompRasterIsoRenderFactory=new CompRenderFactory("raster-iso",[CompResourceDataType.RASTER,CompResourceDataType.RASTERUV],CompRasterIsoRender,[Comp.LicenseDefine.Renders.Isogram]);CompRenderFactorys.regFactory(CompRasterIsoRenderFactory);class CompHightLightScatter{constructor(){}setPoint(e,t,r,s){this._point=e;this._x=e[t];this._y=e[r];this._style=s}onCustomDraw(r,e,s,i,o){if(this._point){const a=this._point;const n=this._x;const l=this._y;let e=Math.floor((n-r[0])/s)*i;let t=Math.floor((r[3]-l)/s)*i;OLE.LargePointsLayer.draw({pd:a,ostyle:this._style,ctx:o,cx:e,cy:t})}}}class CompScatterRender extends CompTableDataRender{constructor(e,t){super(e,t);this._pointsDrawer=new OLE.LargePointsLayer;this._pointsDrawer.setHiddenRadious(3);this._pointsDrawer.setStyle(e=>this._getStyle(e));this._tooltipPoint=new CompHightLightScatter}get factory(){return CompPointRenderFactory}get olLayer(){var e;return(e=this._pointsDrawer)===null||e===void 0?void 0:e.layer}updateImm(){const e=this._layer;if(!e.values)return;this._fireRenderStatus(CompMapLayerEventType.RENDER_BEGIN);const t=this._declare;this._fieldValue=CompFieldsHelp.findField(e.fields,t.fieldValue);const r=CompFieldsHelp.findField(e.fields,t.fieldX);const s=CompFieldsHelp.findField(e.fields,t.fieldY);this._fieldX=r!==-1?r:e.fieldx;this._fieldY=s!==-1?s:e.fieldy;this._initFilter();this._initStyle();let i;if(this._filter){i=[];e.values.forEach(e=>{if(this._filter(e)){return}i.push(e)})}else{i=e.values}this._pointsDrawer.setPoints({points:i,fieldX:this._fieldX,fieldY:this._fieldY});this._fireRenderStatus(CompMapLayerEventType.RENDER_COMPLATE)}clear(){var e;(e=this._pointsDrawer)===null||e===void 0?void 0:e.clear()}destroy(){if(this._pointsDrawer){this._pointsDrawer.destroy();this._pointsDrawer=undefined}this._tooltipPoint=undefined}queryTip(e,t,r){const s=this._pointsDrawer.getValue(e,t,r);if(s){this._tooltipPoint.setPoint(s,this._fieldX,this._fieldY,this._getStyle(s,true));return{layer:this._layer,fields:this._layer.fields,values:s,hlShape:this._tooltipPoint}}return}_initFilter(){const e=this._declare;let t=e.filter;if(!t)return;if(typeof t==="function"){this._filter=t;return}if(!Array.isArray(t)){t=[t]}const s=t.map(e=>{return{case:CompUtils.buildCaseFunction(e.case),field:CompFieldsHelp.findField(this._layer.fields,e.field),value:e.value}});const i=s.length;this._filter=t=>{for(let e=0;e<i;++e){const r=s[e];if(r.field==-1)continue;if(r.case(undefined,{value:t[r.field]})){if(r.value===undefined)return true;t[r.field]=r.value}}return false}}_initStyle(){var e,t;const s=this._layer.fields;function r(t){const r={};for(let e in t){r[e]=CompUtils.buildPropertyGetter(t[e],s)}return r}const i=this._declare;const o=r(i.styleNormal);const a=r(i.styleEmphasis);const n=r((e=i.styleNormal)===null||e===void 0?void 0:e.label);const l=r((t=i.styleEmphasis)===null||t===void 0?void 0:t.label);this._styleNormal=o;this._styleEmphasis=Object.assign({},o,a);this._styleNormal.label=n;this._styleEmphasis.label=Object.assign({},n,l)}_getStyle(i,e){const t=this._declare;const o=this._layer.fields;const r=e?this._styleEmphasis:this._styleNormal;const s={view:this._layer.view,layer:this._layer,values:i};function a(e,t,r){const s=e?e(t):r;if(typeof s==="string"){return CompUtils.replaceTokenByFiled(o,i,s)}return s}function n(e){if(e==""||e==null||e==undefined)return false;return!isNaN(e)}let l=i[this._fieldValue];let c=i.length-1;while(!n(l)&&c>0){l=i[c];c--}if(this.layer.filterByColor(l)){return{type:OLE.PointStyleType.NONE}}const u=this.getColor(l);const h=a(r.symbol,s,OLE.PointShapeType.CIRCLE);const p=a(r.symbolSize,s,5);const d=a(r.symbolRotate,s,0);const f=u||a(r.fillColor,s);const m=a(r.lineColor,s);const y=a(r.lineWidth,s);const _=r.label;const g={type:OLE.PointStyleType.SHAPE};g.shape=h||OLE.PointShapeType.CIRCLE;g.radius=p/2;g.rotate=d;g.fillColor=f;g.lineColor=m;g.lineWidth=y;if(g.shape.startsWith("image://")){g.type=OLE.PointStyleType.ICON;g.icon={url:g.shape.substring(8)}}if(_&&a(_.enable,s)!==false){g.label={};g.label.color=a(_.color,s);if(g.label.color==="auto")g.label.color=u;const C=a(_.offset,s);g.label.font=a(_.font,s);if(C){g.label.offsetX=C[0];g.label.offsetY=C[1]}const R=a(_.text,s);const v=a(_.stroke,s,{width:0,color:"#000"});const w=a(_.background,s,{shapeDraw:false});g.label.formatter=()=>R;g.label.textAlign=a(_.textAlign,s);g.label.textBaseline=a(_.textBaseline,s);g.label.lineWidth=()=>v.width;g.label.lineColor=()=>v.color;g.label.background=()=>w}return g}}const CompScatterRenderFactory=new CompRenderFactory("scatter",[CompResourceDataType.TABLE],CompScatterRender,[Comp.LicenseDefine.Renders.Scatter]);CompRenderFactorys.regFactory(CompScatterRenderFactory);class CompStreamLineRender extends CompUVDataRender{constructor(e,t){super(e,t);const r=t;this._stream=new OLE.StreamLineLayer(null,r)}get factory(){return CompWindVectorRenderFactory}get olLayer(){return this._stream.layer}query(e,t){if(!this.data)return undefined;const{datau:r,datav:s,xcells:i,ycells:o,extent:a}=this.data;const n=(a[2]-a[0])/i;const l=(a[3]-a[1])/o;const c=Math.floor((e-a[0])/n);const u=Math.floor((t-a[1])/l);if(c<0||c>=i||u<0||u>=o)return undefined;const h=c+u*i;return[r[h],s[h]]}updateImm(){if(!this.data)return;this._fireRenderStatus(CompMapLayerEventType.RENDER_BEGIN);function e(e){const{values:t,vmin:r,vmax:s,noData:i}=e;let o=t.length;const a=new Float32Array(o);for(let e=0;e<o;++e){const n=t[e];if(n>s||n<r||n==i)a[e]=0;else a[e]=n}return a}const t=this.data;const r=e(t.datau);const s=e(t.datav);this._stream.setData({u:r,v:s,width:t.xcells,height:t.ycells,range:t.extent});this._fireRenderStatus(CompMapLayerEventType.RENDER_COMPLATE)}clear(){this._stream.clear()}destroy(){}}const CompStreamLineRenderFactory=new CompRenderFactory("streamLine",[CompResourceDataType.RASTERUV],CompStreamLineRender,[Comp.LicenseDefine.Renders.StreamLine]);CompRenderFactorys.regFactory(CompStreamLineRenderFactory);class CompTyphoonRender extends CompTableDataRender{constructor(e,t){super(e,t);this._tooltipPoint=new CompHightLightScatter;const r=this._declare;this._typhoon=new OLE.TyphoonLayer(this.olMap,{icon:r.icon,showAlertLine:r.enableAlertLine});const s=CompUtils.defualtValue(r.enableClick,true);if(s)this._typhoon.enableClick();e.olLayer.on("change:visible",()=>{const e=this._layer.getVisible();this._typhoon.udpateIconVisible(e)})}get factory(){return CompTyphoonRenderFactory}get olLayer(){return this._typhoon.layer}updateImm(){const i=this._layer.fields;const e=this._layer.values;if(!e)return;this._fireRenderStatus(CompMapLayerEventType.RENDER_BEGIN);const o=this._declare;const a=CompFieldsHelp.findField;const n=(e,t,r)=>{const s=a(i,e);return CompUtils.defualtValue(t[s],r)};const t=a(i,o.fieldX);const r=a(i,o.fieldY);this._fieldX=t!==-1?t:this._layer.fieldx;this._fieldY=r!==-1?r:this._layer.fieldy;const l=a(i,o.fieldDate);const s=a(i,o.fieldWindSpeed);const c=a(i,o.fieldForecast);const u=a(i,o.fieldRadii.radius7);const h=a(i,o.fieldRadii.radius10);const p=a(i,o.fieldRadii.radius12);const d={x:i[t],y:i[r],datetime:i[l],windspeed:i[s],forecast:i[c],radius7:i[u],radius10:i[h],radius12:i[p]};if(l!=-1){e.sort((e,t)=>{const r=e[l];const s=t[l];return r.localeCompare(s)})}const f={};e.forEach(e=>{const t=n(o.fieldId,e);let r=f[t];if(!r){const s=n(o.fieldName,e,"");f[t]=r={id:t,name:s,fields:i,values:[],fieldMap:d}}r.values.push(e)});const m=OLE.ColorTable.createPiecewise(this.colors.list.map(e=>{return{min:e.minV,max:e.maxV,color:e.color}}));this._typhoon.clear();for(let e in f){this._typhoon.addTyphoon({data:f[e],circles:o.circleStyles,label:o.labelStyle,point:o.pointStyle,forecast:o.forecastStyle,forecastLine:o.forecastLineStyle,showForecastCircle:o.showForecastCircle,interval:o.interval,interpDistance:o.interpDistance,colors:m})}this._fireRenderStatus(CompMapLayerEventType.RENDER_COMPLATE)}clear(){this._typhoon.clear()}destroy(){this._typhoon.destroy()}queryTip(e,t,r){const s=this._typhoon.getValue(e,t,r);if(s){const i=s.point.data;const o=s.typhoon.colors.getCssColor(s.point.windspeed);this._tooltipPoint.setPoint(i,this._fieldX,this._fieldY,{type:PointEngine.PointStyleType.SHAPE,shape:PointEngine.PointShapeType.CIRCLE,fillColor:o,lineColor:"rgba(0, 0, 0, 0.6)",lineWidth:1,radius:[5,5]});return{layer:this._layer,fields:this._layer.fields,values:i,hlShape:this._tooltipPoint}}return}}const CompTyphoonRenderFactory=new CompRenderFactory("typhoon",[CompResourceDataType.TABLE],CompTyphoonRender,[Comp.LicenseDefine.Renders.Typhoon]);CompRenderFactorys.regFactory(CompTyphoonRenderFactory);class CompWindVectorRender extends CompUVDataRender{constructor(e,t){super(e,t);this._wind=new RasterEngine.WindArrowLayer(undefined);const r=t;this._wind.arrowSize=r.windSize;this._wind.arrowColor=r.windColor}get factory(){return CompWindVectorRenderFactory}get olLayer(){var e;return(e=this._wind)===null||e===void 0?void 0:e.layer}query(e,t){if(!this.data)return undefined;const{datau:r,datav:s,xcells:i,ycells:o,extent:a}=this.data;const n=(a[2]-a[0])/i;const l=(a[3]-a[1])/o;const c=Math.floor((e-a[0])/n);const u=Math.floor((t-a[1])/l);if(c<0||c>=i||u<0||u>=o)return undefined;const h=c+u*i;return[r[h],s[h]]}updateImm(){if(!this.data)return;this._fireRenderStatus(CompMapLayerEventType.RENDER_BEGIN);function e(e){return{data:e.values,min:e.vmin,max:e.vmax,noData:e.noData}}const t=this.data;this._wind.setDataOption({datau:e(t.datau),datav:e(t.datav),xcells:t.xcells,ycells:t.ycells,extent:t.extent});this._fireRenderStatus(CompMapLayerEventType.RENDER_COMPLATE)}clear(){var e;(e=this._wind)===null||e===void 0?void 0:e.clear()}destroy(){if(this._wind){this._wind.destroy();this._wind=undefined}}}const CompWindVectorRenderFactory=new CompRenderFactory("windVector",[CompResourceDataType.RASTERUV],CompWindVectorRender,[Comp.LicenseDefine.Renders.WindVector]);CompRenderFactorys.regFactory(CompWindVectorRenderFactory);class CompWmsDataRender extends CompMapDataRender{constructor(e,t){super(e,t);this._wms=new RasterEngine.CustomWmsLayer({getImage:(e,t,r,s,i)=>this._getImage(e,t,r,s,i),win:undefined})}get factory(){return CompWmsDataRenderFactory}get olLayer(){var e;return(e=this._wms)===null||e===void 0?void 0:e.layer}updateImm(){if(this._imageFlag)this._imageFlag.cancel=true;const e=this.data;if(e.extent)this._wms.layer.setExtent(e.extent);this._wms.update()}clear(){var e;(e=this._wms)===null||e===void 0?void 0:e.clear()}destroy(){if(this._wms){this._wms.destroy();this._wms=undefined}}async _getImage(e,t,r,s,i){const o=this.data;if(!o)return;this._fireRenderStatus(CompMapLayerEventType.RENDER_BEGIN);try{const a=this._imageFlag={cancel:false};const n=new CompWmsHelp(e,t,r,s,i);const l=CompUtils.replaceTokenByFiled(undefined,n,o.url);const c=await CompUtils.createImagePromise(l,a);this._fireRenderStatus(CompMapLayerEventType.RENDER_COMPLATE);return c}catch(e){this._fireRenderStatus(CompMapLayerEventType.RENDER_ERROR);this._fireRenderStatus(CompMapLayerEventType.RENDER_COMPLATE);throw e}}}class CompWmsHelp{constructor(e,t,r,s,i){this.minx=this.west=e[0];this.miny=this.south=e[1];this.maxx=this.east=e[2];this.maxy=this.north=e[3];this.width=s[0];this.height=s[1];this.bbox=e.join();this.size=s.join()}}const CompWmsDataRenderFactory=new CompRenderFactory("wms",[CompResourceDataType.MAP],CompWmsDataRender);CompRenderFactorys.regFactory(CompWmsDataRenderFactory);class CompWtmsDataRender extends CompMapDataRender{constructor(e,t){super(e,t);this._tile=new ol.layer.Tile}get factory(){return CompWtmsDataRenderFactory}get olLayer(){return this._tile}updateImm(){if(!this.data)return;const e=this.data;const t=this._view.olMap.getView().getProjection().getCode();let r=undefined;switch(e.type){case"xyz":r=new ol.source.XYZ({url:e.url,projection:e.projection||t});break;case"zmap":r=new ol.source.TileZMap({projection:e.projection||t,url:e.url,tileGrid:e.topGrid||this._view.zmap2d.olTileGrid,attributions:[]});break}if(r==undefined){console.warn("不支持的瓦片地图类型");return}this._fireRenderStatus(CompMapLayerEventType.RENDER_BEGIN);this._tile.setSource(r);this._fireRenderStatus(CompMapLayerEventType.RENDER_COMPLATE)}clear(){}destroy(){this._tile=undefined}}const CompWtmsDataRenderFactory=new CompRenderFactory("wtms",[CompResourceDataType.MAP],CompWtmsDataRender,[],["tile"]);CompRenderFactorys.regFactory(CompWtmsDataRenderFactory);class CompCommonDataset extends CompResource{constructor(e){super(e);this.exdata=e}get dataType(){return CompResourceDataType.TABLE}load(n){var e,t,r;const l=this.exdata;const s=this.getBaseTime(n.time,this.declare.nowUrlType===URLType.NORMAL);const i=OLE.guid();const o={uuid:i,UUID:i.toUpperCase(),timestamp:(new Date).getTime(),random:Math.random()*2147483648|0};let a=l.url;const c=l.method||"GET";const u=l.contentType||"application/x-www-form-urlencoded";const h=Object.assign({},l.headers,{"Content-Type":u});let p;const d=CompUtils.defualtValue((e=l.sign)===null||e===void 0?void 0:e.signOnlyParams,[]);const f=Comp.getSignFunction((t=l.sign)===null||t===void 0?void 0:t.method);let m;if(typeof l.data==="string"){m=CompResource.fmtParam(s,o,l.data);if(f)p=f(m)}else if(l.data){if(u==="application/x-www-form-urlencoded"){const _=[],g=[];Object.keys(l.data).sort().forEach(e=>{const t=CompResource.fmtParam(s,o,l.data[e]);g.push(`${e}=${t}`);if(!d.includes(e))_.push(`${e}=${encodeURIComponent(t)}`)});if(f){p=f(g.join("&"));if(l.sign.place=="data")_.push(`${l.sign.paramName}=${p}`)}m=_.join("&")}else if(u==="application/json"){const C=CompResource.fmtParamJSON(s,o,OLE.deepAssign({},l.data));if(l.sign){p=f(JSON.stringify(C));d.forEach(e=>delete C[e]);if(l.sign.place=="data")C[l.sign.paramName]=p}m=JSON.stringify(C)}}if(((r=l.sign)===null||r===void 0?void 0:r.place)==="header"){h[l.sign.paramName]=p}if(c==="GET"){a+=(a.indexOf("?")!=-1?"&":"?")+m;m=undefined}function y(t,r){if(!t)return;for(let e=0;e<r.length;++e){t=t[r[e]];if(!t)return}return t}fetch(a,{method:c,headers:h,body:m}).then(e=>{if(!e.ok)return Promise.reject(e.text());return e.json()}).then(e=>{const t=l.responseDataPath||l.path||["data"];const r=y(e,t);let s=[];let i=[];if(r&&r.length){const a=r[0];s=Object.keys(a);i=r.map(t=>{return s.map(e=>t[e])})}const o=new CompResourceTable({fields:s,rows:i,fieldx:CompFieldsHelp.findField(s,this.exdata.fieldx,["经度","x","X","LON"]),fieldy:CompFieldsHelp.findField(s,this.exdata.fieldy,["纬度","y","Y","LAT"]),isLastPart:true});CompResource.callLoadGotData(n,o);CompResource.callLoadDataSuccess(n);CompResource.callLoadDataFinish(n)}).catch(e=>{CompResource.callLoadDataError(n,e)})}changeDataSetType(e){}set futureTime(e){}get futureTime(){return this.declare.futureValue}}var Comp;(function(e){function t(e){if(e=="md5")return r;if(e=="MD5")return i;return undefined}e.getSignFunction=t;function s(e,t){return Array(t).join("0").concat(e).slice(-t)}function r(e){const t=new goog.crypt.Md5;t.update(e);const r=t.digest();return r.map(e=>s(e.toString(16),2)).join("")}function i(e){return r(e).toUpperCase()}})(Comp||(Comp={}));CompResourceFactory.factories["CompCommonDataset"]=CompCommonDataset;class CompMapDataset extends CompResource{constructor(e){super(e)}get dataType(){return CompResourceDataType.MAP}load(r){this._checkData(r).then(e=>{const t=this._loadData(r,e);CompResource.callLoadGotData(r,e?t:null);CompResource.callLoadDataSuccess(r);CompResource.callLoadDataFinish(r)},()=>{CompResource.callLoadDataError(r,"");CompResource.callLoadDataFinish(r)})}_checkData(e){const t=this.getBaseTime(e.time);const r=CompResource.fmtParam(t,e.params,this.declare.url);const s=new CompZMapServerCheck(r);if(s.isZMapServer){return s.checkHasData()}else{return Promise.resolve({ok:true})}}}class CompMemoryDataset extends CompResource{constructor(e){super(e);this.exdata=e}get dataType(){return CompResourceDataType.TABLE}load(t){const r=this.exdata.data;setTimeout(()=>{const e=new CompResourceTable({fields:r.fields,rows:r.rows,fieldx:CompFieldsHelp.findField(r.fields,r.fieldx,["经度","x","X","LON"]),fieldy:CompFieldsHelp.findField(r.fields,r.fieldy,["纬度","y","Y","LAT"]),isLastPart:true});CompResource.callLoadGotData(t,e)});CompResource.callLoadDataSuccess(t);CompResource.callLoadDataFinish(t)}changeDataSetType(t){if(t===URLType.FUTURE){this.declare.nowUrlType=t;let e=this.declare.urls.find(e=>e.type===this.declare.nowUrlType);this.declare.nowDataType=e.dataType||DataType.GRID}else{this.declare.nowUrlType=t;this.declare.nowDataType=undefined}}set futureTime(e){this.declare.futureValue=this.fillNumber(e)}get futureTime(){return this.declare.futureValue}fillNumber(t){const r=[];for(let e=t.length;e<3;e++){r.push(0)}return r.join("")+t}}class CompMemoryRasterDataset extends CompResource{get dataType(){return CompResourceDataType.RASTERUV}load(e){}}CompResourceFactory.factories["MemoryTableDataset"]=CompMemoryDataset;class CompSmartbiDataset extends CompResource{constructor(e){super(e);this.exdata=e}get dataType(){return CompResourceDataType.TABLE}load(t){const r=this.getBaseTime(t.time,this.declare.nowUrlType===URLType.NORMAL);const e=this.getDatasetID();const s=new SmartbiDataset(this.getAddress(),e);const i=this.exdata.params;const o=this.exdata.batchCount||1e3;const a=i?i.map(e=>({id:e.id,value:CompResource.fmtParam(r,t.params,e.value)})):[];(this.declare.nowUrlType===URLType.FUTURE&&(!this.declare.futureList||this.declare.futureUList)?s.getFutureList(e,this.declare.nowDataType):new Promise(e=>e(undefined))).then(e=>{if(e&&e.type===DataType.GRID){this.declare.futureList=e.data1}else if(e&&e.type===DataType.UVGRID){this.declare.futureUList=e.data1;this.declare.futureVList=e.data2}}).then(()=>{if(this.declare.nowUrlType===URLType.FUTURE){if(this.declare.nowDataType===DataType.GRID){a.push({id:"Nc查询-变量名称",value:this.pickFutureRealValue()})}else if(this.declare.nowDataType===DataType.UVGRID){a.push({id:"varu",value:this.pickFutureURealValue()});a.push({id:"varv",value:this.pickFutureVRealValue()})}}s.fetch({params:a,rows:o,gotdata:e=>SmartbiUtils.asTable(t,e,this.exdata.fieldx,this.exdata.fieldy),success:t.success,error:t.error,finish:t.finish})})}changeDataSetType(t){if(t===URLType.FUTURE){this.declare.nowUrlType=t;let e=this.declare.urls.find(e=>e.type===this.declare.nowUrlType);this.declare.nowDataType=e.dataType||DataType.GRID}else{this.declare.nowUrlType=t;this.declare.nowDataType=undefined}}set futureTime(e){this.declare.futureValue=this.fillNumber(e)}get futureTime(){return this.declare.futureValue}fillNumber(t){const r=[];for(let e=t.length;e<3;e++){r.push(0)}return r.join("")+t}pickFutureRealValue(){let e=this.declare.futureList.find(e=>e[1].indexOf(this.declare.futureValue)>-1);return e?e[0]:this.declare.futureList[0][0]}pickFutureURealValue(){let e=this.declare.futureUList.find(e=>e[1].indexOf(this.declare.futureValue)>-1);return e?e[0]:this.declare.futureUList[0][0]}pickFutureVRealValue(){let e=this.declare.futureVList.find(e=>e[1].indexOf(this.declare.futureValue)>-1);return e?e[0]:this.declare.futureVList[0][0]}getAddress(){const e=this.declare.url;const t=CompSmartbiDataset.SmartBiPrefix;const r=e.indexOf(`/${t}/vision`);return(r!=-1?e.substring(0,r):"")+`/${t}/vision/RMIServlet`}getDatasetID(){const e=this.declare.url;const t=this.declare.urls;if(Array.isArray(t)){let e=t.find(e=>e.type===this.declare.nowUrlType);if(!e){throw new Error("cant find url type: "+this.declare.nowUrlType)}const r=e.url.lastIndexOf("resid=");return r!=-1?e.url.substring(r+6):""}else{const r=e.lastIndexOf("resid=");return r!=-1?e.substring(r+6):""}}}CompSmartbiDataset.SmartBiPrefix="ywwhome";class CompSmartbiRasterDataset extends CompSmartbiDataset{constructor(e){super(e)}get dataType(){return CompResourceDataType.RASTER}load(t){super.load({time:t.time,params:t.params,gotdata:e=>SmartbiUtils.asRaster(t,e),success:t.success,error:t.error,finish:t.finish})}}class CompSmartbiUVRasterDataset extends CompSmartbiDataset{constructor(e){super(e)}get dataType(){return CompResourceDataType.RASTERUV}load(t){super.load({time:t.time,params:t.params,gotdata:e=>SmartbiUtils.asRasterUV(t,e),success:t.success,error:t.error,finish:t.finish})}}CompResourceFactory.factories["SmartbiDataset"]=CompSmartbiDataset;CompResourceFactory.factories["SmartbiRasterDataset"]=CompSmartbiRasterDataset;CompResourceFactory.factories["SmartbiUVRasterDataset"]=CompSmartbiUVRasterDataset;var SmartbiUtils;(function(e){function t(e,t,r,s){const i=new CompResourceTable({fields:t.fields,rows:t.data,fieldx:CompFieldsHelp.findField(t.fields,r,["经度","x","X","LON"]),fieldy:CompFieldsHelp.findField(t.fields,s,["纬度","y","Y","LAT"]),isLastPart:t.isLastPart});CompResource.callLoadGotData(e,i)}e.asTable=t;function r(e,t){if(t.rows.length==0){console.warn("没有查询到数据");CompResource.callLoadGotData(e,null);return}const r=t.rows[0];const s=Number.parseInt(r[2]);const i=Number.parseInt(r[3]);const o=r.slice(4,8);o.forEach((e,t)=>o[t]=Number.parseFloat(e));const a=r[9];const{data:n,min:l,max:c,noData:u}=RasterEngine.unpackRasterData(a);const h=new CompResourceRaster({extent:o,xcells:s,ycells:i,data:{values:n,vmin:l,vmax:c,noData:u,base64:a}});CompResource.callLoadGotData(e,h)}e.asRaster=r;function s(e,t){if(t.rows.length==0){console.warn("没有查询到数据");CompResource.callLoadGotData(e,null);return}const r=t.rows[0];const s=Number.parseInt(r[2]);const i=Number.parseInt(r[3]);const o=r.slice(4,8);o.forEach((e,t)=>o[t]=Number.parseFloat(e));const a=RasterEngine.unpackRasterData(r[9]);const n=RasterEngine.unpackRasterData(r[10]);let l;const c=CompFieldsHelp.findField(t.fields,"SCALAR");const u=r[c];if(u){l=RasterEngine.unpackRasterData(u)}const h={extent:o,xcells:s,ycells:i,data:undefined,datau:{values:a.data,vmin:a.min,vmax:a.max,noData:a.noData,base64:r[9]},datav:{values:n.data,vmin:n.min,vmax:n.max,noData:n.noData,base64:r[10]}};if(l){h.data={values:l.data,vmin:l.min,vmax:l.max,noData:l.noData,base64:u}}const p=new CompResourceUVRaster(h);CompResource.callLoadGotData(e,p)}e.asRasterUV=s})(SmartbiUtils||(SmartbiUtils={}));class CompSmartbiDatasetLocal extends CompResource{get dataType(){return CompResourceDataType.TABLE}load(t){fetch(this.declare.url).then(e=>e.json()).then(e=>this.asTable(t,e.result)).then(e=>CompResource.callLoadDataSuccess(t)).catch(e=>CompResource.callLoadDataError(t,e)).then(e=>CompResource.callLoadDataFinish(t))}asTable(e,t){const r=t.map((e,t)=>t.toString());const s=new CompResourceTable({fields:r,rows:t,fieldx:undefined,fieldy:undefined,isLastPart:true});CompResource.callLoadGotData(e,s)}}class CompSmartbiRasterDatasetLocal extends CompSmartbiDatasetLocal{constructor(e){super(e)}get dataType(){return CompResourceDataType.RASTER}load(t){super.load({time:t.time,params:t.params,gotdata:e=>SmartbiUtils.asRaster(t,e),success:t.success,error:t.error,finish:t.finish})}}class CompSmartbiUVRasterDatasetLocal extends CompSmartbiDatasetLocal{constructor(e){super(e)}get dataType(){return CompResourceDataType.RASTERUV}load(t){super.load({time:t.time,params:t.params,gotdata:e=>SmartbiUtils.asRasterUV(t,e),success:t.success,error:t.error,finish:t.finish})}}CompResourceFactory.factories["SmartbiDatasetLocal"]=CompSmartbiDatasetLocal;CompResourceFactory.factories["SmartbiRasterDatasetLocal"]=CompSmartbiRasterDatasetLocal;CompResourceFactory.factories["SmartbiUVRasterDatasetLocal"]=CompSmartbiUVRasterDatasetLocal;class CompWmsMapDataset extends CompMapDataset{constructor(e){super(e)}_loadData(e,t){const r=this.getBaseTime(e.time);const s=this.declare;return new CompResourceWmsMapData({url:CompResource.fmtParam(r,e.params,this.declare.url),extent:CompUtils.defualtValue(s.extent,t.extent),projection:s.projection})}}CompResourceFactory.factories["WmsDataset"]=CompWmsMapDataset;class CompWtmsMapDataset extends CompMapDataset{constructor(e){super(e)}_loadData(e){const t=this.getBaseTime(e.time);const r=this.declare;return new CompResourceWtmsMapData({url:CompResource.fmtParam(t,e.params,this.declare.url),type:r.tileType,extent:r.extent,projection:this.declare.projection,topGrid:r.topGrid})}}CompResourceFactory.factories["WtmsDataset"]=CompWtmsMapDataset;CompResourceFactory.factories["TileMapDataset"]=CompWtmsMapDataset;var ZMapMiddleWareEnum;(function(e){e["LocalRawRaster"]="LocalRawRaster";e["LocalBz2Raster"]="LocalBz2Raster"})(ZMapMiddleWareEnum||(ZMapMiddleWareEnum={}));class CompZMapServerCheck{constructor(e){this._url=e;if(CompZMapServerCheck.Regx_zsTileMap.test(e)||CompZMapServerCheck.Regx_zsMap.test(e)){this._server=RegExp.$1;this._catalog=RegExp.$2;this._query=RegExp.$3;this._infoURL=`${this._server}/zs/data/${this._catalog}?f=json`}}get url(){return this._url}get server(){return this._server}get catalog(){return this._catalog}get info(){return this._info}get isZMapServer(){return this._server!==undefined}async checkHasData(){if(!this._infoURL)return Promise.resolve({ok:false});const e=await fetch(this._infoURL);const t=this._info=await e.json();if(t.attributes.MiddleWare===ZMapMiddleWareEnum.LocalRawRaster||t.attributes.MiddleWare===ZMapMiddleWareEnum.LocalBz2Raster){const r=new URL(`${this._server}/zs/data/${this._catalog}/tile/datainfo${this._query}`);r.searchParams.delete("id");r.searchParams.delete("range");const s=[];r.searchParams.forEach((e,t)=>{if(CompZMapServerCheck.Regx_CustomTags.test(e)){s.push(t)}});s.forEach(e=>r.searchParams.delete(e));const i=await fetch(r.toString());const o=await i.json();const a=o.extent;return{ok:o.success!==false,extent:[a.xmin,a.ymin,a.xmax,a.ymax]}}else{return{ok:true}}}}CompZMapServerCheck.Regx_zsMap=/(.+)\/zs\/data\/(.+)\/map(.+)/;CompZMapServerCheck.Regx_zsTileMap=/(.+)\/zs\/data\/(.+)\/tile\/map(.+)/;CompZMapServerCheck.Regx_CustomTags=/^{.+}$/;
