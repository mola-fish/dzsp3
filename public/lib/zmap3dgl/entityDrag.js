!function(e){var t=function(e,t,i){e&&t?(this.GmMap3D=e,this.map3DView=t,this.viewer=t.cesium.viewer,this.inited=!0,this.map3DTool=new ZMap3DLib.Input3DTool(t),this.axisLength=i&&i.length||300):this.inited=!1,this.lines=[],this.points=[],this.polygons=[],this.polylines=[],this.labels=[],this.lineLabels=[],this.editing=!1,this.leftDownFlag=!1,this.pointDraged=null,this.opt={}};t.prototype={msg:{typeError:"请传入实体类型"},init:function(e,t,i){return this.inited||(this.GmMap3D=e,this.map3DView=t,this.viewer=t.cesium.viewer,this.inited=!0,this.map3DTool=new ZMap3DLib.Input3DTool(t),this.axisLength=i&&i.length||300),this},adjustEntity:function(e,t){if("Entity"!==this.entityType(e))throw new Error(this.msg.typeError);t&&(this.opt=t),e.polyline?this.adjustPolyline(e,t):e.point&&this.adjustPoint(e,t)},adjustPoint:function(e){e.point.color=GmMap3D.Color.YELLOW;var t=this.setReferenceFrame(e),i=this;this.viewer.screenSpaceEventHandler.setInputAction((function(e,t){i.pointDraged=i.viewer.scene.pick(e.position),i.leftDownFlag=!0,i.pointDraged&&(i.viewer.scene.screenSpaceCameraController.enableRotate=!1)}),GmMap3D.ScreenSpaceEventType.LEFT_DOWN),this.viewer.screenSpaceEventHandler.setInputAction((function(e){i.leftDownFlag=!1,i.pointDraged=null,i.viewer.scene.screenSpaceCameraController.enableRotate=!0}),GmMap3D.ScreenSpaceEventType.LEFT_UP),this.viewer.screenSpaceEventHandler.setInputAction((function(n){if(!0===i.leftDownFlag&&null!=i.pointDraged){var o=i.viewer.camera.getPickRay(n.endPosition),r=i.viewer.scene.globe.pick(o,i.viewer.scene);e.position=new Cesium.ConstantPositionProperty(r);var a=i.GmMap3D.Transforms.eastNorthUpToFixedFrame(r);t.modelMatrix=a}}),GmMap3D.ScreenSpaceEventType.MOUSE_MOVE)},adjustPolyline:function(e){var t=Date.now(),i=e.polyline,n=i.positions._value;this.pts=n,this.polyline=i;var o=[];this.arrowsArr=o,n.forEach((function(e,t){var i=this.addEntityPoint(e);arrows=this.setReferenceFrame(e,i),o.push(arrows)}),this),i.positions=new GmMap3D.CallbackProperty((function(){return n.map((function(e){return new GmMap3D.Cartesian3(e.x,e.y,e.z)}))}),!1);var r=this;this.control=new GmMap3D.ScreenSpaceEventHandler(this.viewer.scene.canvas);var a=this.control;a.setInputAction((function(e,t){(r.moving=!0,r.pointDraged=r.viewer.scene.pick(e.position),r.leftDownFlag=!0,r.pointDraged)&&(r.pointDraged.id.type&&(r.viewer.scene.screenSpaceCameraController.enableRotate=!1))}),GmMap3D.ScreenSpaceEventType.LEFT_DOWN),a.setInputAction((function(e){if(r.moving=!1,r.pointDraged){var t=r.viewer.camera.getPickRay(e.position),i=(r.viewer.scene.globe.pick(t,r.viewer.scene),r.pointDraged.id&&r.pointDraged.id.belong||r.pointDraged.id&&r.pointDraged.id.id);if(i){var a=r.getEntityIndex(i),s=r.getEntityPoint(i);if(s){var p=s.position._value;n[a]=p,o[a].forEach((function(e){e.polyline.positions=[p,r.rotate(p,e.opt)]}))}}r.leftDownFlag=!1,r.pointDraged=null,r.viewer.scene.screenSpaceCameraController.enableRotate=!0}}),GmMap3D.ScreenSpaceEventType.LEFT_UP),a.setInputAction((function(e){if(!(Date.now()-t<20)){if(r.hoverHandler(e),!0===r.leftDownFlag&&null!=r.pointDraged){var o=r.pointDraged.id.type;if(!o)return;var a="axis"===o,s=r.viewer.camera.getPickRay(e.endPosition),p=r.getEntityIndex(a?r.pointDraged.id.belong:r.pointDraged.id.id),c=a?r.getEntityPoint(r.pointDraged.id.belong):r.pointDraged.id,l=r.getPlaneIntersect(c.position._value,s),h=r._cartographic(n[p]),u=r.getAxisCarsian(r.pointDraged.id,h,l,!a);n[p]=u,c.position=new GmMap3D.ConstantPositionProperty(u),"function"==typeof r.opt.step&&r.opt.step({points:n}),i._createPrimitive=!0}t=Date.now()}}),GmMap3D.ScreenSpaceEventType.MOUSE_MOVE)},hoverHandler:function(e){this.viewer.camera.getPickRay(e.endPosition);var t=this.viewer.scene.pick(e.endPosition);if(!(this.moving||t&&this.colorEqual(t.id.color,Cesium.Color.YELLOW))&&(!t||!t.id.fake)&&(this.arrowsArr.forEach((function(e){e.forEach((function(e){e.fake?e.show=!1:e.show=!0}))})),t&&"axis"===t.id.type)){var i=t.id;i.show=!1,i.shado.show=!0}},colorEqual:function(e,t){return e&&t&&e.alpha===t.alpha&&e.red===t.red&&e.green===t.green&&e.blue===t.blue},getAxisCarsian:function(e,t,i,n){if(n){var o=i.xOy;return Cesium.Cartesian3.fromDegrees(o.lng,o.lat,o.hei)}switch(e.typename){case"east":o=i.xOz;return Cesium.Cartesian3.fromDegrees(o.lng,t.lat,t.hei);case"north":o=i.yOz;return Cesium.Cartesian3.fromDegrees(t.lng,o.lat,t.hei);case"up":o=i[this.viewerPlane()];return Cesium.Cartesian3.fromDegrees(t.lng,t.lat,o.hei)}},viewerPlane:function(){var e=this.viewer.scene.camera;return e.heading>.75*Math.PI&&e.heading<1.75*Math.PI?"xOz":"yOz"},addEntityPoint:function(e){var t=this.viewer.entities.add({position:e,point:{color:this.GmMap3D.Color.RED,pixelSize:15}});return t.type="axis-point",this.points.push(t),t},getPlaneIntersect:function(e,t){var i=e,n=(this.viewer.camera,{}),o=new Cesium.Cartesian3(0,0,0);return[{name:"xOz",PHR:{heading:90,pitch:0}},{name:"yOz",PHR:{heading:0,pitch:0}},{name:"xOy",PHR:{heading:0,pitch:90}}].forEach((function(r){var a=this.rotate(i,r.PHR),s=Cesium.Cartesian3.subtract(a,i,o),p=Cesium.Cartesian3.normalize(s,o),c=Cesium.Plane.fromPointNormal(i,p),l=Cesium.IntersectionTests.rayPlane(t,c);n[r.name]=this._cartographic(l||e)}),this),n},getEntityPoint:function(e){var t;return this.points.forEach((function(i){i.id===e&&(t=i)})),t},getEntityIndex:function(e){var t;return this.points.forEach((function(i,n){i.id===e&&(t=n)})),t},entityType:function(e){return e.constructor.name},setReferenceFrame:function(e,t){var i=e,n=this._cartographic(i),o=this.axisLength;this.viewer.camera.flyTo({destination:Cesium.Cartesian3.fromDegrees(n.lng,n.lat,n.hei+2*o)});var r=[{name:"east",color:new Cesium.Color(1,0,0,1),opt:{heading:0,pitch:0}},{name:"north",color:new Cesium.Color(0,1,0,1),opt:{heading:-90,pitch:0}},{name:"up",color:new Cesium.Color(0,0,1,1),opt:{heading:0,pitch:90}}],a=[];return r.forEach((function(i){var n=this.viewer.entities.add({polyline:{show:!0,positions:[e,this.rotate(e,i.opt)],material:new Cesium.PolylineArrowMaterialProperty(Cesium.Color.clone(i.color)),followSurface:!1,width:20}});n.opt=i.opt,n.color=Cesium.Color.clone(i.color),n.type="axis",n.fake=!1,n.belong=t.id,n.typename=i.name;var o=this.viewer.entities.add({polyline:{show:!0,positions:[e,this.rotate(e,i.opt)],material:new Cesium.PolylineArrowMaterialProperty(Cesium.Color.YELLOW),followSurface:!1,width:20}});o.opt=i.opt,o.color=Cesium.Color.clone(i.color),o.type="axis",o.fake=!0,o.belong=t.id,o.typename=i.name,n.shado=o,o.shado=n,a.push(n),a.push(o)}),this),a},rotate:function(e,t){this.viewer;var i=e,n=t.heading,o=t.pitch,r=GmMap3D.Math.toRadians(n),a=GmMap3D.Math.toRadians(o),s=new GmMap3D.HeadingPitchRoll(r,a,0),p=GmMap3D.Transforms.headingPitchRollToFixedFrame(i,s,GmMap3D.Ellipsoid.WGS84,GmMap3D.Transforms.eastNorthUpToFixedFrame,new GmMap3D.Matrix4),c=new GmMap3D.Cartesian3(this.axisLength,0,0);return GmMap3D.Matrix4.multiplyByPoint(p,c,new GmMap3D.Cartesian3)},end:function(){this.map3DTool.ClearAll()},_cartographic:function(e){var t=this.viewer.scene.globe.ellipsoid.cartesianToCartographic(e);return{lat:Cesium.Math.toDegrees(t.latitude),lng:Cesium.Math.toDegrees(t.longitude),hei:t.height}},destroy:function(){this.control=this.control&&this.control.destroy(),this.polyline.positions=this.pts.map((function(e){return new GmMap3D.Cartesian3(e.x,e.y,e.z)}));var e=this.viewer.entities;this.points.forEach((function(t){e.remove(t)})),this.arrowsArr.forEach((function(t){t.forEach((function(t){e.remove(t)}))})),this.points=[],this.arrowsArr=[],this.pts=[],"function"==typeof this.opt.done&&this.opt.done()}},window.dragTool=new t,window.dragToolPrototype=t}(jQuery);