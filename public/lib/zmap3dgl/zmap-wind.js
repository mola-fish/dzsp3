!function(){function e(e,t,i,a){if(!e||!t||!i)throw new Error("请传入完整的参数");this.data=i,this._canvas=e,this._viewer=t,this.expand=.5,this._range=[],this.listened=!1,this.littleEndian=a,this._material={},this._appearance,this._geometry,this._primitive,this.imageCanvas,this.inited=!1}e.prototype={init:function(){if(!this.inited){var e=this;this.imageCanvas=document.createElement("canvas"),this.imageCanvas.width=this._canvas.width*(1+this.expand),this.imageCanvas.height=this._canvas.height*(1+this.expand),this.canvasDefaultSize=[this.imageCanvas.width,this.imageCanvas.height];var t=this.imageCanvas.getContext("webgl",{antialiasing:!1}),i=new WindGL(t);this.wind=i,setTimeout((function(){e.listenCameraMove(),e._updateView(),this.inited=!0}),2e3),this._viewer.scene.postRender.addEventListener((function(){e.render()})),this.readData(this.data,!!this.littleEndian)}},get show(){return this._primitive.show},set show(e){this._primitive.show=!!e,e&&this._updateView(!0)},destory:function(){},render:function(){this.wind.windData1&&this.wind.draw();var e=this._material,t=this.imageCanvas,i=e._textures&&e._textures.image;i&&i.width==t.width&&i.height==t.height&&i.copyFrom(t)},listenCameraMove:function(){var e=this;if(!this.listened){this._viewer.scene.camera.moveEnd.addEventListener((function(){e._updateView()})),this.listened=!0,this.handler=new Cesium.ScreenSpaceEventHandler(this._canvas);var t=Date.now();this.handler.setInputAction((function(i,a){Date.now()-t<50||(e._updateView(!0),t=Date.now())}),Cesium.ScreenSpaceEventType.WHEEL)}},_pointAllIn:function(e){var t=this.windData,i=Number(t.lonMax),a=Number(t.lonMin),n=Number(t.latMax),s=Number(t.latMin),r=function(e,t){return e<=Math.max(i,a)&&e>=Math.min(i,a)&&t<=Math.max(n,s)&&t>=Math.min(n,s)};return r(e[0],e[1])+r(e[0],e[3])+r(e[2],e[1])+r(e[2],e[3])},_updateView:function(e){this.windData;var t=this.getRange(this._canvas.width,this._canvas.height,e);if(t!==this._range){var i=this._pointAllIn(t[1]);if(JSON.stringify(t)===JSON.stringify([[-180,-90,180,90],[-180,-90,180,90]]))t=this._updateViewGloble();else if(4===i)this._updateViewAllIn(),this.rangeIsAllOut=!1;else if(0===i){if(this.rangeIsAllOut)return;t=this._updateViewGloble(),this.rangeIsAllOut=!0}else t=this._updateViewIntersect(t[1]),this.rangeIsAllOut=!1;this.updateCanvas(t),this.showRectangle(t),this._range=t}},_updateViewGloble:function(){var e=this.windData,t=[],i=[Number(e.lonMin),Number(e.latMin),Number(e.lonMax),Number(e.latMax)];return i[2]>180?(t[0]=[i[0]-180,i[1],i[2]-180,i[3]],t[1]=[i[0]-180,i[1],i[2]-180,i[3]]):(t[0]=i,t[1]=i),t},_updateViewAllIn:function(){},_updateViewIntersect:function(e){var t=this.windData,i=[Number(t.lonMin),Number(t.latMin),Number(t.lonMax),Number(t.latMax)],a=[],n=[Math.max(e[0],i[0]),Math.max(e[1],i[1]),Math.min(e[2],i[2]),Math.min(e[3],i[3])];return n[2]>180?(a[0]=[n[0]-180,n[1],n[2]-180,n[3]],a[1]=[n[0]-180,n[1],n[2]-180,n[3]]):(a[0]=n,a[1]=n),a},showRectangle:function(e){if(e&&(!this._primitive||!1!==this._primitive.show)){this._canvas,this._viewer,this._primitive;if(this._geometry)return this._geometry=new Cesium.RectangleGeometry({rectangle:Cesium.Rectangle.fromDegrees.apply(this,e[0]),vertexFormat:Cesium.EllipsoidSurfaceAppearance.VERTEX_FORMAT}),this._viewer.scene.primitives.remove(this._primitive),void(this._primitive=this._viewer.scene.primitives.add(new Cesium.Primitive({geometryInstances:new Cesium.GeometryInstance({geometry:Cesium.RectangleGeometry.createGeometry(this._geometry),id:Date.now()}),appearance:this._appearance,asynchronous:!1,show:!0})));this._material=new Cesium.Material({fabric:{type:"Image",uniforms:{image:this.imageCanvas}}}),this._appearance=new Cesium.EllipsoidSurfaceAppearance({faceForward:!1,flat:!0,material:this._material,renderState:{fog:{enabled:!0,density:.01}}}),this._geometry=new Cesium.RectangleGeometry({rectangle:Cesium.Rectangle.fromDegrees.apply(this,e[0]),vertexFormat:Cesium.EllipsoidSurfaceAppearance.VERTEX_FORMAT}),this._primitive=this._viewer.scene.primitives.add(new Cesium.Primitive({geometryInstances:new Cesium.GeometryInstance({geometry:Cesium.RectangleGeometry.createGeometry(this._geometry),id:Date.now()}),appearance:this._appearance,asynchronous:!1,show:!0})),this.listenCameraMove()}},updateCanvas:function(e){this.wind&&this._range!==e&&(//!(表示移动范围很小，并没有出界，所以使用原始的范围)
this.wind.resize(),this.wind.resetWind(e[1]),this._range=e)},getRange:function(e,t,i){var a=this._viewer,n=new Cesium.Cartesian2(0,t),s=new Cesium.Cartesian2(e,0),r=this._viewer.scene.globe.pick(a.camera.getPickRay(n),a.scene),h=this._viewer.scene.globe.pick(a.camera.getPickRay(s),a.scene);if(!r||!h){var o=[[-180,-90,180,90],[-180,-90,180,90]];return JSON.stringify(o)===JSON.stringify(this._range)?this._range:o}var m=a.scene.globe.ellipsoid.cartesianToCartographic(r),l=a.scene.globe.ellipsoid.cartesianToCartographic(h),u=[m.longitude/Math.PI*180,m.latitude/Math.PI*180],d=[l.longitude/Math.PI*180,l.latitude/Math.PI*180];if(this._range.length>0&&!i){var c=this._range[0];if(u[0]>c[0]&&u[1]>c[1]&&d[0]<c[2]&&d[1]<c[3])return this._range}var g=(d[0]-u[0])*this.expand/2,w=(d[1]-u[1])*this.expand/2;d[0]<0&&u[0]>0&&(g=180-u[0]+(d[0]+180));var v=(u[0]-g+180)%360-180,p=Math.max(Math.min(u[1]-w,90),-90),_=(d[0]+g+180)%360-180,f=Math.max(Math.min(d[1]+w,90),-90),M=0,y=0;return v<-180&&(v+=360),v>0&&_<0?(M=v,y=_+360):(M=v,y=_),[[Math.min(v,_),Math.min(p,f),Math.max(v,_),Math.max(p,f)],[Math.min(M,y),Math.min(p,f),Math.max(M,y),Math.max(p,f)]]},updateData:function(e,t){this.data=e,this.readData(e,t)},readData:function(e,t){var i,a=new Object;e instanceof Uint8Array?(i=e,void 0===t&&(t=!0)):i=new Uint8Array(e.field);var n=new Uint8Array(e.length||e.field.length);n.set(i.subarray(0,(e.length||e.field.length)-1),0);for(var s=new DataView(n.buffer),r=new Float32Array(8),h=0;h<r.length;h++)r[h]=s.getFloat32(4*h,!!t);a.latMin=r[0],a.latMax=r[1],a.lonMin=r[2],a.lonMax=r[3],a.uMax=r[4],a.vMax=r[5],a.uMin=r[6],a.vMin=r[7],a.width=s.getInt32(32,!!t),a.height=s.getInt32(36,!!t),this.windData=a;for(var o=new Int8Array(s.byteLength-40),m=0;m<o.length;m+=2)o[m]=Math.floor(256*(s.getInt8(m+40)-a.uMin)/(a.uMax-a.uMin)),o[m+1]=Math.floor(256*(s.getInt8(m+41)-a.vMin)/(a.vMax-a.vMin));a.data=new Uint8Array(2*o.byteLength);for(m=0;m<o.byteLength;m+=2)a.data[2*m]=o[m],a.data[2*m+1]=o[m+1];this.wind.setWind(a,this._range[1])},updateProp:function(e,t){return this.wind[e]=t,this}},window.Wind=e}();