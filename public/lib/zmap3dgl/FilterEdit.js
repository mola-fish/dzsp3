var FilterEdit=function(i){i?(this._name_X=i.name_X?i.name_X:"属性值",this._split_X=i.split_X?i.split_X:4,this._max_X=i.max_X?i.max_X:1e3,this._min_X=i.min_X?i.min_X:0,this._name_Y=i.name_Y?i.name_Y:"透明度",this._split_Y=i.split_Y?i.split_Y:5,this._max_Y=i.max_Y?i.max_Y:1e3,this._min_Y=i.min_Y?i.min_Y:0,this.tolerance=i.tolerance?i.tolerance:3,this._line=i.line?i.line:[[this._min_X,this._min_Y],[this._max_X,this._max_Y]]):(this._name_X="属性值",this._split_X=4,this._max_X=1e3,this._min_X=0,this._name_Y="透明度",this._split_Y=5,this._max_Y=1e3,this._min_Y=0,this.tolerance=3,this._line=[[0,0],[this._max_X,this._max_Y]])};function relation(i,t,s){for(var h={},e=0;e<t.length;e++)if(pp_distance(i,t[e])<=s+2)return h.relation=1,h.position=e,h;for(e=0;e<t.length-1;e++)if(PointLine_Disp(i[0],i[1],t[e][0],t[e][1],t[e+1][0],t[e+1][1])<=s)return h.relation=2,h.point=i,h.position=e+1,h;return h.relation=0,h}function pp_distance(i,t){var s=i[0]-t[0],h=i[1]-t[1];return Math.pow(s*s+h*h,.5)}function PointLine_Disp(i,t,s,h,e,n){var _,a,o,r,l,x,p;return 0==(_=Math.sqrt((s-i)*(s-i)+(h-t)*(h-t)))||0==(a=Math.sqrt((e-i)*(e-i)+(n-t)*(n-t)))?-1:0==(o=Math.sqrt((s-e)*(s-e)+(h-n)*(h-n)))?_:_<a?(h==n?r=s<e?0:Math.PI:((p=(e-s)/o)-1>1e-5&&(p=1),r=Math.acos(p),h>n&&(r=2*Math.PI-r)),(p=(i-s)/_)-1>1e-5&&(p=1),l=Math.acos(p),h>t&&(l=2*Math.PI-l),(x=l-r)<0&&(x=-x),x>Math.PI&&(x=2*Math.PI-x),x>Math.PI/2?_:_*Math.sin(x)):(h==n?r=s<e?Math.PI:0:((p=(s-e)/o)-1>1e-5&&(p=1),r=Math.acos(p),n>h&&(r=2*Math.PI-r)),(p=(i-e)/a)-1>1e-5&&(p=1),l=Math.acos(p),n>t&&(l=2*Math.PI-l),(x=l-r)<0&&(x=-x),x>Math.PI&&(x=2*Math.PI-x),x>Math.PI/2?a:a*Math.sin(x))}FilterEdit.prototype={constructor:FilterEdit,_init:function(i){this.x_axis=30,this.y_axis=40,this._width=i.offsetWidth,this._height=i.offsetHeight,this.painter=document.createElement("canvas"),this.painter.width=this._width,this.painter.height=this._height;var t,s=0,h=this;this.parse_line();var e=-1;this.painter.addEventListener("mousedown",(function(i){1==t.relation?s=1:2==t.relation&&(h.trans_line.splice(t.position,0,t.point),s=1,e=t.position,h._draw(e),h.reverse_parse_line())})),this.painter.addEventListener("mousemove",(function(i){if(1==s){var n;if(n=i.offsetY<=50?50:i.offsetY>h._height-h.x_axis?h._height-h.x_axis:i.offsetY,0==t.position)h.trans_line[t.position]=[h.y_axis,n];else if(t.position==h.trans_line.length-1)h.trans_line[t.position]=[h._width-50,n];else{h.trans_line[t.position]=[i.offsetX,n];for(var _=1;_<h.trans_line.length-1-t.position;_++)h.trans_line[t.position+_][0]<=i.offsetX&&(h.trans_line[t.position+_][0]=i.offsetX);for(_=0;_<t.position;_++)h.trans_line[_][0]>=i.offsetX&&(h.trans_line[_][0]=i.offsetX);i.offsetX>=h._width-50&&(h.trans_line.splice(t.position+1,h.trans_line.length-1-t.position),h.trans_line[t.position]=[h._width-50,n]),i.offsetX<=h.y_axis&&(h.trans_line.splice(0,t.position),t.position=0,h.trans_line[0]=[h.y_axis,n])}e=t.position,h._draw(t.position),h.reverse_parse_line(),h.onchangestatus(t.position,h._line)}else{var a=[i.offsetX,i.offsetY];1==(t=relation(a,h.trans_line,h.tolerance)).relation?(h.highlight(t.position),e=t.position):e>=0&&(h._draw(),e=-1)}})),this.painter.addEventListener("mouseup",(function(i){1==s&&(s=0,h.onchangestatus_over(t.position,h._line))})),this.painter.addEventListener("mouseout",(function(i){1==s&&(s=0,h.onchangestatus_over(t.position,h._line))})),i.appendChild(this.painter)},_draw:function(i){this.clearCanvas(),this._draw_arrow(),this._draw_line(i)},_draw_arrow:function(){var i=this.painter.getContext("2d");i.beginPath(),i.lineWidth="1",i.strokeStyle="#272727",i.font="12px Courier New",i.fillStyle="black",i.moveTo(this.y_axis,this._height-this.x_axis),i.lineTo(this.y_axis,30),i.lineTo(this.y_axis-4,34),i.moveTo(this.y_axis,30),i.lineTo(this.y_axis+4,34),i.moveTo(this.y_axis,this._height-this.x_axis),i.lineTo(this._width-30,this._height-this.x_axis),i.lineTo(this._width-34,this._height-this.x_axis-4),i.moveTo(this._width-30,this._height-this.x_axis),i.lineTo(this._width-34,this._height-this.x_axis+4);for(var t=(this._width-50-this.y_axis)/this._split_X,s=((this._max_X-this._min_X)/this._split_X).toFixed(0),h=1;h<=this._split_X;h++)i.moveTo(t*h+this.y_axis,this._height-this.x_axis),i.lineTo(t*h+this.y_axis,this._height-this.x_axis+5),i.fillText(this._min_X+s*h,t*h+this.y_axis-12,this._height-this.x_axis+15);i.moveTo(this._width-50,this._height-30),i.lineTo(this._width-50,50),i.fillText(this._name_X,this._width-40,this._height-this.x_axis-11),i.fillText(this._name_Y,this.y_axis-15,20),i.stroke(),i.beginPath(),i.strokeStyle="#4DFFFF",i.lineWidth="1";var e=(this._height-this.x_axis-50)/this._split_Y,n=((this._max_Y-this._min_Y)/this._split_Y).toFixed(0);for(h=0;h<this._split_Y;h++)i.moveTo(this.y_axis,e*h+50),i.lineTo(this._width-50,e*h+50),i.fillText(this._max_Y-n*h,this.y_axis-30,e*h+55);i.stroke()},_draw_line:function(i){var t=this.painter.getContext("2d");t.beginPath(),t.lineWidth="1",t.strokeStyle="#272727",t.moveTo(this.trans_line[0][0],this.trans_line[0][1]);for(var s=1;s<this.trans_line.length;s++)t.lineTo(this.trans_line[s][0],this.trans_line[s][1]);t.stroke();for(s=0;s<this.trans_line.length;s++)t.beginPath(),t.arc(this.trans_line[s][0],this.trans_line[s][1],4,0,2*Math.PI),t.fill();i&&this.highlight(i)},highlight:function(i){var t=this.painter.getContext("2d");t.beginPath(),t.lineWidth="1",t.strokeStyle="#271616",t.arc(this.trans_line[i][0],this.trans_line[i][1],6,0,2*Math.PI),t.fill()},clearCanvas:function(){var i=this.painter.getContext("2d");i.beginPath(),i.fillStyle="#fff",i.fillRect(0,0,this._width,this._height),i.closePath()},parse_line:function(){this.trans_line=[];for(var i=0;i<this._line.length;i++){var t=[];t[0]=(this._line[i][0]-this._min_X)/(this._max_X-this._min_X)*(this._width-this.y_axis-50)+this.y_axis,t[1]=this._height-this.x_axis-(this._line[i][1]-this._min_Y)/(this._max_Y-this._min_Y)*(this._height-this.x_axis-50),this.trans_line.push(t)}},reverse_parse_line:function(){this._line=[];for(var i=0;i<this.trans_line.length;i++){var t=[];t[0]=((this.trans_line[i][0]-this.y_axis)/(this._width-this.y_axis-50)*(this._max_X-this._min_X)+this._min_X).toFixed(1),t[1]=((this._height-this.x_axis-this.trans_line[i][1])/(this._height-this.x_axis-50)*(this._max_Y-this._min_Y)+this._min_Y).toFixed(1),this._line.push(t)}},onchangestatus:function(){},onchangestatus_over:function(){}};