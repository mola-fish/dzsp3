!function(){var t=function(t,i,e,n){t&&i&&e?(this.GmMap3D=t,this.map3DView=i,this.map3DTool=new ZMap3DLib.Input3DTool(i),this.viewer=i.cesium.viewer,this._toolbar=e,this._redPoint=null,this._nowPoint=null,this._positions=[],this.defaultHeight=null,this.scale=1,this.p={x:0,y:0,z:0,lng:0,lat:0,hei:0,typex:1,typey:1,typez:1,heading:0,pitch:0,speed:0,size:1e5},this.GmMap3D.knockout.track(this.p),void 0!==n&&(this.defaultHeight=n),this.GmMap3D.knockout.applyBindings(this.p,e),this.inited=!0):this.inited=!1};t.prototype={init:function(t,i,e,n){return this.inited||(this.GmMap3D=t,this.map3DView=i,this.map3DTool=new ZMap3DLib.Input3DTool(i),this.viewer=i.cesium.viewer,this._toolbar=e,this._redPoint=null,this._nowPoint=null,this._positions=[],this.defaultHeight=null,this.scale=1,this.p={x:0,y:0,z:0,lng:0,lat:0,hei:0,typex:1,typey:1,typez:1,heading:0,pitch:0,speed:0,size:1e5},this.GmMap3D.knockout.track(this.p),void 0!==n&&(this.defaultHeight=n),this.GmMap3D.knockout.applyBindings(this.p,e),this.inited=!0),this},clean:function(){return this.viewer.entities.removeAll(),this},_updatePolyline:function(){var t=this;return function(){return t._positions}},_updatePoint:function(t){var i=this;return function(){if(i._nowPoint&&t===i.getSelf(i._nowPoint)){var e=i._cartographic(t);if(i.p.lng=e.lng,i.p.lat=e.lat,i.p.hei=e.hei,t.heading=i.p.heading,t.pitch=i.p.pitch,t.speed=i.p.speed,0===i.p.x&&0===i.p.y&&0===i.p.z)return t;var n=new GmMap3D.Cartesian3.fromDegrees(e.lng+Number(i.p.x)*i.p.typex/1e5,e.lat+Number(i.p.y)*i.p.typey/1e5,e.hei+Number(i.p.z)*i.p.typez);return t.x=n.x,t.y=n.y,t.z=n.z,t}return t}},_updateArrowPolyline:function(t){var i=this;return function(){return[t,i.rotate(t)]}},_resetEditing:function(){return this._redPoint&&this.viewer.entities.remove(this._redPoint),this},_showToolbar:function(){this._toolbar.style.display="block"},_hideToolbar:function(){this._toolbar.style.display="none"},typeCheck:function(t,i){return t.constructor.toString().substr(9,i.length)===i},cleanEntity:function(){return this.viewer.entities.removeAll(),this},_pointStyle:function(){return{pixelSize:8,color:GmMap3D.Color.YELLOW,outlineColor:GmMap3D.Color.BROWN,outlineWidth:3}},_checkedPointStyle:function(){return{pixelSize:12,color:GmMap3D.Color.RED,outlineColor:GmMap3D.Color.BROWN,outlineWidth:8}},getNext:function(t){var i=null;return this._positions.forEach((function(e,n,o){t.x==e.x&&t.y==e.y&&t.z==e.z&&(i=n===o.length-1?o[n-1]:o[n+1])}),this),i},getSelf:function(t){var i=null;return this._positions.forEach((function(e,n,o){t.x==e.x&&t.y==e.y&&t.z==e.z&&(i=o[n])}),this),i},rotate:function(t){this.viewer;var i=t,e=i.heading,n=i.pitch;target=this.getNext(t);var o=GmMap3D.Math.toRadians(e),r=GmMap3D.Math.toRadians(n),a=new GmMap3D.HeadingPitchRoll(o,r,0),s=GmMap3D.Transforms.headingPitchRollToFixedFrame(i,a,GmMap3D.Ellipsoid.WGS84,GmMap3D.Transforms.eastNorthUpToFixedFrame,new GmMap3D.Matrix4),p=new GmMap3D.Cartesian3(this.p.size,0,0);return GmMap3D.Matrix4.multiplyByPoint(s,p,new GmMap3D.Cartesian3)},_cartographic:function(t){var i=this.viewer.scene.globe.ellipsoid.cartesianToCartographic(t);return{lat:this.GmMap3D.Math.toDegrees(i.latitude),lng:this.GmMap3D.Math.toDegrees(i.longitude),hei:i.height}},getLine:function(t){var i=this,e=this.GmMap3D;i.map3DTool._returnZ=!0,i.map3DTool.StartLineTool((function(t){}),(function(n){var o=n.geometry;if(o){var r=[];o.forEach((function(t){r.push(e.Cartesian3.fromDegrees(t[0],t[1],null!==i.defaultHeight?i.defaultHeight:t[2]))})),i._nowPoint=null;var a=[];r.forEach((function(t,n,o){if(t.target=null,t.speed=0,t.pitch=0,n!==o.length-1){a.push(Math.abs(Number(e.Cartesian3.distance(t,r[n+1]))));var s=i._cartographic(t),p=i._cartographic(o[n+1]),l=p.lat-s.lat,h=p.lng-s.lng;t.heading=-Math.atan2(l,h)/Math.PI*180}else t.heading=o[n-1].heading}));var s=i.getZoom()||10,p=1;p=s<7?100:s<9?10:s<14?1:s<18?.1:.01,i.p.typex=p,i.p.typey=p,i.p.typez=p,i.scale=p,i.p.size=a.sort()[1]/2,i._positions=r,t.call(i,r)}}))},resetRange:function(){this.p.x=0,this.p.y=0,this.p.z=0},editPoint:function(t){var i=this.viewer,e=this.GmMap3D,n=this;i.entities.add({polyline:{show:!0,positions:new e.CallbackProperty(n._updatePolyline(),!1),material:new e.PolylineGlowMaterialProperty({glowPower:.1,color:e.Color.YELLOW}),width:5}}),this._positions.forEach((function(t){this.viewer.entities.add({position:new e.CallbackProperty(n._updatePoint(t),!1),point:this._pointStyle()}),this.viewer.entities.add({polyline:{show:!0,positions:new e.CallbackProperty(n._updateArrowPolyline(t),!1),material:new e.PolylineArrowMaterialProperty(new e.Color(255,255,255,.1)),followSurface:!1,width:10}})}),this),new e.ScreenSpaceEventHandler(i.scene.canvas).setInputAction((function(t){var o=i.scene.pick(t.position);i.scene.drillPick(t.position);if(o&&o.primitive&&n.typeCheck(o.primitive,"PointPrimitive")){n._showToolbar(),n._nowPoint=o.primitive.position;var r=n.getSelf(o.primitive.position);return n.p.heading=r.heading,n.p.pitch=r.pitch,n.p.speed=r.speed,n._resetEditing(),n.setReferenceFrame(o.primitive.position),void(n._redPoint=n.viewer.entities.add({position:new e.CallbackProperty(n._updatePoint(n.getSelf(o.primitive.position)),!1),point:n._checkedPointStyle()}))}}),e.ScreenSpaceEventType.LEFT_CLICK)},setReferenceFrame:function(t){},getFormatData:function(){var t=this;return this._positions.map((function(i){var e=this._cartographic(i),n=this._cartographic(this.rotate(i));return{targetPoint:[n.lng,n.lat,n.hei],cameraPoint:[e.lng,e.lat,e.hei],speed:0===i.speed?100*t.scale:i.speed/3.6}}),this)},getZoom:function(){return this.map3DView.GetZoom()}},window.MapTool=new t,window.MapToolPrototype=t}();