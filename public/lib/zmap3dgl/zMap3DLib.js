var Map3DSDKLib=Map3DSDKLib||{};!function(){var t=function(){var e=GmMap3D.Ellipsoid.WGS84;function i(t){this._map=t;var e=t.GetMap();this._scene=e.scene,this._surfaces=[],this.initialiseHandlers(),this.enhancePrimitives(),this._returnZ=!0,this._mouseHandler=null,this._tempprim=[],this.enableDalfutInput=!1}i.prototype.EnableReturnZ=function(t){this._returnZ=t},i.prototype.PickPositonM=function(t){var i=this._map.PickModel(t).coord;return i?this._map.PickModel(t).models&&this._map.PickModel(t).models.primitive&&(this._map.PickModel(t).models.id&&this._map.PickModel(t).models.id.model||this._map.PickModel(t).models.primitive instanceof GmMap3D.Cesium3DTileset)?this._map.JWcoordToC3([i.x-0,i.y-0,i.z-0]):i.z<0?this._scene.camera.pickEllipsoid(t,e):this._map.JWcoordToC3([i.x-0,i.y-0,i.z-0]):this.PickPositon(t)},i.prototype.PickPositon=function(t){var i,n=this._scene,r=n.pick(t);GmMap3D.defined(r)?(i=n.pickPosition(t,new GmMap3D.Cartesian3),e.cartesianToCartographic(i).height<0&&(i=n.camera.pickEllipsoid(t,e))):i=n.camera.pickEllipsoid(t,e);return i},i.prototype.EnableInput=function(t){this.enableDalfutInput?this._scene.screenSpaceCameraController.enableInputs=t:this._scene.screenSpaceCameraController.enableInputs=!0},i.prototype.StartPointTool=function(t,e,i){this.ClearAll();var n={callstart:t,callback:e};i&&(n=c(n,i)),this.startDrawingPoint(n)},i.prototype.StartLineTool=function(t,e,i){this.ClearAll();var n={callstart:t,callback:e};i&&(n=c(n,i)),this.startDrawingPolyline(n)},i.prototype.StartSingleLineTool=function(t,e,i,n){this.ClearAll();var r={callstart:t,callback:e,updateCallback:i};n&&(r=c(r,n)),this.startDrawingSingleline(r)},i.prototype.StartRectTool=function(t,e,i){this.ClearAll();var n={callstart:t,callback:e};i&&(n=c(n,i)),this.startDrawingExtent(n)},i.prototype.StartCircleTool=function(t,e,i){this.ClearAll();var n={callstart:t,callback:e};i&&(n=c(n,i)),this.startDrawingCircle(n)},i.prototype.startEllipseTool=function(t,e,i){this.ClearAll();var n={callstart:t,callback:e};i&&(n=c(n,i)),this.drawingEllipse(n)},i.prototype.StartPolygonTool=function(t,e,i){this.ClearAll();var n={callstart:t,callback:e};i&&(n=c(n,i)),this.startDrawingPolygon(n)},i.prototype.StartAnyPolygonTool=function(t,e){},i.prototype.ClearAll=function(){this.muteHandlers(!1);for(var t=0;t<this._tempprim.length;t++)this._scene.primitives.remove(this._tempprim[t]);this._mouseHandler&&(this._mouseHandler.destroy(),this._mouseHandler=null)},i.prototype.ClearGeometry=function(){this.disableAllEditMode()},i.prototype.initialiseHandlers=function(){this._scene},i.prototype.setListener=function(t,e,i){t[e]=i},i.prototype.muteHandlers=function(t){this._handlersMuted=t,this.EnableInput(!t)},i.prototype.startDrawing=function(){this.ClearAll(),this.muteHandlers(!0)},i.prototype.stopDrawing=function(){this.muteHandlers(!1),this.ClearAll()},i.prototype.disableAllHighlights=function(){this.setHighlighted(void 0)},i.prototype.setHighlighted=function(t){this._highlightedSurface&&!this._highlightedSurface.isDestroyed()&&this._highlightedSurface!=t&&this._highlightedSurface.setHighlighted(!1),this._highlightedSurface=t},i.prototype.disableAllEditMode=function(){this.setEdited(void 0)},i.prototype.setEdited=function(t){this._editedSurface&&!this._editedSurface.isDestroyed()&&this._editedSurface.setEditMode(!1),this._editedSurface=t};var n=GmMap3D.Material.fromType(GmMap3D.Material.ColorType);n.uniforms.color=Cesium.Color.DEEPSKYBLUE;var r={ellipsoid:GmMap3D.Ellipsoid.WGS84,textureRotationAngle:0,height:0,asynchronous:!0,show:!0,debugShowBoundingVolume:!1},a=c(r,{appearance:new GmMap3D.EllipsoidSurfaceAppearance({aboveGround:!1}),material:n,granularity:Math.PI/180}),o=(c(r,{}),c(r,{}),c(r,{}),c(a,{rotation:0})),s=c(r,{width:2,geodesic:!0,granularity:1e4,appearance:new GmMap3D.PolylineMaterialAppearance({aboveGround:!1}),material:n});class l{constructor(){}initialiseOptions(t){!function(t,e){var i;for(i in t=t||{},e)void 0===t[i]&&(t[i]=u(e[i]))}(this,t),this._ellipsoid=void 0,this._granularity=void 0,this._height=void 0,this._textureRotationAngle=void 0,this._id=void 0,this._createPrimitive=!0,this._primitive=void 0,this._outlinePolygon=void 0}setAttribute(t,e){this[t]=e,this._createPrimitive=!0}getAttribute(t){return this[t]}update(t,e,i){if(!GmMap3D.defined(this.ellipsoid))throw new GmMap3D.DeveloperError("this.ellipsoid must be defined.");if(!GmMap3D.defined(this.appearance))throw new GmMap3D.DeveloperError("this.material must be defined.");if(this.granularity<0)throw new GmMap3D.DeveloperError("this.granularity and scene2D/scene3D overrides must be greater than zero.");if(this.show&&(this._createPrimitive||GmMap3D.defined(this._primitive))){if(this._createPrimitive||this._ellipsoid!==this.ellipsoid||this._granularity!==this.granularity||this._height!==this.height||this._textureRotationAngle!==this.textureRotationAngle||this._id!==this.id){var n=this.getGeometry();if(!n)return;this._createPrimitive=!1,this._ellipsoid=this.ellipsoid,this._granularity=this.granularity,this._height=this.height,this._textureRotationAngle=this.textureRotationAngle,this._id=this.id,this._primitive=this._primitive&&this._primitive.destroy(),this._primitive=new GmMap3D.Primitive({geometryInstances:new GmMap3D.GeometryInstance({geometry:n,id:this.id,pickPrimitive:this}),appearance:this.appearance,asynchronous:this.asynchronous}),this._outlinePolygon=this._outlinePolygon&&this._outlinePolygon.destroy(),this.strokeColor&&this.getOutlineGeometry&&(console.log(t),this._outlinePolygon=new GmMap3D.Primitive({geometryInstances:new GmMap3D.GeometryInstance({geometry:this.getOutlineGeometry(),attributes:{color:GmMap3D.ColorGeometryInstanceAttribute.fromColor(this.strokeColor)}}),appearance:new GmMap3D.PerInstanceColorAppearance({flat:!0,renderState:{depthTest:{enabled:!0},lineWidth:1}})}))}var r=this._primitive;r.appearance.material=this.material,r.debugShowBoundingVolume=this.debugShowBoundingVolume,r.update(t,e,i),this._outlinePolygon&&this._outlinePolygon.update(t,e,i)}}isDestroyed(){return!1}destroy(){return this._primitive=this._primitive&&this._primitive.destroy(),GmMap3D.destroyObject(this)}setStrokeStyle(t,e){this.strokeColor&&this.strokeColor.equals(t)&&this.strokeWidth==e||(this._createPrimitive=!0,this.strokeColor=t,this.strokeWidth=e)}}i.ExtentPrimitive=function(){function t(t){if(!GmMap3D.defined(t.extent))throw new GmMap3D.DeveloperError("Extent is required");t=c(t,a),this.initialiseOptions(t),this.setExtent(t.extent)}return t.prototype=new l,t.prototype.setExtent=function(t){this.setAttribute("extent",t)},t.prototype.getExtent=function(){return this.getAttribute("extent")},t.prototype.getGeometry=function(){if(GmMap3D.defined(this.extent))return new GmMap3D.RectangleGeometry({rectangle:this.extent,height:this.height,vertexFormat:GmMap3D.EllipsoidSurfaceAppearance.VERTEX_FORMAT,stRotation:this.textureRotationAngle,ellipsoid:this.ellipsoid,granularity:this.granularity})},t.prototype.getOutlineGeometry=function(){return new GmMap3D.RectangleOutlineGeometry({rectangle:this.extent})},t}(),i.PointPrimitive=function(){function t(t){if(!GmMap3D.defined(t.center)||!GmMap3D.defined(t.radius))throw new GmMap3D.DeveloperError("Center and radius are required");t=c(t,a),this.initialiseOptions(t),this.setRadius(t.radius)}return t.prototype=new l,t.prototype.setCenter=function(t){this.setAttribute("center",t)},t.prototype.setRadius=function(t){this.setAttribute("radius",Math.max(.1,t))},t.prototype.getCenter=function(){return this.getAttribute("center")},t.prototype.getRadius=function(){return this.getAttribute("radius")},t.prototype.getGeometry=function(){if(GmMap3D.defined(this.center)&&GmMap3D.defined(this.radius))return new GmMap3D.CircleGeometry({center:this.center,radius:this.radius,height:this.height,vertexFormat:GmMap3D.EllipsoidSurfaceAppearance.VERTEX_FORMAT,stRotation:this.textureRotationAngle,ellipsoid:this.ellipsoid,granularity:this.granularity})},t.prototype.getOutlineGeometry=function(){return new GmMap3D.CircleOutlineGeometry({center:this.getCenter(),radius:this.getRadius()})},t}(),i.PolylinePrimitive=function(){function t(t){t=c(t,s),this.initialiseOptions(t)}return t.prototype=new l,t.prototype.setPositions=function(t){this.setAttribute("positions",t)},t.prototype.setWidth=function(t){this.setAttribute("width",t)},t.prototype.setGeodesic=function(t){this.setAttribute("geodesic",t)},t.prototype.getPositions=function(){return this.getAttribute("positions")},t.prototype.getWidth=function(){return this.getAttribute("width")},t.prototype.getGeodesic=function(t){return this.getAttribute("geodesic")},t.prototype.getGeometry=function(){if(GmMap3D.defined(this.positions)&&!(this.positions.length<2))return new GmMap3D.PolylineGeometry({positions:this.positions,height:this.height,width:this.width<1?1:this.width,vertexFormat:GmMap3D.EllipsoidSurfaceAppearance.VERTEX_FORMAT,ellipsoid:this.ellipsoid})},t}(),i.PolygonPrimitive=function(){function t(t){t=c(t,a),this.initialiseOptions(t),this.isPolygon=!0}return t.prototype=new l,t.prototype.setPositions=function(t){this.setAttribute("positions",t)},t.prototype.getPositions=function(){return this.getAttribute("positions")},t.prototype.getGeometry=function(){if(GmMap3D.defined(this.positions)&&!(this.positions.length<3))return GmMap3D.PolygonGeometry.fromPositions({positions:this.positions,vertexFormat:GmMap3D.EllipsoidSurfaceAppearance.VERTEX_FORMAT,stRotation:this.textureRotationAngle,ellipsoid:this.ellipsoid,granularity:this.granularity,perPositionHeight:!0})},t.prototype.getOutlineGeometry=function(){return GmMap3D.PolygonOutlineGeometry.fromPositions({positions:this.getPositions()})},t}(),i.CirclePrimitive=function(){function t(t){if(!GmMap3D.defined(t.center)||!GmMap3D.defined(t.radius))throw new GmMap3D.DeveloperError("Center and radius are required");t=c(t,a),this.initialiseOptions(t),this.setRadius(t.radius)}return t.prototype=new l,t.prototype.setCenter=function(t){this.setAttribute("center",t)},t.prototype.setRadius=function(t){this.setAttribute("radius",Math.max(.1,t))},t.prototype.setHeight=function(t){this.setAttribute("height",t)},t.prototype.getCenter=function(){return this.getAttribute("center")},t.prototype.getRadius=function(){return this.getAttribute("radius")},t.prototype.getHeight=function(){return this.getAttribute("height")},t.prototype.getGeometry=function(){if(GmMap3D.defined(this.center)&&GmMap3D.defined(this.radius))return new GmMap3D.CircleGeometry({center:this.center,radius:this.radius,height:this.height,vertexFormat:GmMap3D.EllipsoidSurfaceAppearance.VERTEX_FORMAT,stRotation:this.textureRotationAngle,ellipsoid:this.ellipsoid,granularity:this.granularity})},t.prototype.getOutlineGeometry=function(){return new GmMap3D.CircleOutlineGeometry({center:this.getCenter(),radius:this.getRadius()})},t}();class p extends l{constructor(t){if(super(),!(GmMap3D.defined(t.center)&&GmMap3D.defined(t.semiMajorAxis)&&GmMap3D.defined(t.semiMinorAxis)))throw new GmMap3D.DeveloperError("Center and semi major and semi minor axis are required");t=c(t,o),this._singleRadius=!0,this.initialiseOptions(t)}setCenter(t){this.setAttribute("center",t)}setSingleRadius(t){this._singleRadius=!!t}setSemiMajorAxis(t){t<this.getSemiMinorAxis()||this.setAttribute("semiMajorAxis",t)}setSemiMinorAxis(t){this.setAttribute("semiMinorAxis",t)}setRotation(t){return this.setAttribute("rotation",t)}getCenter(){return this.getAttribute("center")}getSemiMajorAxis(){return this.getAttribute("semiMajorAxis")}getSemiMinorAxis(){return this.getAttribute("semiMinorAxis")}getRotation(){return this.getAttribute("rotation")}getGeometry(){if(!(GmMap3D.defined(this.center)&&GmMap3D.defined(this.semiMajorAxis)&&GmMap3D.defined(this.semiMinorAxis)))return;const t=this._singleRadius?this.semiMinorAxis:this.semiMajorAxis,e=this.semiMinorAxis;return new GmMap3D.EllipseGeometry({ellipsoid:this.ellipsoid,center:this.center,semiMajorAxis:Math.max(t,e),semiMinorAxis:Math.min(t,e),rotation:this.rotation,height:this.height,vertexFormat:GmMap3D.EllipsoidSurfaceAppearance.VERTEX_FORMAT,stRotation:this.textureRotationAngle,granularity:this.granularity})}getOutlineGeometry(){return new GmMap3D.EllipseOutlineGeometry({center:this.getCenter(),semiMajorAxis:this.getSemiMajorAxis(),semiMinorAxis:this.getSemiMinorAxis(),rotation:this.getRotation()})}}function h(t,e){var i=new GmMap3D.Rectangle;i.west=Math.min(t.longitude,e.longitude),i.east=Math.max(t.longitude,e.longitude),i.south=Math.min(t.latitude,e.latitude),i.north=Math.max(t.latitude,e.latitude);var n=GmMap3D.Math.EPSILON7;return i.east-i.west<n&&(i.east+=2*n),i.north-i.south<n&&(i.north+=2*n),i}function u(t,e){if(null==t||"object"!=typeof t)return t;if(t.constructor!=Object&&t.constructor!=Array)return t;if(t.constructor==Date||t.constructor==RegExp||t.constructor==Function||t.constructor==String||t.constructor==Number||t.constructor==Boolean)return new t.constructor(t);for(var i in e=e||new t.constructor,t)e[i]=void 0===e[i]?u(t[i],null):e[i];return e}function c(t,e){var i,n=u(t);for(i in e)void 0===n[i]&&(n[i]=u(e[i]));return n}function d(t){t._listeners={},t.addListener=function(t,e){return this._listeners[t]=this._listeners[t]||[],this._listeners[t].push(e),this._listeners[t].length},t.executeListeners=function(t,e){if(this._listeners[t.name]&&this._listeners[t.name].length>0)for(var i=0;i<this._listeners[t.name].length;i++)this._listeners[t.name][i](t);else e&&e(t)}}return i.prototype.startDrawingPolyline=function(t){t=c(t,s);this.startDrawingmultiline(!1,t)},i.prototype.startDrawingSingleline=function(t){t=c(t,s);this.startDrawingSline(!1,t)},i.prototype.startDrawingPolygon=function(t){t=c(t,a);this.startDrawingPolyshape(!0,t)},i.prototype.startDrawingPoint=function(t){t=c(t,a);var n=this._returnZ,r=this;this.startDrawing();var o=this._scene,s=this._scene.primitives,l=null;(r._mouseHandler=new GmMap3D.ScreenSpaceEventHandler(o.canvas)).setInputAction((function(a){if(null!=a.position){var o=r.PickPositon(a.position);if(o){a.position;var p=e.cartesianToCartographic(o),h=null;h=n?[GmMap3D.Math.toDegrees(p.longitude),GmMap3D.Math.toDegrees(p.latitude),p.height]:[GmMap3D.Math.toDegrees(p.longitude),GmMap3D.Math.toDegrees(p.latitude)];var u=1e6/Math.pow(2,r._map.GetZoom());t.callstart({screen:a.position,type:"point",geometry:h}),null==l?(l=new i.PointPrimitive({center:o,radius:u,asynchronous:!1,material:t.material}),s.add(l),r._tempprim.push(l)):(l.setCenter(o),l.setRadius(u)),t.callback({screen:a.position,type:"point",geometry:h}),r.EnableInput(!0)}}}),GmMap3D.ScreenSpaceEventType.LEFT_CLICK)},i.prototype.startDrawingSline=function(i,n){var r=this._returnZ;this.startDrawing();var a,o=this,s=this._scene,l=s.primitives;(a=new t.PolylinePrimitive(n)).asynchronous=!1,l.add(a),o._tempprim.push(a);var p=[],h=o._mouseHandler=new GmMap3D.ScreenSpaceEventHandler(s.canvas);h.setInputAction((function(t){if(null!=t.position){var i=o.PickPositonM(t.position);if(i){if(0==p.length)n.callstart({screen:t.position,firstPoint:i}),p.push(i.clone());else if(o.stopDrawing(),"function"==typeof n.callback){p.length;for(var s=[],l=0;l<p.length;l++){var h=e.cartesianToCartographic(p[l]);r?s.push([GmMap3D.Math.toDegrees(h.longitude),GmMap3D.Math.toDegrees(h.latitude),h.height]):s.push([GmMap3D.Math.toDegrees(h.longitude),GmMap3D.Math.toDegrees(h.latitude)])}n.callback({geometry:s,type:"singleline"})}p.push(i),p.length>=2&&(a.positions=p,a._createPrimitive=!0)}}}),GmMap3D.ScreenSpaceEventType.LEFT_CLICK),h.setInputAction((function(t){var e=t.endPosition;if(null!=e)if(0==p.length);else{var i=o.PickPositonM(e);if(i){if(p.pop(),p.push(i),p.length>=2)a.positions=p,a._createPrimitive=!0;else{new GmMap3D.Cartesian3(p[0].x,p[0].y,p[0].z),new GmMap3D.Cartesian3(p[1].x,p[1].y,p[1].z);void 0}"function"==typeof n.updateCallback&&n.updateCallback(p)}}}),GmMap3D.ScreenSpaceEventType.MOUSE_MOVE)},i.prototype.startDrawingmultiline=function(i,n){var r=this._returnZ;this.startDrawing();var a,o=this,s=this._scene,l=s.primitives;(a=new t.PolylinePrimitive(n)).asynchronous=!1,l.add(a),o._tempprim.push(a);var p=[],h=o._mouseHandler=new GmMap3D.ScreenSpaceEventHandler(s.canvas);h.setInputAction((function(t){if(null!=t.position){var e=o.PickPositon(t.position);e&&(0==p.length&&(n.callstart({screen:t.position,firstPoint:e}),p.push(e.clone())),p.push(e),p.length>=2&&(a.positions=p,a._createPrimitive=!0))}}),GmMap3D.ScreenSpaceEventType.LEFT_CLICK),h.setInputAction((function(t){var e=t.endPosition;if(null!=e)if(0==p.length);else{var i=o.PickPositon(e);if(i)if(p.pop(),p.push(i),p.length>=2)a.positions=p,a._createPrimitive=!0;else{new GmMap3D.Cartesian3(p[0].x,p[0].y,p[0].z),new GmMap3D.Cartesian3(p[1].x,p[1].y,p[1].z);void 0}}}),GmMap3D.ScreenSpaceEventType.MOUSE_MOVE),h.setInputAction((function(t){var i=t.position;if(null!=i){if(p.length<2)return;if(o.PickPositon(i)&&(o.stopDrawing(),"function"==typeof n.callback)){p.length;for(var a=[],s=0;s<p.length;s++){var l=e.cartesianToCartographic(p[s]);r?a.push([GmMap3D.Math.toDegrees(l.longitude),GmMap3D.Math.toDegrees(l.latitude),l.height]):a.push([GmMap3D.Math.toDegrees(l.longitude),GmMap3D.Math.toDegrees(l.latitude)])}n.callback({geometry:a,type:"polyline"})}}}),GmMap3D.ScreenSpaceEventType.RIGHT_CLICK)},i.prototype.startDrawingPolyshape=function(i,n){var r=this._returnZ,a=this;this.startDrawing();var o,l,p=this._scene,h=p.primitives,u=i?3:2,c=n.lineWidth;i?(c&&(s.width=c),(l=new t.PolylinePrimitive(s)).asynchronous=!1,h.add(l),a._tempprim.push(l),o=new t.PolygonPrimitive(n),a._tempprim.push(o)):(o=new t.PolylinePrimitive(n),a._tempprim.push(o)),o.asynchronous=!1,h.add(o);var d=[],m=a._mouseHandler=new GmMap3D.ScreenSpaceEventHandler(p.canvas);m.setInputAction((function(t){if(null!=t.position){var e=a.PickPositon(t.position);e&&(0==d.length&&(n.callstart({screen:t.position,firstPoint:e}),d.push(e.clone())),d.push(e),d.length>=u&&(o.positions=d,o._createPrimitive=!0))}}),GmMap3D.ScreenSpaceEventType.LEFT_CLICK),m.setInputAction((function(t){var e=t.endPosition;if(null!=e)if(0==d.length);else{var i=a.PickPositon(e);if(i){i.z=i.z+.5,d.pop(),d.push(i),d.length>=u&&(o.positions=d,o._createPrimitive=!0);for(var n=[],r=0;r<d.length;r++)n.push(d[r]);n.push(d[0]),l&&(l.positions=n,l._createPrimitive=!0)}}}),GmMap3D.ScreenSpaceEventType.MOUSE_MOVE),m.setInputAction((function(t){var i=t.position;if(null!=i){if(d.length<u)return;if(a.PickPositon(i)&&(a.stopDrawing(),"function"==typeof n.callback)){d.length;for(var o=[],s=0;s<d.length;s++){var l=e.cartesianToCartographic(d[s]);r?o.push([GmMap3D.Math.toDegrees(l.longitude),GmMap3D.Math.toDegrees(l.latitude),l.height]):o.push([GmMap3D.Math.toDegrees(l.longitude),GmMap3D.Math.toDegrees(l.latitude)])}l=e.cartesianToCartographic(d[0]),r?o.push([GmMap3D.Math.toDegrees(l.longitude),GmMap3D.Math.toDegrees(l.latitude),l.height]):o.push([GmMap3D.Math.toDegrees(l.longitude),GmMap3D.Math.toDegrees(l.latitude)]),n.callback({geometry:o,type:"polygon"})}}}),GmMap3D.ScreenSpaceEventType.RIGHT_CLICK)},i.prototype.startDrawingExtent=function(t){this._returnZ,t=c(t,a);this.startDrawing();var n=this,r=this._scene,o=this._scene.primitives,s=null,l=null,p=n._mouseHandler=new GmMap3D.ScreenSpaceEventHandler(r.canvas);function u(r){null==l&&(t.extent=r,(l=new i.ExtentPrimitive(t)).asynchronous=!1,o.add(l),n._tempprim.push(l)),l.setExtent(r),l._createPrimitive=!0;!function(t){e.cartographicArrayToCartesianArray([GmMap3D.Rectangle.northwest(t),GmMap3D.Rectangle.northeast(t),GmMap3D.Rectangle.southeast(t),GmMap3D.Rectangle.southwest(t)])}(r)}p.setInputAction((function(i){if(null!=i.position){var r=n.PickPositon(i.position);if(r)if(null==l)t.callstart({screen:i.position,firstPoint:r}),i.position,s=e.cartesianToCartographic(r),t.height=s.height||0,u(h(s,s));else if(n.stopDrawing(),"function"==typeof t.callback){var a=h(s,e.cartesianToCartographic(r)),o=[GmMap3D.Math.toDegrees(a.west),GmMap3D.Math.toDegrees(a.south),GmMap3D.Math.toDegrees(a.east),GmMap3D.Math.toDegrees(a.north)];t.callback({geometry:o,type:"rectangle",height:s.height})}}}),GmMap3D.ScreenSpaceEventType.LEFT_CLICK),p.setInputAction((function(t){var i=t.endPosition;if(null!=i)if(null==l);else{var r=n.PickPositon(i);if(r)u(h(s,e.cartesianToCartographic(r)))}}),GmMap3D.ScreenSpaceEventType.MOUSE_MOVE)},i.prototype.startDrawingCircle=function(t){this._returnZ,t=c(t,a);this.startDrawing();var n=this,r=this._scene,o=this._scene.primitives,s=null;var l=n._mouseHandler=new GmMap3D.ScreenSpaceEventHandler(r.canvas);l.setInputAction((function(r){if(null!=r.position){var a=n.PickPositon(r.position);if(a)if(r.position,null==s)t.callstart({screen:r.position,firstPoint:a}),s=new i.CirclePrimitive({center:a,radius:0,height:e.cartesianToCartographic(a).height,asynchronous:!1,material:t.material}),o.add(s),n._tempprim.push(s);else{if("function"==typeof t.callback){var l=e.cartesianToCartographic(s.getCenter()),p={center:[GmMap3D.Math.toDegrees(l.longitude),GmMap3D.Math.toDegrees(l.latitude),l.height],radius:GmMap3D.Math.toDegrees(s.getRadius()/e._maximumRadius)};t.callback({geometry:p,type:"circle"})}n.stopDrawing()}}}),GmMap3D.ScreenSpaceEventType.LEFT_CLICK),l.setInputAction((function(t){var i=t.endPosition;if(null!=i)if(null==s);else{var n=r.camera.pickEllipsoid(i,e);if(n){var a=e.cartesianToCartographic(n),o=e.cartesianToCartographic(s.getCenter()),l=[GmMap3D.Math.toDegrees(a.longitude),GmMap3D.Math.toDegrees(a.latitude)],p=[GmMap3D.Math.toDegrees(o.longitude),GmMap3D.Math.toDegrees(o.latitude)],h=GmMap3D.Cartesian3.fromDegrees(l[0],l[1],0),u=GmMap3D.Cartesian3.fromDegrees(p[0],p[1],0);s.setRadius(GmMap3D.Cartesian3.distance(u,h))}}}),GmMap3D.ScreenSpaceEventType.MOUSE_MOVE)},i.prototype.drawingEllipse=function(t){this._returnZ,t=c(t,a);this.startDrawing();var i=this,n=this._scene,r=this._scene.primitives;let o,s,l=0;var h=null,u=i._mouseHandler=new GmMap3D.ScreenSpaceEventHandler(n.canvas);u.setInputAction((function(n){if(null!=n.position&&(o=i.PickPositon(n.position),o)){if(firstPixel=n.position,0===l)t.callstart({screen:n.position,firstPoint:o}),h=new p({center:o,semiMinorAxis:0,semiMajorAxis:0,height:0,asynchronous:!1,material:t.material,granularity:Math.PI/180/4}),r.add(h),i._tempprim.push(h);else{if("function"==typeof t.callback){var a=e.cartesianToCartographic(h.getCenter()),s={center:[GmMap3D.Math.toDegrees(a.longitude),GmMap3D.Math.toDegrees(a.latitude),a.height],radius:[GmMap3D.Math.toDegrees(h.getSemiMinorAxis()/e._maximumRadius),GmMap3D.Math.toDegrees(h.getSemiMajorAxis()/e._maximumRadius)],rotation:h.getRotation(),granularity:Math.PI/180/4};t.callback({geometry:s,type:"ellipse"})}i.stopDrawing()}l++}}),GmMap3D.ScreenSpaceEventType.LEFT_CLICK);const d=new Cesium.Matrix4,m=new Cesium.Matrix4,g=new Cesium.Cartesian3,M=new Cesium.Cartesian3,f=new Cesium.Cartesian3;u.setInputAction((function(t){var e=t.endPosition;if(!e)return;if(!h)return;if(s=i.PickPositon(e),!s)return;const n=GmMap3D.Cartesian3.midpoint(o,s,f);Cesium.Transforms.eastNorthUpToFixedFrame(n,Cesium.Ellipsoid.WGS84,d),Cesium.Matrix4.inverse(d,m),Cesium.Matrix4.multiplyByPoint(m,o,g),Cesium.Matrix4.multiplyByPoint(m,s,M),h.setCenter(n);const r=Math.abs(M.x-g.x)/2,a=Math.abs(M.y-g.y)/2;r>a?(h.setSemiMajorAxis(r),h.setSemiMinorAxis(a),h.setRotation(0)):(h.setSemiMinorAxis(r),h.setSemiMajorAxis(a),h.setRotation(Math.PI/2)),console.info(`r0=${r},r1=${a}`),h.setSingleRadius(!1)}),GmMap3D.ScreenSpaceEventType.MOUSE_MOVE)},i.prototype.enhancePrimitives=function(){var t=this;function n(e){t._scene;this._highlighted&&this._highlighted==e||!0!==this._editMode&&(this._highlighted=e,e?(t.setHighlighted(this),this._strokeColor=this.strokeColor,this.setStrokeStyle(GmMap3D.Color.fromCssColorString("white"),this.strokeWidth)):this._strokeColor?this.setStrokeStyle(this._strokeColor,this.strokeWidth):this.setStrokeStyle(void 0,void 0))}GmMap3D.Billboard.prototype.setEditable=function(){if(!this._editable){this._editable=!0;var i,n=this,r=this;i=function(i){function o(t){s.destroy(),a(!0),r.executeListeners({name:"dragEnd",positions:t})}var s=new GmMap3D.ScreenSpaceEventHandler(t._scene.canvas);s.setInputAction((function(i){var a=t._scene.camera.pickEllipsoid(i.endPosition,e);a?function(t){n.position=t,r.executeListeners({name:"drag",positions:t})}(a):o(a)}),GmMap3D.ScreenSpaceEventType.MOUSE_MOVE),s.setInputAction((function(i){o(t._scene.camera.pickEllipsoid(i.position,e))}),GmMap3D.ScreenSpaceEventType.LEFT_UP),a(!1)},n["leftDown"]=i,d(n)}function a(e){t._scene.screenSpaceCameraController.enableRotate=e}},i.CirclePrimitive.prototype.getCircleCartesianCoordinates=function(t){for(var i,n=GmMap3D.CircleOutlineGeometry.createGeometry(new GmMap3D.CircleOutlineGeometry({ellipsoid:e,center:this.getCenter(),radius:this.getRadius(),granularity:t})),r=0,a=[];r<n.attributes.position.values.length;r+=3)i=n.attributes.position.values,a.push(new GmMap3D.Cartesian3(i[r],i[r+1],i[r+2]));return a},i.CirclePrimitive.prototype.setEditable=function(){if(!this.setEditMode){var e=this,i=t._scene;e.asynchronous=!1,t.registerEditableShape(e),e.setEditMode=function(n){if(this._editMode!=n)if(t.disableAllHighlights(),n){t.setEdited(this);var r=this;if(null==this._markers){function a(){return r.getCircleCartesianCoordinates(GmMap3D.Math.PI_OVER_TWO)}var o={dragHandlers:{onDrag:function(t,i){e.setRadius(GmMap3D.Cartesian3.distance(e.getCenter(),i)),markers.updateBillboardsPositions(a())},onDragEnd:function(t,i){e.executeListeners({name:"onEdited",center:e.getCenter(),radius:e.getRadius()})}},tooltip:function(){return"拖拽改变半径"}};markers.addBillboards(a(),o),this._markers=markers,this._globeClickhandler=new GmMap3D.ScreenSpaceEventHandler(i.canvas),this._globeClickhandler.setInputAction((function(t){var e=i.pick(t.position);e&&e.primitive||r.setEditMode(!1)}),GmMap3D.ScreenSpaceEventType.LEFT_CLICK),markers.setOnTop()}this._editMode=!0}else null!=this._markers&&(this._markers.remove(),this._markers=null,this._globeClickhandler.destroy()),this._editMode=!1},e.setHighlighted=n,d(e),e.setEditMode(!1)}}},i}();Map3DSDKLib.Input3DTool=t,Map3DSDKLib.Math=function(){};Map3DSDKLib.Math.Degree2Rad=function(t){return t*Math.PI/180},Map3DSDKLib.Math.CalcFlatDistance=function(t,e,i,n){var r,a,o,s,l=Map3DSDKLib.Math.Degree2Rad((e+n)/2),p=Map3DSDKLib.Math.Degree2Rad((e-n)/2),h=Map3DSDKLib.Math.Degree2Rad((t-i)/2),u=Math.sin(p),c=Math.sin(h),d=Math.sin(l);return r=(u*=u)*(1-(c*=c))+(1-(d*=d))*c,a=(1-u)*(1-c)+d*c,2*(o=Math.atan(Math.sqrt(r/a)))*6378137*(1+1/298.257*((3*(s=Math.sqrt(r*a)/o)-1)/2/a*d*(1-u)-(3*s+1)/2/r*(1-d)*u))},Map3DSDKLib.Math.CalcTriAngleArea=function(t,e,i,n,r,a){var o=Map3DSDKLib.Math.CalcFlatDistance(t,e,i,n),s=Map3DSDKLib.Math.CalcFlatDistance(i,n,r,a),l=Map3DSDKLib.Math.CalcFlatDistance(t,e,r,a),p=(o+s+l)/2;return Math.sqrt(p*(p-o)*(p-s)*(p-l))},Map3DSDKLib.Math.CalcAnyPolyArea=function(t,e){t=function(t,e){var i=[];if(null!=t){for(var n=0;n<t.length;n++){var r={x:t[n].x,y:t[n].y,z:t[n].z},a=e.cartesianTo2MapCoord(r);i.push(a[0]),i.push(a[1])}return i}}(t,e);for(var i=0,n=1;n<=t.length/2-2;n++)i+=Map3DSDKLib.Math.CalcTriAngleArea(t[2*n-2],t[2*n-1],t[2*n],t[2*n+1],t[2*n+2],t[2*n+3]);return i};var e={};var i=Map3DSDKLib.DistanceTool=function(t){this.divMap=t,this.Input3DTool=new Map3DSDKLib.Input3DTool(map),e.dist=this};i.prototype.GetMap=function(){return this.divMap},i.prototype.ClearGeometry=function(){this.Input3DTool.ClearGeometry()};var n=null;function r(t){if(e.dist.ClearGeometry(),e.dist.GetMap().RemoveLabel("distance-tip"),t){var i=t.currentTarget.finishCoordinate_;e.dist.GetMap().AddTextLabel("distance-tip-start",i[0],i[1],"起点")}}function a(t){t.feature.values_.geometry.extent_;for(var i=t.feature.values_.geometry.flatCoordinates,n=i.length,r=0,a=1;a<i.length/2;a++)r+=Map3DSDKLib.Math.CalcFlatDistance(i[2*a-2],i[2*a-1],i[2*a],i[2*a+1]);r/=1e3,e.dist.GetMap().AddTextLabel("distance-tip",i[n-2],i[n-1],"总长:"+r.toFixed(2)+"公里")}i.prototype.AddFlashTip=function(t,i){if(this.CloseFlashTip(),null==n){null==i&&(i=3e3);var r=this.GetMap().GetViewCenter();if(null==r)return void this.CloseFlashTip();e.dist.GetMap().AddTextLabel("only-tip",r[0],r[1],t),n=window.setInterval(this.CloseFlashTip,i)}},i.prototype.CloseFlashTip=function(){null!=n&&(e.dist.GetMap().RemoveLabel("only-tip"),window.clearInterval(n),n=null)},i.prototype.Start=function(){r(),this.AddFlashTip("距离提示：左击开始，双击左键结束!",2e3),this.Input3DTool.StartLineTool(r,a)},i.prototype.End=function(){this.Input3DTool.ClearAll(),this.GetMap().RemoveLabel("distance-tip-start"),this.GetMap().RemoveLabel("distance-tip")},Map3DSDKLib.DistanceTool=i;var o=Map3DSDKLib.AreaTool=function(t){this.divMap=t,this.Input3DTool=new Map3DSDKLib.Input3DTool(t),e.area=this};o.prototype.GetMap=function(){return this.divMap},o.prototype.ClearGeometry=function(){this.Input3DTool.ClearGeometry()};n=null;function s(t){e.area.ClearGeometry(),e.area.GetMap().RemoveLabel("area-tip-start"),e.area.GetMap().RemoveLabel("area-tip")}function l(t){for(var i=t.feature.values_.geometry.flatCoordinates,n=t.feature.values_.geometry.getInteriorPoint().getCoordinates(),r=(i.length,0),a=1;a<=i.length/2-3;a++)r+=Map3DSDKLib.Math.CalcTriAngleArea(i[2*a-2],i[2*a-1],i[2*a],i[2*a+1],i[2*a+2],i[2*a+3]);var o="";o=r>1e6?"总面积:"+(r/=1e6).toFixed(2)+"平方公里":"总面积:"+r.toFixed(2)+"平方米",e.area.GetMap().AddTextLabel("area-tip",n[0],n[1],o)}o.prototype.AddFlashTip=function(t,i){if(this.CloseFlashTip(),null==n){null==i&&(i=3e3);var r=this.GetMap().GetViewCenter();if(null==r)return void this.CloseFlashTip();e.area.GetMap().AddTextLabel("only-tip",r[0],r[1],t),n=window.setInterval(this.CloseFlashTip,i)}},o.prototype.CloseFlashTip=function(){null!=n&&(e.area.GetMap().RemoveLabel("only-tip"),window.clearInterval(n),n=null)},o.prototype.Start=function(){s(),this.AddFlashTip("距离提示：左击开始，双击左键结束!",2e3),this.Input3DTool.StartPolygonTool(s,l)},o.prototype.End=function(){this.Input3DTool.ClearAll(),this.GetMap().RemoveLabel("area-tip-start"),this.GetMap().RemoveLabel("area-tip")},Map3DSDKLib.AreaTool=o}();var ZMap3DLib=Map3DSDKLib;