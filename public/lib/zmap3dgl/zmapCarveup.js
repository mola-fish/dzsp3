var dheadingArray=[GmMap3D.Math.toRadians(-45),GmMap3D.Math.toRadians(-45),GmMap3D.Math.toRadians(45),GmMap3D.Math.toRadians(45),GmMap3D.Math.toRadians(-135),GmMap3D.Math.toRadians(-135),GmMap3D.Math.toRadians(135),GmMap3D.Math.toRadians(135)],dpitcharray=[Math.asin(Math.sqrt(3)/3),-Math.asin(Math.sqrt(3)/3),Math.asin(Math.sqrt(3)/3),-Math.asin(Math.sqrt(3)/3),Math.asin(Math.sqrt(3)/3),-Math.asin(Math.sqrt(3)/3),Math.asin(Math.sqrt(3)/3),-Math.asin(Math.sqrt(3)/3)],mheadingArray=[GmMap3D.Math.toRadians(0),GmMap3D.Math.toRadians(90),GmMap3D.Math.toRadians(180),GmMap3D.Math.toRadians(-90),GmMap3D.Math.toRadians(0),GmMap3D.Math.toRadians(0)],mpitcharray=[GmMap3D.Math.toRadians(0),GmMap3D.Math.toRadians(0),GmMap3D.Math.toRadians(0),GmMap3D.Math.toRadians(0),GmMap3D.Math.toRadians(90),GmMap3D.Math.toRadians(-90)],defineBaseVector=[{axisNum:1,axis:"x",vector:[1,0,0]},{axisNum:2,axis:"xf",vector:[-1,0,0]},{axisNum:3,axis:"y",vector:[0,1,0]},{axisNum:4,axis:"yf",vector:[0,-1,0]},{axisNum:5,axis:"z",vector:[0,0,1]},{axisNum:6,axis:"zf",vector:[0,0,-1]}],ZMAPCARVEUP=function(t){this.map3dTool=t,this.viewer=t.GetView(),this.camera=this.viewer.camera,this.nativeScene=map3dView.cesium.mViewer.scene,this.Handler=new GmMap3D.ScreenSpaceEventHandler(this.viewer.scene.canvas),this._model=null,this._modelFlag=!0,this._planeEntities=[],this._clippingPlanes,this._clippingId=[],this._modelRadius=0,this.selectedPlane=null,this.basePlanes={},this.basevector={},this.modelMart3=null,this.dpoints=new _points,this.dtarget=new _distance};ZMAPCARVEUP.prototype.initBaseParam=function(t){this.map3dTool=t,this.viewer=t.GetView(),this.camera=this.viewer.camera,this.nativeScene=map3dView.cesium.mViewer.scene,this.Handler=new GmMap3D.ScreenSpaceEventHandler(this.viewer.scene.canvas)},ZMAPCARVEUP.prototype.removeAllMes=function(){this._model=null,this._modelFlag=!0,this._planeEntities=[],this._clippingPlanes,this._modelRadius=0,this.selectedPlane=null,this.basePlanes={},this.basevector={},this.modelMart3=null,this.dpoints=null,this.dpoints=new _points,this.dtarget=null,this.dtarget=new _distance;for(var t=0;t<this._clippingId.length;t++)this.map3dTool.removeModelByid(this._clippingId[t]);this._clippingId=[]},ZMAPCARVEUP.prototype.judge=function(t){return!!t&&(this._model=t,"string"==typeof t&&(this.map3dTool.zmapGltf?this._model=this.map3dTool.GetModel(t):this._model=this.map3dTool.get3dTilesById(t)),"string"!=typeof this._model)},ZMAPCARVEUP.prototype.getModelBorder=function(){if(this._modelFlag){this._modelRadius=this._model._root._boundingVolume._boundingSphere.radius,this.dpoints.setCenter(this._model._root._boundingVolume._boundingSphere.center);var t=this._model._modelMatrix;this.modelMart3=GmMap3D.Matrix4.getRotation(t,new GmMap3D.Matrix3)}else{for(var e=this.viewer.scene.primitives._primitives,a=null,i=0;i<e.length;i++){var s=e[i];if(s.id&&s.id._id===this._model._id){a=s;break}}this._modelRadius=a._scaledBoundingSphere.radius,this.dpoints.setCenter(this._model._position._value);var n=this._model._orientation._value;this.modelMart3=GmMap3D.Matrix3.fromQuaternion(n)}},ZMAPCARVEUP.prototype.getModelBoxPoints=function(){for(var t=this.dpoints.getCenter(),e=null,a=0;a<8;a++)e=this.deviationCalculate(t,dheadingArray[a],dpitcharray[a],this._modelRadius),0==a&&this.dpoints.setOnep(e),1==a&&this.dpoints.setTwop(e),2==a&&this.dpoints.setThrp(e),3==a&&this.dpoints.setFoup(e),4==a&&this.dpoints.setFivp(e),5==a&&this.dpoints.setSixp(e),6==a&&this.dpoints.setSevp(e),7==a&&this.dpoints.setEigp(e);for(a=0;a<6;a++)e=this.deviationCalculate(t,mheadingArray[a],mpitcharray[a],this._modelRadius),0==a&&this.dpoints.setXmps(e),1==a&&this.dpoints.setXfmps(e),2==a&&this.dpoints.setYmps(e),3==a&&this.dpoints.setYfmps(e),4==a&&this.dpoints.setZmps(e),5==a&&this.dpoints.setZfmps(e)},ZMAPCARVEUP.prototype.deviationCalculate=function(t,e,a,i){var s=new GmMap3D.HeadingPitchRoll(e,a,0),n=GmMap3D.Transforms.headingPitchRollToFixedFrame(t,s,GmMap3D.Ellipsoid.WGS84,GmMap3D.Transforms.eastNorthUpToFixedFrame,new GmMap3D.Matrix4),r=new GmMap3D.Cartesian3(i,0,0);return GmMap3D.Matrix4.multiplyByPoint(n,r,new GmMap3D.Cartesian3)},ZMAPCARVEUP.prototype.createBasePlanes=function(t){var e=null,a=null,i=null,s=null,n=[],r=0,o=[];if(null==t||null==t)o=[1,2,3,4,5,6];else for(var p=0;p<t.length;p++)for(var d=t[p],g=0;g<defineBaseVector.length;g++){var h=defineBaseVector[g];if(Number(d)==Number(h.axisNum)){o.push(h.axisNum);break}}if(0==o.length)return!1;for(var l=0;l<defineBaseVector.length;l++){var _=defineBaseVector[l],c=_.vector,m=_.axis;t=_.axisNum;e=new GmMap3D.Cartesian3(c[0],c[1],c[2]),a=GmMap3D.Matrix3.multiplyByVector(this.modelMart3,e,new GmMap3D.Cartesian3),a=GmMap3D.Cartesian3.normalize(a,new GmMap3D.Cartesian3),$.inArray(t,o)>=0&&(s=new GmMap3D.ClippingPlane(e,0),n.push(s),this._clippingId.push("plane"+m),this.dtarget["_target"+m]._targetDis=this._modelRadius),this.basevector[m]=a,m.indexOf("f")<0&&(i=new GmMap3D.Plane(a,0),r=GmMap3D.Plane.getPointDistance(i,this.dpoints.getCenter()),i.distance=r,"x"==m&&this.dpoints.getCenter().x>0&&(i.distance=-r),"y"==m&&this.dpoints.getCenter().y>0&&(i.distance=-r),"z"==m&&(i.distance=-r),this.basePlanes[m]=i)}return n},ZMAPCARVEUP.prototype.createPlaneUpdateFunctionx=function(t){var e=this;return function(){return t.distance=e.dtarget._targetx._targetDis,t}},ZMAPCARVEUP.prototype.createPlaneUpdateFunctionxf=function(t){var e=this;return function(){return t.distance=e.dtarget._targetxf._targetDis,t}},ZMAPCARVEUP.prototype.createPlaneUpdateFunctiony=function(t){var e=this;return function(){return t.distance=e.dtarget._targety._targetDis,t}},ZMAPCARVEUP.prototype.createPlaneUpdateFunctionyf=function(t){var e=this;return function(){return t.distance=e.dtarget._targetyf._targetDis,t}},ZMAPCARVEUP.prototype.createPlaneUpdateFunctionz=function(t){var e=this;return function(){return t.distance=e.dtarget._targetz._targetDis,t}},ZMAPCARVEUP.prototype.createPlaneUpdateFunctionzf=function(t,e){var a=this;return function(){return t.distance=a.dtarget._targetzf._targetDis,t}},ZMAPCARVEUP.prototype.computeAxis=function(t,e){var a="x";if(t.indexOf("x")>=0)return a="y";if(t.indexOf("y")>=0)return a="x";var i=GmMap3D.Cartesian3.angleBetween(this.basevector.x,e),s=GmMap3D.Cartesian3.angleBetween(this.basevector.y,e),n=GmMap3D.Cartesian3.angleBetween(this.basevector.z,e),r=Math.abs(i);return Math.abs(s)<=r&&(r=Math.abs(s),a="y"),Math.abs(n)<=r&&(r=Math.abs(n),a="z"),a},ZMAPCARVEUP.prototype.computeDistance=function(t,e,a){var i=this.camera.getPickRay(t),s=i.direction,n=this.computeAxis(a,s),r=GmMap3D.IntersectionTests.rayPlane(i,this.basePlanes[n],new GmMap3D.Cartesian3);null!=r&&null!=r||(r=GmMap3D.IntersectionTests.rayPlane(i,this.basePlanes[n],new GmMap3D.Cartesian3));var o=GmMap3D.Cartesian3.subtract(r,this.dpoints.getCenter(),new GmMap3D.Cartesian3),p=-GmMap3D.Cartesian3.dot(o,e);return p>=0?p>this._modelRadius&&(p=this._modelRadius):Math.abs(p)>this._modelRadius&&(p=-this._modelRadius),p},ZMAPCARVEUP.prototype.addMoveHander=function(){var t=this;this.Handler.setInputAction((function(e){var a=t.nativeScene.pick(e.position);if(GmMap3D.defined(a)&&GmMap3D.defined(a.id)&&GmMap3D.defined(a.id._plane)){t.changeCavPlaneColor();var i=a.id._id;"planex"==i&&(t.dtarget._targetx._targetflag=!0),"planexf"==i&&(t.dtarget._targetxf._targetflag=!0),"planey"==i&&(t.dtarget._targety._targetflag=!0),"planeyf"==i&&(t.dtarget._targetyf._targetflag=!0),"planez"==i&&(t.dtarget._targetz._targetflag=!0),"planezf"==i&&(t.dtarget._targetzf._targetflag=!0),t.selectedPlane=a.id._plane,t.selectedPlane.material=GmMap3D.Color.WHITE.withAlpha(.01),t.selectedPlane.outlineColor=GmMap3D.Color.WHITE,t.viewer.scene.screenSpaceCameraController.enableInputs=!1}}),GmMap3D.ScreenSpaceEventType.LEFT_DOWN),this.Handler.setInputAction((function(){GmMap3D.defined(t.selectedPlane)&&(t.selectedPlane.material=GmMap3D.Color.WHITE.withAlpha(.1),t.selectedPlane.outlineColor=GmMap3D.Color.WHITE,t.selectedPlane=void 0,t.dtarget._targetx._targetflag=!1,t.dtarget._targetxf._targetflag=!1,t.dtarget._targety._targetflag=!1,t.dtarget._targetyf._targetflag=!1,t.dtarget._targetz._targetflag=!1,t.dtarget._targetzf._targetflag=!1),t.changeCavPlaneColor(),t.viewer.scene.screenSpaceCameraController.enableInputs=!0}),GmMap3D.ScreenSpaceEventType.LEFT_UP),this.Handler.setInputAction((function(e){if(GmMap3D.defined(t.selectedPlane)){var a=0;t.dtarget._targetx._targetflag&&(a=t.computeDistance(e.endPosition,t.basevector.x,"x"),t.computeRdistance("x",a)),t.dtarget._targetxf._targetflag&&(a=t.computeDistance(e.endPosition,t.basevector.xf,"xf"),t.computeRdistance("xf",a)),t.dtarget._targety._targetflag&&(a=t.computeDistance(e.endPosition,t.basevector.y,"y"),t.computeRdistance("y",a)),t.dtarget._targetyf._targetflag&&(a=t.computeDistance(e.endPosition,t.basevector.yf,"yf"),t.computeRdistance("yf",a)),t.dtarget._targetz._targetflag&&(a=t.computeDistance(e.endPosition,t.basevector.z,"z"),t.computeRdistance("z",a)),t.dtarget._targetzf._targetflag&&(a=t.computeDistance(e.endPosition,t.basevector.zf,"zf"),t.computeRdistance("zf",a))}else{var i=t.nativeScene.pick(e.endPosition);GmMap3D.defined(i)&&GmMap3D.defined(i.id)&&GmMap3D.defined(i.id._plane)&&t.changeCavPlaneColor(i.id._plane)}}),GmMap3D.ScreenSpaceEventType.MOUSE_MOVE)},ZMAPCARVEUP.prototype.changeCavPlaneColor=function(t){for(var e=0;e<this._clippingId.length;e++){this.map3dTool.GetModel(this._clippingId[e]).plane.material=GmMap3D.Color.WHITE.withAlpha(.1)}t&&(t.material=GmMap3D.Color.RED.withAlpha(.5))},ZMAPCARVEUP.prototype.computeRdistance=function(t,e){if("x"==t){this.dtarget._targetx._targetDis=e;var a=this.dtarget._targetx._targetDis,i=this.dtarget._targetxf._targetDis;a>0?i<=0&&Math.abs(a)<=Math.abs(i)&&(this.dtarget._targetxf._targetDis=-a):Math.abs(i)<=Math.abs(a)&&(this.dtarget._targetxf._targetDis=-a)}if("xf"==t){this.dtarget._targetxf._targetDis=e;a=this.dtarget._targetx._targetDis;(i=this.dtarget._targetxf._targetDis)>0?a<=0&&Math.abs(i)<=Math.abs(a)&&(this.dtarget._targetx._targetDis=-i):Math.abs(a)<=Math.abs(i)&&(this.dtarget._targetx._targetDis=-i)}if("y"==t){this.dtarget._targety._targetDis=e;var s=this.dtarget._targety._targetDis,n=this.dtarget._targetyf._targetDis;s>0?n<=0&&Math.abs(s)<=Math.abs(n)&&(this.dtarget._targetyf._targetDis=-s):Math.abs(n)<=Math.abs(s)&&(this.dtarget._targetyf._targetDis=-s)}if("yf"==t){this.dtarget._targetyf._targetDis=e;s=this.dtarget._targety._targetDis;(n=this.dtarget._targetyf._targetDis)>0?s<=0&&Math.abs(n)<=Math.abs(s)&&(this.dtarget._targety._targetDis=-n):Math.abs(s)<=Math.abs(n)&&(this.dtarget._targety._targetDis=-n)}if("z"==t){this.dtarget._targetz._targetDis=e;var r=this.dtarget._targetz._targetDis,o=this.dtarget._targetzf._targetDis;r>0?n<=0&&Math.abs(r)<=Math.abs(o)&&(this.dtarget._targetzf._targetDis=-r):Math.abs(o)<=Math.abs(r)&&(this.dtarget._targetzf._targetDis=-r)}if("zf"==t){this.dtarget._targetzf._targetDis=e;r=this.dtarget._targetz._targetDis;(o=this.dtarget._targetzf._targetDis)>0?r<=0&&Math.abs(o)<=Math.abs(r)&&(this.dtarget._targetz._targetDis=-o):Math.abs(r)<=Math.abs(o)&&(this.dtarget._targetz._targetDis=-o)}},ZMAPCARVEUP.prototype.carverModel=function(t,e){if(!this.judge(t))return"需要切割的物体不存在！";this._modelFlag=!1,this.getModelBorder();var a=this.createBasePlanes(e);if(!a)return"需要生成的切面不存在！";this._clippingPlanes=new GmMap3D.ClippingPlaneCollection({planes:a,edgeWidth:1,unionClippingRegions:!0}),this._model._model.clippingPlanes=this._clippingPlanes,this.initCarvePlane()},ZMAPCARVEUP.prototype.carveUpTiles=function(t,e){if(!this.judge(t))return"需要切割的物体不存在！";this._modelFlag=!0,this.getModelBorder();var a=this.createBasePlanes(e);if(!a)return"需要生成的切面不存在！";this._clippingPlanes=new GmMap3D.ClippingPlaneCollection({planes:a,edgeWidth:1,unionClippingRegions:!0}),this._model.clippingPlanes=this._clippingPlanes,this.initCarvePlane()},ZMAPCARVEUP.prototype.initCarvePlane=function(){for(var t=2*this._modelRadius,e=this.dpoints.getCenter(),a=0;a<this._clippingPlanes.length;++a){var i=this._clippingPlanes.get(a),s=null,n=this._clippingId[a];"planex"==n&&(s=this.createPlaneUpdateFunctionx(i,GmMap3D.Matrix4.IDENTITY)),"planexf"==n&&(s=this.createPlaneUpdateFunctionxf(i,GmMap3D.Matrix4.IDENTITY)),"planey"==n&&(s=this.createPlaneUpdateFunctiony(i,GmMap3D.Matrix4.IDENTITY)),"planeyf"==n&&(s=this.createPlaneUpdateFunctionyf(i,GmMap3D.Matrix4.IDENTITY)),"planez"==n&&(s=this.createPlaneUpdateFunctionz(i,GmMap3D.Matrix4.IDENTITY)),"planezf"==n&&(s=this.createPlaneUpdateFunctionzf(i,GmMap3D.Matrix4.IDENTITY));var r=this.viewer.entities.add({id:n,position:e,plane:{dimensions:new GmMap3D.Cartesian2(t,t),material:GmMap3D.Color.WHITE.withAlpha(.1),plane:new GmMap3D.CallbackProperty(s,!1),outline:!0,outlineColor:GmMap3D.Color.WHITE}});this._planeEntities.push(r)}this.addMoveHander()},ZMAPCARVEUP.prototype.repeatePlane=function(){this._model&&this._modelRadius&&(this.dtarget._targetx._targetflag=!1,this.dtarget._targetx._targetDis=this._modelRadius,this.dtarget._targetxf._targetflag=!1,this.dtarget._targetxf._targetDis=this._modelRadius,this.dtarget._targety._targetflag=!1,this.dtarget._targety._targetDis=this._modelRadius,this.dtarget._targetyf._targetflag=!1,this.dtarget._targetyf._targetDis=this._modelRadius,this.dtarget._targetz._targetflag=!1,this.dtarget._targetzf._targetDis=this._modelRadius)};var _distance=function(){};_distance.prototype._targetx={_targetflag:!1,_targetDis:0},_distance.prototype._targetxf={_targetflag:!1,_targetDis:0},_distance.prototype._targety={_targetflag:!1,_targetDis:0},_distance.prototype._targetyf={_targetflag:!1,_targetDis:0},_distance.prototype._targetz={_targetflag:!1,_targetDis:0},_distance.prototype._targetzf={_targetflag:!1,_targetDis:0};var _points=function(){};_points.prototype.center,_points.prototype.xmps,_points.prototype.xfmps,_points.prototype.ymps,_points.prototype.yfmps,_points.prototype.zmps,_points.prototype.zfmps,_points.prototype.onep,_points.prototype.twop,_points.prototype.thrp,_points.prototype.foup,_points.prototype.fivp,_points.prototype.sixp,_points.prototype.sevp,_points.prototype.eigp,_points.prototype.getCenter=function(){return this.center},_points.prototype.setCenter=function(t){this.center=t},_points.prototype.getXmps=function(){return this.xmps},_points.prototype.setXmps=function(t){this.xmps=t},_points.prototype.getXfmps=function(){return this.xfmps},_points.prototype.setXfmps=function(t){this.xfmps=t},_points.prototype.getYmps=function(){return this.ymps},_points.prototype.setYmps=function(t){this.ymps=t},_points.prototype.getYfmps=function(){return this.yfmps},_points.prototype.setYfmps=function(t){this.yfmps=t},_points.prototype.getZmps=function(){return this.zmps},_points.prototype.setZmps=function(t){this.zmps=t},_points.prototype.getZfmps=function(){return this.zfmps},_points.prototype.setZfmps=function(t){this.zfmps=t},_points.prototype.getOnep=function(){return this.onep},_points.prototype.setOnep=function(t){this.onep=t},_points.prototype.getTwop=function(){return this.twop},_points.prototype.setTwop=function(t){this.twop=t},_points.prototype.getThrp=function(){return this.thrp},_points.prototype.setThrp=function(t){this.thrp=t},_points.prototype.getFoup=function(){return this.foup},_points.prototype.setFoup=function(t){this.foup=t},_points.prototype.getFivp=function(){return this.fivp},_points.prototype.setFivp=function(t){this.fivp=t},_points.prototype.getSixp=function(){return this.sixp},_points.prototype.setSixp=function(t){this.sixp=t},_points.prototype.getSevp=function(){return this.sevp},_points.prototype.setSevp=function(t){this.sevp=t},_points.prototype.getEigp=function(){return this.eigp},_points.prototype.setEigp=function(t){this.eigp=t};